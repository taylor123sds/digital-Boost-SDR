/**
 * ðŸŽ¯ FIRST MESSAGE BUILDER - Sistema HÃ­brido de Mensagens Iniciais
 *
 * Unifica a lÃ³gica de primeira mensagem do ORBION:
 * - Usa templates testados de sector_pain_messages.js quando setor conhecido
 * - Fallback genÃ©rico quando setor desconhecido
 * - Uma Ãºnica fonte de verdade para agent.js E campaign_manager.js
 *
 * BenefÃ­cios:
 * âœ… Alta conversÃ£o (templates especÃ­ficos por setor)
 * âœ… ConsistÃªncia (sempre mesma msg para mesmo setor)
 * âœ… FÃ¡cil manutenÃ§Ã£o (atualizar 1 lugar)
 */

import { getSectorCategory, generateSectorMessage } from './sector_pain_messages.js';

/**
 * ðŸ—ï¸ CONSTRUTOR PRINCIPAL DE PRIMEIRA MENSAGEM
 *
 * @param {string} name - Nome do contato/empresa (ex: "Bolo da Leca")
 * @param {string|null} profileName - Nome do perfil WhatsApp (alternativa para detectar setor)
 * @param {string|null} sector - Setor explÃ­cito (se conhecido da planilha)
 * @returns {string} Mensagem personalizada pronta para enviar
 */
export function buildFirstMessage(name, profileName = null, sector = null) {
  // Limpar nome para saudaÃ§Ã£o
  const cleanName = name || profileName || 'OlÃ¡';

  // 1ï¸âƒ£ Se setor foi fornecido explicitamente (ex: da planilha de leads)
  if (sector) {
    console.log(`ðŸ“‹ [FIRST-MSG] Setor explÃ­cito fornecido: "${sector}"`);
    const category = getSectorCategory(sector);
    console.log(`ðŸŽ¯ [FIRST-MSG] Categoria mapeada: "${category}"`);

    if (category !== 'default') {
      const message = generateSectorMessage(cleanName, sector);
      console.log(`âœ… [FIRST-MSG] Usando template especÃ­fico para "${category}"`);
      return message;
    }
  }

  // 2ï¸âƒ£ Tentar detectar setor pelo nome do perfil
  if (profileName) {
    console.log(`ðŸ” [FIRST-MSG] Tentando detectar setor pelo nome: "${profileName}"`);
    const category = getSectorCategory(profileName);

    if (category !== 'default') {
      const message = generateSectorMessage(cleanName, profileName);
      console.log(`âœ… [FIRST-MSG] Setor detectado: "${category}" via nome`);
      return message;
    }
  }

  // 3ï¸âƒ£ Tentar detectar setor pelo nome do contato
  if (name && name !== profileName) {
    console.log(`ðŸ” [FIRST-MSG] Tentando detectar setor pelo contato: "${name}"`);
    const category = getSectorCategory(name);

    if (category !== 'default') {
      const message = generateSectorMessage(cleanName, name);
      console.log(`âœ… [FIRST-MSG] Setor detectado: "${category}" via contato`);
      return message;
    }
  }

  // 4ï¸âƒ£ Fallback: usar template genÃ©rico
  console.log(`âš ï¸  [FIRST-MSG] Setor nÃ£o identificado, usando template genÃ©rico`);
  return buildGenericFirstMessage(cleanName);
}

/**
 * ðŸ”„ MENSAGEM GENÃ‰RICA (FALLBACK)
 * Usada quando nÃ£o conseguimos identificar o setor
 *
 * @param {string} name - Nome para saudaÃ§Ã£o
 * @returns {string} Mensagem genÃ©rica otimizada
 */
function buildGenericFirstMessage(name) {
  return `OlÃ¡ ${name}, tudo bem?

Sou ORBION, atendente virtual da *Digital Boost* ðŸš€

Somos uma startup premiada em *5Âº lugar no Startup Nordeste pelo Sebrae* e ajudamos PMEs a escalarem seus resultados de forma previsÃ­vel.

Nosso foco Ã© implementar soluÃ§Ãµes tecnolÃ³gicas que geram crescimento real:
â€¢ *Growth Marketing*: estratÃ©gias data-driven para aumentar sua base de clientes
â€¢ *Sites e PresenÃ§a Digital*: plataformas otimizadas para conversÃ£o e vendas

Me conta, *qual Ã© o maior desafio que vocÃª enfrenta hoje no seu negÃ³cio?*

Pode ser desde vendas travadas, marketing que nÃ£o traz resultado, atÃ© falta de presenÃ§a digital... quero entender sua realidade pra ver como posso ajudar.

_Responda REMOVER se nÃ£o quiser mais contato_`;
}

/**
 * ðŸŽ¯ DETECTOR DE SETOR (Alias)
 * ExpÃµe funÃ§Ã£o de detecÃ§Ã£o para uso externo
 */
export { getSectorCategory as detectSector };

/**
 * ðŸ“Š TESTE DO BUILDER (Para Debug)
 * Exemplo de uso:
 *
 * import { testFirstMessageBuilder } from './first_message_builder.js';
 * testFirstMessageBuilder();
 */
export function testFirstMessageBuilder() {
  const tests = [
    { name: 'Bolo da Leca', profileName: 'Confeitaria Leca', sector: null },
    { name: 'Ã“tica Avenida', profileName: null, sector: 'Ã“tica' },
    { name: 'ClÃ­nica Pedro Cavalcanti', profileName: 'Dr. Pedro', sector: 'ClÃ­nica' },
    { name: 'JoÃ£o Silva', profileName: 'JoÃ£o', sector: null },
    { name: 'Padaria PÃ£o Nosso', profileName: null, sector: null }
  ];

  console.log('\nðŸ§ª TESTE DO FIRST MESSAGE BUILDER\n');
  console.log('â•'.repeat(80));

  tests.forEach((test, i) => {
    console.log(`\nðŸ“‹ Teste ${i + 1}:`);
    console.log(`   Nome: "${test.name}"`);
    console.log(`   Profile: "${test.profileName}"`);
    console.log(`   Setor: "${test.sector}"`);
    console.log('\nðŸ“¤ Mensagem gerada:\n');
    const message = buildFirstMessage(test.name, test.profileName, test.sector);
    console.log(message);
    console.log('\n' + 'â”€'.repeat(80));
  });

  console.log('\nâœ… Teste concluÃ­do!\n');
}
