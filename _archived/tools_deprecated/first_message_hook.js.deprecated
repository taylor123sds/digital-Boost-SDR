// tools/first_message_hook.js
// ğŸ£ MELHORIA #6: Gancho Inicial para Primeira Mensagem

/**
 * ğŸ£ FIRST MESSAGE HOOK - MELHORIA #6
 *
 * Cria ganchos de valor para primeira mensagem do lead:
 * âœ¨ ApresentaÃ§Ã£o com proposta de valor clara
 * ğŸ¯ Cria curiosidade imediata
 * ğŸ’¬ Tom conversacional (nÃ£o corporativo)
 * âš¡ Call-to-action implÃ­cito
 */

class FirstMessageHook {
  constructor() {
    // ğŸ£ Templates de gancho por contexto de entrada
    this.hookTemplates = {
      // SaudaÃ§Ã£o simples
      greeting: [
        "E aÃ­! Sou o ORBION da Digital Boost. Automatizo vendas no WhatsApp 24/7. O que te trouxe aqui? ğŸ˜Š",
        "Oi! Aqui Ã© o assistente da Digital Boost. Ajudo empresas a vender mais sem esforÃ§o. Como posso te ajudar?",
        "OlÃ¡! Sou o ORBION. Cuido do atendimento no WhatsApp pra vocÃª focar em fechar vendas. Qual seu desafio hoje?"
      ],

      // Pergunta sobre produto/serviÃ§o
      service_inquiry: [
        "Opa! Legal vocÃª perguntar. Automatizamos atendimento no WhatsApp com IA. Libera seu time pra focar em vendas. Quer ver como?",
        "Show! Criamos agentes de IA que atendem, qualificam e agendam reuniÃµes 24/7. Sua empresa perde leads por falta de tempo?",
        "Bacana! Nossos agentes de IA fazem todo trabalho braÃ§al de vendas automaticamente. Quantos leads vocÃª perde por demora no atendimento?"
      ],

      // Interesse em automaÃ§Ã£o
      automation_interest: [
        "Perfeito! AutomaÃ§Ã£o Ã© nosso forte. Colocamos IA pra trabalhar enquanto vocÃª dorme. O que consome mais tempo do seu time hoje?",
        "Excelente! Imagina ter um vendedor que nunca dorme e responde em segundos. Ã‰ isso que fazemos. Quer testar?",
        "Ã“timo! IA trabalhando 24/7 enquanto vocÃª foca no que importa. Qual processo vocÃª quer automatizar primeiro?"
      ],

      // Dor/problema mencionado
      pain_point: [
        "Entendo a dor! Muitos clientes nossos tinham esse mesmo problema. Conseguimos resolver com automaÃ§Ã£o inteligente. Quer saber como?",
        "Te entendo perfeitamente. Essa Ã© uma dor comum. Temos uma soluÃ§Ã£o que pode te economizar horas todo dia. Posso explicar?",
        "Sei bem como Ã©. A boa notÃ­cia? Resolvemos isso com IA. Seus concorrentes provavelmente ainda sofrem com isso. Quer sair na frente?"
      ],

      // Pergunta sobre preÃ§o
      pricing_inquiry: [
        "Boa pergunta! Varia entre R$2k e R$8k/mÃªs, depende do volume. Mas antes, me conta: quantos leads vocÃª atende por mÃªs?",
        "Depende do que vocÃª precisa. Pode ser R$2k ou R$8k/mÃªs. Primeiro quero entender: qual seu maior gargalo hoje?",
        "Entre R$2k e R$8k/mÃªs, customizado pro seu caso. Mas me diz: quanto vocÃª perde em vendas por demora no atendimento?"
      ],

      // ComparaÃ§Ã£o com concorrentes
      competitive: [
        "Legal vocÃª pesquisar! Nosso diferencial? Somos de Natal, entendemos PME brasileira e damos suporte real. Quer ver na prÃ¡tica?",
        "Show que tÃ¡ comparando! O que te fez buscar alternativas? Posso te mostrar o que nos torna Ãºnicos.",
        "Ã“timo que estÃ¡ avaliando! Qual critÃ©rio Ã© mais importante pra vocÃª: preÃ§o, qualidade ou suporte?"
      ],

      // GenÃ©rico (fallback)
      default: [
        `OlÃ¡! ğŸ‘‹

Me chamo ORBION, sou o assistente inteligente da Digital Boost, uma startup de Growth & IA premiada pelo Sebrae Startup Nordeste.

Ajudamos empresas como Expert Turismo, ClÃ­nica Pedro Cavalcanti e BRC Lightning a automatizar atendimentos, gerar previsibilidade de vendas e reduzir o tempo de resposta ao cliente â€” tudo com tecnologia e estratÃ©gia.

Gostaria de entender melhor o seu negÃ³cio para identificar como posso te ajudar a alcanÃ§ar resultados parecidos. Qual o maior desafio que vocÃª enfrenta hoje para crescer?

_Digite SAIR para nÃ£o receber mais mensagens_`,

        `Oi! ğŸ‘‹

Sou o ORBION, assistente inteligente da Digital Boost â€” premiada pelo Sebrae Startup Nordeste.

Trabalhamos com clientes como Expert Turismo e ClÃ­nica Pedro Cavalcanti, ajudando a automatizar atendimentos e melhorar resultados.

Gostaria de entender melhor o seu negÃ³cio para identificar como posso te ajudar. O que te impede de atender todos os seus clientes no tempo ideal?

_Responda SAIR se nÃ£o tiver interesse_`,

        `OlÃ¡! ğŸ‘‹

Me chamo ORBION, da Digital Boost â€” startup de Growth & IA reconhecida pelo Sebrae Startup Nordeste.

Ajudamos empresas como BRC Lightning a reduzir tempo de resposta e gerar mais vendas com automaÃ§Ã£o inteligente.

Gostaria de entender melhor o seu negÃ³cio para identificar oportunidades. VocÃª consegue responder todos os seus clientes rapidamente hoje?

_Digite SAIR para nÃ£o receber mais mensagens_`
      ]
    };

    // ğŸ” PadrÃµes para detectar contexto da primeira mensagem
    this.contextPatterns = {
      greeting: /^(oi|olÃ¡|ola|hey|e aÃ­|opa|bom dia|boa tarde|boa noite|hello|hi)(\s+(orbion|tudo\s+bem|td\s+bem|tudo|bem))?[\s!?,]*$/i,

      service_inquiry: [
        /o que (vocÃª|vocÃªs|vc|vcs) (faz|fazem|oferece|oferecem)/i,
        /(quais|que) serviÃ§os/i,
        /me (fala|fale|explica|explique) (sobre|do)/i,
        /como (funciona|trabalha)/i,
        /o que Ã© (a digital boost|digital boost|orbion)/i
      ],

      automation_interest: [
        /automaÃ§Ã£o|automatizar|automÃ¡tico/i,
        /inteligÃªncia artificial|ia|ai\b/i,
        /bot|chatbot|agente/i,
        /whatsapp.*automÃ¡tico/i
      ],

      pain_point: [
        /(problema|dificuldade|desafio|dor) (com|de|no|na)/i,
        /(perdendo|perco|perde) (cliente|lead|venda)/i,
        /(demora|demorado|lento|atrasado)/i,
        /nÃ£o (consigo|aguento|tenho tempo)/i,
        /muito trabalho/i
      ],

      pricing_inquiry: [
        /quanto cust|preÃ§o|valor|investimento/i,
        /quanto (custa|Ã©|fica|sai|pag)/i,
        /valores|tabela|orÃ§amento/i
      ],

      competitive: [
        /concorr|alternativa|comparar|opÃ§Ãµes/i,
        /outras empresas|outro fornecedor/i,
        /diferencial|por que (vocÃª|vocÃªs)/i,
        /melhor que/i
      ]
    };

    console.log('ğŸ£ [FIRST-MESSAGE-HOOK] Sistema de gancho inicial inicializado');
  }

  /**
   * ğŸ£ GERA GANCHO INICIAL
   * @param {string} message - Primeira mensagem do lead
   * @param {Object} context - Contexto adicional
   * @returns {Object} Gancho personalizado
   */
  generateHook(message, context = {}) {
    const startTime = Date.now();

    // Detectar contexto da mensagem
    const detectedContext = this.detectMessageContext(message);

    // Selecionar template apropriado
    const templates = this.hookTemplates[detectedContext] || this.hookTemplates.default;

    // Escolher template aleatÃ³rio para variar
    const hook = templates[Math.floor(Math.random() * templates.length)];

    console.log(`ğŸ£ [HOOK] Contexto: ${detectedContext} | Template selecionado`);

    return {
      hook,
      context: detectedContext,
      shouldUseHook: true,
      generationTime: Date.now() - startTime
    };
  }

  /**
   * ğŸ” DETECTA CONTEXTO DA MENSAGEM
   * @param {string} message - Mensagem do lead
   * @returns {string} Contexto detectado
   */
  detectMessageContext(message) {
    const lowerMessage = message.toLowerCase().trim();

    // SaudaÃ§Ã£o simples
    if (this.contextPatterns.greeting.test(lowerMessage)) {
      return 'greeting';
    }

    // Testar cada padrÃ£o de contexto
    for (const [context, patterns] of Object.entries(this.contextPatterns)) {
      if (context === 'greeting') continue; // JÃ¡ testado

      const patternsArray = Array.isArray(patterns) ? patterns : [patterns];

      for (const pattern of patternsArray) {
        if (pattern.test(lowerMessage)) {
          return context;
        }
      }
    }

    // Fallback
    return 'default';
  }

  /**
   * âœ… VERIFICA SE Ã‰ PRIMEIRA MENSAGEM
   * @param {Array} history - HistÃ³rico de conversa
   * @returns {boolean}
   */
  isFirstMessage(history = []) {
    // Ã‰ primeira mensagem APENAS se nÃ£o hÃ¡ histÃ³rico nenhum
    // âš ï¸ IMPORTANTE: history.length === 0 ou === 1 significa que Ã© a primeira interaÃ§Ã£o
    // mas precisamos verificar se nÃ£o hÃ¡ mensagens ANTERIORES do ORBION
    if (!history || history.length === 0) {
      return true; // Sem histÃ³rico = primeira mensagem
    }

    // ğŸ”¥ FIX CRÃTICO: Se hÃ¡ histÃ³rico, SEMPRE retornar false
    // O first message hook NUNCA deve ser ativado se jÃ¡ existe conversa anterior
    return false;
  }

  /**
   * ğŸ¯ VERIFICA SE DEVE USAR GANCHO
   * @param {Object} context - Contexto da conversa
   * @returns {boolean}
   */
  shouldApplyHook(context = {}) {
    // Aplicar gancho se:
    // 1. Ã‰ primeira mensagem
    // 2. NÃ£o Ã© resposta a uma pergunta especÃ­fica do sistema
    // 3. NÃ£o Ã© continuaÃ§Ã£o de conversa existente

    if (!this.isFirstMessage(context.history)) {
      return false;
    }

    // Se tem contexto de conversa anterior, nÃ£o aplicar
    if (context.hasExistingConversation) {
      return false;
    }

    return true;
  }
}

// Singleton instance
const firstMessageHook = new FirstMessageHook();

export default firstMessageHook;

// FunÃ§Ãµes de conveniÃªncia
export function generateFirstMessageHook(message, context = {}) {
  return firstMessageHook.generateHook(message, context);
}

export function shouldUseFirstMessageHook(context = {}) {
  return firstMessageHook.shouldApplyHook(context);
}

export function isFirstMessage(history = []) {
  return firstMessageHook.isFirstMessage(history);
}
