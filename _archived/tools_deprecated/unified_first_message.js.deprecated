// tools/unified_first_message.js
// ðŸŽ¯ SISTEMA UNIFICADO DE PRIMEIRA MENSAGEM
// Estrutura padrÃ£o para TODAS as primeiras mensagens do ORBION

/**
 * ðŸ“ ESTRUTURA OBRIGATÃ“RIA DA PRIMEIRA MENSAGEM:
 *
 * 1) IntroduÃ§Ã£o
 *    - SaudaÃ§Ã£o com nome do lead
 *    - ApresentaÃ§Ã£o do ORBION
 *    - Credencial (5Âº lugar Startup Nordeste/SEBRAE)
 *
 * 2) VocÃª sabia? (growth)
 *    - Dado especÃ­fico de impacto
 *    - EstatÃ­stica relevante para o setor/problema
 *
 * 3) Convite
 *    - Proposta de valor direta
 *    - Baixo compromisso temporal (1 minutinho)
 *
 * 4) Opt-out
 *    - OpÃ§Ã£o clara de nÃ£o receber mais mensagens
 */

/**
 * ðŸ—ï¸ CONSTRUTOR DE PRIMEIRA MENSAGEM UNIFICADA
 *
 * @param {string} contactName - Nome do lead (do perfil WhatsApp ou contato)
 * @param {Object} options - OpÃ§Ãµes adicionais
 * @param {string} options.sector - Setor do lead (se conhecido)
 * @param {string} options.painType - Tipo de dor detectada
 * @returns {string} Mensagem formatada pronta para envio
 */
export function buildUnifiedFirstMessage(contactName, options = {}) {
  const { sector, painType } = options;

  // Pegar primeiro nome para saudaÃ§Ã£o mais pessoal
  const firstName = extractFirstName(contactName);

  // 1ï¸âƒ£ INTRODUÃ‡ÃƒO
  // Se nÃ£o temos nome, usar saudaÃ§Ã£o genÃ©rica sem repetiÃ§Ã£o
  const greeting = (firstName === 'OlÃ¡' || !firstName)
    ? `OlÃ¡! Aqui Ã© o ORBION, agente da Digital Boost (5Âº lugar no Startup Nordeste/SEBRAE). ðŸ‘‹`
    : `OlÃ¡, ${firstName}! Aqui Ã© o ORBION, agente da Digital Boost (5Âº lugar no Startup Nordeste/SEBRAE). ðŸ‘‹`;
  const introduction = greeting;

  // 2ï¸âƒ£ VOCÃŠ SABIA? (Growth - dados de impacto)
  const growthInsight = getGrowthInsight(sector, painType);

  // 3ï¸âƒ£ COLETA DE DADOS INICIAIS (antes de entender as dores)
  const dataCollection = `Antes de entendermos suas dores e como podemos te ajudar, poderia me falar rapidinho:

ðŸ“ Qual seu nome?
ðŸ¢ Nome da empresa?
ðŸŽ¯ Setor/ramo de atuaÃ§Ã£o?

Isso me ajuda a direcionar melhor a conversa para o que faz sentido pro seu negÃ³cio.`;

  // 4ï¸âƒ£ OPT-OUT
  const optOut = `Se nÃ£o quiser receber, me avisa e removo vocÃª na hora. ðŸ™‚`;

  // Montar mensagem completa
  return `${introduction}

${growthInsight}

${dataCollection}

${optOut}`;
}

/**
 * ðŸ“Š DADOS DE GROWTH POR SETOR/DOR
 * Retorna estatÃ­sticas relevantes baseadas no contexto
 */
function getGrowthInsight(sector, painType) {
  // Insights especÃ­ficos por tipo de dor ou setor
  const insights = {
    // Por tipo de dor
    leads: `VocÃª sabia que empresas que aplicam growth costumam reduzir o CAC em atÃ© 40% e aumentar a conversÃ£o em 65% com testes rÃ¡pidos e otimizaÃ§Ã£o de funil?`,

    vendas: `VocÃª sabia que empresas com automaÃ§Ã£o de vendas convertem atÃ© 3x mais leads em clientes e reduzem o ciclo de vendas em 50%?`,

    atendimento: `VocÃª sabia que empresas com atendimento automatizado respondem em atÃ© 3 segundos (vs 5 horas manual) e aumentam satisfaÃ§Ã£o em 80%?`,

    marketing: `VocÃª sabia que empresas data-driven conseguem ROI 5-8x maior em marketing e reduzem desperdÃ­cio de verba em atÃ© 60%?`,

    // Por setor especÃ­fico
    restaurante: `VocÃª sabia que restaurantes com presenÃ§a digital forte aumentam pedidos em atÃ© 200% e fidelizam 3x mais clientes?`,

    clinica: `VocÃª sabia que clÃ­nicas com agendamento automatizado reduzem no-shows em 70% e aumentam a taxa de ocupaÃ§Ã£o em 40%?`,

    ecommerce: `VocÃª sabia que e-commerces com growth bem aplicado aumentam ticket mÃ©dio em 45% e recuperam atÃ© 30% de carrinhos abandonados?`,

    servicos: `VocÃª sabia que empresas de serviÃ§os com automaÃ§Ã£o conseguem atender 5x mais leads sem aumentar equipe?`,

    // Default (growth genÃ©rico)
    default: `VocÃª sabia que empresas que aplicam growth costumam reduzir o CAC em atÃ© 40% e aumentar a conversÃ£o em 65% com testes rÃ¡pidos e otimizaÃ§Ã£o de funil?`
  };

  // Priorizar painType, depois sector, depois default
  if (painType && insights[painType]) {
    return insights[painType];
  }

  if (sector) {
    const sectorLower = sector.toLowerCase();

    // Mapear setores para insights
    if (sectorLower.includes('restaurante') || sectorLower.includes('food') || sectorLower.includes('comida')) {
      return insights.restaurante;
    }
    if (sectorLower.includes('clÃ­nica') || sectorLower.includes('saÃºde') || sectorLower.includes('mÃ©dico')) {
      return insights.clinica;
    }
    if (sectorLower.includes('ecommerce') || sectorLower.includes('loja') || sectorLower.includes('varejo')) {
      return insights.ecommerce;
    }
    if (sectorLower.includes('serviÃ§o') || sectorLower.includes('consultoria') || sectorLower.includes('agÃªncia')) {
      return insights.servicos;
    }
  }

  // Default genÃ©rico
  return insights.default;
}

/**
 * ðŸ‘¤ EXTRAI PRIMEIRO NOME DO CONTATO
 * Exemplos:
 * - "JoÃ£o Silva" â†’ "JoÃ£o"
 * - "ClÃ­nica Dr. Pedro" â†’ "Dr. Pedro"
 * - "Restaurante Bom Sabor" â†’ "Bom Sabor"
 */
function extractFirstName(fullName) {
  if (!fullName || fullName === 'OlÃ¡') {
    return 'OlÃ¡';
  }

  // Remover nÃºmeros de telefone se houver
  const cleaned = fullName.replace(/[\d\s\-\(\)]/g, ' ').trim();

  // Se comeÃ§ar com nome de empresa, pegar tudo
  const empresaPrefixes = ['restaurante', 'clÃ­nica', 'dr.', 'dra.', 'empresa', 'grupo', 'hotel'];
  const lowerName = cleaned.toLowerCase();

  for (const prefix of empresaPrefixes) {
    if (lowerName.startsWith(prefix)) {
      return cleaned; // Retornar nome completo se for empresa
    }
  }

  // Caso contrÃ¡rio, pegar primeiro nome
  const parts = cleaned.split(/\s+/);
  return parts[0] || fullName;
}

/**
 * ðŸ§ª TESTE DO SISTEMA
 * Para debug e validaÃ§Ã£o
 */
export function testUnifiedFirstMessage() {
  const tests = [
    { name: 'JoÃ£o Silva', sector: null, painType: 'leads' },
    { name: 'ClÃ­nica Dr. Pedro', sector: 'clinica', painType: null },
    { name: 'Restaurante Bom Sabor', sector: 'restaurante', painType: null },
    { name: 'Maria Santos', sector: null, painType: 'vendas' },
    { name: 'Loja XYZ', sector: 'ecommerce', painType: null },
    { name: '5584996791624', sector: null, painType: null }
  ];

  console.log('\nðŸ§ª TESTE DO SISTEMA UNIFICADO DE PRIMEIRA MENSAGEM\n');
  console.log('â•'.repeat(80));

  tests.forEach((test, i) => {
    console.log(`\nðŸ“‹ Teste ${i + 1}:`);
    console.log(`   Nome: "${test.name}"`);
    console.log(`   Setor: "${test.sector}"`);
    console.log(`   Pain Type: "${test.painType}"`);
    console.log('\nðŸ“¤ Mensagem gerada:\n');

    const message = buildUnifiedFirstMessage(test.name, {
      sector: test.sector,
      painType: test.painType
    });

    console.log(message);
    console.log('\n' + 'â”€'.repeat(80));
  });

  console.log('\nâœ… Teste concluÃ­do!\n');
}

export default buildUnifiedFirstMessage;
