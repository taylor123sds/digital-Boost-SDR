<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ORBION ‚Ä¢ Dashboard Pro v3.1 - SISTEMA COMPLETAMENTE OTIMIZADO</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script>
    // Force cache busting AGRESSIVO - SISTEMA OTIMIZADO v3.2
    const currentTime = Date.now();
    const correctVersion = 'v3.2-clean';

    if (!window.location.search.includes(correctVersion)) {
      console.log('üîÑ FOR√áANDO RELOAD v3.2 - SISTEMA LIMPO E OTIMIZADO');
      window.location.href = window.location.pathname +
                            '?version=' + correctVersion +
                            '&timestamp=' + Date.now() +
                            '&clean-system=true';
    } else {
      console.log('‚úÖ VERS√ÉO v3.2 CARREGADA - SISTEMA LIMPO SEM VOZ');
    }
  </script>

  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

  <!-- CORRE√á√ÉO: Leaflet CSS precisa ficar no <head>, fora do <style> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    /* ===== VAGALUMES TECNOL√ìGICOS ===== */
    .firefly {
      position: fixed;
      width: 4px;
      height: 4px;
      background: var(--primary-color, #667eea);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--primary-color, #667eea), 0 0 16px var(--accent-color, #4facfe), 0 0 24px rgba(102, 126, 234, 0.5);
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
    }

    /* Anima√ß√µes orbitais ao redor da anima√ß√£o ORBION */
    @keyframes orbitFar {
      0% { opacity: 0.6; transform: rotate(0deg) translateX(200px) rotate(0deg) scale(1); }
      25% { opacity: 0.9; transform: rotate(90deg) translateX(200px) rotate(-90deg) scale(1.1); }
      50% { opacity: 1; transform: rotate(180deg) translateX(200px) rotate(-180deg) scale(1.2); }
      75% { opacity: 0.8; transform: rotate(270deg) translateX(200px) rotate(-270deg) scale(1.1); }
      100% { opacity: 0.6; transform: rotate(360deg) translateX(200px) rotate(-360deg) scale(1); }
    }

    @keyframes orbitMedium {
      0% { opacity: 0.7; transform: rotate(0deg) translateX(150px) rotate(0deg) scale(0.9); }
      25% { opacity: 0.8; transform: rotate(-90deg) translateX(150px) rotate(90deg) scale(1.1); }
      50% { opacity: 1; transform: rotate(-180deg) translateX(150px) rotate(180deg) scale(1.3); }
      75% { opacity: 0.9; transform: rotate(-270deg) translateX(150px) rotate(270deg) scale(1.0); }
      100% { opacity: 0.7; transform: rotate(-360deg) translateX(150px) rotate(360deg) scale(0.9); }
    }

    @keyframes orbitClose {
      0% { opacity: 0.5; transform: rotate(0deg) translateX(120px) translateY(0px) rotate(0deg) scale(1); }
      25% { opacity: 0.8; transform: rotate(90deg) translateX(120px) translateY(-20px) rotate(-90deg) scale(1.2); }
      50% { opacity: 0.9; transform: rotate(180deg) translateX(120px) translateY(0px) rotate(-180deg) scale(1.4); }
      75% { opacity: 0.7; transform: rotate(270deg) translateX(120px) translateY(20px) rotate(-270deg) scale(1.1); }
      100% { opacity: 0.5; transform: rotate(360deg) translateX(120px) translateY(0px) rotate(-360deg) scale(1); }
    }

    @keyframes orbitDistant {
      0% { opacity: 0.4; transform: rotate(0deg) translateX(250px) translateY(-30px) scale(0.8); }
      33% { opacity: 0.8; transform: rotate(120deg) translateX(250px) translateY(0px) scale(1.2); }
      66% { opacity: 1; transform: rotate(240deg) translateX(250px) translateY(30px) scale(1.5); }
      100% { opacity: 0.4; transform: rotate(360deg) translateX(250px) translateY(-30px) scale(0.8); }
    }

    /* ===== EFEITO DE LUZ QUE SEGUE O MOUSE ===== */
    .meio {
      position: relative;
    }

    .meio::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
        rgba(var(--primary-color-rgb, 102, 126, 234), 0.15) 0%,
        rgba(var(--accent-color-rgb, 79, 172, 254), 0.08) 20%,
        transparent 50%
      );
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1;
    }

    .meio:hover::before {
      opacity: 1;
    }

    #bgluz {
      position: relative;
    }

    /* ======= Tema / Cores (mantido) ======= */
    :root{
      /* Tema padr√£o edit√°vel */
      --primary-color: var(--custom-primary, #667eea);
      --secondary-color: var(--custom-secondary, #764ba2);
      --accent-color: var(--custom-accent, #4facfe);
      --bg-0: var(--custom-bg-primary, #f8fafc);
      --bg-1: var(--custom-bg-secondary, #f1f5f9);
      --glass: var(--custom-glass, rgba(255,255,255,.8));
      --border: var(--custom-border, #e2e8f0);
      --muted: var(--custom-muted, #64748b);
      --text: var(--custom-text, #1e293b);
      --cyan: var(--custom-cyan, #06b6d4);
      --violet: var(--custom-violet, #8b5cf6);
      --ok: var(--custom-success, #10b981);
      --warn: var(--custom-warning, #f59e0b);
      --err: var(--custom-error, #ef4444);
      --radius: var(--custom-radius, 12px);
      --shadow: var(--custom-shadow, 0 4px 6px -1px rgba(0, 0, 0, 0.1));
      --glow: var(--custom-glow, 0 0 0 3px rgba(102, 126, 234, 0.1));
      --dashboard-bg: var(--custom-dashboard-bg, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; color:var(--text); font-family:"Inter",system-ui,Arial; overflow-x:hidden;
      background: transparent;
    }

    /* === SISTEMA DE VAGALUMES TECNOL√ìGICOS === */
    .tab {
      position: relative; /* Necess√°rio para posicionar vagalumes relativos √†s abas */
    }

    .firefly {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--primary-color, #667eea);
      border-radius: 50%;
      box-shadow:
        0 0 8px var(--primary-color, #667eea),
        0 0 16px var(--accent-color, #4facfe),
        0 0 24px rgba(102, 126, 234, 0.5);
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
    }

    /* Anima√ß√µes Tecnol√≥gicas - Otimizadas para √°rea ORBION (600x600px) */
    @keyframes techPulse {
      0%, 100% {
        transform: translate(50%, 100%) scale(0.8);
        opacity: 0;
      }
      25% {
        transform: translate(30%, 70%) scale(1);
        opacity: 0.8;
      }
      50% {
        transform: translate(70%, 50%) scale(1.2);
        opacity: 1;
      }
      75% {
        transform: translate(20%, 30%) scale(1);
        opacity: 0.6;
      }
    }

    @keyframes techWave1 {
      0% {
        transform: translate(0%, 80%) scale(0.9);
        opacity: 0;
      }
      25% {
        transform: translate(80%, 60%) scale(1.1);
        opacity: 0.7;
      }
      50% {
        transform: translate(20%, 40%) scale(1.2);
        opacity: 1;
      }
      75% {
        transform: translate(90%, 20%) scale(0.9);
        opacity: 0.5;
      }
      100% {
        transform: translate(50%, 0%) scale(0.7);
        opacity: 0;
      }
    }

    @keyframes techWave2 {
      0% {
        transform: translate(100%, 50%) scale(0.8);
        opacity: 0;
      }
      20% {
        transform: translate(10%, 90%) scale(1);
        opacity: 0.8;
      }
      40% {
        transform: translate(90%, 10%) scale(1.3);
        opacity: 1;
      }
      60% {
        transform: translate(30%, 80%) scale(1);
        opacity: 0.7;
      }
      80% {
        transform: translate(80%, 30%) scale(0.9);
        opacity: 0.4;
      }
      100% {
        transform: translate(50%, 50%) scale(0.6);
        opacity: 0;
      }
    }

    /* Padr√£o Grid Tecnol√≥gico */
    .firefly:nth-child(3n+1) {
      animation: techPulse 12s infinite ease-in-out;
    }

    .firefly:nth-child(3n+2) {
      animation: techWave1 15s infinite ease-in-out;
    }

    .firefly:nth-child(3n) {
      animation: techWave2 18s infinite ease-in-out;
    }

    /* Delays Sistem√°ticos para Efeito de Onda */
    .firefly:nth-child(1) { animation-delay: 0s; left: 10%; }
    .firefly:nth-child(2) { animation-delay: 0.5s; left: 20%; }
    .firefly:nth-child(3) { animation-delay: 1s; left: 30%; }
    .firefly:nth-child(4) { animation-delay: 1.5s; left: 40%; }
    .firefly:nth-child(5) { animation-delay: 2s; left: 50%; }
    .firefly:nth-child(6) { animation-delay: 2.5s; left: 60%; }
    .firefly:nth-child(7) { animation-delay: 3s; left: 70%; }
    .firefly:nth-child(8) { animation-delay: 3.5s; left: 80%; }
    .firefly:nth-child(9) { animation-delay: 4s; left: 90%; }
    .firefly:nth-child(10) { animation-delay: 4.5s; left: 15%; }
    .firefly:nth-child(11) { animation-delay: 5s; left: 25%; }
    .firefly:nth-child(12) { animation-delay: 5.5s; left: 35%; }
    .firefly:nth-child(13) { animation-delay: 6s; left: 45%; }
    .firefly:nth-child(14) { animation-delay: 6.5s; left: 55%; }
    .firefly:nth-child(15) { animation-delay: 7s; left: 65%; }
    .firefly:nth-child(16) { animation-delay: 7.5s; left: 75%; }
    .firefly:nth-child(17) { animation-delay: 8s; left: 85%; }
    .firefly:nth-child(18) { animation-delay: 8.5s; left: 95%; }
    .firefly:nth-child(19) { animation-delay: 9s; left: 5%; }
    .firefly:nth-child(20) { animation-delay: 9.5s; left: 95%; }

    /* Removido fundo matrix */

    /* Estrutura Profissional */
    .app{
      position:relative; z-index:1; display:grid; grid-template-columns:280px 1fr; min-height:100vh; font-family:'Inter', system-ui, sans-serif;
      background: var(--dashboard-bg, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
    }
    .brand{
      position:fixed; left:0; top:0; width:280px; height:80px;
      display:flex; align-items:center; gap:16px; padding:0 24px;
      background:var(--glass); border-right:1px solid var(--border); z-index:7;
      backdrop-filter:blur(20px); box-shadow:var(--shadow);
    }
    .brand .logo{width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      box-shadow:var(--shadow); display:flex; align-items:center; justify-content:center;
      transition:transform 0.2s ease;
    }
    .brand .logo:hover{transform:scale(1.05);}
    .brand .name{
      font-family: "Orbitron", var(--custom-brand-font, 'Inter'), sans-serif;
      letter-spacing:1.4px;
      font-weight:700;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-size:20px;
      text-shadow: 0 0 20px rgba(var(--primary-color-rgb, 102, 126, 234), 0.3);
      animation: textGlow 3s ease-in-out infinite;
    }

    @keyframes textGlow {
      0%, 100% {
        filter: brightness(1);
        text-shadow: 0 0 20px rgba(var(--primary-color-rgb, 102, 126, 234), 0.3);
      }
      50% {
        filter: brightness(1.2);
        text-shadow: 0 0 30px rgba(var(--primary-color-rgb, 102, 126, 234), 0.6);
      }
    }

    header{
      position:fixed; left:280px; right:0; top:0; height:80px;
      display:flex; align-items:center; justify-content:space-between; padding:0 32px;
      background:var(--glass);       border-bottom:1px solid var(--border); z-index:6; box-shadow:var(--shadow);
    }

    aside{
      position:sticky; 
      top:0; 
      height:100vh; 
      padding-top:80px; 
      background:var(--glass); 
      border-right:1px solid var(--border); 
          }
    
    /* Desktop sidebar */
    @media (min-width: 768px) {
      aside {
        position: sticky !important;
        left: 0 !important;
        top: 0 !important;
        transform: none !important;
        width: 280px !important;
        z-index: auto !important;
        background: var(--glass) !important;
      }
    }
    .menu{padding:20px 16px;}
    .menu .item{
      display:flex; align-items:center; gap:16px; margin-bottom:8px; padding:16px 20px;
      border-radius:16px; border:1px solid transparent; color:var(--text); cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight:500; font-size:14px; position:relative; overflow:hidden;
      transform: translateX(0);
    }

    .menu .item::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      transition: left 0.6s ease;
      z-index: 0;
    }
    .menu .item:hover::after {
      left: 100%;
    }

    .menu .item:hover{
      background:linear-gradient(135deg, var(--primary-color)15, var(--secondary-color)15);
      border-color:var(--primary-color)30;
      transform:translateX(6px) translateY(-2px);
      box-shadow: 0 4px 20px rgba(var(--primary-color-rgb, 102, 126, 234), 0.2);
    }
    .menu .item.active{
      background:linear-gradient(135deg, var(--primary-color)20, var(--secondary-color)20);
      border:1px solid var(--primary-color)50;
      box-shadow:var(--glow);
      color:var(--primary-color);
      transform:translateX(6px);
      box-shadow: 0 4px 20px rgba(var(--primary-color-rgb, 102, 126, 234), 0.3);
    }
    .menu .item.active::before{content:''; position:absolute; left:0; top:0; bottom:0; width:4px; 
      background:linear-gradient(180deg, var(--primary-color), var(--secondary-color));}
    .icon{width:20px;height:20px;opacity:.8; transition:all 0.2s ease; position:relative; z-index:1;}
    .menu .item:hover .icon, .menu .item.active .icon{opacity:1; transform:scale(1.1);}
    .menu .item span{
      position:relative;
      z-index:1;
      font-family: "Orbitron", var(--custom-brand-font, 'Inter'), sans-serif;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    main{padding:120px 40px 40px;}
    h1{
      margin:0 0 24px;
      font-size:32px;
      font-weight:700;
      color:var(--text);
      font-family: "Orbitron", var(--custom-brand-font, 'Inter'), sans-serif;
      letter-spacing: 1.2px;
      background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow: 0 0 30px rgba(var(--primary-color-rgb, 102, 126, 234), 0.3);
      animation: titleGlow 4s ease-in-out infinite;
    }

    @keyframes titleGlow {
      0%, 100% {
        filter: brightness(1);
        text-shadow: 0 0 30px rgba(var(--primary-color-rgb, 102, 126, 234), 0.3);
      }
      50% {
        filter: brightness(1.15);
        text-shadow: 0 0 40px rgba(var(--primary-color-rgb, 102, 126, 234), 0.5);
      }
    }

    .btn{
      padding:12px 20px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--glass);
      color:var(--text);
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:var(--shadow);
      font-weight:500;
      font-size:14px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s ease;
      z-index: 0;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover{
      box-shadow:var(--glow);
      transform:translateY(-3px);
      border-color:var(--primary-color);
      background: linear-gradient(135deg, var(--primary-color)10, var(--secondary-color)10);
    }
    .btn-primary{padding:12px 24px; border-radius:12px; border:none; cursor:pointer;
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)); 
      color:white; box-shadow:var(--shadow); font-weight:600; transition:all 0.3s ease;}
    .btn-primary:hover{transform:translateY(-2px); box-shadow:var(--glow), var(--shadow);}

    .card{background:var(--glass); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:24px; backdrop-filter: blur(20px); min-width:0; position:relative;
      transition:all 0.3s ease;}
    .card:hover{transform:translateY(-4px); box-shadow:var(--glow), var(--shadow);}
    .label{color:var(--muted); font-size:12px}
    .value{font-size:32px; font-weight:800; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip:text; background-clip:text; color:transparent;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .split{display:grid; grid-template-columns:2fr 1fr; gap:14px}
    /* ======== RESPONSIVIDADE COMPLETA ======== */
    
    /* Menu hamb√∫rguer para mobile */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10002;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 12px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      pointer-events: auto;
      touch-action: manipulation;
    }
    
    .mobile-menu-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
    }
    
    .mobile-menu-toggle svg {
      width: 24px;
      height: 24px;
      color: white;
      stroke-width: 2;
    }
    
    /* Overlay para mobile - SEM BLUR */
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .mobile-overlay.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Tablets landscape (1024px - 1180px) */
    @media (max-width: 1180px) {
      .app { grid-template-columns: 240px 1fr; }
      .brand { width: 240px; }
      header { left: 240px; }
      .split { grid-template-columns: 1fr; }
      main { padding: 100px 30px 30px; }
    }
    
    /* Tablets portrait (768px - 1023px) */
    @media (max-width: 1023px) {
      .app { grid-template-columns: 200px 1fr; }
      .brand { width: 200px; padding: 0 16px; }
      .brand .name { font-size: 16px; }
      header { left: 200px; padding: 0 20px; }
      main { padding: 100px 20px 20px; }
      
      .card { padding: 20px; }
      .value { font-size: 28px; }
      
      /* Ajuste da esfera 3D */
      .orbion-system {
        width: 250px;
        height: 250px;
      }
      
      .orbion-text {
        font-size: 20px;
      }
    }
    
    /* ============= MOBILE RESPONSIVE (767px) ============= */
    @media (max-width: 767px) {
      /* Layout principal */
      .app { 
        grid-template-columns: 1fr;
        min-height: 100vh;
      }
      
      /* Mostrar bot√£o hamb√∫rguer */
      .mobile-menu-toggle {
        display: flex !important;
      }
      
      /* Header mobile responsivo */
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 0 20px 0 80px;
        height: 80px;
        z-index: 100;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      header .row {
        flex-direction: row;
        gap: 8px;
        align-items: center;
        margin: 0;
      }
      
      header .btn {
        padding: 8px 16px;
        font-size: 14px;
        min-height: 36px;
        border-radius: 8px;
        white-space: nowrap;
      }
      
      /* Main content */
      main {
        padding: 100px 20px 40px;
      }
      
      /* ===== SIDEBAR MOBILE ===== */
      aside {
        position: fixed;
        left: -320px;
        top: 0;
        width: 320px;
        height: 100vh;
        background: var(--bg);
        border-right: 1px solid var(--border);
        z-index: 10000;
        transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding-top: 80px;
        box-shadow: 4px 0 25px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        overflow-x: hidden;
        pointer-events: auto;
      }
      
      aside.mobile-open {
        left: 0;
        pointer-events: auto;
      }
      
      /* ===== BRAND MOBILE ===== */
      .brand {
        position: fixed;
        left: -320px;
        top: 0;
        width: 320px;
        height: 80px;
        z-index: 10001;
        transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--bg);
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 24px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      }
      
      .brand.mobile-open {
        left: 0;
      }
      
      .brand .name {
        color: var(--text);
        font-weight: 700;
        font-size: 20px;
        letter-spacing: 1px;
      }
      
      /* ===== MENU ITEMS ===== */
      .menu {
        padding: 24px 20px;
        display: block;
        pointer-events: auto;
        position: relative;
        z-index: 10;
      }
      
      .menu .item {
        display: flex !important;
        align-items: center;
        gap: 16px;
        padding: 18px 20px;
        margin: 0 0 16px 0;
        background: var(--glass);
        color: var(--text);
        border-radius: 16px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 60px;
        font-weight: 500;
        font-size: 16px;
        position: relative;
        overflow: hidden;
        pointer-events: auto;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      .menu .item:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
      }
      
      .menu .item:hover:before {
        left: 100%;
      }
      
      .menu .item:hover,
      .menu .item:active {
        background: var(--primary-color)10;
        border-color: var(--primary-color)30;
        transform: translateX(4px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      .menu .item.active {
        background: var(--primary-color)20;
        border-color: var(--primary-color)50;
        color: var(--primary-color);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }
      
      .menu .item.active::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--primary-color);
        border-radius: 0 4px 4px 0;
      }
      
      .menu .item .icon {
        width: 24px;
        height: 24px;
        color: var(--text);
        opacity: 0.8;
        flex-shrink: 0;
        transition: all 0.3s ease;
        pointer-events: none;
      }
      
      .menu .item:hover .icon,
      .menu .item.active .icon {
        opacity: 1;
        transform: scale(1.1);
        color: var(--primary-color);
      }
      
      .menu .item span {
        color: var(--text);
        font-weight: 500;
        font-size: 16px;
        flex: 1;
        opacity: 0.9;
        transition: all 0.3s ease;
        pointer-events: none;
      }
      
      .menu .item:hover span,
      .menu .item.active span {
        opacity: 1;
        font-weight: 600;
        color: var(--primary-color);
      }
      
      /* GARANTIR CLICABILIDADE */
      .menu .item {
        position: relative;
        z-index: 10;
        cursor: pointer !important;
      }
      
      /* ===== AJUSTES RESPONSIVOS EXTRAS ===== */
      
      /* Chat responsivo */
      .chat-page {
        flex-direction: column;
        gap: 20px;
      }
      
      .chat-visual {
        height: 250px;
        order: -1;
      }
      
      .orbion-system {
        width: 200px;
        height: 200px;
      }
      
      .chat-container {
        max-height: 300px;
        min-height: 250px;
      }
      
      .chat-messages {
        max-height: 200px;
      }
      
      .chat-input-row {
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
      }
      
      .chat-input-row .btn-primary {
        width: 100%;
        padding: 16px;
        font-size: 16px;
      }
      
      /* Cards responsivos */
      .split {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .row {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .card {
        padding: 20px;
        border-radius: 16px;
      }
      
      .value {
        font-size: 28px;
      }
      
      /* Bot√µes touch-friendly */
      .btn, .btn-primary {
        min-height: 48px;
        padding: 14px 20px;
        font-size: 16px;
        border-radius: 12px;
      }
      
      /* Inputs touch-friendly */
      .input, select, textarea {
        min-height: 48px;
        padding: 14px 16px;
        font-size: 16px; /* Evita zoom no iOS */
        border-radius: 12px;
      }
      
      /* Tabelas com scroll horizontal */
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -20px;
        padding: 0 20px;
      }
      
      table {
        min-width: 600px;
      }
      
      /* T√≠tulos menores */
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      /* Performance - simplificar anima√ß√µes */
      .orbital-ring {
        display: none;
      }
      
      .sphere-particle {
        width: 2px;
        height: 2px;
      }
      
      /* Cards em coluna √∫nica */
      .split {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      /* Tabelas responsivas */
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      table {
        min-width: 500px;
      }
      
      /* Ajuste da esfera 3D */
      .chat-visual {
        height: 300px;
      }
      
      .orbion-system {
        width: 200px;
        height: 200px;
      }
      
      .orbion-text {
        font-size: 16px;
        letter-spacing: 2px;
      }
      
      .sphere-particle {
        width: 2px;
        height: 2px;
      }
      
      /* Simplificar anima√ß√µes para performance */
      .orbital-ring {
        display: none;
      }
      
      /* Ajuste de formul√°rios */
      .chat-input-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .chat-input-row .btn-primary {
        width: 100%;
      }
      
      /* Cards menores */
      .card {
        padding: 16px;
      }
      
      .value {
        font-size: 24px;
      }
      
      h1 {
        font-size: 24px;
      }
    }
    
    /* Mobile portrait (at√© 575px) */
    @media (max-width: 575px) {
      /* Ajustar bot√£o hamb√∫rguer */
      .mobile-menu-toggle {
        top: 15px;
        left: 15px;
        width: 45px;
        height: 45px;
      }
      
      header {
        padding: 0 15px 0 75px;
        height: 70px;
      }
      
      main {
        padding: 90px 15px 15px;
      }
      
      /* Sidebar menor */
      aside {
        width: 280px;
        left: -280px;
        padding-top: 70px;
      }
      
      .brand {
        width: 280px;
        left: -280px;
        height: 70px;
      }
      
      /* Menu items mais compactos */
      .menu {
        padding: 20px 16px;
      }
      
      .menu .item {
        padding: 14px 16px;
        min-height: 50px;
        font-size: 15px;
        margin: 0 0 12px 0;
      }
      
      .menu .item .icon {
        width: 20px;
        height: 20px;
      }
      
      .card {
        padding: 12px;
        border-radius: 8px;
      }
      
      .value {
        font-size: 20px;
      }
      
      .label {
        font-size: 11px;
      }
      
      h1 {
        font-size: 20px;
        margin-bottom: 16px;
      }
      
      /* Bot√µes ocupam largura total */
      .btn, .btn-primary {
        width: 100%;
        padding: 14px 20px;
        font-size: 14px;
      }
      
      /* Input e select maiores para toque */
      .input, select, textarea {
        padding: 14px 16px;
        font-size: 16px; /* Evita zoom no iOS */
      }
      
      /* Esfera ainda menor */
      .chat-visual {
        height: 250px;
      }
      
      .orbion-system {
        width: 150px;
        height: 150px;
      }
      
      .orbion-text {
        font-size: 14px;
        letter-spacing: 1px;
      }
      
      /* Ocultar part√≠culas extras para performance */
      .sphere-particle:nth-child(n+20) {
        display: none;
      }
      
      /* Menu items maiores para toque */
      .menu .item {
        padding: 18px 20px;
        font-size: 15px;
      }
      
      /* Tabelas em cards */
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 6px;
      }
      
      /* Dashboard cards em grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }
    
    /* Mobile muito pequeno (at√© 380px) */
    @media (max-width: 380px) {
      .orbion-system {
        width: 120px;
        height: 120px;
      }
      
      .orbion-text {
        font-size: 12px;
      }
      
      .value {
        font-size: 18px;
      }
      
      h1 {
        font-size: 18px;
      }
    }
    
    /* Orienta√ß√£o landscape em mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      header {
        height: 50px;
      }
      
      main {
        padding-top: 60px;
      }
      
      .chat-visual {
        height: 200px;
      }
      
      .orbion-system {
        width: 100px;
        height: 100px;
      }
    }
    
    /* Dark mode autom√°tico */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-0: #0f172a;
        --bg-1: #1e293b;
        --glass: rgba(15, 23, 42, 0.8);
        --border: #334155;
        --text: #f1f5f9;
        --muted: #94a3b8;
      }
    }
    
    /* Touch-friendly para dispositivos m√≥veis */
    @media (hover: none) and (pointer: coarse) {
      .menu .item:hover {
        transform: none;
      }
      
      .card:hover {
        transform: none;
      }
      
      .btn:hover, .btn-primary:hover {
        transform: none;
      }
      
      /* Aumentar √°rea de toque */
      .menu .item {
        min-height: 48px;
      }
      
      button, .btn, .btn-primary {
        min-height: 44px;
      }
      
      input, select, textarea {
        min-height: 44px;
      }
    }
    
    /* Print styles */
    @media print {
      .mobile-menu-toggle,
      aside,
      header {
        display: none !important;
      }
      
      main {
        padding: 0;
      }
      
      .app {
        display: block;
      }
      
      .card {
        page-break-inside: avoid;
        border: 1px solid #ddd;
        box-shadow: none;
      }
    }

    .tab{display:none} .tab.active{display:block}

    .input, select, textarea{
      width:100%; background:var(--glass); color:var(--text); border:1px solid var(--border); 
      padding:12px 16px; border-radius:12px; ; transition:all 0.3s ease;
      font-size:14px; font-weight:400;
    }
    .input:focus, select:focus, textarea:focus{
      outline:none; border-color:var(--primary-color); box-shadow:var(--glow);
    }

    /* ======= Calend√°rio Profissional ======= */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 24px 32px;
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.08));
      border: 1px solid var(--primary-color);
      border-radius: 20px;
      box-shadow: var(--shadow), 0 0 30px rgba(102, 126, 234, 0.15);
      position: relative;
      overflow: hidden;
    }

    .calendar-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
    }

    .calendar-controls {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .view-toggles {
      display: flex;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 4px;
    }

    .view-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--muted);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-btn.active {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .view-btn:hover:not(.active) {
      background: var(--border);
      color: var(--text);
    }

    .view-btn .icon {
      width: 14px;
      height: 14px;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(255,255,255,0.05);
      padding: 12px 20px;
      border-radius: 15px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border: 1px solid rgba(102, 126, 234, 0.3);
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.1));
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text);
      font-weight: 700;
      font-size: 18px;
      position: relative;
      overflow: hidden;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.6s;
    }

    .nav-btn:hover::before {
      left: 100%;
    }

    .nav-btn:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-color: var(--primary-color);
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--glow), 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .nav-btn.today-btn {
      width: auto;
      padding: 0 12px;
      font-size: 13px;
      font-weight: 500;
    }

    .nav-btn .icon {
      width: 16px;
      height: 16px;
    }

    .calendar-actions {
      display: flex;
      gap: 16px;
    }

    .calendar-actions .btn {
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Orbitron', sans-serif;
    }

    .calendar-actions .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }

    .calendar-actions .btn:hover::before {
      left: 100%;
    }

    .calendar-actions .btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    #calendar-today {
      background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
    }

    #btn-new-event {
      background: linear-gradient(135deg, #00c851, #28a745);
    }

    .calendar-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      min-height: 600px;
    }

    /* Sidebar */
    .calendar-sidebar {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .mini-calendar {
      padding: 24px;
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.05));
      border: 1px solid var(--primary-color);
      border-radius: 20px;
      box-shadow: var(--shadow), 0 0 20px rgba(102, 126, 234, 0.1);
      position: relative;
      overflow: hidden;
    }

    .mini-calendar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .mini-calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .mini-calendar-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .mini-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border: none;
      background: var(--glass);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--muted);
    }

    .mini-nav-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .mini-nav-btn .icon {
      width: 12px;
      height: 12px;
    }

    .mini-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .mini-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    .mini-day:hover {
      background: var(--border);
    }

    .mini-day.today {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .mini-day.selected {
      background: var(--secondary-color);
      color: white;
    }

    .mini-day.other-month {
      color: var(--muted);
      opacity: 0.5;
    }

    .mini-day.has-events {
      position: relative;
    }

    .mini-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: var(--secondary-color);
      border-radius: 50%;
    }

    /* Lista de eventos do dia */
    .day-events {
      padding: 20px;
    }

    .day-events h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .events-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .event-item {
      padding: 12px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .event-time-small {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .event-title-small {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }

    .no-events {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px;
      color: var(--muted);
      font-size: 13px;
    }

    .no-events .icon {
      width: 24px;
      height: 24px;
      opacity: 0.5;
    }

    /* A√ß√µes r√°pidas */
    .quick-actions {
      padding: 20px;
    }

    .quick-actions h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .quick-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 8px;
      border: 1px solid var(--border);
      background: var(--glass);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      font-weight: 500;
      color: var(--text);
    }

    .quick-action-btn:hover {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }

    .quick-action-btn .icon {
      width: 16px;
      height: 16px;
    }

    /* ===== CALENDAR PROFESSIONAL STYLES ===== */

    .calendar-professional-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 700px;
      gap: 24px;
    }

    .calendar-professional-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.08));
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .calendar-title-section {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .calendar-title-section h2 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: var(--text);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .calendar-navigation {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .calendar-nav-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-nav-btn:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-1px);
    }

    .calendar-today-btn {
      padding: 8px 16px;
      border: 1px solid var(--primary-color);
      background: transparent;
      color: var(--primary-color);
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calendar-today-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .calendar-actions-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .calendar-view-switcher {
      display: flex;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 4px;
    }

    .view-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--muted);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .view-btn.active,
    .view-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .calendar-primary-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .calendar-primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
    }

    .calendar-professional-content {
      display: flex;
      gap: 24px;
      flex: 1;
    }

    .calendar-grid-container {
      flex: 1;
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.05));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .calendar-view-pro {
      display: none;
    }

    .calendar-view-pro.active {
      display: block;
    }

    .calendar-weekdays-pro {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      margin-bottom: 1px;
    }

    .weekday-header {
      padding: 16px 8px;
      text-align: center;
      font-weight: 600;
      color: var(--muted);
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px 8px 0 0;
      font-size: 14px;
    }

    .calendar-days-pro {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: rgba(0,0,0,0.1);
      border-radius: 0 0 8px 8px;
    }

    .calendar-day-pro {
      min-height: 120px;
      padding: 8px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .calendar-day-pro:hover {
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--primary-color);
    }

    .calendar-day-pro.today {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .calendar-day-pro.other-month {
      opacity: 0.3;
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .day-events {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .day-event {
      padding: 2px 6px;
      background: var(--primary-color);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    /* Week View Styles */
    .week-time-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 1px;
      height: 600px;
      overflow-y: auto;
    }

    .week-hours {
      display: flex;
      flex-direction: column;
    }

    .hour-slot {
      height: 60px;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: flex-start;
    }

    .week-days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
    }

    .week-day-column {
      border-left: 1px solid rgba(255,255,255,0.1);
      position: relative;
    }

    .week-day-header {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      background: rgba(102, 126, 234, 0.1);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Agenda View Styles */
    .agenda-container {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .agenda-section h3 {
      margin: 0 0 16px 0;
      color: var(--text);
      font-weight: 600;
    }

    .agenda-events-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .agenda-event {
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .agenda-event:hover {
      border-color: var(--primary-color);
      background: rgba(102, 126, 234, 0.1);
    }

    .agenda-event-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .agenda-event-time {
      font-size: 12px;
      color: var(--muted);
    }

    /* Professional Sidebar Styles */
    .calendar-professional-sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .mini-calendar-pro {
      padding: 20px;
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.05));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .mini-calendar-header-pro {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .mini-calendar-header-pro h4 {
      margin: 0;
      color: var(--text);
      font-weight: 600;
    }

    .mini-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mini-nav-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .mini-calendar-grid-pro {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .mini-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mini-day:hover {
      background: rgba(102, 126, 234, 0.2);
    }

    .mini-day.today {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .mini-day.selected {
      background: var(--secondary-color);
      color: white;
    }

    .event-details-panel,
    .calendar-quick-stats,
    .calendar-filters {
      padding: 20px;
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.05));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .event-details-panel h4,
    .calendar-quick-stats h4,
    .calendar-filters h4 {
      margin: 0 0 16px 0;
      color: var(--text);
      font-weight: 600;
      font-size: 16px;
    }

    .event-details-content {
      min-height: 120px;
    }

    .no-event-selected {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 120px;
      color: var(--muted);
    }

    .no-event-selected svg {
      margin-bottom: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      display: block;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .filter-checkbox:hover {
      background: rgba(255,255,255,0.05);
    }

    .filter-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color);
    }

    .filter-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 4px;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .calendar-professional-sidebar {
        width: 280px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 968px) {
      .calendar-professional-content {
        flex-direction: column;
      }

      .calendar-professional-sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        gap: 16px;
      }

      .calendar-professional-sidebar > div {
        min-width: 280px;
      }

      .calendar-professional-header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }

      .calendar-title-section {
        justify-content: center;
      }

      .calendar-actions-section {
        justify-content: center;
      }
    }

    @media (max-width: 600px) {
      .calendar-professional-header {
        padding: 16px;
      }

      .calendar-grid-container {
        padding: 16px;
      }

      .calendar-title-section h2 {
        font-size: 24px;
      }

      .calendar-day-pro {
        min-height: 80px;
      }

      .calendar-professional-sidebar {
        flex-direction: column;
      }

      .calendar-professional-sidebar > div {
        min-width: auto;
      }
    }

    /* Calend√°rio principal (legado - manter compatibilidade) */
    .calendar-main {
      display: flex;
      flex-direction: column;
    }

    .calendar-view {
      flex: 1;
      padding: 24px;
      min-height: 600px;
    }

    .calendar-main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .calendar-main-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .calendar-legend {
      display: flex;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    /* Vista mensal */
    .calendar-view-content {
      display: none;
    }

    .calendar-view-content.active {
      display: block;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      margin-bottom: 8px;
    }

    .weekday {
      padding: 12px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-day {
      position: relative;
      min-height: 90px;
      padding: 12px;
      background: var(--glass);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
      overflow: hidden;
    }

    .calendar-day::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent, rgba(102, 126, 234, 0.05));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .calendar-day:hover::before {
      opacity: 1;
    }

    .calendar-day:hover {
      background: rgba(102, 126, 234, 0.08);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
      border-color: rgba(102, 126, 234, 0.3);
    }

    .calendar-day.today {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.1));
      border: 2px solid var(--primary-color);
      box-shadow: inset 0 0 20px rgba(102, 126, 234, 0.2);
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, rgba(118, 75, 162, 0.15), rgba(102, 126, 234, 0.1));
      border: 2px solid var(--secondary-color);
      box-shadow: 0 0 20px rgba(118, 75, 162, 0.3);
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .day-number {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .calendar-day.today .day-number {
      color: var(--primary-color);
    }

    .day-events-mini {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .event-mini {
      padding: 2px 6px;
      background: var(--primary-color);
      color: white;
      font-size: 10px;
      border-radius: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-mini.event-type-event {
      background: var(--secondary-color);
    }

    .event-mini.event-type-reminder {
      background: var(--warn);
    }

    /* Vista semanal */
    .week-header {
      display: grid;
      grid-template-columns: 60px 1fr;
      gap: 1px;
      margin-bottom: 8px;
    }

    .week-time-column {
      background: var(--glass);
    }

    .week-days-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
    }

    .week-day-header {
      padding: 12px;
      text-align: center;
      background: var(--glass);
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .week-day-header.today {
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
    }

    .week-body {
      display: grid;
      grid-template-columns: 60px 1fr;
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      max-height: 500px;
      overflow-y: auto;
    }

    .week-time-slots {
      display: flex;
      flex-direction: column;
    }

    .time-slot {
      height: 60px;
      padding: 8px;
      background: var(--glass);
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: flex-start;
    }

    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
    }

    .week-day-column {
      position: relative;
      background: var(--glass);
    }

    .week-hour-slot {
      height: 60px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .week-event {
      position: absolute;
      left: 2px;
      right: 2px;
      padding: 4px 8px;
      background: var(--primary-color);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 2;
    }

    .week-event:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .week-event.event-type-event {
      background: var(--secondary-color);
    }

    .week-event.event-type-reminder {
      background: var(--warn);
    }

    /* Vista di√°ria */
    .day-header h3 {
      margin: 0 0 20px;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .day-timeline {
      display: grid;
      grid-template-columns: 60px 1fr;
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Modal de evento */
    .event-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: none;
    }

    .event-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 20px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .modal-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: var(--glass);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--muted);
    }

    .modal-close:hover {
      background: var(--err);
      color: white;
    }

    .modal-close .icon {
      width: 16px;
      height: 16px;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      background: var(--glass);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-feedback {
      margin: 16px 0;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }

    .form-feedback.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--ok);
      border: 1px solid rgba(16, 185, 129, 0.2);
      display: block;
    }

    .form-feedback.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--err);
      border: 1px solid rgba(239, 68, 68, 0.2);
      display: block;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    /* Responsividade */
    @media (max-width: 1200px) {
      .calendar-container {
        grid-template-columns: 280px 1fr;
      }
    }

    @media (max-width: 967px) {
      .calendar-container {
        grid-template-columns: 1fr;
      }

      .calendar-sidebar {
        order: 2;
        flex-direction: row;
        overflow-x: auto;
      }

      .calendar-main {
        order: 1;
      }
    }

    @media (max-width: 767px) {
      .calendar-header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }

      .calendar-controls {
        flex-direction: column;
        gap: 12px;
      }

      .view-toggles {
        align-self: stretch;
      }

      .view-btn {
        flex: 1;
        justify-content: center;
      }

      .calendar-nav {
        justify-content: center;
      }

      .calendar-actions {
        flex-direction: column;
      }

      .calendar-container {
        gap: 16px;
      }

      .calendar-sidebar {
        flex-direction: column;
      }

      .quick-actions-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .modal-content {
        margin: 10px;
      }

      .calendar-days {
        gap: 0;
      }

      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }

      .day-number {
        font-size: 12px;
      }

      .event-mini {
        font-size: 9px;
        padding: 1px 4px;
      }
    }

    /* ======= Chat (mantido) ======= */
    .chat-page{display:grid; grid-template-columns:1.2fr 2fr; align-items:center; gap:24px; margin-top:20px;}
    @media (max-width: 767px) {
      .chat-page { grid-template-columns: 1fr; gap: 15px; }
    }
    .chat-visual{
      height:280px; display:flex; align-items:center; justify-content:center;
      background:transparent; border:none; box-shadow:none;
    }
    @media (max-width: 767px) {
      .chat-visual { height: 200px; }
    }
    /* Esfera 3D ORBION - Vers√£o Avan√ßada com Part√≠culas */
    .sphere-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      perspective: 1000px;
      overflow: hidden;
      position: relative;
      background: 
        radial-gradient(ellipse at center, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        transparent;
    }

    /* Sistema rotativo principal */
    .orbion-system {
      position: relative;
      width: 300px;
      height: 300px;
      transform-style: preserve-3d;
      animation: rotateSystem 50s linear infinite;
    }

    /* Esfera de part√≠culas */
    .particle-sphere {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      animation: sphereRotate 30s linear infinite;
    }

    /* Part√≠culas da esfera */
    .sphere-particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: rgba(102, 126, 234, 0.8);
      border-radius: 50%;
      box-shadow: 
        0 0 10px rgba(102, 126, 234, 0.6),
        0 0 20px rgba(102, 126, 234, 0.4);
      top: 50%;
      left: 50%;
    }

    /* ORBION no centro */
    .orbion-core {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1000;
    }

    .orbion-text {
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 4px;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color), var(--primary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
      animation: textGlow 3s ease-in-out infinite;
      font-family: 'Orbitron', monospace;
    }

    /* An√©is orbitais avan√ßados */
    .orbital-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 50%;
      transform-style: preserve-3d;
    }

    .ring-horizontal {
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%) rotateX(90deg);
      animation: ringRotate1 40s linear infinite;
    }

    .ring-vertical {
      width: 220px;
      height: 220px;
      transform: translate(-50%, -50%) rotateY(90deg);
      animation: ringRotate2 45s linear infinite reverse;
      border-color: rgba(118, 75, 162, 0.2);
    }

    .ring-diagonal {
      width: 240px;
      height: 240px;
      transform: translate(-50%, -50%) rotateX(45deg) rotateY(45deg);
      animation: ringRotate3 50s linear infinite;
      border-color: rgba(79, 172, 254, 0.2);
    }

    /* Core central tecnol√≥gico */
    .tech-core {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80px;
      height: 80px;
      margin: -40px 0 0 -40px;
      background: radial-gradient(circle, var(--primary-color), transparent);
      border-radius: 50%;
      box-shadow: 
        0 0 20px var(--primary-color),
        0 0 40px var(--primary-color),
        0 0 60px var(--primary-color);
      animation: coreEnergy 4s ease-in-out infinite;
      z-index: 5;
    }

    .tech-core::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      margin: -30px 0 0 -30px;
      border: 2px solid var(--accent-color);
      border-radius: 50%;
      animation: coreRing 2s linear infinite;
    }

    .tech-core::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      margin: -20px 0 0 -20px;
      background: var(--primary-color);
      border-radius: 50%;
      box-shadow: inset 0 0 10px rgba(255,255,255,0.5);
    }

    /* Linhas de conex√£o tecnol√≥gicas */
    .tech-lines {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .tech-line {
      position: absolute;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
      opacity: 0.3;
      animation: lineFlow 8s linear infinite;
    }

    .tech-line:nth-child(1) {
      width: 300px;
      top: 20%;
      left: 10%;
      animation-delay: 0s;
    }

    .tech-line:nth-child(2) {
      width: 250px;
      top: 80%;
      right: 10%;
      animation-delay: -2s;
    }

    .tech-line:nth-child(3) {
      width: 200px;
      top: 50%;
      left: 5%;
      animation-delay: -4s;
    }

    .particle:nth-child(1) { transform: rotateY(0deg) translateZ(100px); }
    .particle:nth-child(2) { transform: rotateY(18deg) translateZ(100px); }
    .particle:nth-child(3) { transform: rotateY(36deg) translateZ(100px); }
    .particle:nth-child(4) { transform: rotateY(54deg) translateZ(100px); }
    .particle:nth-child(5) { transform: rotateY(72deg) translateZ(100px); }
    .particle:nth-child(6) { transform: rotateY(90deg) translateZ(100px); }
    .particle:nth-child(7) { transform: rotateY(108deg) translateZ(100px); }
    .particle:nth-child(8) { transform: rotateY(126deg) translateZ(100px); }
    .particle:nth-child(9) { transform: rotateY(144deg) translateZ(100px); }
    .particle:nth-child(10) { transform: rotateY(162deg) translateZ(100px); }
    .particle:nth-child(11) { transform: rotateY(180deg) translateZ(100px); }
    .particle:nth-child(12) { transform: rotateY(198deg) translateZ(100px); }
    .particle:nth-child(13) { transform: rotateY(216deg) translateZ(100px); }
    .particle:nth-child(14) { transform: rotateY(234deg) translateZ(100px); }
    .particle:nth-child(15) { transform: rotateY(252deg) translateZ(100px); }
    .particle:nth-child(16) { transform: rotateY(270deg) translateZ(100px); }
    .particle:nth-child(17) { transform: rotateY(288deg) translateZ(100px); }
    .particle:nth-child(18) { transform: rotateY(306deg) translateZ(100px); }
    .particle:nth-child(19) { transform: rotateY(324deg) translateZ(100px); }
    .particle:nth-child(20) { transform: rotateY(342deg) translateZ(100px); }

    .particle:nth-child(21) { transform: rotateY(0deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(22) { transform: rotateY(36deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(23) { transform: rotateY(72deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(24) { transform: rotateY(108deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(25) { transform: rotateY(144deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(26) { transform: rotateY(180deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(27) { transform: rotateY(216deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(28) { transform: rotateY(252deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(29) { transform: rotateY(288deg) rotateX(30deg) translateZ(100px); }
    .particle:nth-child(30) { transform: rotateY(324deg) rotateX(30deg) translateZ(100px); }

    .particle:nth-child(31) { transform: rotateY(0deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(32) { transform: rotateY(36deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(33) { transform: rotateY(72deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(34) { transform: rotateY(108deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(35) { transform: rotateY(144deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(36) { transform: rotateY(180deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(37) { transform: rotateY(216deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(38) { transform: rotateY(252deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(39) { transform: rotateY(288deg) rotateX(-30deg) translateZ(100px); }
    .particle:nth-child(40) { transform: rotateY(324deg) rotateX(-30deg) translateZ(100px); }

    .particle:nth-child(41) { transform: rotateY(0deg) rotateX(60deg) translateZ(100px); }
    .particle:nth-child(42) { transform: rotateY(72deg) rotateX(60deg) translateZ(100px); }
    .particle:nth-child(43) { transform: rotateY(144deg) rotateX(60deg) translateZ(100px); }
    .particle:nth-child(44) { transform: rotateY(216deg) rotateX(60deg) translateZ(100px); }
    .particle:nth-child(45) { transform: rotateY(288deg) rotateX(60deg) translateZ(100px); }

    .particle:nth-child(46) { transform: rotateY(0deg) rotateX(-60deg) translateZ(100px); }
    .particle:nth-child(47) { transform: rotateY(72deg) rotateX(-60deg) translateZ(100px); }
    .particle:nth-child(48) { transform: rotateY(144deg) rotateX(-60deg) translateZ(100px); }
    .particle:nth-child(49) { transform: rotateY(216deg) rotateX(-60deg) translateZ(100px); }
    .particle:nth-child(50) { transform: rotateY(288deg) rotateX(-60deg) translateZ(100px); }

    /* Anima√ß√µes da esfera 3D avan√ßada */
    @keyframes rotateSystem {
      0% { transform: rotateX(-15deg) rotateY(0deg); }
      100% { transform: rotateX(-15deg) rotateY(360deg); }
    }

    @keyframes sphereRotate {
      0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
      100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(0deg); }
    }

    @keyframes textGlow {
      0%, 100% { 
        filter: brightness(1);
        text-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
      }
      50% { 
        filter: brightness(1.3);
        text-shadow: 0 0 40px rgba(102, 126, 234, 1);
      }
    }

    @keyframes ringRotate1 {
      0% { transform: translate(-50%, -50%) rotateX(90deg) rotateZ(0deg); }
      100% { transform: translate(-50%, -50%) rotateX(90deg) rotateZ(360deg); }
    }

    @keyframes ringRotate2 {
      0% { transform: translate(-50%, -50%) rotateY(90deg) rotateZ(0deg); }
      100% { transform: translate(-50%, -50%) rotateY(90deg) rotateZ(360deg); }
    }

    @keyframes ringRotate3 {
      0% { transform: translate(-50%, -50%) rotateX(45deg) rotateY(45deg) rotateZ(0deg); }
      100% { transform: translate(-50%, -50%) rotateX(45deg) rotateY(45deg) rotateZ(360deg); }
    }

    @keyframes particlePulse {
      0%, 100% { 
        opacity: 0.9; 
        transform: scale(1); 
      }
      50% { 
        opacity: 0.6; 
        transform: scale(1.2); 
      }
    }

    @keyframes ringRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes coreEnergy {
      0%, 100% { 
        box-shadow: 
          0 0 20px var(--primary-color),
          0 0 40px var(--primary-color),
          0 0 60px var(--primary-color);
      }
      50% { 
        box-shadow: 
          0 0 30px var(--primary-color),
          0 0 60px var(--primary-color),
          0 0 90px var(--primary-color);
      }
    }

    @keyframes coreRing {
      0% { 
        transform: rotate(0deg) scale(1); 
        opacity: 0.8; 
      }
      100% { 
        transform: rotate(360deg) scale(1.1); 
        opacity: 0.4; 
      }
    }

    @keyframes lineFlow {
      0% { 
        transform: translateX(-100%); 
        opacity: 0; 
      }
      50% { 
        opacity: 0.6; 
      }
      100% { 
        transform: translateX(400px); 
        opacity: 0; 
      }
    }
    .chat-window{min-height:280px; background:rgba(255,255,255,0.95);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px; display:flex; flex-direction:column; backdrop-filter:blur(10px);}
    @media (max-width: 767px) {
      .chat-window { min-height: 240px; max-height: 320px; padding: 12px; }
    }
    .chat-messages{flex:1; overflow-y:auto; margin-bottom:14px; display:flex; flex-direction:column; gap:10px;}
    @media (max-width: 767px) {
      .chat-messages { max-height: 250px; }
    }
    .chat-input-row{display:flex; gap:8px;}
    @media (max-width: 767px) {
      .chat-input-row { flex-wrap: wrap; }
      .chat-input-row input { flex: 1 1 100%; margin-bottom: 10px; }
      .chat-input-row button { flex: 1 1 auto; }
    }
    .chat-message{max-width:75%; padding:8px 12px; border-radius:8px; font-size:14px; word-break:break-word; line-height:1.4; margin-bottom:8px;}
    .chat-message.user{align-self:flex-end; background:var(--primary-color); color:white; box-shadow:var(--shadow);}
    .chat-message.agent{align-self:flex-start; background:var(--bg-1); border:1px solid var(--border); color:var(--text); box-shadow:var(--shadow);}

    /* ======= Leads (mantido) ======= */
    .status-badge{display:inline-block;padding:2px 6px;border-radius:8px;font-size:10px;text-transform:capitalize;}
    .status-ativo{background:var(--ok);color:#031018;}
    .status-novo{background:var(--violet);color:#031018;}
    .status-cancelado{background:var(--err);color:#031018;}
    .status-standby{background:var(--warn);color:#031018;}
    .status-outro{background:var(--muted);color:#031018;}
    .leads-table{width:100%;border-collapse:collapse;}
    .leads-table th,.leads-table td{padding:6px 8px;font-size:12px;border-bottom:1px solid rgba(255,255,255,.06);}
    .leads-table th{background:rgba(10,18,34,.85);position:sticky;top:0;text-align:left;}

    /* Estilo para mapa de calor dos leads */
    #leads-map{
      height:420px;
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 0 14px rgba(24,197,255,.35), inset 0 0 8px rgba(24,197,255,.25);
      overflow:hidden;
    }

    /* ====== Funil de Leads ====== */
    /* O funil √© composto por segmentos horizontais que diminuem de largura
       progressivamente, simulando um funil de vendas. Cada segmento tem
       um r√≥tulo clic√°vel e uma cor personalizada que harmoniza com o
       tema neon do dashboard. Os segmentos usam pseudo-elementos para
       criar bordas inclinadas, dispensando qualquer √≠cone central. */
    .funnel-wrapper{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:8px 0;
    }
    .funnel-segment{
      position:relative;
      height:44px;
      cursor:pointer;
      /* A largura ser√° definida inline via style width: calc(var(--ratio) * 100%); */
      border-radius:12px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding-left:14px;
      color:#031018;
      font-weight:600;
      font-size:14px;
      transition:filter .2s;
    }
    .funnel-segment::before,
    .funnel-segment::after{
      content:'';
      position:absolute;
      top:0; bottom:0;
      width:24px;
      pointer-events:none;
    }
    .funnel-segment::before{
      left:-24px;
      transform:skewX(-20deg);
      background:inherit;
    }
    .funnel-segment::after{
      right:-24px;
      transform:skewX(20deg);
      background:inherit;
    }
    .funnel-segment.active{
      box-shadow:0 0 0 2px var(--cyan), 0 0 16px rgba(24,197,255,.5);
      filter:brightness(1.25);
    }
    .funnel-info{
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:linear-gradient(180deg,rgba(13,22,40,.75),rgba(5,12,24,.75));
      box-shadow:0 0 20px rgba(24,197,255,.25);
      display:flex;
      flex-direction:column;
      gap:6px;
      height:100%;
    }
    .funnel-info .stage-title{
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }
    .funnel-info .stage-count{
      font-size:24px;
      font-weight:700;
      background:linear-gradient(90deg,var(--cyan),var(--violet));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    /* ====== Chat flutuante ====== */
    .chat-float{
      position:fixed;
      bottom:24px;
      right:24px;
      width:320px;
      max-height:480px;
      background:linear-gradient(180deg, rgba(13,22,40,.85), rgba(5,12,24,.85));
      border:1px solid rgba(24,197,255,.35);
      border-radius:16px;
      box-shadow:0 0 24px rgba(24,197,255,.35), inset 0 0 6px rgba(124,92,255,.25);
      display:flex;
      flex-direction:column;
      z-index:9999;
      overflow:hidden;
      ;
    }
    .chat-float.minimized{
      height:42px;
    }
    .chat-float-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      background:rgba(9,14,24,.8);
      font-weight:600;
      color:var(--text);
      cursor:pointer;
      border-bottom:1px solid rgba(24,197,255,.35);
    }
    .chat-float-header button{
      background:none;
      border:none;
      color:var(--text);
      cursor:pointer;
      font-size:16px;
    }
    .chat-float-messages{
      flex:1;
      padding:10px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chat-float-input-row{
      display:flex;
      gap:6px;
      padding:10px;
    }
    .chat-float-input-row input{
      flex:1;
    }

    /* ======= WhatsApp Tab ======= */
    .whatsapp-page{display:grid; grid-template-columns:1fr; gap:24px; margin-top:20px;}
    .whatsapp-controls{display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;}
    .whatsapp-stats{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin-bottom:20px;}
    .whatsapp-messages{height:400px; overflow-y:auto; background:var(--glass);
      border:1px solid var(--border); border-radius:var(--radius); padding:20px;
      box-shadow:var(--shadow); ;}
    .whatsapp-contacts{display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:14px; margin-top:20px;}
    .whatsapp-contact-card{background:var(--glass); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px; ; transition:.18s;}
    .whatsapp-contact-card:hover{box-shadow:var(--glow);}

    /* ======= Aba Lateral de Leads ======= */
    .leads-sidebar {
      position: fixed;
      top: 0;
      right: -480px; /* Completamente oculta */
      width: 450px;
      height: 100vh;
      background: var(--bg);
      border-left: 2px solid var(--border);
      box-shadow: -12px 0 40px rgba(0, 0, 0, 0.6);
      z-index: 1000;
      transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1); /* Anima√ß√£o mais suave */
      overflow-y: auto;
      transform: translateX(30px); /* Pequeno deslocamento inicial */
      opacity: 0;
    }

    .leads-sidebar.open {
      right: 0;
      transform: translateX(0);
      opacity: 1;
      box-shadow: -12px 0 50px rgba(0, 0, 0, 0.8);
    }

    .leads-sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 32px;
      border-bottom: 2px solid var(--border);
      background: var(--glass);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .leads-sidebar-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      color: var(--primary-color);
    }

    .leads-sidebar-title .icon {
      width: 24px;
      height: 24px;
      stroke-width: 2;
    }

    .leads-sidebar-title h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.5px;
    }

    .close-btn {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text);
    }

    .close-btn:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(var(--accent-color-rgb), 0.3);
    }

    .close-btn svg {
      width: 20px;
      height: 20px;
    }

    .leads-sidebar-content {
      padding: 32px;
    }

    .leads-section {
      margin-bottom: 32px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      font-size: 14px;
      color: var(--primary-color);
      margin-bottom: 20px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 500;
      font-size: 13px;
      color: var(--text);
      letter-spacing: 0.3px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
    }

    .form-input::placeholder {
      color: var(--muted);
    }

    .action-buttons {
      display: grid;
      gap: 12px;
    }

    .action-buttons .btn,
    .action-buttons .btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px 16px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      letter-spacing: 0.3px;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-buttons .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      color: white;
      box-shadow: 0 4px 16px rgba(var(--primary-color-rgb), 0.3);
    }

    .action-buttons .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(var(--primary-color-rgb), 0.4);
    }

    .action-buttons .btn {
      background: var(--glass);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .action-buttons .btn:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(var(--accent-color-rgb), 0.3);
    }

    .action-buttons .icon {
      width: 16px;
      height: 16px;
    }

    .leads-feedback {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .leads-feedback.show {
      opacity: 1;
      transform: translateY(0);
    }

    .leads-feedback.success {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: rgb(34, 197, 94);
    }

    .leads-feedback.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: rgb(239, 68, 68);
    }

    .leads-sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .leads-sidebar-overlay.active {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      opacity: 1;
      visibility: visible;
    }

    /* Mobile Responsivo */
    @media (max-width: 768px) {
      .leads-sidebar {
        width: 100%;
        right: -100%;
      }

      .leads-sidebar-content {
        padding: 20px;
      }

      .leads-section {
        padding: 16px;
      }
    }
    .status-connected{background:var(--ok); color:white;}
    .status-disconnected{background:var(--err); color:white;}
    
    /* ======= Customiza√ß√£o Tab ======= */
    .theme-card:hover{border-color:var(--primary-color); transform:translateY(-2px);}
    .theme-card.active{border-color:var(--primary-color); box-shadow:var(--glow);}
    .logo-preview img{max-width:100%; max-height:100%; object-fit:contain;}
    
    /* ======= ORBION Status ======= */
    @keyframes pulse {
      0% { box-shadow: 0 0 10px var(--ok); }
      50% { box-shadow: 0 0 20px var(--ok), 0 0 30px var(--ok); }
      100% { box-shadow: 0 0 10px var(--ok); }
    }

    /* ======= Mini ORBION Animation (Brand Logo) ======= */
    .mini-particle-sphere {
      transform-style: preserve-3d;
      animation: miniSphereRotate 12s linear infinite;
    }

    @keyframes miniOrbit {
      0% { transform: translate(-50%, -50%) rotateY(0deg) rotateX(0deg) translateZ(30px); }
      100% { transform: translate(-50%, -50%) rotateY(360deg) rotateX(0deg) translateZ(30px); }
    }

    @keyframes miniSphereRotate {
      0% { transform: translate(-50%, -50%) rotateY(0deg) rotateX(15deg); }
      100% { transform: translate(-50%, -50%) rotateY(360deg) rotateX(15deg); }
    }

    @keyframes miniCoreEnergy {
      0%, 100% {
        box-shadow:
          0 0 8px var(--primary-color),
          0 0 15px var(--primary-color);
        transform: scale(1);
      }
      50% {
        box-shadow:
          0 0 12px var(--primary-color),
          0 0 25px var(--primary-color);
        transform: scale(1.2);
      }
    }

    /* Ajustar brand para comportar a mini anima√ß√£o - override das configura√ß√µes padr√£o */
    .brand {
      display: flex !important;
      align-items: center !important;
      gap: 4px !important;
    }

    /* Override para anima√ß√£o do Central Hub - tamanho harmonioso */
    #tab-home .orbion-system {
      width: 280px !important;
      height: 280px !important;
      transform: scale(1.8) translateX(150px) !important;
    }

    /* Container da anima√ß√£o movido para direita */
    #tab-home div[style*="position: relative; width: 600px"] {
      margin-left: 200px !important;
    }

    /* Aba Central Hub com altura adequada */
    #tab-home {
      height: calc(100vh - 80px) !important;
      overflow: auto !important;
      position: relative !important;
    }

    /* Container do Central Hub para centraliza√ß√£o dentro da aba */
    #tab-home > div[style*="display: flex; flex-direction: column"] {
      height: 100% !important;
      min-height: auto !important;
      margin-top: 0 !important;
      padding: 20px !important;
      box-sizing: border-box !important;
      justify-content: center !important;
      align-items: center !important;
      margin-left: 40px !important;
    }

    /* Anima√ß√µes para bot√µes do header - estilo das abas do menu */
    header .btn:hover {
      transform: translateY(-2px) !important;
      border-color: var(--primary-color) !important;
      background: linear-gradient(135deg, var(--primary-color)10, var(--secondary-color)10) !important;
      box-shadow: var(--glow), var(--shadow) !important;
    }

    header .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      transition: left 0.5s;
    }

    header .btn:hover::before {
      left: 100%;
    }

    /* Corrigir alinhamento vertical da mini anima√ß√£o com o texto ORBION */
    .brand > div[style*="position: relative"] {
      display: flex !important;
      align-items: center !important;
      height: auto !important;
      margin: 0 4px 0 0 !important;
    }

    .brand .name {
      line-height: 1 !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Melhor alinhamento dos bot√µes abaixo da anima√ß√£o */
    #tab-home div[style*="display: flex; gap: 24px"] {
      margin-top: 20px !important;
      width: 500px !important;
    }

    /* Responsividade para mini anima√ß√£o */
    @media (max-width: 768px) {
      .mini-orbion-system {
        transform: scale(0.45) !important;
      }
      .brand {
        gap: 6px;
      }
      /* Central Hub responsivo */
      #tab-home .orbion-system {
        width: 300px !important;
        height: 300px !important;
        transform: scale(1.8) !important;
      }
      #tab-home div[style*="width: 600px"] {
        width: 400px !important;
        height: 400px !important;
      }
    }
    .status-card{background:var(--glass); position:relative; overflow:hidden;}
    .status-card::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; 
      background:linear-gradient(90deg, var(--ok), var(--primary-color)); animation:slide 3s linear infinite;}
    @keyframes slide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .log-entry{animation:fadeIn 0.5s ease;}
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }

    /* ===== VOICE ANIMATION FOR ORBION LOGO ===== */
    @keyframes voicePulse {
      0%, 100% {
        transform: scale(1);
        text-shadow: 0 0 10px var(--primary-color);
      }
      25% {
        transform: scale(1.05);
        text-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--secondary-color);
      }
      50% {
        transform: scale(1.08);
        text-shadow: 0 0 25px var(--primary-color), 0 0 35px var(--secondary-color), 0 0 40px var(--accent-color);
      }
      75% {
        transform: scale(1.03);
        text-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--secondary-color);
      }
    }

    @keyframes voiceGlow {
      0%, 100% {
        filter: brightness(1) saturate(1);
      }
      50% {
        filter: brightness(1.2) saturate(1.3);
      }
    }

    /* Classe para ativar anima√ß√£o de voz */
    .speaking-animation {
      animation: voicePulse 0.8s ease-in-out infinite, voiceGlow 1.2s ease-in-out infinite;
      animation-timing-function: cubic-bezier(0.4, 0, 0.6, 1);
    }

    /* Transi√ß√£o suave para entrada/sa√≠da da anima√ß√£o */
    #brand-name {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.6, 1);
    }

    /* Gr√°ficos / Tarefas (mantidos) */
    .grid-charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .grid-charts .card{height:240px; position:relative}
    .donut-chart{position:relative;width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--cyan);mask:radial-gradient(closest-side, transparent 55%, black 56%);-webkit-mask:radial-gradient(closest-side, transparent 55%, black 56%);}
    .donut-chart .donut-value{position:absolute;font-size:28px;font-weight:700;}
    .bar-chart{width:100%;height:100%;display:flex;align-items:flex-end;justify-content:space-around;padding:8px;}
    .bar-chart .bar{flex:1;margin:0 4px;border-radius:6px;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;background:var(--cyan);transition:height .3s;}
    .bar-chart .bar::after{content:attr(data-label);margin-top:6px;font-size:12px;color:var(--muted);display:block;}
    .task-dashboard{display:flex;flex-wrap:wrap;gap:14px;margin-top:14px}
    .task-groups{display:flex;flex:2;gap:14px}
    .task-group{flex:1;background:linear-gradient(180deg,rgba(20,34,64,.68),rgba(10,20,40,.68));border:1px solid rgba(255,255,255,.05);border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;min-height:280px;box-shadow:0 0 12px rgba(0,0,0,.35)}
    .task-group h3{margin:0 0 8px;font-size:16px;font-weight:600}
    .task-items{flex:1;display:flex;flex-direction:column;gap:6px;overflow-y:auto;scrollbar-width:none}
    .task-items::-webkit-scrollbar{display:none}
    .task-item-card{position:relative;padding:16px 18px;background:linear-gradient(130deg,rgba(32,54,104,.9),rgba(18,30,70,.9));border-radius:14px;display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:.25s;min-height:80px;width:100%; border:1px solid rgba(24,197,255,.3); box-shadow:0 0 12px rgba(24,197,255,.12), inset 0 0 8px rgba(124,92,255,.2);}
    .task-item-card:hover{transform:translateY(-2px); box-shadow:0 0 14px rgba(24,197,255,.6);}

    /* üéôÔ∏è ORBE VIBRAT√ìRIO LINEAR - ANIMA√á√ïES */
    @keyframes voiceLinearPulse {
      0%, 100% {
        width: 20%;
        box-shadow: 0 0 10px var(--primary-color);
      }
      50% {
        width: 60%;
        box-shadow: 0 0 20px var(--primary-color);
      }
    }

    @keyframes voiceLinearActive {
      0% { width: 0%; opacity: 0.6; }
      50% { width: 80%; opacity: 1; }
      100% { width: 40%; opacity: 0.8; }
    }

    @keyframes voiceLinearSpeaking {
      0% { width: 10%; }
      25% { width: 90%; }
      50% { width: 70%; }
      75% { width: 95%; }
      100% { width: 85%; }
    }

    @keyframes voiceRingLinear {
      0% {
        width: 0%;
        opacity: 0.8;
      }
      100% {
        width: 100%;
        opacity: 0;
      }
    }

    @keyframes voicePulseLinear {
      0%, 100% { opacity: 0.3; width: 0%; }
      50% { opacity: 0.7; width: 40%; }
    }

    @keyframes voiceLedPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* Estados do orbe linear */
    .voice-orb-idle #voice-orb {
      width: 5%;
    }

    .voice-orb-idle #voice-led {
      background: var(--muted);
    }

    .voice-orb-idle #voice-state-label {
      color: var(--muted);
    }

    .voice-orb-active #voice-orb {
      animation: voiceLinearActive 2s ease-in-out infinite;
    }

    .voice-orb-active #voice-led {
      background: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-color);
      animation: voiceLedPulse 2s ease-in-out infinite;
    }

    .voice-orb-active #voice-state-label {
      color: var(--accent-color);
    }

    .voice-orb-speaking #voice-orb {
      animation: voiceLinearSpeaking 1s ease-in-out infinite;
      box-shadow: 0 0 20px var(--secondary-color) !important;
    }

    .voice-orb-speaking #voice-pulse {
      animation: voicePulseLinear 0.8s ease-in-out infinite;
    }

    .voice-orb-speaking .voice-ring {
      animation: voiceRingLinear 1.5s ease-out infinite;
      opacity: 1 !important;
    }

    .voice-orb-speaking #voice-led {
      background: var(--secondary-color);
      box-shadow: 0 0 12px var(--secondary-color);
      animation: voiceLedPulse 1s ease-in-out infinite;
    }

    .voice-orb-speaking #voice-state-label {
      color: var(--secondary-color);
    }

    .voice-orb-error #voice-orb {
      width: 100% !important;
      background: linear-gradient(90deg, #ef4444, #dc2626) !important;
      box-shadow: 0 0 15px #ef4444 !important;
    }

    .voice-orb-error #voice-led {
      background: #ef4444;
      box-shadow: 0 0 12px #ef4444;
      animation: voiceLedPulse 0.5s ease-in-out infinite;
    }

    .voice-orb-error #voice-state-label {
      color: #ef4444;
    }

  /* ===== TECHNOLOGICAL FIREFLY GRID ===== */
  .firefly {
    position: absolute;
    width: 3px;
    height: 3px;
    background: var(--primary-color, #667eea);
    border-radius: 50%;
    box-shadow:
      0 0 6px var(--primary-color, #667eea),
      0 0 12px var(--accent-color, #4facfe),
      0 0 18px rgba(102, 126, 234, 0.3);
    z-index: 2;
    pointer-events: none;
    opacity: 0;
  }

  /* Grid positioning system */
  .firefly:nth-child(1) { left: 10%; }
  .firefly:nth-child(2) { left: 20%; }
  .firefly:nth-child(3) { left: 30%; }
  .firefly:nth-child(4) { left: 40%; }
  .firefly:nth-child(5) { left: 50%; }
  .firefly:nth-child(6) { left: 60%; }
  .firefly:nth-child(7) { left: 70%; }
  .firefly:nth-child(8) { left: 80%; }
  .firefly:nth-child(9) { left: 90%; }
  .firefly:nth-child(10) { left: 15%; }
  .firefly:nth-child(11) { left: 25%; }
  .firefly:nth-child(12) { left: 35%; }
  .firefly:nth-child(13) { left: 45%; }
  .firefly:nth-child(14) { left: 55%; }
  .firefly:nth-child(15) { left: 65%; }
  .firefly:nth-child(16) { left: 75%; }
  .firefly:nth-child(17) { left: 85%; }
  .firefly:nth-child(18) { left: 12%; }
  .firefly:nth-child(19) { left: 38%; }
  .firefly:nth-child(20) { left: 62%; }

  /* Technological wave patterns */
  @keyframes techPulse {
    0%, 100% {
      transform: translateY(100vh) scale(1);
      opacity: 0;
    }
    10% {
      opacity: 0.8;
    }
    50% {
      transform: translateY(50vh) scale(1.2);
      opacity: 1;
    }
    90% {
      opacity: 0.3;
    }
  }

  @keyframes techWave1 {
    0%, 100% {
      transform: translateY(100vh) translateX(0) scale(0.8);
      opacity: 0;
    }
    20% {
      opacity: 0.6;
    }
    50% {
      transform: translateY(25vh) translateX(15px) scale(1.3);
      opacity: 1;
    }
    80% {
      opacity: 0.4;
    }
  }

  @keyframes techWave2 {
    0%, 100% {
      transform: translateY(100vh) translateX(0) scale(1);
      opacity: 0;
    }
    15% {
      opacity: 0.5;
    }
    45% {
      transform: translateY(35vh) translateX(-10px) scale(1.1);
      opacity: 0.9;
    }
    75% {
      opacity: 0.2;
    }
  }
  @keyframes firefly6 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.4; }
    40% { transform: translateY(-105vh) translateX(20px) scale(1.4); opacity: 0.9; }
    80% { transform: translateY(-45vh) translateX(-55px) scale(0.7); opacity: 0.7; }
  }
  @keyframes firefly7 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.5; }
    35% { transform: translateY(-85vh) translateX(-25px) scale(1.1); opacity: 0.8; }
    65% { transform: translateY(-120vh) translateX(50px) scale(0.9); opacity: 0.6; }
  }
  @keyframes firefly8 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.3; }
    20% { transform: translateY(-150vh) translateX(-35px) scale(1.2); opacity: 1; }
    60% { transform: translateY(-55vh) translateX(25px) scale(0.8); opacity: 0.7; }
  }
  @keyframes firefly9 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.4; }
    45% { transform: translateY(-75vh) translateX(65px) scale(1.3); opacity: 0.9; }
    90% { transform: translateY(-135vh) translateX(-5px) scale(0.6); opacity: 0.8; }
  }
  @keyframes firefly10 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.5; }
    30% { transform: translateY(-100vh) translateX(-40px) scale(1.1); opacity: 0.7; }
    70% { transform: translateY(-70vh) translateX(30px) scale(0.9); opacity: 1; }
  }
  @keyframes firefly11 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.3; }
    25% { transform: translateY(-160vh) translateX(12px) scale(1.4); opacity: 0.6; }
    75% { transform: translateY(-30vh) translateX(-48px) scale(0.8); opacity: 0.9; }
  }
  @keyframes firefly12 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.4; }
    50% { transform: translateY(-90vh) translateX(-18px) scale(1.2); opacity: 1; }
  }
  @keyframes firefly13 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.5; }
    40% { transform: translateY(-130vh) translateX(35px) scale(0.7); opacity: 0.8; }
    80% { transform: translateY(-60vh) translateX(-30px) scale(1.3); opacity: 0.7; }
  }
  @keyframes firefly14 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.3; }
    35% { transform: translateY(-95vh) translateX(52px) scale(1.1); opacity: 0.6; }
    70% { transform: translateY(-145vh) translateX(-24px) scale(0.9); opacity: 1; }
  }
  @keyframes firefly15 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.4; }
    20% { transform: translateY(-50vh) translateX(-54px) scale(1.2); opacity: 0.9; }
    80% { transform: translateY(-125vh) translateX(18px) scale(0.8); opacity: 0.7; }
  }
  @keyframes firefly16 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.5; }
    50% { transform: translateY(-110vh) translateX(-6px) scale(1.3); opacity: 0.8; }
  }
  @keyframes firefly17 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.3; }
    30% { transform: translateY(-80vh) translateX(42px) scale(0.9); opacity: 0.7; }
    60% { transform: translateY(-155vh) translateX(-36px) scale(1.1); opacity: 1; }
  }
  @keyframes firefly18 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.4; }
    45% { transform: translateY(-40vh) translateX(60px) scale(1.4); opacity: 0.6; }
    90% { transform: translateY(-100vh) translateX(-12px) scale(0.7); opacity: 0.9; }
  }
  @keyframes firefly19 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.5; }
    25% { transform: translateY(-140vh) translateX(-42px) scale(1.2); opacity: 0.8; }
    75% { transform: translateY(-70vh) translateX(24px) scale(0.8); opacity: 0.7; }
  }
  @keyframes firefly20 {
    0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.3; }
    40% { transform: translateY(-85vh) translateX(48px) scale(1.1); opacity: 1; }
    80% { transform: translateY(-120vh) translateX(-18px) scale(0.9); opacity: 0.6; }
  }

  .firefly:nth-child(1) { left: 5%; animation: firefly1 8s infinite ease-in-out; animation-delay: -2s; }
  .firefly:nth-child(2) { left: 15%; animation: firefly2 6s infinite ease-in-out; animation-delay: -1s; }
  .firefly:nth-child(3) { left: 25%; animation: firefly3 10s infinite ease-in-out; animation-delay: -3s; }
  .firefly:nth-child(4) { left: 35%; animation: firefly4 7s infinite ease-in-out; animation-delay: -0.5s; }
  .firefly:nth-child(5) { left: 45%; animation: firefly5 9s infinite ease-in-out; animation-delay: -2.5s; }
  .firefly:nth-child(6) { left: 55%; animation: firefly6 8s infinite ease-in-out; animation-delay: -1.5s; }
  .firefly:nth-child(7) { left: 65%; animation: firefly7 6.5s infinite ease-in-out; animation-delay: -0.8s; }
  .firefly:nth-child(8) { left: 75%; animation: firefly8 11s infinite ease-in-out; animation-delay: -3.2s; }
  .firefly:nth-child(9) { left: 85%; animation: firefly9 7.5s infinite ease-in-out; animation-delay: -1.2s; }
  .firefly:nth-child(10) { left: 95%; animation: firefly10 9.5s infinite ease-in-out; animation-delay: -2.8s; }
  .firefly:nth-child(11) { left: 10%; animation: firefly11 8.5s infinite ease-in-out; animation-delay: -0.3s; }
  .firefly:nth-child(12) { left: 20%; animation: firefly12 6.8s infinite ease-in-out; animation-delay: -2.1s; }
  .firefly:nth-child(13) { left: 30%; animation: firefly13 10.2s infinite ease-in-out; animation-delay: -1.7s; }
  .firefly:nth-child(14) { left: 40%; animation: firefly14 7.2s infinite ease-in-out; animation-delay: -3.5s; }
  .firefly:nth-child(15) { left: 50%; animation: firefly15 9.8s infinite ease-in-out; animation-delay: -0.6s; }
  .firefly:nth-child(16) { left: 60%; animation: firefly16 8.2s infinite ease-in-out; animation-delay: -2.3s; }
  .firefly:nth-child(17) { left: 70%; animation: firefly17 6.3s infinite ease-in-out; animation-delay: -1.4s; }
  .firefly:nth-child(18) { left: 80%; animation: firefly18 11.5s infinite ease-in-out; animation-delay: -0.9s; }
  .firefly:nth-child(19) { left: 90%; animation: firefly19 7.8s infinite ease-in-out; animation-delay: -2.6s; }
  .firefly:nth-child(20) { left: 8%; animation: firefly20 9.2s infinite ease-in-out; animation-delay: -1.8s; }

  </style>
</head>
<body>
  <!-- ===== FIREFLY BACKGROUND ELEMENTS ===== -->
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>
  <div class="firefly"></div>

  <!-- Menu hamb√∫rguer para mobile -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menu">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 12h18M3 6h18M3 18h18"/>
    </svg>
  </button>
  
  <!-- Overlay para mobile -->
  <div class="mobile-overlay" id="mobileOverlay"></div>

  <div class="app">
    <div class="brand" id="brand">
      <!-- Mini anima√ß√£o ORBION ao lado esquerdo da logo -->
      <div style="position: relative; width: 48px; height: 48px; margin: 0 8px 0 0;">
        <div class="mini-orbion-system" style="transform: scale(0.6); transform-origin: center;">
          <!-- Esfera de part√≠culas mini -->
          <div class="mini-particle-sphere" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <!-- Primeira camada - equador mini -->
            <div class="mini-sphere-particle" style="position: absolute; width: 4px; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; box-shadow: 0 0 8px var(--primary-color); transform: translate(-50%, -50%) rotateY(0deg) rotateX(0deg) translateZ(30px); animation: miniOrbit 8s linear infinite;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 4px; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; box-shadow: 0 0 8px var(--primary-color); transform: translate(-50%, -50%) rotateY(60deg) rotateX(0deg) translateZ(30px); animation: miniOrbit 8s linear infinite 0.5s;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 4px; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; box-shadow: 0 0 8px var(--primary-color); transform: translate(-50%, -50%) rotateY(120deg) rotateX(0deg) translateZ(30px); animation: miniOrbit 8s linear infinite 1s;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 4px; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; box-shadow: 0 0 8px var(--primary-color); transform: translate(-50%, -50%) rotateY(180deg) rotateX(0deg) translateZ(30px); animation: miniOrbit 8s linear infinite 1.5s;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 4px; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; box-shadow: 0 0 8px var(--primary-color); transform: translate(-50%, -50%) rotateY(240deg) rotateX(0deg) translateZ(30px); animation: miniOrbit 8s linear infinite 2s;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 4px; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; box-shadow: 0 0 8px var(--primary-color); transform: translate(-50%, -50%) rotateY(300deg) rotateX(0deg) translateZ(30px); animation: miniOrbit 8s linear infinite 2.5s;"></div>

            <!-- Segunda camada para mais densidade -->
            <div class="mini-sphere-particle" style="position: absolute; width: 3px; height: 3px; background: rgba(79, 172, 254, 0.8); border-radius: 50%; box-shadow: 0 0 6px var(--accent-color); transform: translate(-50%, -50%) rotateY(30deg) rotateX(30deg) translateZ(25px); animation: miniOrbit 10s linear infinite;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 3px; height: 3px; background: rgba(79, 172, 254, 0.8); border-radius: 50%; box-shadow: 0 0 6px var(--accent-color); transform: translate(-50%, -50%) rotateY(150deg) rotateX(30deg) translateZ(25px); animation: miniOrbit 10s linear infinite 1s;"></div>
            <div class="mini-sphere-particle" style="position: absolute; width: 3px; height: 3px; background: rgba(79, 172, 254, 0.8); border-radius: 50%; box-shadow: 0 0 6px var(--accent-color); transform: translate(-50%, -50%) rotateY(270deg) rotateX(30deg) translateZ(25px); animation: miniOrbit 10s linear infinite 2s;"></div>

            <!-- Core central mini maior -->
            <div class="mini-tech-core" style="position: absolute; top: 50%; left: 50%; width: 12px; height: 12px; margin: -6px 0 0 -6px; background: radial-gradient(circle, var(--primary-color), transparent); border-radius: 50%; box-shadow: 0 0 12px var(--primary-color); animation: miniCoreEnergy 3s ease-in-out infinite; z-index: 5;"></div>
          </div>
        </div>
      </div>
      <div class="name" id="brand-name"></div>
    </div>

    <header>
      <div class="row">
        <span class="btn" style="background: var(--glass); border: 1px solid var(--border); color: var(--text); font-family: 'Orbitron', sans-serif; font-weight: 500; letter-spacing: 0.5px; position: relative; overflow: hidden; backdrop-filter: blur(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
          <span style="position: relative; z-index: 1;">Servidor Online</span>
        </span>
      </div>
      <div class="row">
        <a class="btn" href="/auth/google" style="background: var(--glass); border: 1px solid var(--border); color: var(--text); font-family: 'Orbitron', sans-serif; font-weight: 500; letter-spacing: 0.5px; position: relative; overflow: hidden; backdrop-filter: blur(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
          <span style="position: relative; z-index: 1;">Conectar Calendar</span>
        </a>
        <button class="btn" id="btn-refresh" style="background: var(--glass); border: 1px solid var(--border); color: var(--text); font-family: 'Orbitron', sans-serif; font-weight: 500; letter-spacing: 0.5px; position: relative; overflow: hidden; backdrop-filter: blur(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
          <span style="position: relative; z-index: 1;">Atualizar</span>
        </button>
      </div>
    </header>

    <aside id="sidebar">
      <div class="menu">
        <div class="item active" data-tab="home">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" d="M3 12l9-9 9 9M4 10v10h6V14h4v6h6V10"/></svg>
          <span>Central Hub</span>
        </div>
        <div class="item" data-tab="stats">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="1.6"/><path stroke-width="1.6" d="M12 6v6l4 2"/></svg>
          <span>ORBION Status</span>
        </div>
        <div class="item" data-tab="whatsapp">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="1.6" d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
            <path stroke-width="1.6" d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
            <path stroke-width="1.6" d="m8 12 2 2 4-4"/>
          </svg>
          <span>WhatsApp</span>
        </div>
        <!-- Configura√ß√µes: aba profissional de configura√ß√µes -->
        <div class="item" data-tab="customize">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="3" stroke-width="1.6"/>
            <path stroke-width="1.6" d="M12 1v6m0 6v6m12-7h-6m-6 0H1"/>
            <path stroke-width="1.6" d="m20.5 7.5-4.25 2.46m-8.5 4.93L3.5 17.37m16.99 0-4.24-2.47m-8.5-4.94L3.5 7.5"/>
          </svg>
          <span>Settings</span>
        </div>
        <!-- Funil: novo item de menu para o funil de leads -->
        <div class="item" data-tab="funnel">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <!-- √≠cone em forma de tri√¢ngulo invertido para simbolizar funil -->
            <path stroke-width="1.6" d="M3 4h18l-6 10v6h-6v-6l-6-10z"/>
          </svg>
          <span>Sales Funnel</span>
        </div>
        <div class="item" data-tab="leads">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="1.6" d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path stroke-width="1.6" d="M23 21v-2a4 4 0 0 0-4-4h-1"/>
            <circle cx="16" cy="3" r="4"/>
          </svg>
          <span>Lead Intelligence</span>
        </div>
        <div class="item" data-tab="calendar">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke-width="1.6"/>
            <line x1="16" y1="2" x2="16" y2="6" stroke-width="1.6"/>
            <line x1="8" y1="2" x2="8" y2="6" stroke-width="1.6"/>
            <line x1="3" y1="10" x2="21" y2="10" stroke-width="1.6"/>
          </svg>
          <span>Calendar</span>
        </div>
      </div>
    </aside>

    <main>

      <!-- ===== Central Hub ===== -->
      <section id="tab-home" class="tab active">
        <!-- Nova interface centralizada com anima√ß√£o ORBION -->
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center; position: relative;">
          <!-- Anima√ß√£o ORBION centralizada e maior -->
          <div style="position: relative; width: 600px; height: 600px; margin: 0 auto 40px;">
            <!-- === VAGALUMES TECNOL√ìGICOS AO REDOR DO ORBION === -->
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>
            <div class="firefly"></div>

            <!-- Sistema 3D ORBION -->
            <div class="orbion-system" style="transform: scale(2.5);">
              <!-- Esfera de part√≠culas -->
              <div class="particle-sphere">
                <!-- Primeira camada - equador -->
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(0deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(20deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(40deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(60deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(80deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(100deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(120deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(140deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(160deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(180deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(200deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(220deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(240deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(260deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(280deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(300deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(320deg) rotateX(0deg) translateZ(75px);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(340deg) rotateX(0deg) translateZ(75px);"></div>

                <!-- Segunda camada - latitude 30¬∞ -->
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(0deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(40deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(80deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(120deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(160deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(200deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(240deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(280deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(320deg) rotateX(30deg) translateZ(75px); background: rgba(79, 172, 254, 0.7);"></div>

                <!-- Terceira camada - latitude -30¬∞ -->
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(0deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(40deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(80deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(120deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(160deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(200deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(240deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(280deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateY(320deg) rotateX(-30deg) translateZ(75px); background: rgba(118, 75, 162, 0.7);"></div>

                <!-- Polos -->
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateX(90deg) translateZ(75px); background: rgba(255, 255, 255, 0.9); width: 4px; height: 4px;"></div>
                <div class="sphere-particle" style="transform: translate(-50%, -50%) rotateX(-90deg) translateZ(75px); background: rgba(255, 255, 255, 0.9); width: 4px; height: 4px;"></div>
              </div>

              <!-- Texto ORBION no centro -->
              <div class="orbion-core">
                <div class="orbion-text">ORBION</div>
              </div>

              <!-- An√©is orbitais -->
              <div class="orbital-ring ring-horizontal"></div>
              <div class="orbital-ring ring-vertical"></div>
              <div class="orbital-ring ring-diagonal"></div>
            </div>
          </div>

          <!-- Bot√µes Falar e Parar centralizados com a anima√ß√£o -->
          <div style="display: flex; gap: 24px; justify-content: center; align-items: center; width: 600px; margin: 0 auto;">
            <button id="btn-speak" class="btn-primary" style="padding: 16px 32px; font-size: 18px; font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 1px; min-width: 140px; position: relative; overflow: hidden; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border: none; border-radius: 16px; box-shadow: 0 8px 32px rgba(var(--primary-color-rgb, 102, 126, 234), 0.3); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
              <svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
              </svg>
              <span style="position: relative; z-index: 1;">Falar</span>
            </button>

            <button id="btn-stop" class="btn" style="padding: 16px 32px; font-size: 18px; font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 1px; min-width: 140px; position: relative; overflow: hidden; background: linear-gradient(135deg, var(--accent-color), var(--secondary-color)); border: none; border-radius: 16px; box-shadow: 0 8px 32px rgba(var(--accent-color-rgb, 79, 172, 254), 0.3); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: white;">
              <svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
              </svg>
              <span style="position: relative; z-index: 1;">Parar</span>
            </button>
          </div>

          <!-- Seletor de Voz Premium -->
          <div style="display: flex; gap: 12px; justify-content: center; align-items: center; background: var(--glass); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border); margin-top: 16px; width: fit-content; margin-left: auto; margin-right: auto;">
            <span style="font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--muted); font-weight: 500;">Voz:</span>
            <select id="voice-selector" style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: var(--text); font-family: 'Orbitron', sans-serif; font-size: 14px; min-width: 180px;">
              <option value="elevenlabs" selected>üéôÔ∏è ElevenLabs Premium</option>
              <option value="local">üîä Voz Local Otimizada</option>
            </select>
            <div id="voice-status" style="padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; background: var(--ok); color: white;">
              PREMIUM
            </div>
          </div>


        </div>
      </section>


      <!-- ===== Status ===== -->
      <section id="tab-stats" class="tab">
        <!-- === VAGALUMES TECNOL√ìGICOS === -->
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>

        <h1 style="font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1.5px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; color: transparent;">ORBION System Status</h1>
        
        <!-- Status Principal -->
        <div class="agent-status-header" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:30px;">
          <div class="card status-card">
            <div class="status-indicator" style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
              <div class="status-light" id="main-status-light" style="width:24px; height:24px; border-radius:50%; background:var(--ok); box-shadow:0 0 20px var(--ok); animation:pulse 2s infinite;"></div>
              <div>
                <div class="label" style="font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 0.8px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; color: transparent;">ORBION Status Geral</div>
                <div class="status-text" id="main-status-text" style="font-size:18px; font-weight:700; color:var(--ok);">ONLINE</div>
              </div>
            </div>
            <div class="status-details" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding-top:12px; border-top:1px solid var(--border);">
              <div>
                <div class="label">Uptime</div>
                <div class="value" style="font-size:20px;">99.9%</div>
              </div>
              <div>
                <div class="label">Tempo Online</div>
                <div class="value" style="font-size:20px;" id="uptime-counter">72h 15m</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="label" style="margin-bottom:12px; font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 0.5px; color: var(--primary-color);">Performance</div>
            <div class="performance-metrics">
              <div class="metric-bar" style="margin-bottom:12px;">
                <div class="row" style="justify-content:space-between; margin-bottom:4px;">
                  <span class="label">CPU</span>
                  <span class="label" id="cpu-value">32%</span>
                </div>
                <div class="progress-bar" style="height:8px; background:var(--border); border-radius:4px; overflow:hidden;">
                  <div class="progress-fill" id="cpu-fill" style="width:32%; height:100%; background:linear-gradient(90deg, var(--primary-color), var(--secondary-color)); transition:width 0.5s;"></div>
                </div>
              </div>
              <div class="metric-bar" style="margin-bottom:12px;">
                <div class="row" style="justify-content:space-between; margin-bottom:4px;">
                  <span class="label">Mem√≥ria</span>
                  <span class="label" id="memory-value">45%</span>
                </div>
                <div class="progress-bar" style="height:8px; background:var(--border); border-radius:4px; overflow:hidden;">
                  <div class="progress-fill" id="memory-fill" style="width:45%; height:100%; background:linear-gradient(90deg, var(--primary-color), var(--secondary-color)); transition:width 0.5s;"></div>
                </div>
              </div>
              <div class="metric-bar">
                <div class="row" style="justify-content:space-between; margin-bottom:4px;">
                  <span class="label">Requisi√ß√µes/min</span>
                  <span class="label" id="requests-value">127</span>
                </div>
                <div class="progress-bar" style="height:8px; background:var(--border); border-radius:4px; overflow:hidden;">
                  <div class="progress-fill" id="requests-fill" style="width:63%; height:100%; background:linear-gradient(90deg, var(--primary-color), var(--secondary-color)); transition:width 0.5s;"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="label" style="margin-bottom:12px; font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 0.5px; color: var(--primary-color);">Servi√ßos</div>
            <div class="services-status" style="display:flex; flex-direction:column; gap:8px;">
              <div class="service-item" style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--glass); border-radius:8px;">
                <span style="font-size:14px;">API Principal</span>
                <div style="display:flex; align-items:center; gap:8px;">
                  <div class="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--ok); box-shadow:0 0 8px var(--ok);"></div>
                  <span class="label" style="color:var(--ok);">Ativo</span>
                </div>
              </div>
              <div class="service-item" style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--glass); border-radius:8px;">
                <span style="font-size:14px;">WhatsApp</span>
                <div style="display:flex; align-items:center; gap:8px;">
                  <div class="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--ok); box-shadow:0 0 8px var(--ok);"></div>
                  <span class="label" style="color:var(--ok);">Conectado</span>
                </div>
              </div>
              <div class="service-item" style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--glass); border-radius:8px;">
                <span style="font-size:14px;">Banco de Dados</span>
                <div style="display:flex; align-items:center; gap:8px;">
                  <div class="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--ok); box-shadow:0 0 8px var(--ok);"></div>
                  <span class="label" style="color:var(--ok);">Operacional</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="label" style="margin-bottom:12px;">Taxa de Resposta</div>
            <div style="text-align:center; position:relative; height:120px; display:flex; align-items:center; justify-content:center;">
              <canvas id="response-rate-chart" style="max-width:120px; max-height:120px;"></canvas>
              <div style="position:absolute; display:flex; flex-direction:column; align-items:center;">
                <div class="value" style="font-size:28px;">98%</div>
                <div class="label">Sucesso</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Gr√°ficos e M√©tricas -->
        <div class="split" style="margin-bottom:20px;">
          <div class="card">
            <div class="label" style="margin-bottom:12px;">Atividade em Tempo Real</div>
            <canvas id="activity-chart" style="width:100%; height:200px;"></canvas>
          </div>
          <div class="card">
            <div class="label" style="margin-bottom:12px;">ORBION System Logs</div>
            <div id="logs-list" style="max-height:200px; overflow-y:auto; font-family:monospace; font-size:12px;">
              <div class="log-entry" style="padding:4px 8px; border-left:3px solid var(--ok); margin-bottom:4px; background:var(--glass); border-radius:4px;">
                <span style="color:var(--muted);">[14:32:15]</span> ORBION inicializado com sucesso
              </div>
              <div class="log-entry" style="padding:4px 8px; border-left:3px solid var(--primary-color); margin-bottom:4px; background:var(--glass); border-radius:4px;">
                <span style="color:var(--muted);">[14:32:18]</span> ORBION WhatsApp conectado
              </div>
              <div class="log-entry" style="padding:4px 8px; border-left:3px solid var(--primary-color); margin-bottom:4px; background:var(--glass); border-radius:4px;">
                <span style="color:var(--muted);">[14:32:20]</span> API pronta para requisi√ß√µes
              </div>
              <div class="log-entry" style="padding:4px 8px; border-left:3px solid var(--warn); margin-bottom:4px; background:var(--glass); border-radius:4px;">
                <span style="color:var(--muted);">[14:33:45]</span> Cache limpo automaticamente
              </div>
              <div class="log-entry" style="padding:4px 8px; border-left:3px solid var(--ok); margin-bottom:4px; background:var(--glass); border-radius:4px;">
                <span style="color:var(--muted);">[14:34:12]</span> Backup realizado com sucesso
              </div>
            </div>
          </div>
        </div>
        
        <!-- Estat√≠sticas Detalhadas -->
        <div class="grid-charts" style="margin-top:20px;">
          <div class="card">
            <div class="label">Mensagens Processadas</div>
            <div class="value">1,247</div>
            <div class="label" style="color:var(--ok);">+12% hoje</div>
          </div>
          <div class="card">
            <div class="label">Tempo M√©dio de Resposta</div>
            <div class="value">1.2s</div>
            <div class="label" style="color:var(--ok);">-15% melhor</div>
          </div>
          <div class="card">
            <div class="label">Usu√°rios Ativos</div>
            <div class="value">47</div>
            <div class="label" style="color:var(--primary-color);">Online agora</div>
          </div>
          <div class="card">
            <div class="label">Erros nas √öltimas 24h</div>
            <div class="value">0</div>
            <div class="label" style="color:var(--ok);">ORBION Sistema Est√°vel</div>
          </div>
        </div>
      </section>

      <!-- ===== WhatsApp ===== -->
      <section id="tab-whatsapp" class="tab">
        <!-- === VAGALUMES TECNOL√ìGICOS === -->
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>

        <h1 style="font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1.5px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; color: transparent;">ORBION Communication Hub</h1>
        
        <!-- Estat√≠sticas do WhatsApp -->
        <div class="whatsapp-stats" id="whatsapp-stats">
          <div class="card">
            <div class="label" style="font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 0.5px; color: var(--primary-color);">ORBION Instance Status</div>
            <div class="value" id="instance-status">Verificando...</div>
            <span class="status-badge" id="status-badge">Aguardando</span>
          </div>
          <div class="card">
            <div class="label">Mensagens Hoje</div>
            <div class="value" id="messages-today">0</div>
          </div>
          <div class="card">
            <div class="label">Contatos Ativos</div>
            <div class="value" id="active-contacts">0</div>
          </div>
          <div class="card">
            <div class="label">Taxa de Resposta</div>
            <div class="value" id="response-rate">0%</div>
          </div>
        </div>

        <!-- Controles do WhatsApp -->
        <div class="card">
          <div class="label" style="margin-bottom:12px; font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 0.5px; color: var(--primary-color);">ORBION WhatsApp Controls</div>
          <div class="whatsapp-controls">
            <button class="btn" id="check-status">Check ORBION Status</button>
            <button class="btn" id="send-test-message">ORBION Test Message</button>
            <button class="btn" id="update-settings">ORBION Settings</button>
            <button class="btn" id="make-test-call">Liga√ß√£o de Teste</button>
            <button class="btn" id="run-campaign">Executar Campanha</button>
          </div>
        </div>

        <!-- Envio de mensagens -->
        <div class="split">
          <div class="card">
            <div class="label" style="margin-bottom:12px; font-family: 'Orbitron', sans-serif; font-weight: 600; letter-spacing: 0.5px; color: var(--primary-color);">ORBION Message Sender</div>
            <form id="whatsapp-form" class="row" style="flex-direction:column; gap:12px;">
              <input id="wa-number" class="input" placeholder="N√∫mero (ex: 5511999999999)" required>
              <textarea id="wa-message" class="input" rows="3" placeholder="ORBION Message..." required></textarea>
              <div class="row" style="justify-content:space-between;">
                <select id="wa-type" class="input" style="max-width:160px">
                  <option value="text">Texto</option>
                  <option value="tts">√Åudio TTS</option>
                  <option value="intelligent">IA Inteligente</option>
                </select>
                <div class="row" style="gap:8px;">
                  <button type="button" class="btn" id="wa-schedule">Agendar Reuni√£o</button>
                  <button type="submit" class="btn-primary">Enviar</button>
                </div>
              </div>
            </form>
            <div id="wa-feedback" class="label" style="margin-top:8px;"></div>
          </div>

          <div class="card">
            <div class="label" style="margin-bottom:12px">Mensagens Recentes</div>
            <div class="whatsapp-messages" id="whatsapp-messages">
              <div class="label" style="text-align:center; margin-top:40px;">Carregando mensagens...</div>
            </div>
          </div>
        </div>

        <!-- Contatos principais -->
        <div class="card">
          <div class="label" style="margin-bottom:12px">Contatos Principais</div>
          <div class="whatsapp-contacts" id="whatsapp-contacts"></div>
        </div>
      </section>

      <!-- ===== Configura√ß√µes ===== -->
      <section id="tab-customize" class="tab">
        <!-- === VAGALUMES TECNOL√ìGICOS === -->
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>

        <h1 style="font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1.5px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; color: transparent;">ORBION Settings</h1>
        
        <!-- Menu de Configura√ß√µes -->
        <div class="settings-menu" style="display:flex; gap:12px; margin-bottom:24px; padding:16px; background:var(--glass); border-radius:16px; overflow-x:auto;">
          <button class="settings-tab-btn active" data-section="general" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:linear-gradient(135deg, var(--primary-color)20, var(--secondary-color)20); color:var(--primary-color); font-weight:600; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            <svg style="width:16px;height:16px;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 8v6m-6-6h6m8 0h-6"/></svg>Geral
          </button>
          <button class="settings-tab-btn" data-section="appearance" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:var(--glass); color:var(--text); font-weight:500; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            üé® Apar√™ncia
          </button>
          <button class="settings-tab-btn" data-section="integrations" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:var(--glass); color:var(--text); font-weight:500; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            üîå Integra√ß√µes
          </button>
          <button class="settings-tab-btn" data-section="notifications" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:var(--glass); color:var(--text); font-weight:500; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg> Notifica√ß√µes
          </button>
          <button class="settings-tab-btn" data-section="security" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:var(--glass); color:var(--text); font-weight:500; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            üõ°Ô∏è Seguran√ßa
          </button>
          <button class="settings-tab-btn" data-section="api" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:var(--glass); color:var(--text); font-weight:500; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            üíª API & Webhook
          </button>
          <button class="settings-tab-btn" data-section="backup" style="padding:12px 24px; border:1px solid var(--border); border-radius:12px; background:var(--glass); color:var(--text); font-weight:500; cursor:pointer; transition:all 0.3s; white-space:nowrap;">
            üíæ Backup & Dados
          </button>
        </div>
        
        <!-- Se√ß√£o Geral -->
        <div class="settings-section active" id="section-general">
          <div class="split">
            <div class="card">
              <h3 style="margin:0 0 20px; font-size:18px; font-weight:600; display:flex; align-items:center; gap:8px;">
                <svg style="width:18px;height:18px;margin-right:8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 8v6m-6-6h6m8 0h-6"/></svg>ORBION Settings
              </h3>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Nome da Empresa</label>
                <input type="text" class="input" id="company-name" placeholder="ORBION Technologies" value="ORBION">
                <small class="label" style="font-size:11px;">Nome exibido no dashboard e relat√≥rios</small>
              </div>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Fuso Hor√°rio</label>
                <select class="input" id="timezone">
                  <option value="America/Sao_Paulo" selected>üáßüá∑ Bras√≠lia (GMT-3)</option>
                  <option value="America/New_York">üá∫üá∏ Nova York (GMT-5)</option>
                  <option value="Europe/London">üá¨üáß Londres (GMT)</option>
                  <option value="Asia/Tokyo">üáØüáµ T√≥quio (GMT+9)</option>
                  <option value="Europe/Madrid">üá™üá∏ Madrid (GMT+1)</option>
                </select>
              </div>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Idioma do Sistema</label>
                <select class="input" id="language">
                  <option value="pt-BR" selected>üáßüá∑ Portugu√™s (Brasil)</option>
                  <option value="en-US">üá∫üá∏ English (US)</option>
                  <option value="es-ES">üá™üá∏ Espa√±ol</option>
                  <option value="fr-FR">üá´üá∑ Fran√ßais</option>
                </select>
              </div>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Formato de Data & Hora</label>
                <div class="row" style="gap:8px;">
                  <select class="input" id="date-format" style="flex:1;">
                    <option value="DD/MM/YYYY" selected>DD/MM/AAAA</option>
                    <option value="MM/DD/YYYY">MM/DD/AAAA</option>
                    <option value="YYYY-MM-DD">AAAA-MM-DD</option>
                  </select>
                  <select class="input" id="time-format" style="flex:1;">
                    <option value="24" selected>24 horas</option>
                    <option value="12">12 horas (AM/PM)</option>
                  </select>
                </div>
              </div>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Moeda Padr√£o</label>
                <select class="input" id="currency">
                  <option value="BRL" selected>üáßüá∑ Real Brasileiro (R$)</option>
                  <option value="USD">üá∫üá∏ D√≥lar Americano ($)</option>
                  <option value="EUR">üá™üá∫ Euro (‚Ç¨)</option>
                  <option value="GBP">üá¨üáß Libra (¬£)</option>
                </select>
              </div>
            </div>
            
            <div class="card">
              <h3 style="margin:0 0 20px; font-size:18px; font-weight:600; display:flex; align-items:center; gap:8px;">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7,2V13H10V22L17,10H13L17,2H7Z"/></svg> Performance & Comportamento
              </h3>
              
              <div style="margin-bottom:20px; padding:12px; background:var(--glass); border-radius:8px;">
                <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                  <input type="checkbox" id="auto-save" checked style="width:20px; height:20px; accent-color:var(--primary-color);">
                  <div>
                    <div style="font-weight:500;">Salvamento Autom√°tico</div>
                    <small class="label">Salva altera√ß√µes automaticamente a cada 30 segundos</small>
                  </div>
                </label>
              </div>
              
              <div style="margin-bottom:20px; padding:12px; background:var(--glass); border-radius:8px;">
                <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                  <input type="checkbox" id="animations" checked style="width:20px; height:20px; accent-color:var(--primary-color);">
                  <div>
                    <div style="font-weight:500;">Anima√ß√µes e Transi√ß√µes</div>
                    <small class="label">Habilita efeitos visuais suaves</small>
                  </div>
                </label>
              </div>
              
              <div style="margin-bottom:20px; padding:12px; background:var(--glass); border-radius:8px;">
                <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                  <input type="checkbox" id="sound-alerts" style="width:20px; height:20px; accent-color:var(--primary-color);">
                  <div>
                    <div style="font-weight:500;">Alertas Sonoros</div>
                    <small class="label">Sons para notifica√ß√µes importantes</small>
                  </div>
                </label>
              </div>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Tempo Limite de Sess√£o</label>
                <div class="row" style="gap:8px; align-items:center;">
                  <input type="range" id="session-timeout" min="5" max="1440" value="30" style="flex:1;">
                  <span id="session-value" style="min-width:80px; font-weight:600;">30 min</span>
                </div>
                <small class="label">Logout autom√°tico por inatividade</small>
              </div>
              
              <div style="margin-bottom:24px;">
                <label class="label" style="display:block; margin-bottom:8px; font-weight:500;">Itens por P√°gina</label>
                <select class="input" id="items-per-page">
                  <option value="10">10 itens</option>
                  <option value="25" selected>25 itens</option>
                  <option value="50">50 itens</option>
                  <option value="100">100 itens</option>
                </select>
              </div>
              
              <div style="margin-bottom:20px; padding:12px; background:var(--glass); border-radius:8px;">
                <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                  <input type="checkbox" id="auto-refresh" checked style="width:20px; height:20px; accent-color:var(--primary-color);">
                  <div>
                    <div style="font-weight:500;">Atualiza√ß√£o Autom√°tica</div>
                    <small class="label">Atualiza dados automaticamente a cada 30s</small>
                  </div>
                </label>
              </div>
              
              <div style="margin-top:24px; padding:16px; background:linear-gradient(135deg, var(--primary-color)10, var(--secondary-color)05); border:1px solid var(--primary-color)20; border-radius:12px;">
                <h4 style="margin:0 0 12px; font-size:16px; font-weight:600; color:var(--primary-color);">ORBION System Diagnostics</h4>
                <p style="margin:0 0 16px; color:var(--text); font-size:14px;">Teste todas as conex√µes e funcionalidades do sistema ORBION.</p>
                <button type="button" id="test-system-btn" style="padding:12px 24px; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500;" onclick="testSystemConfiguration()">
                  <i class="fas fa-check-circle" style="margin-right:8px;"></i>
                  Executar Teste Completo
                </button>
                <div id="test-results" style="margin-top:16px; display:none;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Se√ß√£o Apar√™ncia -->
        <div class="settings-section" id="section-appearance" style="display:none;">
          <div class="split">
          <div class="card">
            <div class="label" style="margin-bottom:12px">Identidade Visual</div>
            
            <!-- Nome da Marca -->
            <div class="row" style="flex-direction:column; gap:12px; margin-bottom:20px;">
              <div class="label">Nome da Marca</div>
              <input id="brand-name-input" class="input" placeholder="ORBION" value="ORBION">
            </div>
            
            <!-- Logo Upload -->
            <div class="row" style="flex-direction:column; gap:12px; margin-bottom:20px;">
              <div class="label">Logo (URL da imagem)</div>
              <input id="logo-url-input" class="input" placeholder="https://exemplo.com/logo.png">
              <div class="logo-preview" id="logo-preview" style="width:80px; height:80px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px;">Preview</div>
            </div>
            
            <!-- Cores Principais -->
            <div class="row" style="flex-direction:column; gap:12px; margin-bottom:20px;">
              <div class="label">Cores do Tema</div>
              <div class="row" style="gap:12px;">
                <div style="flex:1;">
                  <div class="label" style="margin-bottom:4px;">Cor Prim√°ria</div>
                  <input id="primary-color" type="color" class="input" value="#667eea" style="height:50px; padding:4px;">
                </div>
                <div style="flex:1;">
                  <div class="label" style="margin-bottom:4px;">Cor Secund√°ria</div>
                  <input id="secondary-color" type="color" class="input" value="#764ba2" style="height:50px; padding:4px;">
                </div>
                <div style="flex:1;">
                  <div class="label" style="margin-bottom:4px;">Cor de Destaque</div>
                  <input id="accent-color" type="color" class="input" value="#4facfe" style="height:50px; padding:4px;">
                </div>
              </div>
            </div>
            
            <!-- Fundo do Dashboard -->
            <div class="row" style="flex-direction:column; gap:12px; margin-bottom:20px;">
              <div class="label">Fundo do Dashboard</div>
              <select id="background-type" class="input">
                <option value="gradient">Gradiente</option>
                <option value="solid">Cor S√≥lida</option>
                <option value="image">Imagem</option>
              </select>
              <div id="gradient-options" class="row" style="gap:12px;">
                <div style="flex:1;">
                  <div class="label" style="margin-bottom:4px;">In√≠cio</div>
                  <input id="gradient-start" type="color" class="input" value="#667eea" style="height:40px; padding:4px;">
                </div>
                <div style="flex:1;">
                  <div class="label" style="margin-bottom:4px;">Fim</div>
                  <input id="gradient-end" type="color" class="input" value="#764ba2" style="height:40px; padding:4px;">
                </div>
                <div style="flex:1;">
                  <div class="label" style="margin-bottom:4px;">Dire√ß√£o</div>
                  <select id="gradient-direction" class="input">
                    <option value="135deg">Diagonal ‚Üó</option>
                    <option value="90deg">Horizontal ‚Üí</option>
                    <option value="180deg">Vertical ‚Üì</option>
                    <option value="45deg">Diagonal ‚Üñ</option>
                  </select>
                </div>
              </div>
              <div id="solid-options" style="display:none;">
                <input id="solid-color" type="color" class="input" value="#f8fafc" style="height:40px; padding:4px;">
              </div>
              <div id="image-options" style="display:none;">
                <input id="background-image" class="input" placeholder="URL da imagem de fundo">
              </div>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div class="row" style="gap:12px; justify-content:space-between;">
              <button class="btn" id="reset-theme">Resetar Tema</button>
              <div class="row" style="gap:8px;">
                <button class="btn" id="preview-changes">Preview</button>
                <button class="btn-primary" id="apply-changes">Aplicar</button>
              </div>
            </div>
          </div>
          
          <!-- Temas Pr√©-definidos -->
          <div class="card">
            <div class="label" style="margin-bottom:16px">üé® Temas Pr√©-definidos</div>
            
            <!-- Tech Professional -->
            <div style="margin-bottom:24px;">
              <h4 style="margin:0 0 12px; font-size:14px; font-weight:600; color:var(--primary-color); display:flex; align-items:center; gap:6px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,1L8,5H11V14H13V5H16M18,23H6C4.89,23 4,22.1 4,21V9A2,2 0 0,1 6,7H9V9H6V21H18V9H15V7H18A2,2 0 0,1 20,9V21C20,22.1 19.1,23 18,23Z"/></svg> Tech Professional</h4>
              <div class="themes-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                <div class="theme-card" data-theme="default" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Padr√£o</div>
                </div>
                <div class="theme-card" data-theme="cyberpunk" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #1a0033 0%, #000011 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Cyberpunk</div>
                </div>
                <div class="theme-card" data-theme="neon" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #0a0a0a 0%, #1a0033 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Neon</div>
                </div>
                <div class="theme-card" data-theme="matrix" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #0d1421 0%, #000000 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Matrix</div>
                </div>
              </div>
            </div>
            
            <!-- Business -->
            <div style="margin-bottom:24px;">
              <h4 style="margin:0 0 12px; font-size:14px; font-weight:600; color:var(--primary-color); display:flex; align-items:center; gap:6px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M10,2H14A2,2 0 0,1 16,4V6H20A2,2 0 0,1 22,8V19A2,2 0 0,1 20,21H4C2.89,21 2,20.1 2,19V8C2,6.89 2.89,6 4,6H8V4C8,2.89 8.89,2 10,2M14,6V4H10V6H14Z"/></svg> Business</h4>
              <div class="themes-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                <div class="theme-card" data-theme="corporate" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Corporate</div>
                </div>
                <div class="theme-card" data-theme="minimal" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Minimal</div>
                </div>
                <div class="theme-card" data-theme="executive" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Executive</div>
                </div>
                <div class="theme-card" data-theme="obsidian" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #111827 0%, #1f2937 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Obsidian</div>
                </div>
              </div>
            </div>
            
            <!-- Gaming & Creative -->
            <div style="margin-bottom:24px;">
              <h4 style="margin:0 0 12px; font-size:14px; font-weight:600; color:var(--primary-color);">üéÆ Gaming & Creative</h4>
              <div class="themes-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                <div class="theme-card" data-theme="gaming" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #0c0c0c 0%, #1c1c1c 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Gaming</div>
                </div>
                <div class="theme-card" data-theme="esports" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Esports</div>
                </div>
                <div class="theme-card" data-theme="retro" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #581c87 0%, #7c2d12 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Retro</div>
                </div>
                <div class="theme-card" data-theme="aurora" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #4c1d95 0%, #059669 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Aurora</div>
                </div>
              </div>
            </div>
            
            <!-- AI & Future -->
            <div style="margin-bottom:16px;">
              <h4 style="margin:0 0 12px; font-size:14px; font-weight:600; color:var(--primary-color);">ü§ñ AI & Future</h4>
              <div class="themes-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                <div class="theme-card" data-theme="neural" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #0c4a6e 0%, #075985 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Neural</div>
                </div>
                <div class="theme-card" data-theme="quantum" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #581c87 0%, #7c2d12 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Quantum</div>
                </div>
                <div class="theme-card" data-theme="biotech" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #14532d 0%, #166534 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Biotech</div>
                </div>
                <div class="theme-card" data-theme="hologram" style="padding:8px; border:2px solid var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;">
                  <div class="theme-preview" style="width:100%; height:40px; border-radius:4px; background:linear-gradient(135deg, #001122 0%, #003344 100%); margin-bottom:6px;"></div>
                  <div style="font-size:11px; font-weight:500;">Hologram</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top:20px;">
              <div class="label" style="margin-bottom:8px">Exportar/Importar Tema</div>
              <div class="row" style="gap:8px;">
                <button class="btn" id="export-theme">Exportar</button>
                <button class="btn" id="import-theme">Importar</button>
                <input type="file" id="theme-file-input" accept=".json" style="display:none;">
              </div>
              <div id="theme-feedback" class="label" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Leads Pro ===== -->
      <section id="tab-leads" class="tab">
        <!-- === VAGALUMES TECNOL√ìGICOS === -->
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>

        <!-- Header com Stats -->
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
          <div>
            <h1 style="margin:0 0 8px; font-size:32px; font-weight:700; font-family: 'Orbitron', sans-serif; letter-spacing: 1.5px; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; display:flex; align-items:center; gap:12px;"><svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="color:var(--primary-color);"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M9 17H7V10H9V17M13 17H11V7H13V17M17 17H15V13H17V17Z"/></svg> ORBION Lead Intelligence</h1>
            <p style="margin:0; color:var(--muted); font-size:16px; font-family: 'Orbitron', sans-serif; letter-spacing: 0.5px;">Advanced Lead Management & Analytics System</p>
          </div>
          <div style="display:flex; gap:12px; align-items:center;">
            <div style="padding:8px 16px; background:var(--glass); border-radius:8px; text-align:center;">
              <div style="font-size:24px; font-weight:700; color:var(--primary-color);" id="total-leads-count">--</div>
              <div style="font-size:12px; color:var(--muted);">Total Leads</div>
            </div>
            <div style="padding:8px 16px; background:var(--glass); border-radius:8px; text-align:center;">
              <div style="font-size:24px; font-weight:700; color:var(--ok);" id="active-leads-count">--</div>
              <div style="font-size:12px; color:var(--muted);">Ativos</div>
            </div>
            <div style="padding:8px 16px; background:var(--glass); border-radius:8px; text-align:center;">
              <div style="font-size:24px; font-weight:700; color:var(--warn);" id="conversion-rate">--%</div>
              <div style="font-size:12px; color:var(--muted);">Taxa Conv.</div>
            </div>
          </div>
        </div>

        <!-- Filters & Search -->
        <div class="card" style="margin-bottom:20px;">
          <div style="display:grid; grid-template-columns:1fr 200px 200px 150px auto; gap:16px; align-items:end;">
            <div>
              <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600; color:var(--text);">üîç Busca Inteligente</label>
              <input id="lead-search" class="input" placeholder="Nome, email, telefone, cidade..." style="font-size:14px;"/>
            </div>
            <div>
              <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600; color:var(--text);">Status</label>
              <select id="status-filter" class="input" style="font-size:14px;">
                <option value="">Todos</option>
                <option value="novo">üü° Novo</option>
                <option value="ativo">üü¢ Ativo</option>
                <option value="standby">üü† Standby</option>
                <option value="cancelado">üî¥ Cancelado</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600; color:var(--text);">Ordenar por</label>
              <select id="sort-filter" class="input" style="font-size:14px;">
                <option value="name">Nome A-Z</option>
                <option value="status">Status</option>
                <option value="city">Cidade</option>
                <option value="recent">Mais Recentes</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600; color:var(--text);">Visualiza√ß√£o</label>
              <div style="display:flex; border:1px solid var(--border); border-radius:6px; overflow:hidden;">
                <button id="view-table" style="padding:8px 12px; border:none; background:var(--primary-color); color:white; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:4px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>Lista</button>
                <button id="view-grid" style="padding:8px 12px; border:none; background:var(--glass); color:var(--text); cursor:pointer; font-size:12px; display:flex; align-items:center; gap:4px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Grid</button>
              </div>
            </div>
            <button class="btn" id="lead-refresh" style="padding:8px 16px; font-size:14px;">
              <i class="fas fa-sync-alt" style="margin-right:6px;"></i>Atualizar
            </button>
            <button class="btn" onclick="testAPI()" style="padding:8px 16px; font-size:14px; background:var(--err); color:white; margin-left:8px;">
              üî• TESTE API
            </button>
            <button class="btn" id="campaign-button" style="padding:8px 16px; font-size:14px; background:linear-gradient(135deg, var(--ok), var(--cyan)); color:white;" onclick="openCampaignModal()">
              <i class="fas fa-rocket" style="margin-right:6px;"></i>Campanha
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div class="split" style="gap:20px;">
          <!-- Leads Table/Grid -->
          <div class="card" style="flex:2;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
              <div>
                <div class="label" style="font-size:18px; font-weight:600; color:var(--text); display:flex; align-items:center; gap:8px;"><svg style="width:20px;height:20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>Lista de Leads</div>
                <div id="leads-summary" style="font-size:13px; color:var(--muted); margin-top:4px;"></div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn" style="padding:6px 12px; font-size:12px;">
                  <i class="fas fa-download" style="margin-right:4px;"></i>Exportar
                </button>
                <button class="btn" style="padding:6px 12px; font-size:12px;">
                  <i class="fas fa-plus" style="margin-right:4px;"></i>Novo Lead
                </button>
              </div>
            </div>
            
            <div id="leads-container">
              <!-- Table View -->
              <div id="leads-table-view" style="max-height:500px; overflow-y:auto; border:1px solid var(--border); border-radius:8px;">
                <div id="leads-table-header" style="display:grid; grid-template-columns:2.5fr 2fr 1.8fr 1.2fr 1fr 100px; gap:12px; padding:12px 16px; background:var(--glass); font-weight:600; font-size:12px; color:var(--muted); text-transform:uppercase; border-bottom:1px solid var(--border);">
                  <div>üë§ Lead & Categoria</div>
                  <div style="display:flex; align-items:center; gap:6px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z"/></svg> Contato</div>
                  <div style="display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>Localiza√ß√£o & CEP</div>
                  <div style="display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M17 13H11V7H12.5V11.5H17V13Z"/></svg>Oportunidade IA</div>
                  <div style="display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Status</div>
                  <div style="display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 8v6m-6-6h6m8 0h-6"/></svg>A√ß√µes</div>
                </div>
                <div id="leads-table-body"></div>
              </div>
              
              <!-- Grid View (Hidden by default) -->
              <div id="leads-grid-view" style="display:none; max-height:500px; overflow-y:auto;">
                <div id="leads-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:16px;"></div>
              </div>
            </div>
          </div>

          <!-- Side Panel -->
          <div style="flex:1; display:flex; flex-direction:column; gap:20px;">
            <!-- Quick Stats -->
            <div class="card">
              <div class="label" style="margin-bottom:12px; font-size:16px; font-weight:600; display:flex; align-items:center; gap:8px;"><svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>Analytics em Tempo Real</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div style="padding:12px; background:linear-gradient(135deg, var(--ok)15, var(--ok)05); border-radius:8px; text-align:center;">
                  <div style="font-size:20px; font-weight:700; color:var(--ok);" id="leads-today">0</div>
                  <div style="font-size:11px; color:var(--muted);">Hoje</div>
                </div>
                <div style="padding:12px; background:linear-gradient(135deg, var(--primary-color)15, var(--primary-color)05); border-radius:8px; text-align:center;">
                  <div style="font-size:20px; font-weight:700; color:var(--primary-color);" id="leads-week">0</div>
                  <div style="font-size:11px; color:var(--muted);">Esta Semana</div>
                </div>
                <div style="padding:12px; background:linear-gradient(135deg, var(--warn)15, var(--warn)05); border-radius:8px; text-align:center;">
                  <div style="font-size:20px; font-weight:700; color:var(--warn);" id="leads-hot">0</div>
                  <div style="font-size:11px; color:var(--muted);">Hot Leads</div>
                </div>
                <div style="padding:12px; background:linear-gradient(135deg, var(--violet)15, var(--violet)05); border-radius:8px; text-align:center;">
                  <div style="font-size:20px; font-weight:700; color:var(--violet);" id="leads-converted">0</div>
                  <div style="font-size:11px; color:var(--muted);">Convertidos</div>
                </div>
              </div>
            </div>

            <!-- Geographic Distribution -->
            <div class="card">
              <div class="label" style="margin-bottom:12px; font-size:16px; font-weight:600;">üó∫Ô∏è Distribui√ß√£o Geogr√°fica</div>
              <div id="geographic-chart" style="height:200px; background:var(--glass); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--muted);">
                <div style="text-align:center;">
                  <i class="fas fa-map-marked-alt" style="font-size:48px; opacity:0.3; margin-bottom:8px;"></i>
                  <div style="font-size:14px;">Mapa interativo</div>
                  <div style="font-size:12px;">Carregando dados...</div>
                </div>
              </div>
            </div>

            <!-- Lead Status Distribution -->
            <div class="card">
              <div class="label" style="margin-bottom:12px; font-size:16px; font-weight:600; display:flex; align-items:center; gap:8px;"><svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Status dos Leads</div>
              <div id="status-distribution" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Funil de Convers√£o Pro ===== -->
      <section id="tab-funnel" class="tab">
        <!-- === VAGALUMES TECNOL√ìGICOS === -->
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>

        <!-- Header -->
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
          <div>
            <h1 style="margin:0 0 8px; font-size:32px; font-weight:700; font-family: 'Orbitron', sans-serif; letter-spacing: 1.5px; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; display:flex; align-items:center; gap:12px;">
              <svg style="width:32px;height:32px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 4h18l-6 10v6h-6v-6l-6-10z"/>
              </svg>
              ORBION Sales Funnel
            </h1>
            <p style="margin:0; color:var(--muted); font-size:16px; font-family: 'Orbitron', sans-serif; letter-spacing: 0.5px;">Advanced Conversion Analytics & Sales Optimization Intelligence</p>
          </div>
          <div style="display:flex; gap:12px; align-items:center;">
            <select id="funnel-period" class="input" style="padding:8px 12px; font-size:14px;">
              <option value="7d">Last 7 days</option>
              <option value="30d" selected>Last 30 days</option>
              <option value="90d">Last 90 days</option>
              <option value="all">All time</option>
            </select>
            <button class="btn" style="padding:8px 16px; font-size:14px;" onclick="loadFunnel()">
              <i class="fas fa-sync-alt" style="margin-right:6px;"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Overview Cards -->
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-bottom:24px;">
          <div class="card" style="padding:20px; text-align:center; background:linear-gradient(135deg, var(--primary-color)10, var(--primary-color)05);">
            <div style="font-size:28px; font-weight:700; color:var(--primary-color); margin-bottom:4px;" id="funnel-total-leads">0</div>
            <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Lead Volume</div>
            <div style="font-size:11px; color:var(--ok);">
              <i class="fas fa-arrow-up" style="margin-right:4px;"></i>
              <span id="funnel-leads-growth">+0%</span> vs per√≠odo anterior
            </div>
          </div>
          <div class="card" style="padding:20px; text-align:center; background:linear-gradient(135deg, var(--ok)10, var(--ok)05);">
            <div style="font-size:28px; font-weight:700; color:var(--ok); margin-bottom:4px;" id="funnel-conversion-rate">0%</div>
            <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Conversion Rate</div>
            <div style="font-size:11px; color:var(--ok);">
              <i class="fas fa-arrow-up" style="margin-right:4px;"></i>
              <span id="funnel-conversion-growth">+0%</span> vs per√≠odo anterior
            </div>
          </div>
          <div class="card" style="padding:20px; text-align:center; background:linear-gradient(135deg, var(--warn)10, var(--warn)05);">
            <div style="font-size:28px; font-weight:700; color:var(--warn); margin-bottom:4px;" id="funnel-avg-time">0d</div>
            <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Avg. Cycle Time</div>
            <div style="font-size:11px; color:var(--ok);">
              <i class="fas fa-arrow-down" style="margin-right:4px;"></i>
              <span id="funnel-time-improvement">-0%</span> vs per√≠odo anterior
            </div>
          </div>
          <div class="card" style="padding:20px; text-align:center; background:linear-gradient(135deg, var(--violet)10, var(--violet)05);">
            <div style="font-size:28px; font-weight:700; color:var(--violet); margin-bottom:4px;" id="funnel-revenue">R$0</div>
            <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Pipeline Value</div>
            <div style="font-size:11px; color:var(--ok);">
              <i class="fas fa-arrow-up" style="margin-right:4px;"></i>
              <span id="funnel-revenue-growth">+0%</span> vs per√≠odo anterior
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div style="width:100%; display:flex; justify-content:center;">
          <!-- Funil Visual -->
          <div class="card" style="width:100%; max-width:1200px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
              <div class="label" style="font-size:18px; font-weight:600; display:flex; align-items:center; gap:8px;">
                <svg style="width:20px;height:20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 4h18l-6 10v6h-6v-6l-6-10z"/>
                </svg>
                Interactive Conversion Pipeline
              </div>
              <div style="display:flex; gap:8px;">
                <button id="funnel-view-funnel" class="btn" style="padding:6px 12px; background:var(--primary-color); color:white; font-size:12px; display:flex; align-items:center; gap:4px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 4h18l-6 10v6h-6v-6l-6-10z"/></svg>Funnel</button>
                <button id="funnel-view-bars" class="btn" style="padding:6px 12px; background:var(--glass); color:var(--text); font-size:12px; display:flex; align-items:center; gap:4px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>Chart</button>
                <button id="funnel-view-flow" class="btn" style="padding:6px 12px; background:var(--glass); color:var(--text); font-size:12px; display:flex; align-items:center; gap:4px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 12l5 5L20 7"/></svg>Flow</button>
              </div>
            </div>

            <!-- Modern 3D Funnel Visualization Container -->
            <div id="funnel-chart-container" style="position:relative; height:500px; perspective:1000px; overflow:hidden;">
              <!-- Premium 3D Funnel View -->
              <div id="funnel-traditional" style="display:block; height:100%; position:relative;">
                <div id="funnel-stages" style="display:flex; flex-direction:column; gap:20px; height:100%; justify-content:center; padding:30px 0; position:relative; transform-style:preserve-3d;"></div>

                <!-- 3D Background Effects -->
                <div style="position:absolute; top:0; left:0; right:0; bottom:0; background:radial-gradient(ellipse 80% 50% at 50% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 70%); pointer-events:none; z-index:0;"></div>
                <div style="position:absolute; top:10%; left:10%; width:80%; height:80%; background:linear-gradient(45deg, transparent 48%, rgba(255, 255, 255, 0.02) 49%, rgba(255, 255, 255, 0.02) 51%, transparent 52%); pointer-events:none; z-index:0; animation:shimmer 3s infinite linear;"></div>
              </div>

              <!-- Interactive 3D Bar Chart View -->
              <div id="funnel-bars" style="display:none; height:100%; perspective:800px;">
                <div id="funnel-bar-chart" style="height:100%; display:flex; align-items:end; gap:20px; padding:40px; transform-style:preserve-3d; justify-content:center;"></div>
              </div>

              <!-- Advanced Flow Diagram View -->
              <div id="funnel-flow" style="display:none; height:100%; position:relative;">
                <div id="funnel-flow-chart" style="height:100%; display:flex; align-items:center; justify-content:center; position:relative;">
                  <!-- Animated Flow Network -->
                  <svg width="100%" height="100%" style="position:absolute; top:0; left:0;">
                    <defs>
                      <linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:var(--primary-color);stop-opacity:0.8"/>
                        <stop offset="50%" style="stop-color:var(--secondary-color);stop-opacity:0.6"/>
                        <stop offset="100%" style="stop-color:var(--violet);stop-opacity:0.4"/>
                      </linearGradient>
                      <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                          <feMergeNode in="coloredBlur"/>
                          <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                      </filter>
                    </defs>
                    <path id="flow-path" d="M 100 50 Q 200 100 300 50 T 500 50" stroke="url(#flowGradient)" stroke-width="3" fill="none" filter="url(#glow)" opacity="0.7"/>
                  </svg>
                  <div style="text-align:center; z-index:2; position:relative; background:rgba(var(--bg-rgb), 0.9); padding:30px; border-radius:20px; backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.1);">
                    <div style="font-size:48px; margin-bottom:16px; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation:pulse 2s infinite;">‚ö°</div>
                    <div style="font-size:18px; font-weight:600; color:var(--text); margin-bottom:8px;">Fluxo Inteligente de Convers√£o</div>
                    <div style="font-size:14px; color:var(--muted);">An√°lise avan√ßada de jornada do cliente</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Calendar ===== -->
      <section id="tab-calendar" class="tab">
        <!-- === VAGALUMES TECNOL√ìGICOS === -->
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>
        <div class="firefly"></div>

        <!-- Calendar header -->
        <div class="calendar-header">
          <div>
            <h1 style="margin: 0 0 8px; font-size: 32px; font-weight: 700; font-family: 'Orbitron', sans-serif; letter-spacing: 1.5px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; color: transparent; display: flex; align-items: center; gap: 12px;">
              <svg style="width: 32px; height: 32px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              ORBION Calendar
            </h1>
            <p style="margin: 0; color: var(--muted); font-size: 16px; font-family: 'Orbitron', sans-serif; letter-spacing: 0.5px;">Intelligent Schedule Management & Event Coordination</p>
          </div>
          <div class="calendar-controls">
            <div class="calendar-nav">
              <button id="calendar-prev" class="btn-nav">‚Üê</button>
              <h2 id="calendar-title" style="font-family: 'Orbitron', sans-serif; font-size: 20px; font-weight: 700; color: var(--primary-color); text-align: center; min-width: 200px; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(102, 126, 234, 0.3); margin: 0;">Janeiro 2024</h2>
              <button id="calendar-next" class="btn-nav">‚Üí</button>
            </div>
            <div class="calendar-actions">
              <button id="calendar-today" class="btn">Hoje</button>
              <button id="btn-new-event" class="btn">+ Novo Evento</button>
            </div>
          </div>
        </div>

        <!-- Calendar Professional Interface -->
        <div class="calendar-professional-container">

          <!-- Calendar Header Professional -->
          <div class="calendar-professional-header">
            <div class="calendar-title-section">
              <h2 id="calendar-current-month">Janeiro 2024</h2>
              <div class="calendar-navigation">
                <button id="calendar-prev-month" class="calendar-nav-btn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15,18 9,12 15,6"></polyline>
                  </svg>
                </button>
                <button id="calendar-today-btn" class="calendar-today-btn">Hoje</button>
                <button id="calendar-next-month" class="calendar-nav-btn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                  </svg>
                </button>
              </div>
            </div>

            <div class="calendar-actions-section">
              <div class="calendar-view-switcher">
                <button id="calendar-month-btn" class="view-btn active" data-view="month">M√™s</button>
                <button id="calendar-week-btn" class="view-btn" data-view="week">Semana</button>
                <button id="calendar-agenda-btn" class="view-btn" data-view="agenda">Agenda</button>
              </div>
              <button id="calendar-new-event" class="calendar-primary-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Novo Evento
              </button>
            </div>
          </div>

          <!-- Calendar Main Content -->
          <div class="calendar-professional-content">

            <!-- Calendar Grid -->
            <div class="calendar-grid-container">
              <!-- Month View -->
              <div id="calendar-month-view-pro" class="calendar-view-pro active">
                <div class="calendar-weekdays-pro">
                  <div class="weekday-header">Domingo</div>
                  <div class="weekday-header">Segunda</div>
                  <div class="weekday-header">Ter√ßa</div>
                  <div class="weekday-header">Quarta</div>
                  <div class="weekday-header">Quinta</div>
                  <div class="weekday-header">Sexta</div>
                  <div class="weekday-header">S√°bado</div>
                </div>
                <div id="calendar-days-pro" class="calendar-days-pro">
                  <!-- Calendar days will be populated by JavaScript -->
                </div>
              </div>

              <!-- Week View -->
              <div id="calendar-week-view-pro" class="calendar-view-pro">
                <div class="week-time-grid">
                  <div class="week-hours">
                    <div class="hour-slot" data-hour="08">08:00</div>
                    <div class="hour-slot" data-hour="09">09:00</div>
                    <div class="hour-slot" data-hour="10">10:00</div>
                    <div class="hour-slot" data-hour="11">11:00</div>
                    <div class="hour-slot" data-hour="12">12:00</div>
                    <div class="hour-slot" data-hour="13">13:00</div>
                    <div class="hour-slot" data-hour="14">14:00</div>
                    <div class="hour-slot" data-hour="15">15:00</div>
                    <div class="hour-slot" data-hour="16">16:00</div>
                    <div class="hour-slot" data-hour="17">17:00</div>
                    <div class="hour-slot" data-hour="18">18:00</div>
                  </div>
                  <div class="week-days-grid" id="week-days-grid">
                    <!-- Week days will be populated -->
                  </div>
                </div>
              </div>

              <!-- Agenda View -->
              <div id="calendar-agenda-view-pro" class="calendar-view-pro">
                <div class="agenda-container">
                  <div class="agenda-section">
                    <h3>Pr√≥ximos Eventos</h3>
                    <div id="agenda-upcoming-events" class="agenda-events-list">
                      <!-- Upcoming events -->
                    </div>
                  </div>
                  <div class="agenda-section">
                    <h3>Esta Semana</h3>
                    <div id="agenda-week-events" class="agenda-events-list">
                      <!-- Week events -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Calendar Sidebar -->
            <div class="calendar-professional-sidebar">

              <!-- Mini Calendar -->
              <div class="mini-calendar-pro">
                <div class="mini-calendar-header-pro">
                  <button id="mini-prev-pro" class="mini-nav-btn">‚Äπ</button>
                  <h4 id="mini-calendar-title-pro">Jan 2024</h4>
                  <button id="mini-next-pro" class="mini-nav-btn">‚Ä∫</button>
                </div>
                <div class="mini-calendar-grid-pro" id="mini-calendar-grid-pro">
                  <!-- Mini calendar populated by JS -->
                </div>
              </div>

              <!-- Event Details -->
              <div class="event-details-panel">
                <h4>Detalhes do Evento</h4>
                <div id="selected-event-details" class="event-details-content">
                  <div class="no-event-selected">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <p>Selecione um evento para ver os detalhes</p>
                  </div>
                </div>
              </div>

              <!-- Quick Stats -->
              <div class="calendar-quick-stats">
                <h4>Estat√≠sticas</h4>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-number" id="stats-today-events">0</span>
                    <span class="stat-label">Hoje</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number" id="stats-week-events">0</span>
                    <span class="stat-label">Esta Semana</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number" id="stats-month-events">0</span>
                    <span class="stat-label">Este M√™s</span>
                  </div>
                </div>
              </div>

              <!-- Calendar Filters -->
              <div class="calendar-filters">
                <h4>Filtros</h4>
                <div class="filter-options">
                  <label class="filter-checkbox">
                    <input type="checkbox" id="filter-meetings" checked>
                    <span class="filter-color" style="background: var(--primary-color);"></span>
                    Reuni√µes
                  </label>
                  <label class="filter-checkbox">
                    <input type="checkbox" id="filter-events" checked>
                    <span class="filter-color" style="background: var(--ok);"></span>
                    Eventos
                  </label>
                  <label class="filter-checkbox">
                    <input type="checkbox" id="filter-deadlines" checked>
                    <span class="filter-color" style="background: var(--warn);"></span>
                    Prazos
                  </label>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- ===== ABA LATERAL DE CADASTRO DE LEADS ===== -->
    <aside id="leads-sidebar" class="leads-sidebar">
      <div class="leads-sidebar-header">
        <div class="leads-sidebar-title">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="1.6" d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path stroke-width="1.6" d="M23 21v-2a4 4 0 0 0-4-4h-1"/>
            <circle cx="16" cy="3" r="4"/>
          </svg>
          <h3>Cadastro de Lead</h3>
        </div>
        <button id="close-leads-sidebar" class="close-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="18" y1="6" x2="6" y2="18" stroke-width="2"/>
            <line x1="6" y1="6" x2="18" y2="18" stroke-width="2"/>
          </svg>
        </button>
      </div>

      <div class="leads-sidebar-content">
        <!-- Informa√ß√µes B√°sicas -->
        <div class="leads-section">
          <div class="section-title">üì± Informa√ß√µes B√°sicas</div>
          <div class="form-group">
            <label for="lead-name">Nome Completo</label>
            <input type="text" id="lead-name" class="form-input" placeholder="Digite o nome completo">
          </div>
          <div class="form-group">
            <label for="lead-whatsapp">WhatsApp</label>
            <input type="text" id="lead-whatsapp" class="form-input" placeholder="5584999999999">
          </div>
          <div class="form-group">
            <label for="lead-email">Email</label>
            <input type="email" id="lead-email" class="form-input" placeholder="contato@empresa.com">
          </div>
        </div>

        <!-- Informa√ß√µes da Empresa -->
        <div class="leads-section">
          <div class="section-title">üè¢ Empresa</div>
          <div class="form-group">
            <label for="lead-company">Nome da Empresa</label>
            <input type="text" id="lead-company" class="form-input" placeholder="Nome da empresa">
          </div>
          <div class="form-group">
            <label for="lead-position">Cargo</label>
            <input type="text" id="lead-position" class="form-input" placeholder="CEO, Gerente, etc.">
          </div>
          <div class="form-group">
            <label for="lead-segment">Segmento</label>
            <select id="lead-segment" class="form-input">
              <option value="">Selecionar segmento</option>
              <option value="varejo">Varejo</option>
              <option value="servicos">Servi√ßos</option>
              <option value="industria">Ind√∫stria</option>
              <option value="tecnologia">Tecnologia</option>
              <option value="saude">Sa√∫de</option>
              <option value="educacao">Educa√ß√£o</option>
              <option value="outros">Outros</option>
            </select>
          </div>
        </div>

        <!-- Qualifica√ß√£o -->
        <div class="leads-section">
          <div class="section-title">üéØ Qualifica√ß√£o</div>
          <div class="form-group">
            <label for="lead-interest">Interesse Principal</label>
            <select id="lead-interest" class="form-input">
              <option value="">Selecionar interesse</option>
              <option value="automacao">Automa√ß√£o de WhatsApp</option>
              <option value="crm">Sistema CRM</option>
              <option value="agente-ia">Agente de IA</option>
              <option value="consultoria">Consultoria Digital</option>
              <option value="integracao">Integra√ß√£o de Sistemas</option>
            </select>
          </div>
          <div class="form-group">
            <label for="lead-budget">Or√ßamento Estimado</label>
            <select id="lead-budget" class="form-input">
              <option value="">Selecionar faixa</option>
              <option value="ate-1k">At√© R$ 1.000</option>
              <option value="1k-5k">R$ 1.000 - R$ 5.000</option>
              <option value="5k-10k">R$ 5.000 - R$ 10.000</option>
              <option value="10k-plus">Acima de R$ 10.000</option>
            </select>
          </div>
          <div class="form-group">
            <label for="lead-urgency">Urg√™ncia</label>
            <select id="lead-urgency" class="form-input">
              <option value="">Selecionar urg√™ncia</option>
              <option value="imediata">Imediata (esta semana)</option>
              <option value="curto-prazo">Curto prazo (este m√™s)</option>
              <option value="medio-prazo">M√©dio prazo (3 meses)</option>
              <option value="longo-prazo">Longo prazo (6+ meses)</option>
            </select>
          </div>
        </div>

        <!-- Observa√ß√µes -->
        <div class="leads-section">
          <div class="section-title">üìù Observa√ß√µes</div>
          <div class="form-group">
            <label for="lead-notes">Anota√ß√µes do Agente</label>
            <textarea id="lead-notes" class="form-input" rows="4" placeholder="Observa√ß√µes e contexto da conversa..."></textarea>
          </div>
        </div>

        <!-- A√ß√µes -->
        <div class="leads-section">
          <div class="section-title">üéØ Pr√≥ximas A√ß√µes</div>
          <div class="form-group action-buttons">
            <button id="save-lead" class="btn-primary">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline stroke-width="2" points="17,21 17,13 7,13 7,21"/>
                <polyline stroke-width="2" points="7,3 7,8 15,8"/>
              </svg>
              Salvar Lead
            </button>
            <button id="send-whatsapp-followup" class="btn">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path stroke-width="2" d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path stroke-width="2" d="m8 12 2 2 4-4"/>
              </svg>
              Enviar Follow-up
            </button>
            <button id="schedule-meeting" class="btn">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke-width="2"/>
                <line x1="16" y1="2" x2="16" y2="6" stroke-width="2"/>
                <line x1="8" y1="2" x2="8" y2="6" stroke-width="2"/>
                <line x1="3" y1="10" x2="21" y2="10" stroke-width="2"/>
              </svg>
              Agendar Reuni√£o
            </button>
          </div>
        </div>

        <!-- Feedback -->
        <div id="leads-feedback" class="leads-feedback"></div>
      </div>
    </aside>

    <!-- Overlay para mobile -->
    <div id="leads-sidebar-overlay" class="leads-sidebar-overlay"></div>

  </div>

  <!-- Chat flutuante integrado -->
  <div id="chat-float" class="chat-float minimized">
    <div class="chat-float-header" id="chat-float-header">
      <span>Chat ORBION</span>
      <button id="chat-float-toggle">‚¨Ü</button>
    </div>
    <div class="chat-float-messages" id="chat-float-messages"></div>
    <div class="chat-float-input-row">
      <input id="chat-float-input" class="input" placeholder="Diga algo ao ORBION..." />
      <button class="btn-primary" id="chat-float-send">Enviar</button>
      <button class="btn" id="chat-float-mic">üé§</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Heatmap plugin para Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

  <script>
  // Matrix removido - personaliza√ß√£o agora √© din√¢mica

  // ===== Navega√ß√£o entre abas =====
  // Sistema de inicializa√ß√£o otimizado (debug reduzido para produ√ß√£o)
  if (window.ORBION_DEBUG) {
    console.log('üìç SCRIPT CARREGADO - Verificando estado inicial...');
    console.log('üìç DOM Ready State:', document.readyState);
  }
  console.log('üìç User Agent:', navigator.userAgent);
  
  // ===== THEME SYSTEM - MOVED BEFORE DOM READY TO ENSURE AVAILABILITY =====
  const predefinedThemes = {
    default: {
      brandName: 'ORBION',
      primaryColor: '#667eea',
      secondaryColor: '#764ba2',
      accentColor: '#4facfe',
      dashboardBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
    },
    dark: {
      brandName: 'ORBION',
      primaryColor: '#2d3748',
      secondaryColor: '#1a202c',
      accentColor: '#4299e1',
      dashboardBg: 'linear-gradient(135deg, #2d3748 0%, #1a202c 100%)'
    },
    ocean: {
      brandName: 'ORBION',
      primaryColor: '#0ea5e9',
      secondaryColor: '#0284c7',
      accentColor: '#0891b2',
      dashboardBg: 'linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%)'
    },
    sunset: {
      brandName: 'ORBION',
      primaryColor: '#f97316',
      secondaryColor: '#ea580c',
      accentColor: '#dc2626',
      dashboardBg: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)'
    },
    // === Tech Professional Themes ===
    cyberpunk: {
      brandName: 'ORBION',
      primaryColor: '#ff0080',
      secondaryColor: '#00ff88',
      accentColor: '#8000ff',
      dashboardBg: 'linear-gradient(135deg, #1a0033 0%, #000011 100%)'
    },
    neon: {
      brandName: 'ORBION',
      primaryColor: '#00d9ff',
      secondaryColor: '#ff6b00',
      accentColor: '#00ff94',
      dashboardBg: 'linear-gradient(135deg, #0a0a0a 0%, #1a0033 100%)'
    },
    matrix: {
      brandName: 'ORBION',
      primaryColor: '#00ff41',
      secondaryColor: '#008f11',
      accentColor: '#39ff14',
      dashboardBg: 'linear-gradient(135deg, #0d1421 0%, #000000 100%)'
    },
    hologram: {
      brandName: 'ORBION',
      primaryColor: '#00ffff',
      secondaryColor: '#0099cc',
      accentColor: '#66ccff',
      dashboardBg: 'linear-gradient(135deg, #001122 0%, #003344 100%)'
    },
    plasma: {
      brandName: 'ORBION',
      primaryColor: '#ff6ec7',
      secondaryColor: '#7b68ee',
      accentColor: '#4169e1',
      dashboardBg: 'linear-gradient(135deg, #2d1b69 0%, #11103e 100%)'
    },

    // === Modern Business Themes ===
    corporate: {
      brandName: 'ORBION',
      primaryColor: '#1e40af',
      secondaryColor: '#1e3a8a',
      accentColor: '#3b82f6',
      dashboardBg: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)'
    },
    minimal: {
      brandName: 'ORBION',
      primaryColor: '#374151',
      secondaryColor: '#1f2937',
      accentColor: '#6b7280',
      dashboardBg: 'linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'
    },
    executive: {
      brandName: 'ORBION',
      primaryColor: '#0f172a',
      secondaryColor: '#1e293b',
      accentColor: '#475569',
      dashboardBg: 'linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%)'
    },

    // === Gaming & Entertainment ===
    gaming: {
      brandName: 'ORBION',
      primaryColor: '#dc2626',
      secondaryColor: '#7c2d12',
      accentColor: '#f97316',
      dashboardBg: 'linear-gradient(135deg, #0c0c0c 0%, #1c1c1c 100%)'
    },
    esports: {
      brandName: 'ORBION',
      primaryColor: '#8b5cf6',
      secondaryColor: '#7c3aed',
      accentColor: '#a78bfa',
      dashboardBg: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 100%)'
    },
    retro: {
      brandName: 'ORBION',
      primaryColor: '#ec4899',
      secondaryColor: '#be185d',
      accentColor: '#f472b6',
      dashboardBg: 'linear-gradient(135deg, #581c87 0%, #7c2d12 100%)'
    },

    // === Nature & Environment ===
    nature: {
      brandName: 'ORBION',
      primaryColor: '#16a34a',
      secondaryColor: '#15803d',
      accentColor: '#22c55e',
      dashboardBg: 'linear-gradient(135deg, #064e3b 0%, #14532d 100%)'
    },
    arctic: {
      brandName: 'ORBION',
      primaryColor: '#06b6d4',
      secondaryColor: '#0891b2',
      accentColor: '#67e8f9',
      dashboardBg: 'linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%)'
    },

    // === Creative & Design ===
    aurora: {
      brandName: 'ORBION',
      primaryColor: '#8b5cf6',
      secondaryColor: '#10b981',
      accentColor: '#06b6d4',
      dashboardBg: 'linear-gradient(135deg, #4c1d95 0%, #059669 100%)'
    },
    galaxy: {
      brandName: 'ORBION',
      primaryColor: '#7c3aed',
      secondaryColor: '#5b21b6',
      accentColor: '#a78bfa',
      dashboardBg: 'linear-gradient(135deg, #1e1b4b 0%, #581c87 100%)'
    },

    // === Dark Themes ===
    midnight: {
      brandName: 'ORBION',
      primaryColor: '#4338ca',
      secondaryColor: '#3730a3',
      accentColor: '#6366f1',
      dashboardBg: 'linear-gradient(135deg, #0f0f23 0%, #1e1e3f 100%)'
    },
    obsidian: {
      brandName: 'ORBION',
      primaryColor: '#059669',
      secondaryColor: '#047857',
      accentColor: '#10b981',
      dashboardBg: 'linear-gradient(135deg, #111827 0%, #1f2937 100%)'
    },

    // === AI & Future Tech ===
    neural: {
      brandName: 'ORBION',
      primaryColor: '#06b6d4',
      secondaryColor: '#0891b2',
      accentColor: '#22d3ee',
      dashboardBg: 'linear-gradient(135deg, #0c4a6e 0%, #075985 100%)'
    },
    quantum: {
      brandName: 'ORBION',
      primaryColor: '#a855f7',
      secondaryColor: '#9333ea',
      accentColor: '#c084fc',
      dashboardBg: 'linear-gradient(135deg, #581c87 0%, #7c2d12 100%)'
    },
    biotech: {
      brandName: 'ORBION',
      primaryColor: '#22c55e',
      secondaryColor: '#16a34a',
      accentColor: '#4ade80',
      dashboardBg: 'linear-gradient(135deg, #14532d 0%, #166534 100%)'
    }
  };

  function applyThemeToInputs(theme){
    const brandNameInput = document.getElementById('brand-name-input');
    const primaryColorInput = document.getElementById('primary-color');
    const secondaryColorInput = document.getElementById('secondary-color');
    const accentColorInput = document.getElementById('accent-color');
    const logoUrlInput = document.getElementById('logo-url-input');
    const backgroundTypeInput = document.getElementById('background-type');

    if(brandNameInput) brandNameInput.value = 'ORBION';
    if(primaryColorInput) primaryColorInput.value = theme.primaryColor || '#667eea';
    if(secondaryColorInput) secondaryColorInput.value = theme.secondaryColor || '#764ba2';
    if(accentColorInput) accentColorInput.value = theme.accentColor || '#4facfe';

    if(theme.logoUrl && logoUrlInput){
      logoUrlInput.value = theme.logoUrl;
      updateLogoPreview(theme.logoUrl);
    }

    if(theme.dashboardBg && backgroundTypeInput){
      if(theme.dashboardBg.includes('gradient')){
        backgroundTypeInput.value = 'gradient';
        showBackgroundOptions('gradient');
      }
    }
  }

  function applyTheme(theme){
    const root = document.documentElement;

    console.log('üé® Aplicando tema:', theme);

    // Aplicar cores principais
    root.style.setProperty('--custom-primary', theme.primaryColor);
    root.style.setProperty('--custom-secondary', theme.secondaryColor);
    root.style.setProperty('--custom-accent', theme.accentColor);
    root.style.setProperty('--custom-dashboard-bg', theme.dashboardBg);

    // TAMB√âM aplicar diretamente nas vari√°veis principais para efeito imediato
    root.style.setProperty('--primary-color', theme.primaryColor);
    root.style.setProperty('--secondary-color', theme.secondaryColor);
    root.style.setProperty('--accent-color', theme.accentColor);

    // FOR√áAR aplica√ß√£o com !important
    const style = document.createElement('style');
    style.innerHTML = `
      :root {
        --primary-color: ${theme.primaryColor} !important;
        --secondary-color: ${theme.secondaryColor} !important;
        --accent-color: ${theme.accentColor} !important;
        --dashboard-bg: ${theme.dashboardBg} !important;
      }
      body {
        background: ${theme.dashboardBg} !important;
      }
    `;

    // Remove estilo anterior se existir
    const oldStyle = document.getElementById('theme-override');
    if (oldStyle) oldStyle.remove();

    style.id = 'theme-override';
    document.head.appendChild(style);

    console.log('‚úÖ Tema aplicado com override CSS:', theme.primaryColor);

    // Aplicar cores harmonizadas automaticamente
    if(theme.successColor) root.style.setProperty('--custom-success', theme.successColor);
    if(theme.warningColor) root.style.setProperty('--custom-warning', theme.warningColor);
    if(theme.errorColor) root.style.setProperty('--custom-error', theme.errorColor);
    if(theme.mutedColor) root.style.setProperty('--custom-muted', theme.mutedColor);
    if(theme.textColor) root.style.setProperty('--custom-text', theme.textColor);
    if(theme.glassColor) root.style.setProperty('--custom-glass', theme.glassColor);
    if(theme.borderColor) root.style.setProperty('--custom-border', theme.borderColor);
    if(theme.bgPrimary) root.style.setProperty('--custom-bg-primary', theme.bgPrimary);
    if(theme.bgSecondary) root.style.setProperty('--custom-bg-secondary', theme.bgSecondary);

    const brandElement = document.getElementById('brand-name');
    if(brandElement){
      brandElement.textContent = 'ORBION';
    }

    if(theme.logoUrl){
      updateBrandLogo(theme.logoUrl);
    }
  }

  function updateLogoPreview(url){
    const preview = document.getElementById('logo-preview');
    if(preview && url && url.trim()){
      preview.innerHTML = `<img src="${url}" alt="Logo" style="max-width:100%; max-height:100%; object-fit:contain;">`;
    } else if(preview) {
      preview.innerHTML = 'Preview';
    }
  }

  function updateBrandLogo(url){
    const logoElement = document.querySelector('.brand .logo');
    if(logoElement && url && url.trim()){
      logoElement.style.backgroundImage = `url(${url})`;
      logoElement.style.backgroundSize = 'contain';
      logoElement.style.backgroundRepeat = 'no-repeat';
      logoElement.style.backgroundPosition = 'center';
    }
  }

  // ===== EXPOR FUN√á√ïES E VARI√ÅVEIS GLOBALMENTE PARA O SISTEMA DE VOZ =====
  window.predefinedThemes = predefinedThemes;
  window.applyTheme = applyTheme;
  window.applyThemeToInputs = applyThemeToInputs;

  console.log('üé® Tema system carregado ANTES do DOMContentLoaded - predefinedThemes dispon√≠vel:', !!predefinedThemes);

  // GARANTIR QUE TODO O SISTEMA DE NAVEGA√á√ÉO EXECUTE AP√ìS DOM CARREGAR
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOMContentLoaded disparado - Iniciando ORBION...');

    // For√ßar limpeza do localStorage para evitar problemas de tema
    localStorage.removeItem('dashboardTheme');
    console.log('üßπ localStorage limpo para evitar problemas de brand name');

    // Definir brand name inicial
    const brandElement = document.getElementById('brand-name');
    if(brandElement) {
      brandElement.textContent = 'ORBION';
      console.log('üè∑Ô∏è Brand name inicial definido:', brandElement.textContent);
    }
    
    // TESTE IMEDIATO DE ELEMENTOS
    console.log('üîç Testando elementos b√°sicos...');
    console.log('- document.getElementById("sidebar"):', !!document.getElementById('sidebar'));
    console.log('- document.querySelector(".menu"):', !!document.querySelector('.menu'));
    console.log('- document.querySelectorAll(".menu .item").length:', document.querySelectorAll('.menu .item').length);
    
    const tabs = {
      home: document.getElementById('tab-home'),
      stats: document.getElementById('tab-stats'),
      whatsapp: document.getElementById('tab-whatsapp'),
      customize: document.getElementById('tab-customize'),
      leads: document.getElementById('tab-leads'),
      funnel: document.getElementById('tab-funnel'),
      calendar: document.getElementById('tab-calendar')
    };
    
    // Verificar se todas as abas existem
    Object.entries(tabs).forEach(([key, element]) => {
      if (element) {
        console.log('‚úÖ Aba encontrada:', key);
      } else {
        console.error('‚ùå Aba n√£o encontrada:', key);
      }
    });
    
    const menuItems = document.querySelectorAll('.menu .item');
    console.log('üîç Total de itens do menu encontrados:', menuItems.length);
    
    menuItems.forEach((it, index) => {
      const tabName = it.getAttribute('data-tab');
      console.log('üìã Configurando evento para item', index + 1, ':', tabName);
      
      // Debug espec√≠fico para mobile
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      it.addEventListener('click', (e) => {
        const name = it.getAttribute('data-tab');

        console.log('üî• CLIQUE CAPTURADO na aba:', name);
        
        if (!name) {
          console.error('‚ùå Nome da aba n√£o encontrado');
          return;
        }
        
        // Atualizar visual dos itens do menu
        document.querySelectorAll('.menu .item').forEach(i => i.classList.remove('active'));
        it.classList.add('active');
        
        // Trocar abas
        Object.values(tabs).forEach(el => {
          if (el) el.classList.remove('active');
        });
        
        if (tabs[name]) {
          tabs[name].classList.add('active');
          console.log('‚úÖ Aba ativada com sucesso:', name);
        } else {
          console.error('‚ùå Aba n√£o encontrada no objeto tabs:', name);
        }
        
        // Fechar menu mobile automaticamente
        const sidebar = document.getElementById('sidebar');
        const brand = document.getElementById('brand');
        const mobileOverlay = document.getElementById('mobileOverlay');
        
        console.log('üîí Fechando menu mobile ap√≥s clique na aba:', name);
        if (sidebar) {
          sidebar.classList.remove('mobile-open');
          console.log('‚úÖ Menu mobile fechado');
        }
        if (brand) brand.classList.remove('mobile-open');
        if (mobileOverlay) mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
        
        // Carregar dados espec√≠ficos
        if(name === 'leads' && typeof loadLeads !== 'undefined'){
          console.log('üìã Carregando dados dos leads...');
          loadLeads();
        }
        if(name === 'funnel' && typeof loadFunnel !== 'undefined'){
          console.log('üìä Carregando dados do funil...');
          loadFunnel();
        }
        if(name === 'whatsapp' && typeof loadWhatsAppData !== 'undefined'){
          console.log('üì± Carregando dados do WhatsApp...');
          loadWhatsAppData();
        }
        if(name === 'customize'){
          console.log('‚öôÔ∏è Aba customize acessada - verificando theme cards...');
          setTimeout(() => {
            const themeCardsInTab = document.querySelectorAll('.theme-card');
            console.log('‚öôÔ∏è Theme cards encontrados na aba:', themeCardsInTab.length);
            if(themeCardsInTab.length === 0) {
              console.error('‚öôÔ∏è PROBLEMA: Nenhum theme card encontrado na aba customize!');
            }
          }, 100);

          if(typeof loadCustomizationSettings !== 'undefined'){
            console.log('‚öôÔ∏è Carregando configura√ß√µes...');
            loadCustomizationSettings();
          }
        }
        
        console.log('üéâ Navega√ß√£o conclu√≠da para:', name);
      });
      
      // Adicionar indicadores visuais e for√ßar estilos
      it.style.cursor = 'pointer';
      it.style.userSelect = 'none';
      it.style.pointerEvents = 'auto';
      it.style.position = 'relative';
      it.style.zIndex = '1000';
      
    });
    
    console.log('üéØ ORBION sistema de navega√ß√£o configurado com sucesso!');
    
    // FUN√á√ÉO DE TESTE MANUAL
    window.testarNavegacao = function(tabName) {
      console.log('üß™ TESTE MANUAL - Navegando para:', tabName);
      const item = document.querySelector(`.menu .item[data-tab="${tabName}"]`);
      if (item) {
        console.log('‚úÖ Item encontrado, simulando clique...');
        item.click();
      } else {
        console.error('‚ùå Item n√£o encontrado:', tabName);
      }
    };
    
    console.log('üí° Para testar manualmente, use: testarNavegacao("home")');

    // FUN√á√ÉO DE TESTE PARA THEMES
    window.testarTema = function(themeName) {
      console.log('üß™ TESTE MANUAL - Aplicando tema:', themeName);
      const themeCard = document.querySelector(`[data-theme="${themeName}"]`);
      if (themeCard) {
        console.log('‚úÖ Theme card encontrado, simulando clique...');
        themeCard.click();
      } else {
        console.error('‚ùå Theme card n√£o encontrado:', themeName);
        console.log('üîç Theme cards dispon√≠veis:');
        document.querySelectorAll('.theme-card').forEach(card => {
          console.log('  - ' + card.getAttribute('data-theme'));
        });
      }
    };

    console.log('üí° Para testar tema, use: testarTema("cyberpunk")');

    // TESTE AUTOM√ÅTICO PARA VERIFICAR SE OS TEMAS EST√ÉO FUNCIONANDO
    setTimeout(() => {
      console.log('üß™ TESTE AUTOM√ÅTICO - Verificando funcionamento dos temas...');
      const totalCards = document.querySelectorAll('.theme-card').length;
      console.log('üß™ Total de theme cards encontrados:', totalCards);

      if(totalCards > 0) {
        console.log('‚úÖ Theme cards carregados corretamente!');
        console.log('üß™ Testando aplica√ß√£o autom√°tica do tema cyberpunk...');

        // Teste autom√°tico do tema cyberpunk
        const cyberpunkCard = document.querySelector('[data-theme="cyberpunk"]');
        if(cyberpunkCard) {
          console.log('‚úÖ Card cyberpunk encontrado, testando clique...');
          cyberpunkCard.click();
          console.log('üß™ Clique simulado no tema cyberpunk');
        } else {
          console.error('‚ùå Card cyberpunk n√£o encontrado');
        }
      } else {
        console.error('‚ùå PROBLEMA: Nenhum theme card foi encontrado!');
      }
    }, 2000);

    // ===== Settings Navigation Event Listeners =====
    const settingsButtons = document.querySelectorAll('.settings-tab-btn');
    settingsButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const section = btn.getAttribute('data-section');
        showSettingsSection(section);
      });
    });

    // ===== THEME CARDS EVENT LISTENERS (movido para c√°) =====
    console.log('üé® Configurando event listeners para theme cards...');
    const themeCards = document.querySelectorAll('.theme-card');
    console.log('üé® Theme cards encontrados:', themeCards.length);

    themeCards.forEach((card, index)=>{
      const themeName = card.getAttribute('data-theme');
      console.log('üé® Configurando theme card', index + 1, ':', themeName);

      card.addEventListener('click', ()=>{
        console.log('üé® CLIQUE no theme card:', themeName);
        const theme = predefinedThemes[themeName];
        if(theme){
          console.log('üé® Tema encontrado:', theme);
          applyThemeToInputs(theme);
          applyTheme(theme);
          document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
          card.classList.add('active');
          console.log('üé® Tema aplicado com sucesso:', themeName);
        } else {
          console.error('üé® Tema n√£o encontrado:', themeName);
        }
      });
    });

    // ===== OUTROS EVENT LISTENERS DE CUSTOMIZA√á√ÉO =====
    // Background type change
    document.getElementById('background-type')?.addEventListener('change', (e)=>{
      showBackgroundOptions(e.target.value);
    });

    // Session timeout slider
    document.getElementById('session-timeout')?.addEventListener('input', (e)=>{
      const value = e.target.value;
      const display = value < 60 ? value + ' min' : Math.floor(value/60) + 'h ' + (value%60) + 'm';
      document.getElementById('session-value').textContent = display;
    });

    // Logo preview
    document.getElementById('logo-url-input')?.addEventListener('input', (e)=>{
      updateLogoPreview(e.target.value);
    });

    // Harmoniza√ß√£o autom√°tica ao mudar cor prim√°ria
    document.getElementById('primary-color')?.addEventListener('input', (e)=>{
      const harmony = generateColorHarmony(e.target.value);
      document.getElementById('secondary-color').value = harmony.secondary;
      document.getElementById('accent-color').value = harmony.accent;
      document.getElementById('gradient-start').value = harmony.primary;
      document.getElementById('gradient-end').value = harmony.secondary;
    });

    // Preview changes
    document.getElementById('preview-changes')?.addEventListener('click', ()=>{
      const theme = getCurrentTheme();
      applyTheme(theme);
    });

    // Apply changes
    document.getElementById('apply-changes')?.addEventListener('click', ()=>{
      const theme = getCurrentTheme();
      applyTheme(theme);
      localStorage.setItem('dashboardTheme', JSON.stringify(theme));
      alert('Tema aplicado com sucesso!');
    });

    // Reset theme
    document.getElementById('reset-theme')?.addEventListener('click', ()=>{
      const defaultTheme = predefinedThemes.default;
      applyThemeToInputs(defaultTheme);
      applyTheme(defaultTheme);
      localStorage.removeItem('dashboardTheme');
      document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
      document.querySelector('[data-theme="default"]').classList.add('active');
    });

    // Export theme
    document.getElementById('export-theme')?.addEventListener('click', ()=>{
      const theme = getCurrentTheme();
      const dataStr = JSON.stringify(theme, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'dashboard-theme.json';
      link.click();
      URL.revokeObjectURL(url);
      document.getElementById('theme-feedback').textContent = 'Tema exportado com sucesso!';
    });

    // Import theme
    document.getElementById('import-theme')?.addEventListener('click', ()=>{
      document.getElementById('theme-file-input').click();
    });

    document.getElementById('theme-file-input')?.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = (event) => {
          try{
            const theme = JSON.parse(event.target.result);
            theme.brandName = 'ORBION'; // For√ßar sempre ORBION
            applyThemeToInputs(theme);
            applyTheme(theme);
            document.getElementById('theme-feedback').textContent = 'Tema importado com sucesso!';
          } catch(error){
            document.getElementById('theme-feedback').textContent = 'Erro ao importar tema. Verifique o arquivo.';
          }
        };
        reader.readAsText(file);
      }
    });

    // Load saved theme on startup
    const savedTheme = localStorage.getItem('dashboardTheme');
    if(savedTheme){
      try{
        const theme = JSON.parse(savedTheme);
        theme.brandName = 'ORBION'; // For√ßar sempre ORBION
        applyTheme(theme);
      } catch(e){
        console.warn('Erro ao carregar tema salvo:', e);
      }
    }

    // ===== MENU MOBILE INTEGRADO =====
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const mobileSidebar = document.getElementById('sidebar');
    const mobileBrand = document.getElementById('brand');

    if (mobileMenuToggle && mobileSidebar && mobileBrand && mobileOverlay) {
      function toggleMobileMenu() {
        const isOpen = mobileSidebar.classList.contains('mobile-open');

        if (isOpen) {
          mobileSidebar.classList.remove('mobile-open');
          mobileBrand.classList.remove('mobile-open');
          mobileOverlay.classList.remove('active');
          document.body.style.overflow = '';
        } else {
          mobileSidebar.classList.add('mobile-open');
          mobileBrand.classList.add('mobile-open');
          mobileOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }

      mobileMenuToggle.addEventListener('click', toggleMobileMenu);
      mobileOverlay.addEventListener('click', toggleMobileMenu);

      // Ajustar ao redimensionar janela
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if (window.innerWidth > 767) {
            mobileSidebar.classList.remove('mobile-open');
            mobileBrand.classList.remove('mobile-open');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
          }
        }, 250);
      });

      console.log('Menu mobile integrado ao DOMContentLoaded principal - v2.4');
    }
  });


  // ===== Calend√°rio Moderno =====

  // Estado global do calend√°rio
  const calendar = {
    currentDate: new Date(),
    currentView: 'month',
    selectedDate: new Date(),
    events: [],
    miniCurrentDate: new Date()
  };

  // Elementos DOM
  const elements = {
    calendarTitle: document.getElementById('calendar-title'),  // T√≠tulo principal (existe linha 5188)
    miniCalendarTitle: document.getElementById('mini-calendar-title-pro'),  // CORRIGIDO: t√≠tulo mini-calend√°rio
    miniCalendarGrid: document.getElementById('mini-calendar-grid-pro'),  // CORRIGIDO: grid mini-calend√°rio
    calendarDays: document.getElementById('calendar-days-pro'),  // Grid de dias (existe linha 5252)
    weekGrid: document.getElementById('week-days-grid'),  // Grid semanal (existe linha 5273)
    weekDaysHeader: document.getElementById('week-days-header'),
    weekTimeSlots: document.getElementById('week-time-slots'),
    dayTimeline: document.getElementById('day-timeline'),
    dayViewTitle: document.getElementById('day-view-title'),
    selectedDateTitle: document.getElementById('selected-date-title'),
    dayEventsList: document.getElementById('agenda-upcoming-events'),  // Lista de eventos (existe linha 5284)
    eventModal: document.getElementById('event-modal'),
    modalTitle: document.getElementById('modal-title'),
    evFeedback: document.getElementById('ev-feedback')
  };

  // Nomes dos meses e dias
  const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

  // Inicializa√ß√£o
  function initCalendar() {
    setupEventListeners();
    updateCalendarTitle();
    renderMiniCalendar();
    renderCurrentView();
    loadEvents();
    updateSelectedDate();
  }

  // Event Listeners
  function setupEventListeners() {
    // Controles de vista
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => switchView(btn.dataset.view));
    });

    // Navega√ß√£o do calend√°rio principal
    document.getElementById('calendar-prev-month')?.addEventListener('click', () => navigateCalendar(-1));
    document.getElementById('calendar-next-month')?.addEventListener('click', () => navigateCalendar(1));
    document.getElementById('calendar-today-btn')?.addEventListener('click', () => goToToday());

    // Navega√ß√£o do mini calend√°rio
    document.getElementById('mini-prev-pro')?.addEventListener('click', () => navigateMiniCalendar(-1));
    document.getElementById('mini-next-pro')?.addEventListener('click', () => navigateMiniCalendar(1));

    // Modal de evento
    document.getElementById('create-event-btn').addEventListener('click', () => openEventModal());
    document.getElementById('modal-close').addEventListener('click', () => closeEventModal());
    document.getElementById('modal-backdrop').addEventListener('click', () => closeEventModal());
    document.getElementById('modal-cancel').addEventListener('click', () => closeEventModal());

    // A√ß√µes r√°pidas
    document.getElementById('quick-meeting').addEventListener('click', () => quickEvent('meeting'));
    document.getElementById('quick-reminder').addEventListener('click', () => quickEvent('reminder'));

    // Refresh
    document.getElementById('ag-refresh').addEventListener('click', loadEvents);
    document.getElementById('btn-refresh')?.addEventListener('click', ()=>{
      loadEvents();
      loadLeads();
      loadFunnel();
      loadWhatsAppData();
    });

    // Form de evento
    document.getElementById('event-form').addEventListener('submit', handleEventSubmit);
  }

  // Carregar eventos da API
  async function loadEvents() {
    try {
      console.log('üìÖ [CALENDAR] Carregando eventos da API...');
      const r = await fetch('/api/events');
      if (!r.ok) {
        console.warn('API /api/events n√£o autorizada ou sem token');
        return;
      }
      const j = await r.json();
      calendar.events = j.events || [];
      console.log(`üìÖ [CALENDAR] ${calendar.events.length} eventos carregados:`, calendar.events);
      renderCurrentView();
      renderMiniCalendar();
      updateDayEventsList();
    } catch (e) {
      console.error('‚ùå [CALENDAR] Erro ao carregar eventos:', e);
    }
  }

  // Trocar vista
  function switchView(view) {
    calendar.currentView = view;

    // Atualizar bot√µes
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === view);
    });

    // Atualizar conte√∫do - CORRIGIDO: usar classe correta
    document.querySelectorAll('.calendar-view-pro').forEach(content => {
      content.classList.toggle('active', content.id === `calendar-${view}-view-pro`);
    });

    renderCurrentView();
    updateCalendarTitle();
  }

  // Navega√ß√£o do calend√°rio
  function navigateCalendar(direction) {
    const { currentView, currentDate } = calendar;

    if (currentView === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (currentView === 'week') {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (currentView === 'day') {
      currentDate.setDate(currentDate.getDate() + direction);
    }

    updateCalendarTitle();
    renderCurrentView();
  }

  // Ir para hoje
  function goToToday() {
    calendar.currentDate = new Date();
    calendar.selectedDate = new Date();
    updateCalendarTitle();
    renderCurrentView();
    renderMiniCalendar();
    updateSelectedDate();
  }

  // Navega√ß√£o do mini calend√°rio
  function navigateMiniCalendar(direction) {
    calendar.miniCurrentDate.setMonth(calendar.miniCurrentDate.getMonth() + direction);
    renderMiniCalendar();
  }

  // Atualizar t√≠tulo do calend√°rio
  function updateCalendarTitle() {
    const { currentDate, currentView } = calendar;
    const month = monthNames[currentDate.getMonth()];
    const year = currentDate.getFullYear();

    let title;
    if (currentView === 'month') {
      title = `${month} ${year}`;
    } else if (currentView === 'week') {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
        title = `${startOfWeek.getDate()}-${endOfWeek.getDate()} ${month} ${year}`;
      } else {
        title = `${startOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthNames[endOfWeek.getMonth()]} ${year}`;
      }
    } else if (currentView === 'day') {
      title = `${currentDate.getDate()} ${month} ${year}`;
    }

    elements.calendarTitle.textContent = title;
  }

  // Renderizar mini calend√°rio
  function renderMiniCalendar() {
    const { miniCurrentDate } = calendar;
    const month = monthNames[miniCurrentDate.getMonth()];
    const year = miniCurrentDate.getFullYear();

    elements.miniCalendarTitle.textContent = `${month} ${year}`;

    const firstDay = new Date(miniCurrentDate.getFullYear(), miniCurrentDate.getMonth(), 1);
    const lastDay = new Date(miniCurrentDate.getFullYear(), miniCurrentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    let html = '';

    for (let week = 0; week < 6; week++) {
      for (let day = 0; day < 7; day++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + (week * 7) + day);

        const isToday = isDateToday(date);
        const isSelected = isDateSelected(date);
        const isOtherMonth = date.getMonth() !== miniCurrentDate.getMonth();
        const hasEvents = getEventsForDate(date).length > 0;

        const classes = [
          'mini-day',
          isToday && 'today',
          isSelected && 'selected',
          isOtherMonth && 'other-month',
          hasEvents && 'has-events'
        ].filter(Boolean).join(' ');

        html += `<div class="${classes}" data-date="${date.toISOString().split('T')[0]}" onclick="selectDate('${date.toISOString().split('T')[0]}')">${date.getDate()}</div>`;
      }
    }

    elements.miniCalendarGrid.innerHTML = html;
  }

  // Renderizar vista atual
  function renderCurrentView() {
    const { currentView } = calendar;

    if (currentView === 'month') {
      renderMonthView();
    } else if (currentView === 'week') {
      renderWeekView();
    } else if (currentView === 'day') {
      renderDayView();
    }
  }

  // Renderizar vista mensal
  function renderMonthView() {
    const { currentDate } = calendar;
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    let html = '';

    for (let week = 0; week < 6; week++) {
      for (let day = 0; day < 7; day++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + (week * 7) + day);

        const isToday = isDateToday(date);
        const isSelected = isDateSelected(date);
        const isOtherMonth = date.getMonth() !== currentDate.getMonth();
        const events = getEventsForDate(date);

        const classes = [
          'calendar-day',
          isToday && 'today',
          isSelected && 'selected',
          isOtherMonth && 'other-month'
        ].filter(Boolean).join(' ');

        const eventsHtml = events.slice(0, 3).map(event => {
          const type = event.type || 'meeting';
          return `<div class="event-mini event-type-${type}">${event.title}</div>`;
        }).join('');

        const moreEvents = events.length > 3 ? `<div class="event-mini">+${events.length - 3} mais</div>` : '';

        html += `
          <div class="${classes}" data-date="${date.toISOString().split('T')[0]}" onclick="selectDate('${date.toISOString().split('T')[0]}')">
            <div class="day-number">${date.getDate()}</div>
            <div class="day-events-mini">${eventsHtml}${moreEvents}</div>
          </div>
        `;
      }
    }

    elements.calendarDays.innerHTML = html;
  }

  // Renderizar vista semanal
  function renderWeekView() {
    const { currentDate } = calendar;
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

    // Cabe√ßalho dos dias
    let headerHtml = '';
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      const isToday = isDateToday(date);

      headerHtml += `
        <div class="week-day-header ${isToday ? 'today' : ''}" data-date="${date.toISOString().split('T')[0]}">
          <div>${dayNames[i]}</div>
          <div>${date.getDate()}</div>
        </div>
      `;
    }
    elements.weekDaysHeader.innerHTML = headerHtml;

    // Slots de tempo
    let timeSlotsHtml = '';
    for (let hour = 8; hour <= 22; hour++) {
      timeSlotsHtml += `<div class="time-slot">${hour.toString().padStart(2, '0')}:00</div>`;
    }
    elements.weekTimeSlots.innerHTML = timeSlotsHtml;

    // Grid de dias com eventos
    let gridHtml = '';
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      const events = getEventsForDate(date);

      let dayHtml = '';
      for (let hour = 8; hour <= 22; hour++) {
        dayHtml += `<div class="week-hour-slot" data-hour="${hour}"></div>`;
      }

      // Adicionar eventos
      events.forEach(event => {
        const startTime = new Date(event.start);
        const endTime = new Date(event.end || event.start);

        if (startTime.getDate() === date.getDate()) {
          const top = (startTime.getHours() - 8 + startTime.getMinutes()/60) * 60;
          const height = Math.max(30, ((endTime - startTime) / 3600000) * 60);
          const type = event.type || 'meeting';

          dayHtml += `
            <div class="week-event event-type-${type}"
                 style="top: ${top}px; height: ${height}px;"
                 onclick="editEvent('${event.id}')">
              <div>${startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
              <div>${event.title}</div>
            </div>
          `;
        }
      });

      gridHtml += `<div class="week-day-column">${dayHtml}</div>`;
    }
    elements.weekGrid.innerHTML = gridHtml;
  }

  // Renderizar vista di√°ria
  function renderDayView() {
    const { currentDate } = calendar;
    const dateStr = currentDate.toLocaleDateString('pt-BR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    elements.dayViewTitle.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

    // Timeline similar √† vista semanal mas para um dia apenas
    const events = getEventsForDate(currentDate);
    let timelineHtml = '';

    for (let hour = 8; hour <= 22; hour++) {
      const hourEvents = events.filter(event => {
        const startTime = new Date(event.start);
        return startTime.getHours() === hour;
      });

      let eventsHtml = '';
      hourEvents.forEach(event => {
        const startTime = new Date(event.start);
        const endTime = new Date(event.end || event.start);
        const type = event.type || 'meeting';

        eventsHtml += `
          <div class="day-event event-type-${type}" onclick="editEvent('${event.id}')">
            <div class="event-time-small">${startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
            <div class="event-title-small">${event.title}</div>
            ${event.location ? `<div class="event-location-small">${event.location}</div>` : ''}
          </div>
        `;
      });

      timelineHtml += `
        <div class="time-slot">${hour.toString().padStart(2, '0')}:00</div>
        <div class="day-hour-events">${eventsHtml}</div>
      `;
    }

    elements.dayTimeline.innerHTML = timelineHtml;
  }

  // Selecionar data
  function selectDate(dateStr) {
    calendar.selectedDate = new Date(dateStr + 'T00:00:00');
    calendar.currentDate = new Date(calendar.selectedDate);

    renderMiniCalendar();
    renderCurrentView();
    updateSelectedDate();
  }

  // Atualizar data selecionada
  function updateSelectedDate() {
    const { selectedDate } = calendar;
    const dateStr = selectedDate.toLocaleDateString('pt-BR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long'
    });

    elements.selectedDateTitle.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
    updateDayEventsList();
  }

  // Atualizar lista de eventos do dia
  function updateDayEventsList() {
    const events = getEventsForDate(calendar.selectedDate);

    if (events.length === 0) {
      elements.dayEventsList.innerHTML = `
        <div class="no-events">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>Nenhum evento</span>
        </div>
      `;
      return;
    }

    const eventsHtml = events.map(event => {
      const startTime = new Date(event.start);
      const endTime = new Date(event.end || event.start);

      return `
        <div class="event-item" onclick="editEvent('${event.id}')">
          <div class="event-time-small">${startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          <div class="event-title-small">${event.title}</div>
          ${event.location ? `<div style="font-size: 11px; color: var(--muted);">${event.location}</div>` : ''}
        </div>
      `;
    }).join('');

    elements.dayEventsList.innerHTML = eventsHtml;
  }

  // Utilit√°rias
  function isDateToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
  }

  function isDateSelected(date) {
    return date.toDateString() === calendar.selectedDate.toDateString();
  }

  function getEventsForDate(date) {
    const eventsForDate = calendar.events.filter(event => {
      // Google Calendar API retorna start.dateTime ou start.date
      const eventStart = event.start?.dateTime || event.start?.date || event.start;
      const eventDate = new Date(eventStart);
      const match = eventDate.toDateString() === date.toDateString();
      return match;
    });

    if (eventsForDate.length > 0) {
      console.log(`üìÖ [CALENDAR] Eventos para ${date.toDateString()}:`, eventsForDate);
    }

    return eventsForDate;
  }

  // Modal de evento
  function openEventModal(event = null) {
    elements.eventModal.classList.add('active');

    if (event) {
      elements.modalTitle.textContent = 'Editar Evento';
      // Preencher formul√°rio com dados do evento
      document.getElementById('ev-title').value = event.title || '';
      document.getElementById('ev-location').value = event.location || '';
      document.getElementById('ev-att').value = event.attendees ? event.attendees.join(', ') : '';
      document.getElementById('ev-notes').value = event.notes || '';

      if (event.start) {
        const startDate = new Date(event.start);
        document.getElementById('ev-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('ev-time').value = startDate.toTimeString().slice(0, 5);

        if (event.end) {
          const duration = (new Date(event.end) - startDate) / 60000;
          document.getElementById('ev-duration').value = duration;
        }
      }
    } else {
      elements.modalTitle.textContent = 'Criar Evento';
      document.getElementById('event-form').reset();

      // Definir data padr√£o como data selecionada
      const selectedDateStr = calendar.selectedDate.toISOString().split('T')[0];
      document.getElementById('ev-date').value = selectedDateStr;
    }
  }

  function closeEventModal() {
    elements.eventModal.classList.remove('active');
    clearFeedback();
  }

  // Evento r√°pido
  function quickEvent(type) {
    openEventModal();
    document.getElementById('ev-type').value = type;

    if (type === 'meeting') {
      document.getElementById('ev-duration').value = '60';
      document.getElementById('ev-meet').value = 'true';
    } else if (type === 'reminder') {
      document.getElementById('ev-duration').value = '15';
      document.getElementById('ev-meet').value = 'false';
    }
  }

  // Manipular submit do formul√°rio
  async function handleEventSubmit(e) {
    e.preventDefault();

    const title = document.getElementById('ev-title').value.trim();
    const date = document.getElementById('ev-date').value;
    const time = document.getElementById('ev-time').value;
    const duration = parseInt(document.getElementById('ev-duration').value || '60', 10);
    const location = document.getElementById('ev-location').value.trim();
    const attendees = document.getElementById('ev-att').value.split(',').map(s=>s.trim()).filter(Boolean);
    const notes = document.getElementById('ev-notes').value.trim();
    const meet = document.getElementById('ev-meet').value === 'true';
    const type = document.getElementById('ev-type').value;

    if (!title || !date || !time) {
      showFeedback('Preencha t√≠tulo, data e hora.', 'error');
      return;
    }

    const startISO = new Date(`${date}T${time}:00`).toISOString();
    const endISO = new Date(new Date(startISO).getTime() + duration * 60000).toISOString();

    try {
      const r = await fetch('/api/events', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title, start: startISO, end: endISO, location, attendees, notes, meet, type })
      });

      const j = await r.json();

      if (j.ok) {
        showFeedback('Evento criado com sucesso!', 'success');
        setTimeout(() => {
          closeEventModal();
          loadEvents();
        }, 1500);
      } else {
        showFeedback(j.error || 'Erro ao criar evento', 'error');
      }
    } catch (e) {
      showFeedback('Erro de conex√£o', 'error');
    }
  }

  // Editar evento
  function editEvent(eventId) {
    const event = calendar.events.find(e => e.id === eventId);
    if (event) {
      openEventModal(event);
    }
  }

  // Feedback
  function showFeedback(message, type) {
    elements.evFeedback.textContent = message;
    elements.evFeedback.className = `form-feedback ${type}`;
  }

  function clearFeedback() {
    elements.evFeedback.className = 'form-feedback';
    elements.evFeedback.textContent = '';
  }

  // Tornar fun√ß√µes globais para uso em onclick
  window.selectDate = selectDate;
  window.editEvent = editEvent;

  // Inicializar calend√°rio SOMENTE ap√≥s DOM carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üìÖ [CALENDAR] Inicializando calend√°rio ap√≥s DOMContentLoaded...');
      initCalendar();
    });
  } else {
    // DOM j√° carregado
    console.log('üìÖ [CALENDAR] DOM j√° carregado, inicializando calend√°rio imediatamente...');
    initCalendar();
  }

  // ===== WhatsApp Functions =====
  async function loadWhatsAppData(){
    try{
      // Verificar status da inst√¢ncia
      const statusResponse = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_message: 'verificar status whatsapp' })
      });
      const statusData = await statusResponse.json();
      
      // Atualizar interface com dados do WhatsApp
      updateWhatsAppStats();
      loadRecentMessages();
      loadTopContacts();
      
    }catch(e){
      console.warn('Erro ao carregar dados WhatsApp:', e);
    }
  }

  async function updateWhatsAppStats(){
    const instanceStatus = document.getElementById('instance-status');
    const statusBadge = document.getElementById('status-badge');
    const messagesToday = document.getElementById('messages-today');
    const activeContacts = document.getElementById('active-contacts');
    const responseRate = document.getElementById('response-rate');

    try{
      // Simular dados - em produ√ß√£o conectar com API real
      instanceStatus.textContent = 'Conectado';
      statusBadge.textContent = 'Online';
      statusBadge.className = 'status-badge status-connected';
      messagesToday.textContent = '47';
      activeContacts.textContent = '12';
      responseRate.textContent = '87%';
    }catch(e){
      instanceStatus.textContent = 'Erro';
      statusBadge.textContent = 'Offline';
      statusBadge.className = 'status-badge status-disconnected';
    }
  }

  async function loadRecentMessages(){
    const messagesContainer = document.getElementById('whatsapp-messages');
    try{
      // Simular mensagens recentes
      const messages = [
        { from: '5511999999999', text: 'Ol√°, gostaria de saber mais sobre os servi√ßos', fromMe: false, time: '14:32' },
        { from: '5511999999999', text: 'Claro! Posso ajud√°-lo com isso. Temos v√°rias op√ß√µes dispon√≠veis.', fromMe: true, time: '14:33' },
        { from: '5511888888888', text: 'Obrigado pelo atendimento', fromMe: false, time: '14:20' },
        { from: '5511777777777', text: 'Quando podemos agendar uma reuni√£o?', fromMe: false, time: '13:45' }
      ];
      
      messagesContainer.innerHTML = '';
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `chat-message ${msg.fromMe ? 'agent' : 'user'}`;
        div.innerHTML = `<div><strong>${msg.fromMe ? 'Voc√™' : msg.from}</strong> - ${msg.time}</div><div>${msg.text}</div>`;
        messagesContainer.appendChild(div);
      });
    }catch(e){
      messagesContainer.innerHTML = '<div class="label" style="text-align:center;">Erro ao carregar mensagens</div>';
    }
  }

  async function loadTopContacts(){
    const contactsContainer = document.getElementById('whatsapp-contacts');
    try{
      // Simular contatos principais
      const contacts = [
        { phone: '5511999999999', name: 'Jo√£o Silva', messages: 15, lastMessage: '14:32' },
        { phone: '5511888888888', name: 'Maria Santos', messages: 8, lastMessage: '14:20' },
        { phone: '5511777777777', name: 'Pedro Costa', messages: 12, lastMessage: '13:45' }
      ];
      
      contactsContainer.innerHTML = '';
      contacts.forEach(contact => {
        const div = document.createElement('div');
        div.className = 'whatsapp-contact-card';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div><strong>${contact.name}</strong></div>
            <div class="label">${contact.lastMessage}</div>
          </div>
          <div class="label" style="display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>${contact.phone}</div>
          <div class="label" style="display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18v12H8l-5 5V6z"/></svg>${contact.messages} mensagens</div>
        `;
        contactsContainer.appendChild(div);
      });
    }catch(e){
      contactsContainer.innerHTML = '<div class="label">Erro ao carregar contatos</div>';
    }
  }

  // Event listeners para WhatsApp
  document.getElementById('check-status')?.addEventListener('click', async ()=>{
    try{
      const response = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_message: 'verificar status da inst√¢ncia whatsapp' })
      });
      const result = await response.json();
      alert(result.answer || 'Status verificado');
      updateWhatsAppStats();
    }catch(e){
      alert('Erro ao verificar status');
    }
  });

  document.getElementById('whatsapp-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const number = document.getElementById('wa-number').value.trim();
    const message = document.getElementById('wa-message').value.trim();
    const type = document.getElementById('wa-type').value;
    const feedback = document.getElementById('wa-feedback');

    if(!number || !message){
      feedback.textContent = 'Preencha n√∫mero e mensagem.';
      return;
    }

    try{
      let prompt = '';
      if(type === 'text'){
        prompt = `enviar mensagem whatsapp para ${number}: ${message}`;
      } else if(type === 'tts'){
        prompt = `enviar √°udio tts para ${number}: ${message}`;
      } else if(type === 'intelligent'){
        prompt = `enviar mensagem inteligente para ${number}: ${message}`;
      }

      const response = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_message: prompt })
      });
      const result = await response.json();
      feedback.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="#10b981" style="vertical-align:middle;"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg> Mensagem enviada!';
      document.getElementById('wa-number').value = '';
      document.getElementById('wa-message').value = '';
      loadRecentMessages();
    }catch(e){
      feedback.textContent = '‚ùå Erro ao enviar.';
    }
  });

  document.getElementById('wa-schedule')?.addEventListener('click', ()=>{
    const number = document.getElementById('wa-number').value.trim();
    if(!number){
      alert('Digite o n√∫mero primeiro');
      return;
    }
    // Aqui voc√™ pode abrir um modal ou redirecionar para agendamento
    alert('Fun√ß√£o de agendamento em desenvolvimento');
  });

  // ===== Leads =====
  let leadsMap;
  let leadsHeat;
  function ensureMap(){
    if(leadsMap) return leadsMap;
    leadsMap = L.map('leads-map', { scrollWheelZoom:false }).setView([-3.73, -38.52], 4); // Brasil (aprox)
    // Mapa base escuro combinando com o tema do dashboard
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap &copy; CartoDB'
    }).addTo(leadsMap);
    return leadsMap;
  }
  document.getElementById('lead-refresh').addEventListener('click', ()=>{
    loadLeads();
    loadFunnel();
  });
  document.getElementById('lead-search').addEventListener('input', ()=>{
    loadLeads();
    loadFunnel();
  });
  
  // New lead management event listeners
  document.getElementById('status-filter')?.addEventListener('change', loadLeads);
  document.getElementById('sort-filter')?.addEventListener('change', loadLeads);
  
  // View toggle functionality
  document.getElementById('view-table')?.addEventListener('click', () => {
    document.getElementById('leads-table-view').style.display = 'block';
    document.getElementById('leads-grid-view').style.display = 'none';
    document.getElementById('view-table').style.background = 'var(--primary-color)';
    document.getElementById('view-table').style.color = 'white';
    document.getElementById('view-grid').style.background = 'var(--glass)';
    document.getElementById('view-grid').style.color = 'var(--text)';
  });
  
  document.getElementById('view-grid')?.addEventListener('click', () => {
    document.getElementById('leads-table-view').style.display = 'none';
    document.getElementById('leads-grid-view').style.display = 'block';
    document.getElementById('view-grid').style.background = 'var(--primary-color)';
    document.getElementById('view-grid').style.color = 'white';
    document.getElementById('view-table').style.background = 'var(--glass)';
    document.getElementById('view-table').style.color = 'var(--text)';
  });

  async function loadLeads(){
    console.log('üî• ORBION: Iniciando loadLeads()...');
    const q = (document.getElementById('lead-search').value||'').trim();
    const statusFilter = document.getElementById('status-filter')?.value || '';

    try{
      console.log('üî• ORBION: Fazendo fetch para /api/leads...');
      const r = await fetch('/api/leads');
      if(!r.ok){
        console.error('üî• ORBION: Resposta n√£o OK:', r.status, r.statusText);
        renderLeads([], 'Falha ao buscar leads.');
        return;
      }
      const j = await r.json();
      console.log('üî• ORBION: Dados recebidos:', j);

      // O endpoint /api/leads retorna um objeto com propriedade leads
      let rawLeads = j.leads || [];
      if(rawLeads.length === 0){
        renderLeads([], 'Nenhum lead encontrado.');
        return;
      }

      console.log('üìã Primeiro lead bruto:', rawLeads[0]);

      // Fix: Map Google Sheets field names to frontend field names
      let leads = rawLeads.map(lead => ({
        name: lead.Nome || lead.name || 'Sem nome',
        email: lead.Email || lead.email || 'Sem email',
        phone: lead.Telefone || lead.phone || 'Sem telefone',
        city: lead.Cidade || lead.city || 'N√£o informado',
        company: lead.Empresa || lead.company || 'N√£o informado',
        category: lead.Segmento || lead.category || 'Categoria N/A',
        status: (lead.Status || lead.status || 'novo').toLowerCase(),
        revenue: lead.Faturamento || lead.revenue || 'N/A',
        employees: lead.Funcion√°rios || lead.employees || 'N/A',
        observations: lead.Observa√ß√µes || lead.observations || '',
        id: lead.id || Math.random().toString(36).substr(2, 9)
      }));

      console.log('üìã Primeiro lead mapeado:', leads[0]);

      // Aplicar filtros localmente
      if(q){
        leads = leads.filter(l =>
          (l.name || '').toLowerCase().includes(q.toLowerCase()) ||
          (l.company || '').toLowerCase().includes(q.toLowerCase()) ||
          (l.phone || '').includes(q) ||
          (l.email || '').toLowerCase().includes(q.toLowerCase()) ||
          (l.city || '').toLowerCase().includes(q.toLowerCase())
        );
      }

      if(statusFilter){
        leads = leads.filter(l => l.status === statusFilter);
      }

      console.log('üî• ORBION: Chamando renderLeads com', leads.length, 'leads');
      renderLeads(leads, '', null, null);
    }catch(e){
      console.error('üî• ORBION: Erro no loadLeads:', e);
      renderLeads([], 'Falha ao buscar leads do Google Sheets.');
    }
  }

  function renderLeads(items, error, stats, sheetUrl){
    console.log('üî• ORBION: renderLeads chamada com:', items.length, 'items, error:', error);
    // Update stats
    if(stats){
      updateLeadStatsFromSheets(stats);
    } else {
      updateLeadStats(items);
    }

    // Update summary with Google Sheets link
    const summary = document.getElementById('leads-summary');
    if(error){
      summary.innerHTML = error;
      summary.style.color = 'var(--err)';
    } else {
      let summaryText = `${items.length} lead${items.length !== 1 ? 's' : ''} encontrado${items.length !== 1 ? 's' : ''}`;
      if(sheetUrl){
        summaryText += ` ‚Ä¢ <a href="${sheetUrl}" target="_blank" style="color: var(--cyan); text-decoration: none;">üìä Ver no Google Sheets</a>`;
      }
      summary.innerHTML = summaryText;
      summary.style.color = 'var(--muted)';
    }

    // Render table view
    renderLeadsTable(items);
    // Render grid view
    renderLeadsGrid(items);
    // Update status distribution
    updateStatusDistribution(items);
  }

  function updateLeadStatsFromSheets(stats){
    console.log('üî• ORBION: updateLeadStatsFromSheets chamada com:', stats);
    // Update stats using data from Google Sheets - usando IDs corretos
    const totalElement = document.getElementById('total-leads-count');
    const activeElement = document.getElementById('active-leads-count');
    const funnelTotalElement = document.getElementById('funnel-total-leads');

    if(totalElement) {
      totalElement.textContent = stats.total || 0;
      console.log('‚úÖ total-leads-count atualizado:', stats.total || 0);
    } else {
      console.error('‚ùå Elemento total-leads-count n√£o encontrado');
    }

    if(activeElement) {
      activeElement.textContent = stats.interessados || 0;
      console.log('‚úÖ active-leads-count atualizado:', stats.interessados || 0);
    } else {
      console.error('‚ùå Elemento active-leads-count n√£o encontrado');
    }

    if(funnelTotalElement) {
      funnelTotalElement.textContent = stats.total || 0;
      console.log('‚úÖ funnel-total-leads atualizado:', stats.total || 0);
    } else {
      console.error('‚ùå Elemento funnel-total-leads n√£o encontrado');
    }
  }

  function updateLeadStats(items){
    const total = items.length;
    const active = items.filter(l => l.status === 'ativo').length;
    const today = items.filter(l => {
      if(!l.added_at) return false;
      const leadDate = new Date(l.added_at);
      const now = new Date();
      return leadDate.toDateString() === now.toDateString();
    }).length;
    
    const thisWeek = items.filter(l => {
      if(!l.added_at) return false;
      const leadDate = new Date(l.added_at);
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      return leadDate >= weekAgo;
    }).length;
    
    const conversionRate = total > 0 ? Math.round((active / total) * 100) : 0;
    
    // Update header stats
    document.getElementById('total-leads-count').textContent = total;
    document.getElementById('active-leads-count').textContent = active;
    document.getElementById('conversion-rate').textContent = conversionRate + '%';
    
    // Update sidebar stats
    document.getElementById('leads-today').textContent = today;
    document.getElementById('leads-week').textContent = thisWeek;
    document.getElementById('leads-hot').textContent = items.filter(l => l.status === 'ativo').length;
    document.getElementById('leads-converted').textContent = items.filter(l => l.status === 'convertido').length;
  }

  function renderLeadsTable(items){
    console.log('üî• ORBION: renderLeadsTable chamada com', items.length, 'items');
    const tableBody = document.getElementById('leads-table-body');
    if(!tableBody) {
      console.error('üî• ORBION: Elemento leads-table-body n√£o encontrado!');
      return;
    }
    
    if(items.length === 0){
      tableBody.innerHTML = `
        <div style="padding:40px; text-align:center; color:var(--muted); grid-column:1/-1;">
          <i class="fas fa-inbox" style="font-size:48px; opacity:0.3; margin-bottom:12px;"></i>
          <div>Nenhum lead encontrado</div>
          <div style="font-size:12px; margin-top:4px;">Tente ajustar os filtros ou adicionar novos leads</div>
        </div>
      `;
      return;
    }

    console.log('üî• ORBION: Primeiro lead:', items[0]);

    tableBody.innerHTML = items.map(lead => {
      const statusColor = {
        'novo': 'var(--warn)',
        'ativo': 'var(--ok)', 
        'standby': 'var(--warn)',
        'cancelado': 'var(--err)'
      }[lead.status] || 'var(--muted)';
      
      const statusIcon = {
        'novo': 'üü°',
        'ativo': 'üü¢',
        'standby': 'üü†', 
        'cancelado': 'üî¥'
      }[lead.status] || '‚ö™';
      
      return `
        <div style="display:grid; grid-template-columns:2.5fr 2fr 1.8fr 1.2fr 1fr 100px; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); align-items:center; transition:background 0.2s; cursor:pointer;" 
             onmouseover="this.style.background='var(--glass)'" 
             onmouseout="this.style.background='transparent'">
          <div>
            <div style="font-weight:600; color:var(--text); margin-bottom:2px;">${lead.name || 'Sem nome'}</div>
            <div style="font-size:11px; color:var(--muted); display:flex; align-items:center; gap:6px;">
              <span style="background:var(--primary-color)20; color:var(--primary-color); padding:2px 6px; border-radius:8px; font-size:10px;">
                ${lead.category || 'Categoria N/A'}
              </span>
            </div>
          </div>
          <div>
            <div style="font-size:13px; color:var(--text); margin-bottom:2px; display:flex; align-items:center; gap:6px;">
              üìß ${lead.email || 'Sem email'}
            </div>
            <div style="font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px;">
              üì± ${lead.phone || 'Sem telefone'}
            </div>
            ${lead.website ? '<div style="font-size:11px; margin-top:2px;"><a href="' + lead.website + '" target="_blank" style="color:var(--cyan); text-decoration:none;">üîó Website</a></div>' : ''}
          </div>
          <div>
            <div style="font-size:13px; color:var(--text); margin-bottom:2px;">üìç ${lead.city || 'N√£o informado'}</div>
            ${lead.cep ? '<div style="font-size:11px; color:var(--muted);">üìÆ ' + lead.cep + '</div>' : ''}
            ${lead.address ? '<div style="font-size:11px; color:var(--muted); margin-top:2px;" title="' + lead.address + '">üìç ' + (lead.address.length > 25 ? lead.address.substring(0, 25) + '...' : lead.address) + '</div>' : ''}
          </div>
          <div>
            ${lead.ai_opportunity ? '<div style="font-size:11px; color:var(--text); background:var(--warn)10; padding:6px; border-radius:8px; border-left:3px solid var(--warn);" title="' + lead.ai_opportunity + '">ü§ñ ' + (lead.ai_opportunity.length > 80 ? lead.ai_opportunity.substring(0, 80) + '...' : lead.ai_opportunity) + '</div>' : '<div style="font-size:11px; color:var(--muted); text-align:center;">Sem sugest√£o IA</div>'}
          </div>
          <div>
            <span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:${statusColor}20; color:${statusColor}; border-radius:12px; font-size:11px; font-weight:600;">
              ${statusIcon} ${(lead.status || 'novo').toUpperCase()}
            </span>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px;">
            <button style="padding:4px 8px; border:none; background:var(--ok); color:white; border-radius:4px; font-size:9px; cursor:pointer;" 
                    title="WhatsApp: ${lead.phone}" onclick="window.open('https://wa.me/' + '${lead.phone}'.replace(/[^\d]/g, ''), '_blank')">üì± WhatsApp</button>
            ${lead.instagram ? '<button style="padding:3px 6px; border:none; background:linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color:white; border-radius:4px; font-size:9px; cursor:pointer;" title="Instagram" onclick="window.open(\'' + lead.instagram + '\', \'_blank\')">üì∏ IG</button>' : ''}
            <button style="padding:4px 8px; border:none; background:var(--glass); color:var(--text); border-radius:4px; font-size:9px; cursor:pointer;" 
                    title="Editar lead">‚úèÔ∏è Editar</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderLeadsGrid(items){
    const grid = document.getElementById('leads-grid');
    if(!grid) return;
    
    if(items.length === 0){
      grid.innerHTML = `
        <div style="grid-column:1/-1; padding:40px; text-align:center; color:var(--muted);">
          <i class="fas fa-inbox" style="font-size:48px; opacity:0.3; margin-bottom:12px;"></i>
          <div>Nenhum lead encontrado</div>
        </div>
      `;
      return;
    }
    
    grid.innerHTML = items.map(lead => {
      const statusColor = {
        'novo': 'var(--warn)',
        'ativo': 'var(--ok)', 
        'standby': 'var(--warn)',
        'cancelado': 'var(--err)'
      }[lead.status] || 'var(--muted)';
      
      return `
        <div class="card" style="padding:16px; transition:transform 0.2s, box-shadow 0.2s;" 
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow)'" 
             onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
          <div style="display:flex; align-items:start; justify-content:space-between; margin-bottom:12px;">
            <div>
              <h3 style="margin:0 0 4px; font-size:16px; font-weight:600; color:var(--text);">${lead.name || 'Sem nome'}</h3>
              <div style="font-size:12px; color:var(--muted);">Lead #${lead.id || 'N/A'}</div>
            </div>
            <span style="padding:4px 8px; background:${statusColor}20; color:${statusColor}; border-radius:12px; font-size:10px; font-weight:600;">
              ${(lead.status || 'novo').toUpperCase()}
            </span>
          </div>
          
          <div style="margin-bottom:16px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:13px;">
              <i class="fas fa-envelope" style="color:var(--muted); width:12px;"></i>
              <span style="color:var(--text);">${lead.email || 'Sem email'}</span>
            </div>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:13px;">
              <i class="fas fa-phone" style="color:var(--muted); width:12px;"></i>
              <span style="color:var(--text);">${lead.phone || 'Sem telefone'}</span>
            </div>
            <div style="display:flex; align-items:center; gap:8px; font-size:13px;">
              <i class="fas fa-map-marker-alt" style="color:var(--muted); width:12px;"></i>
              <span style="color:var(--text);">${lead.city || 'N√£o informado'}</span>
            </div>
          </div>
          
          <div style="display:flex; gap:8px;">
            <button style="flex:1; padding:8px; border:none; background:var(--primary-color); color:white; border-radius:6px; font-size:12px; cursor:pointer;">
              <svg style="width:14px;height:14px; margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>Contatar
            </button>
            <button style="padding:8px 12px; border:none; background:var(--glass); color:var(--text); border-radius:6px; font-size:12px; cursor:pointer;">
              ‚úèÔ∏è
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  function updateStatusDistribution(items){
    const distribution = document.getElementById('status-distribution');
    if(!distribution) return;
    
    const statusCounts = {};
    items.forEach(lead => {
      const status = lead.status || 'novo';
      statusCounts[status] = (statusCounts[status] || 0) + 1;
    });
    
    const statusColors = {
      'novo': 'var(--warn)',
      'ativo': 'var(--ok)', 
      'standby': 'var(--warn)',
      'cancelado': 'var(--err)'
    };
    
    const total = items.length || 1;
    
    distribution.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
      const percentage = Math.round((count / total) * 100);
      const color = statusColors[status] || 'var(--muted)';
      
      return `
        <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--glass); border-radius:6px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:12px; height:12px; background:${color}; border-radius:50%;"></div>
            <span style="font-size:13px; color:var(--text); text-transform:capitalize;">${status}</span>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:14px; font-weight:600; color:var(--text);">${count}</span>
            <span style="font-size:11px; color:var(--muted);">(${percentage}%)</span>
          </div>
        </div>
      `;
    }).join('');
  }

  // ===== Funil =====
  async function loadFunnel(){
    const q = (document.getElementById('lead-search')?.value || '').trim();
    const url = q ? `/api/leads?q=${encodeURIComponent(q)}` : '/api/leads';
    try{
      const r = await fetch(url);
      if(!r.ok){ renderFunnel([], 'Falha ao buscar leads.'); return; }
      const j = await r.json();
      const leads = j.leads || [];
      console.log('üìä Funil carregado:', leads.length, 'leads');
      renderFunnel(leads);
    }catch(e){
      console.error('‚ùå Erro ao carregar funil:', e);
      renderFunnel([], 'Falha ao buscar leads.');
    }
  }
  function renderFunnel(items){
    // Mapeamento dos status do Google Sheets para categorias do funil
    const statusMapping = {
      'novo': 'novo',
      'interessado': 'ativo',
      'qualificado': 'ativo',
      'proposta': 'ativo',
      'negocia√ß√£o': 'ativo',
      'convertido': 'convertido',
      'cliente': 'convertido',
      'fechado': 'convertido',
      'perdido': 'cancelado',
      'cancelado': 'cancelado',
      'parado': 'standby',
      'standby': 'standby',
      'aguardando': 'standby'
    };

    const counts = { novo:0, standby:0, ativo:0, cancelado:0, convertido:0 };
    const leadsByStatus = { novo:[], standby:[], ativo:[], cancelado:[], convertido:[] };

    items.forEach(lead=>{
      // Usar o campo Status (mai√∫sculo) do Google Sheets
      const originalStatus = (lead.Status || lead.status || 'novo').toLowerCase();
      const mappedStatus = statusMapping[originalStatus] || 'novo';

      counts[mappedStatus]++;
      leadsByStatus[mappedStatus].push({
        nome: lead.Nome || lead.nome || 'Lead sem nome',
        empresa: lead.Empresa || lead.empresa || '',
        telefone: lead.Telefone || lead.telefone || '',
        statusOriginal: originalStatus,
        faturamento: lead.Faturamento || lead.faturamento || '',
        segmento: lead.Segmento || lead.segmento || ''
      });
    });

    console.log('üìä Leads organizados por status:', counts);
    console.log('üìã Detalhes dos leads:', leadsByStatus);
    
    // Update overview cards
    updateFunnelOverview(items, counts);

    // Render funnel stages
    renderFunnelStages(counts, leadsByStatus);

    // Render bar chart
    renderFunnelBars(counts);

    // Update metrics
    updateFunnelMetrics(items, counts);

    // Generate optimization suggestions
    generateOptimizationTips(counts, items);

    // Setup view toggles
    setupFunnelViewToggles();
  }

  function updateFunnelOverview(items, counts) {
    const total = items.length;
    const converted = counts.convertido || 0;
    const conversionRate = total > 0 ? Math.round((converted / total) * 100) : 0;
    const avgTime = calculateAverageTime(items);
    const estimatedRevenue = converted * 2500;
    
    document.getElementById('funnel-total-leads').textContent = total;
    document.getElementById('funnel-conversion-rate').textContent = conversionRate + '%';
    document.getElementById('funnel-avg-time').textContent = avgTime + 'd';
    document.getElementById('funnel-revenue').textContent = 'R$' + estimatedRevenue.toLocaleString('pt-BR');
    
    // Mock growth rates
    document.getElementById('funnel-leads-growth').textContent = '+12%';
    document.getElementById('funnel-conversion-growth').textContent = '+5%';
    document.getElementById('funnel-time-improvement').textContent = '-8%';
    document.getElementById('funnel-revenue-growth').textContent = '+18%';
  }

  function renderFunnelStages(counts, leadsByStatus = {}) {
    const stages = [
      { key: 'novo', name: 'Lead Acquisition', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10Z"/></svg>', color: 'var(--primary-color)' },
      { key: 'standby', name: 'Lead Nurturing', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.7L16.2,16.2Z"/></svg>', color: 'var(--warn)' },
      { key: 'ativo', name: 'Sales Qualified', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.66 11.2C17.43 10.9 17.15 10.64 16.89 10.38C16.22 9.78 15.46 9.35 14.82 8.72C13.33 7.26 13 4.85 13.95 3C13 3.23 12.17 3.75 11.46 4.32C8.87 6.4 7.85 10.07 9.07 13.22C9.11 13.32 9.15 13.42 9.15 13.55C9.15 13.77 9 13.97 8.8 14.05C8.57 14.15 8.33 14.09 8.14 13.93C8.08 13.88 8.04 13.83 8 13.76C6.87 12.33 6.69 10.28 7.45 8.64C5.78 10 4.87 12.3 5 14.47C5.06 14.97 5.12 15.47 5.29 15.97C5.43 16.57 5.7 17.17 6 17.7C7.08 19.43 8.95 20.67 10.96 20.92C13.1 21.19 15.39 20.8 17.03 19.32C18.86 17.66 19.5 15 18.56 12.72L18.43 12.46C18.22 12 17.66 11.2 17.66 11.2M14.5 17.5C14.22 17.74 13.76 18 13.4 18.1C12.28 18.50 11.16 17.94 10.5 17.28C11.69 17 12.4 16.12 12.61 15.23C12.78 14.43 12.46 13.77 12.33 13C12.21 12.26 12.23 11.63 12.5 10.94C12.69 11.32 12.89 11.7 13.13 12C13.9 13 15.11 13.44 15.37 14.8C15.41 14.94 15.43 15.08 15.43 15.23C15.46 16.05 15.1 16.95 14.5 17.5H14.5Z"/></svg>', color: 'var(--ok)' },
      { key: 'cancelado', name: 'Lost/Unqualified', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg>', color: 'var(--err)' },
      { key: 'convertido', name: 'Closed Won', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>', color: 'var(--violet)' }
    ];
    
    const container = document.getElementById('funnel-stages');
    if(!container) return;
    
    const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
    const max = Math.max(...Object.values(counts), 1);
    
    // Layout profissional similar ao calend√°rio
    container.innerHTML = `
      <!-- Funnel Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
                  padding: 16px 20px; background: var(--glass); border: 1px solid var(--border);
                  border-radius: 12px; box-shadow: var(--shadow);">
        <div>
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text);">Sales Pipeline</h3>
          <p style="margin: 2px 0 0; font-size: 12px; color: var(--muted);">Lead conversion flow</p>
        </div>
        <div style="padding: 4px 10px; background: var(--ok)10; border-radius: 16px;
                    font-size: 11px; color: var(--ok); font-weight: 600;">
          ${total} Leads
        </div>
      </div>

      <!-- Funnel Stages Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
        ${stages.map((stage, index) => {
          const count = counts[stage.key] || 0;
          const percentage = Math.round((count / total) * 100);
          const nextStage = stages[index + 1];
          const conversionToNext = nextStage && counts[nextStage.key] && count > 0
            ? Math.round((counts[nextStage.key] / count) * 100) : null;

          return `
            <div class="funnel-stage-card" data-stage="${stage.key}"
                 style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px;
                        padding: 16px; cursor: pointer; transition: all 0.2s ease;
                        position: relative; overflow: hidden;">

              <!-- Stage Header -->
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 8px; height: 8px; border-radius: 50%; background: ${stage.color};"></div>
                  <div>
                    <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text);">
                      ${stage.name}
                    </h4>
                    <p style="margin: 1px 0 0; font-size: 10px; color: var(--muted);">
                      Stage ${index + 1}
                    </p>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 20px; font-weight: 700; color: ${stage.color}; line-height: 1;">
                    ${count}
                  </div>
                  <div style="font-size: 10px; color: var(--muted);">
                    ${percentage}%
                  </div>
                </div>
              </div>

              <!-- Progress Bar -->
              <div style="margin-bottom: 10px;">
                <div style="width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                  <div style="height: 100%; background: ${stage.color}; width: ${Math.max(2, percentage)}%;
                              border-radius: 2px; transition: width 0.6s ease;"></div>
                </div>
              </div>

              <!-- Left border accent -->
              <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: ${stage.color};
                          border-radius: 16px 0 0 16px;"></div>

              <!-- Hover state -->
              <div style="position: absolute; inset: 0; background: ${stage.color}05; border-radius: 16px;
                          opacity: 0; transition: opacity 0.2s ease; pointer-events: none;" class="hover-overlay"></div>
            </div>
          `;
        }).join('')}
      </div>

      <!-- Flow Summary -->
      <div style="background: var(--glass); border: 1px solid var(--border); border-radius: 12px;
                  padding: 16px; box-shadow: var(--shadow);">
        <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--text);">
          Pipeline Overview
        </h4>
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
          ${stages.map((stage, index) => {
            const count = counts[stage.key] || 0;
            const percentage = Math.round((count / total) * 100);

            return `
              <div style="flex: 1; min-width: 80px; text-align: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${stage.color}15;
                            border: 2px solid ${stage.color}; display: flex; align-items: center; justify-content: center;
                            margin: 0 auto 8px; position: relative;">
                  <span style="font-size: 14px; font-weight: 700; color: ${stage.color};">${count}</span>
                </div>
                <div style="font-size: 11px; font-weight: 600; color: var(--text); margin-bottom: 2px;">
                  ${stage.name.split(' ')[0]}
                </div>
                <div style="font-size: 9px; color: var(--muted);">
                  ${percentage}%
                </div>
              </div>

              ${index < stages.length - 1 ? `
                <div style="flex: 0 0 16px; display: flex; align-items: center; justify-content: center;">
                  <svg style="width: 12px; height: 12px; color: var(--muted);" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"/>
                  </svg>
                </div>
              ` : ''}
            `;
          }).join('')}
        </div>
      </div>
    `;
    
    // Event listeners para cards profissionais
    container.querySelectorAll('.funnel-stage-card').forEach(card => {
      const stageKey = card.dataset.stage;
      const stageData = stages.find(s => s.key === stageKey);
      const hoverOverlay = card.querySelector('.hover-overlay');

      card.addEventListener('click', () => showStageDetails(stageKey, counts[stageKey], stageData, leadsByStatus[stageKey] || []));

      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-2px)';
        card.style.boxShadow = `0 8px 25px rgba(0,0,0,0.1), 0 0 0 1px ${stageData.color}30`;
        if(hoverOverlay) hoverOverlay.style.opacity = '1';
      });

      card.addEventListener('mouseleave', () => {
        card.style.transform = 'none';
        card.style.boxShadow = 'var(--shadow)';
        if(hoverOverlay) hoverOverlay.style.opacity = '0';
      });
    });
  }

  function renderFunnelBars(counts) {
    const container = document.getElementById('funnel-bar-chart');
    if(!container) return;
    
    const stages = [
      { key: 'novo', name: 'Acquisition', color: 'var(--primary-color)' },
      { key: 'standby', name: 'Nurturing', color: 'var(--warn)' },
      { key: 'ativo', name: 'Qualified', color: 'var(--ok)' },
      { key: 'cancelado', name: 'Lost', color: 'var(--err)' },
      { key: 'convertido', name: 'Won', color: 'var(--violet)' }
    ];
    
    const max = Math.max(...Object.values(counts), 1);
    
    container.innerHTML = stages.map(stage => {
      const count = counts[stage.key] || 0;
      const heightPercent = (count / max) * 100;
      
      return `
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; height:100%;">
          <div style="flex:1; display:flex; align-items:end; width:100%; padding:0 8px;">
            <div style="width:100%; height:${heightPercent}%; background:linear-gradient(to top, ${stage.color}, ${stage.color}CC); 
                        border-radius:8px 8px 0 0; display:flex; align-items:start; justify-content:center; 
                        padding-top:8px; color:white; font-weight:600; font-size:14px; transition:all 0.3s ease;
                        cursor:pointer;" 
                 onmouseover="this.style.transform='scaleY(1.05)'; this.style.filter='brightness(1.1)'" 
                 onmouseout="this.style.transform='none'; this.style.filter='none'">
              ${count}
            </div>
          </div>
          <div style="padding:8px; text-align:center; font-size:12px; color:var(--text);">
            <div style="font-weight:600;">${stage.name}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function showStageDetails(stageKey, count, stageData, leads = []) {
    const details = document.getElementById('stage-details');
    if(!details) return;

    const totalLeads = parseInt(document.getElementById('funnel-total-leads').textContent) || 1;
    const percentage = Math.round((count / totalLeads) * 100);

    const leadsHtml = leads.length > 0 ? `
      <div style="margin-top:16px; text-align:left;">
        <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:var(--text);">Leads in this stage:</div>
        <div style="max-height:200px; overflow-y:auto;">
          ${leads.slice(0, 10).map(lead => `
            <div style="padding:8px; margin-bottom:6px; background:var(--glass); border-radius:6px; border-left:3px solid ${stageData.color};">
              <div style="font-size:13px; font-weight:600; color:var(--text); margin-bottom:2px;">
                ${lead.nome}
              </div>
              <div style="font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap;">
                ${lead.empresa ? `<span>üè¢ ${lead.empresa}</span>` : ''}
                ${lead.segmento ? `<span>üìä ${lead.segmento}</span>` : ''}
                ${lead.faturamento ? `<span>üí∞ ${lead.faturamento}</span>` : ''}
              </div>
              ${lead.statusOriginal !== stageKey ? `<div style="font-size:10px; color:${stageData.color}; margin-top:2px;">Status: ${lead.statusOriginal}</div>` : ''}
            </div>
          `).join('')}
          ${leads.length > 10 ? `<div style="text-align:center; padding:8px; color:var(--muted); font-size:12px;">... and ${leads.length - 10} more leads</div>` : ''}
        </div>
      </div>
    ` : `
      <div style="margin-top:16px; text-align:center; padding:20px; color:var(--muted);">
        <div style="font-size:14px;">No leads in this stage yet</div>
      </div>
    `;

    details.innerHTML = `
      <div style="padding:16px;">
        <div style="text-align:center; margin-bottom:16px;">
          <div style="font-size:36px; margin-bottom:8px;">${stageData.icon}</div>
          <h3 style="margin:0 0 4px; color:${stageData.color}; font-size:18px;">${stageData.name}</h3>
          <div style="font-size:28px; font-weight:700; color:var(--text); margin-bottom:2px;">${count}</div>
          <div style="font-size:12px; color:var(--muted);">${percentage}% do total</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
          <div style="padding:6px; background:var(--glass); border-radius:4px; text-align:center;">
            <div style="font-size:14px; font-weight:600; color:${stageData.color};">${leads.length}</div>
            <div style="font-size:10px; color:var(--muted);">Leads</div>
          </div>
          <div style="padding:6px; background:var(--glass); border-radius:4px; text-align:center;">
            <div style="font-size:14px; font-weight:600; color:${stageData.color};">${percentage}%</div>
            <div style="font-size:10px; color:var(--muted);">Participa√ß√£o</div>
          </div>
        </div>

        ${leadsHtml}
      </div>
    `;
  }

  function updateFunnelMetrics(items, counts) {
    const total = items.length || 1;
    const active = counts.ativo || 0;
    const converted = counts.convertido || 0;
    
    document.getElementById('hot-leads-rate').textContent = Math.round((active / total) * 100) + '%';
    document.getElementById('velocity-score').textContent = Math.round(((converted + active) / total) * 100);
    document.getElementById('cost-per-lead').textContent = 'R$125';
    document.getElementById('ltv-cac-ratio').textContent = '8:1';
  }

  function generateOptimizationTips(counts, items) {
    const tips = document.getElementById('optimization-tips');
    if(!tips) return;
    
    const total = items.length;
    const converted = counts.convertido || 0;
    const conversionRate = total > 0 ? (converted / total) * 100 : 0;
    
    const suggestions = [];
    
    if (conversionRate < 5) {
      suggestions.push({
        icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>',
        title: 'Taxa de Convers√£o Baixa',
        message: 'Considere revisar o processo de qualifica√ß√£o de leads',
        color: 'var(--warn)'
      });
    }
    
    if (counts.standby > counts.ativo) {
      suggestions.push({
        icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,1L8,5H11V14H13V5H16M18,23H6C4.89,23 4,22.1 4,21V9A2,2 0 0,1 6,7H9V9H6V21H18V9H15V7H18A2,2 0 0,1 20,9V21C20,22.1 19.1,23 18,23Z"/></svg>',
        title: 'Acelerar Follow-up',
        message: 'Muitos leads em standby. Ative campanhas de reengajamento',
        color: 'var(--primary-color)'
      });
    }
    
    if (counts.novo > total * 0.4) {
      suggestions.push({
        icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>',
        title: 'Boa Capta√ß√£o',
        message: 'Excelente volume de novos leads. Mantenha o ritmo!',
        color: 'var(--ok)'
      });
    }
    
    tips.innerHTML = suggestions.length ? suggestions.map(tip => `
      <div style="padding:10px 12px; background:linear-gradient(135deg, ${tip.color}10, ${tip.color}05); 
                  border-left:3px solid ${tip.color}; border-radius:4px;">
        <div style="font-size:12px; font-weight:600; color:${tip.color}; margin-bottom:4px;">
          ${tip.icon} ${tip.title}
        </div>
        <div style="font-size:11px; color:var(--text);">${tip.message}</div>
      </div>
    `).join('') : `
      <div style="padding:10px 12px; background:var(--glass); border-radius:4px; text-align:center; color:var(--muted);">
        <div style="font-size:12px; display:flex; align-items:center; gap:6px;"><svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>Analisando dados...</div>
        <div style="font-size:10px; margin-top:4px;">Sugest√µes em breve</div>
      </div>
    `;
  }

  function setupFunnelViewToggles() {
    document.getElementById('funnel-view-funnel')?.addEventListener('click', () => {
      document.getElementById('funnel-traditional').style.display = 'block';
      document.getElementById('funnel-bars').style.display = 'none';
      document.getElementById('funnel-flow').style.display = 'none';
      
      document.getElementById('funnel-view-funnel').style.background = 'var(--primary-color)';
      document.getElementById('funnel-view-funnel').style.color = 'white';
      document.getElementById('funnel-view-bars').style.background = 'var(--glass)';
      document.getElementById('funnel-view-bars').style.color = 'var(--text)';
      document.getElementById('funnel-view-flow').style.background = 'var(--glass)';
      document.getElementById('funnel-view-flow').style.color = 'var(--text)';
    });
    
    document.getElementById('funnel-view-bars')?.addEventListener('click', () => {
      document.getElementById('funnel-traditional').style.display = 'none';
      document.getElementById('funnel-bars').style.display = 'block';
      document.getElementById('funnel-flow').style.display = 'none';
      
      document.getElementById('funnel-view-bars').style.background = 'var(--primary-color)';
      document.getElementById('funnel-view-bars').style.color = 'white';
      document.getElementById('funnel-view-funnel').style.background = 'var(--glass)';
      document.getElementById('funnel-view-funnel').style.color = 'var(--text)';
      document.getElementById('funnel-view-flow').style.background = 'var(--glass)';
      document.getElementById('funnel-view-flow').style.color = 'var(--text)';
    });
    
    document.getElementById('funnel-view-flow')?.addEventListener('click', () => {
      document.getElementById('funnel-traditional').style.display = 'none';
      document.getElementById('funnel-bars').style.display = 'none';  
      document.getElementById('funnel-flow').style.display = 'block';
      
      document.getElementById('funnel-view-flow').style.background = 'var(--primary-color)';
      document.getElementById('funnel-view-flow').style.color = 'white';
      document.getElementById('funnel-view-funnel').style.background = 'var(--glass)';
      document.getElementById('funnel-view-funnel').style.color = 'var(--text)';
      document.getElementById('funnel-view-bars').style.background = 'var(--glass)';
      document.getElementById('funnel-view-bars').style.color = 'var(--text)';
    });
  }

  function calculateAverageTime(items) {
    return Math.floor(Math.random() * 10) + 5;
  }
  // Fun√ß√£o renderLeads duplicada removida - usando a vers√£o correta acima

  // ===== Chat flutuante =====
  const chatFloat = document.getElementById('chat-float');
  const chatFloatHeader = document.getElementById('chat-float-header');
  const chatFloatToggle = document.getElementById('chat-float-toggle');
  const chatFloatMessages = document.getElementById('chat-float-messages');
  const chatFloatInput = document.getElementById('chat-float-input');
  const chatFloatSend = document.getElementById('chat-float-send');
  const chatFloatMic = document.getElementById('chat-float-mic');
  let chatFloatHistory = [];

  function addFloatMsg(text, who){
    const div = document.createElement('div');
    div.className = 'chat-message ' + (who === 'user' ? 'user' : 'agent');
    div.textContent = text;
    chatFloatMessages.appendChild(div);
    chatFloatMessages.scrollTop = chatFloatMessages.scrollHeight;
  }

  async function sendChatFloat(){
    const text = chatFloatInput.value.trim();
    if(!text) return;
    addFloatMsg(text, 'user');
    chatFloatHistory.push({ role:'user', content:text });
    chatFloatInput.value = '';
    try{
      const r = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          message: text,
          history: chatFloatHistory,
          context: {
            platform: 'dashboard_web',
            fromDashboard: true,
            inputMethod: 'text',
            fromVoiceInput: false
          }
        })
      });
      const j = await r.json();
      const ans = j.response || j.answer || 'Sem resposta.';

      // ‚ö° PROCESSAMENTO PARALELO - NAVEGA√á√ÉO + FEEDBACK + TTS
      if (j.action === 'voice_navigation' && j.instructions && j.instructions.javascript) {
        console.log('üéôÔ∏è [VOICE-NAV] ‚ö° Executando comando em paralelo');

        // üöÄ PROCESSAMENTO PARALELO: Navega√ß√£o + Feedback + TTS (n√£o bloquear UI)
        Promise.all([
          // 1. Executar navega√ß√£o JavaScript imediatamente
          Promise.resolve().then(() => {
            eval(j.instructions.javascript);
            console.log('‚úÖ [PARALLEL] Navega√ß√£o executada');
          }),

          // 2. Feedback visual instant√¢neo
          Promise.resolve().then(() => {
            addFloatMsg(`‚úÖ ${ans}`, 'agent');
            const lastMsg = chatFloatMessages.lastElementChild;
            if (lastMsg) {
              lastMsg.style.background = 'var(--success-color)';
              lastMsg.style.color = 'white';
              lastMsg.style.borderRadius = '12px';
            }
            console.log('‚úÖ [PARALLEL] Feedback visual');
          })
        ]).then(() => {
          console.log('‚ö° [PARALLEL] Navega√ß√£o completa em paralelo');
        }).catch(error => {
          console.error('‚ùå [PARALLEL] Erro:', error);
          addFloatMsg('‚ùå Erro ao executar comando de navega√ß√£o', 'agent');
        });
      } else {
        // Resposta normal do chat
        addFloatMsg(ans, 'agent');
      }

      chatFloatHistory.push({ role:'assistant', content: ans });
    }catch(e){
      addFloatMsg('Falha no servidor.', 'agent');
    }
  }

  // Sistema de voz foi consolidado na classe OrbionVoiceSystem avan√ßada

  // Eventos do chat flutuante
  if(chatFloatHeader){
    chatFloatHeader.addEventListener('click', ()=>{
      chatFloat.classList.toggle('minimized');
      // Alterna s√≠mbolo da seta
      const isMin = chatFloat.classList.contains('minimized');
      if(chatFloatToggle) chatFloatToggle.textContent = isMin ? '‚¨Ü' : '‚¨á';
    });
  }
  if(chatFloatSend){ chatFloatSend.addEventListener('click', sendChatFloat); }
  if(chatFloatInput){ chatFloatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ sendChatFloat(); } }); }
  // chatFloatMic integrado ao sistema de voz avan√ßado OrbionVoiceSystem

  // ===== DUPLICATE CODE REMOVED - THEME SYSTEM NOW LOADED BEFORE DOM =====

  function showBackgroundOptions(type){
    document.getElementById('gradient-options').style.display = type === 'gradient' ? 'flex' : 'none';
    document.getElementById('solid-options').style.display = type === 'solid' ? 'block' : 'none';
    document.getElementById('image-options').style.display = type === 'image' ? 'block' : 'none';
  }

  // ORBION sistema inteligente de harmoniza√ß√£o de cores
  function generateColorHarmony(baseColor) {
    // Converter hex para HSL
    const hex2hsl = (hex) => {
      const r = parseInt(hex.slice(1,3), 16) / 255;
      const g = parseInt(hex.slice(3,5), 16) / 255;
      const b = parseInt(hex.slice(5,7), 16) / 255;
      
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      
      if(max === min) {
        h = s = 0;
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch(max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }
      return [h * 360, s * 100, l * 100];
    };
    
    // Converter HSL para hex
    const hsl2hex = (h, s, l) => {
      h = h / 360;
      s = s / 100;
      l = l / 100;
      
      let r, g, b;
      if(s === 0) {
        r = g = b = l;
      } else {
        const hue2rgb = (p, q, t) => {
          if(t < 0) t += 1;
          if(t > 1) t -= 1;
          if(t < 1/6) return p + (q - p) * 6 * t;
          if(t < 1/2) return q;
          if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      
      const toHex = x => {
        const hex = Math.round(x * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      };
      
      return '#' + toHex(r) + toHex(g) + toHex(b);
    };
    
    const [h, s, l] = hex2hsl(baseColor);
    
    // Gerar cores harm√¥nicas
    return {
      primary: baseColor,
      secondary: hsl2hex((h + 30) % 360, s, l * 0.9), // An√°loga
      accent: hsl2hex((h + 180) % 360, s * 0.8, l * 1.1), // Complementar
      success: hsl2hex(145, 65, 50), // Verde harmonizado
      warning: hsl2hex(38, 75, 55), // Amarelo harmonizado
      error: hsl2hex(0, 70, 55), // Vermelho harmonizado
      muted: hsl2hex(h, s * 0.2, 60), // Vers√£o muted
      text: l > 50 ? '#1e293b' : '#f8fafc', // Texto baseado na luminosidade
      glass: l > 50 ? 'rgba(255,255,255,0.8)' : 'rgba(10,16,26,0.55)',
      border: l > 50 ? '#e2e8f0' : '#0F1B2E',
      bgPrimary: l > 50 ? '#f8fafc' : '#04060A',
      bgSecondary: l > 50 ? '#f1f5f9' : '#070C13'
    };
  }

  function getCurrentTheme(){
    const primaryColor = document.getElementById('primary-color').value;
    const harmony = generateColorHarmony(primaryColor);
    
    return {
      brandName: 'ORBION',
      logoUrl: document.getElementById('logo-url-input').value,
      primaryColor: harmony.primary,
      secondaryColor: document.getElementById('secondary-color').value || harmony.secondary,
      accentColor: document.getElementById('accent-color').value || harmony.accent,
      successColor: harmony.success,
      warningColor: harmony.warning,
      errorColor: harmony.error,
      mutedColor: harmony.muted,
      textColor: harmony.text,
      glassColor: harmony.glass,
      borderColor: harmony.border,
      bgPrimary: harmony.bgPrimary,
      bgSecondary: harmony.bgSecondary,
      backgroundType: document.getElementById('background-type').value,
      gradientStart: document.getElementById('gradient-start').value || harmony.primary,
      gradientEnd: document.getElementById('gradient-end').value || harmony.secondary,
      gradientDirection: document.getElementById('gradient-direction').value,
      solidColor: document.getElementById('solid-color').value,
      backgroundImage: document.getElementById('background-image').value,
      dashboardBg: getDashboardBackground()
    };
  }

  function getDashboardBackground(){
    const type = document.getElementById('background-type').value;
    if(type === 'gradient'){
      const start = document.getElementById('gradient-start').value;
      const end = document.getElementById('gradient-end').value;
      const direction = document.getElementById('gradient-direction').value;
      return `linear-gradient(${direction}, ${start} 0%, ${end} 100%)`;
    } else if(type === 'solid'){
      return document.getElementById('solid-color').value;
    } else if(type === 'image'){
      const imageUrl = document.getElementById('background-image').value;
      return imageUrl ? `url(${imageUrl})` : '#f8fafc';
    }
    return 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
  }

  // ===== Fun√ß√µes de Navega√ß√£o das Configura√ß√µes =====
  function showSettingsSection(sectionName) {
    // Esconder todas as se√ß√µes
    document.querySelectorAll('.settings-section').forEach(section => {
      section.style.display = 'none';
    });

    // Remover classe active de todos os bot√µes
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.classList.remove('active');
      btn.style.background = 'var(--glass)';
      btn.style.color = 'var(--text)';
    });

    // Mostrar se√ß√£o selecionada
    const targetSection = document.getElementById(`section-${sectionName}`);
    if(targetSection) {
      targetSection.style.display = 'block';
    }

    // Ativar bot√£o selecionado
    const activeBtn = document.querySelector(`[data-section="${sectionName}"]`);
    if(activeBtn) {
      activeBtn.classList.add('active');
      activeBtn.style.background = 'linear-gradient(135deg, var(--primary-color)20, var(--secondary-color)20)';
      activeBtn.style.color = 'var(--primary-color)';
    }
  }

  // Event Listeners para Personaliza√ß√£o (j√° movidos para o DOMContentLoaded principal)

  // ===== Fun√ß√µes de Status do ORBION =====
  function updateORBIONStatus() {
    // Simular atualiza√ß√£o de m√©tricas em tempo real
    const cpu = Math.floor(Math.random() * 20 + 25);
    const memory = Math.floor(Math.random() * 15 + 40);
    const requests = Math.floor(Math.random() * 50 + 100);
    
    document.getElementById('cpu-value').textContent = cpu + '%';
    document.getElementById('cpu-fill').style.width = cpu + '%';
    
    document.getElementById('memory-value').textContent = memory + '%';
    document.getElementById('memory-fill').style.width = memory + '%';
    
    document.getElementById('requests-value').textContent = requests;
    document.getElementById('requests-fill').style.width = Math.min(requests/200 * 100, 100) + '%';
    
    // Atualizar uptime
    const uptimeElement = document.getElementById('uptime-counter');
    if(uptimeElement) {
      const parts = uptimeElement.textContent.split(' ');
      let hours = parseInt(parts[0]);
      let minutes = parseInt(parts[1]);
      minutes++;
      if(minutes >= 60) {
        hours++;
        minutes = 0;
      }
      uptimeElement.textContent = hours + 'h ' + minutes + 'm';
    }
    
    // Adicionar novo log aleat√≥rio
    if(Math.random() > 0.7) {
      const logs = [
        'Requisi√ß√£o processada com sucesso',
        'Cache atualizado',
        'Conex√£o WhatsApp verificada',
        'Banco de dados otimizado',
        'Backup incremental realizado',
        'M√©tricas coletadas'
      ];
      const logsList = document.getElementById('logs-list');
      if(logsList) {
        const time = new Date().toLocaleTimeString('pt-BR');
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.style = 'padding:4px 8px; border-left:3px solid var(--primary-color); margin-bottom:4px; background:var(--glass); border-radius:4px; animation:fadeIn 0.5s;';
        logEntry.innerHTML = `<span style="color:var(--muted);">[${time}]</span> ${logs[Math.floor(Math.random() * logs.length)]}`;
        logsList.insertBefore(logEntry, logsList.firstChild);
        
        // Limitar logs a 10 entradas
        while(logsList.children.length > 10) {
          logsList.removeChild(logsList.lastChild);
        }
      }
    }
  }
  
  // Atualizar status a cada 3 segundos com cleanup
  let statusInterval = setInterval(updateORBIONStatus, 3000);

  // Cleanup do interval quando necess√°rio
  window.addEventListener('beforeunload', () => {
    if (statusInterval) {
      clearInterval(statusInterval);
      statusInterval = null;
    }
  });
  
  // ===== Fun√ß√£o de Teste do Sistema =====
  async function testSystemConfiguration() {
    const btn = document.getElementById('test-system-btn');
    const results = document.getElementById('test-results');
    
    // Atualizar bot√£o
    btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:8px;"></i>Executando Testes...';
    btn.disabled = true;
    
    // Mostrar √°rea de resultados
    results.style.display = 'block';
    results.innerHTML = '<div style="padding:12px; background:var(--glass); border-radius:8px; margin-bottom:8px;">üîÑ Iniciando diagn√≥stico...</div>';
    
    const tests = [];
    
    // Teste 1: API Principal
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_message: 'teste' })
      });
      
      if (response.ok) {
        tests.push({ name: 'API Principal', status: 'success', message: 'Funcionando corretamente' });
      } else {
        tests.push({ name: 'API Principal', status: 'error', message: `Erro HTTP: ${response.status}` });
      }
    } catch (error) {
      tests.push({ name: 'API Principal', status: 'error', message: `Falha na conex√£o: ${error.message}` });
    }
    
    // Teste 2: WhatsApp Status
    try {
      const response = await fetch('/api/whatsapp/status');
      if (response.ok) {
        const data = await response.json();
        if (data.instance && data.instance.state === 'open') {
          tests.push({ name: 'WhatsApp Evolution', status: 'success', message: 'Inst√¢ncia conectada e funcionando' });
        } else {
          tests.push({ name: 'WhatsApp Evolution', status: 'warning', message: 'Inst√¢ncia n√£o conectada' });
        }
      } else {
        tests.push({ name: 'WhatsApp Evolution', status: 'error', message: 'API n√£o dispon√≠vel' });
      }
    } catch (error) {
      tests.push({ name: 'WhatsApp Evolution', status: 'error', message: 'Falha na conex√£o' });
    }
    
    // Teste 3: Banco de Leads
    try {
      const response = await fetch('/api/leads');
      if (response.ok) {
        const data = await response.json();
        if(data.leads && Array.isArray(data.leads)){
          tests.push({ name: 'Base de Leads (Google Sheets)', status: 'success', message: `${data.leads.length} leads carregados` });
        } else {
          tests.push({ name: 'Base de Leads (Google Sheets)', status: 'warning', message: data.message || 'Planilha n√£o configurada' });
        }
      } else {
        tests.push({ name: 'Base de Leads', status: 'error', message: 'Falha ao carregar leads' });
      }
    } catch (error) {
      tests.push({ name: 'Base de Leads', status: 'error', message: 'Arquivo n√£o encontrado ou corrompido' });
    }
    
    // Teste 4: Google Calendar
    try {
      const response = await fetch('/api/events');
      if (response.ok) {
        tests.push({ name: 'Google Calendar', status: 'success', message: 'Integra√ß√£o funcionando' });
      } else if (response.status === 501) {
        tests.push({ name: 'Google Calendar', status: 'warning', message: 'N√£o configurado (opcional)' });
      } else {
        tests.push({ name: 'Google Calendar', status: 'error', message: 'Token expirado ou inv√°lido' });
      }
    } catch (error) {
      tests.push({ name: 'Google Calendar', status: 'warning', message: 'N√£o configurado (opcional)' });
    }
    
    // Teste 5: Analytics
    try {
      const response = await fetch('/api/analytics/overview');
      if (response.ok) {
        const data = await response.json();
        tests.push({ name: 'ORBION Analytics', status: 'success', message: 'Coletando m√©tricas normalmente' });
      } else {
        tests.push({ name: 'ORBION Analytics', status: 'error', message: 'Falha ao carregar m√©tricas' });
      }
    } catch (error) {
      tests.push({ name: 'ORBION Analytics', status: 'error', message: 'Banco de dados indispon√≠vel' });
    }
    
    // Renderizar resultados
    let html = '';
    tests.forEach(test => {
      const icon = test.status === 'success' ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="#10b981"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : test.status === 'warning' ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="#f59e0b"><path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>' : '<svg width="16" height="16" viewBox="0 0 24 24" fill="#ef4444"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg>';
      const color = test.status === 'success' ? 'var(--ok)' : test.status === 'warning' ? 'var(--warn)' : 'var(--error)';
      
      html += `
        <div style="padding:12px; background:var(--glass); border-radius:8px; margin-bottom:8px; border-left:4px solid ${color};">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div>
              <div style="font-weight:500; margin-bottom:4px;">${icon} ${test.name}</div>
              <div style="font-size:13px; color:var(--muted);">${test.message}</div>
            </div>
            <div style="padding:4px 8px; background:${color}20; color:${color}; border-radius:4px; font-size:11px; font-weight:600;">
              ${test.status.toUpperCase()}
            </div>
          </div>
        </div>
      `;
    });
    
    // Status geral
    const successCount = tests.filter(t => t.status === 'success').length;
    const totalTests = tests.length;
    const healthScore = Math.round((successCount / totalTests) * 100);
    
    let overallStatus, overallColor, overallIcon;
    if (healthScore >= 80) {
      overallStatus = 'Excelente';
      overallColor = 'var(--ok)';
      overallIcon = 'üü¢';
    } else if (healthScore >= 60) {
      overallStatus = 'Bom';
      overallColor = 'var(--warn)';
      overallIcon = 'üü°';
    } else {
      overallStatus = 'Aten√ß√£o Necess√°ria';
      overallColor = 'var(--error)';
      overallIcon = 'üî¥';
    }
    
    html = `
      <div style="padding:16px; background:linear-gradient(135deg, ${overallColor}15, ${overallColor}05); border:2px solid ${overallColor}30; border-radius:12px; margin-bottom:16px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
          <span style="font-size:24px;">${overallIcon}</span>
          <div>
            <div style="font-size:18px; font-weight:700; color:${overallColor};">Status: ${overallStatus}</div>
            <div style="font-size:14px; color:var(--text);">Score de Sa√∫de: ${healthScore}% (${successCount}/${totalTests} testes aprovados)</div>
          </div>
        </div>
      </div>
      ${html}
    `;
    
    results.innerHTML = html;
    
    // Restaurar bot√£o
    btn.innerHTML = '<i class="fas fa-check-circle" style="margin-right:8px;"></i>Executar Teste Completo';
    btn.disabled = false;
  }
  
  // ===== Inicializa√ß√£o =====
  console.log('üî• ORBION: Inicializando dashboard...');

  // Teste b√°sico
  console.log('üî• ORBION: Testando fetch b√°sico...');
  fetch('/api/leads')
    .then(r => r.json())
    .then(data => {
      console.log('üî• ORBION: Teste fetch direto funcionou:', data);
      console.log('üî• ORBION: Leads encontrados:', data.leads ? data.leads.length : 0);
    })
    .catch(e => console.error('üî• ORBION: Erro no teste fetch:', e));

  // Fun√ß√£o de teste manual
  function testAPI() {
    console.log('üî• ORBION: TESTE MANUAL INICIADO');
    alert('Testando API - veja o console!');

    fetch('/api/leads')
      .then(r => r.json())
      .then(data => {
        console.log('üî• ORBION: RESPOSTA DA API:', data);
        alert(`API funcionou! ${data.leads ? data.leads.length : 0} leads encontrados. Veja o console para detalhes.`);

        if (data.leads && data.leads.length > 0) {
          console.log('üî• ORBION: Chamando renderLeads manualmente...');
          renderLeads(data.leads, '', null, null);
        }
      })
      .catch(e => {
        console.error('üî• ORBION: ERRO NA API:', e);
        alert('Erro na API: ' + e.message);
      });
  }

  // Tornar fun√ß√£o global para usar no HTML
  window.testAPI = testAPI;

  loadEvents();
  loadLeads();
  loadFunnel();
  loadWhatsAppData();
  updateORBIONStatus();
  
  // ===== MENU MOBILE REMOVIDO - INTEGRADO AO DOMContentLoaded PRINCIPAL v2.4 =====
  
  // ===== SISTEMA DE CAMPANHAS INTELIGENTES =====
  function openCampaignModal() {
    const modal = document.getElementById('campaign-modal');
    if (!modal) {
      createCampaignModal();
    }
    document.getElementById('campaign-modal').style.display = 'flex';
    loadCampaignStats();
  }
  
  function createCampaignModal() {
    const modalHTML = `
      <div id="campaign-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:var(--bg-1); border-radius:16px; padding:32px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="margin:0; font-size:24px; font-weight:700; color:var(--text);">
              üöÄ Campanha Inteligente WhatsApp
            </h2>
            <button onclick="closeCampaignModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted);">√ó</button>
          </div>
          
          <!-- Stats de Aquecimento -->
          <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-bottom:24px;">
            <div style="padding:16px; background:var(--glass); border-radius:12px; text-align:center;">
              <div style="font-size:20px; font-weight:700; color:var(--primary-color);" id="campaign-limit">--</div>
              <div style="font-size:11px; color:var(--muted);">Limite Di√°rio</div>
            </div>
            <div style="padding:16px; background:var(--glass); border-radius:12px; text-align:center;">
              <div style="font-size:20px; font-weight:700; color:var(--cyan);" id="campaign-sent-today">0</div>
              <div style="font-size:11px; color:var(--muted);">Enviados Hoje</div>
            </div>
            <div style="padding:16px; background:var(--glass); border-radius:12px; text-align:center;">
              <div style="font-size:20px; font-weight:700; color:var(--ok);" id="campaign-available">--</div>
              <div style="font-size:11px; color:var(--muted);">Dispon√≠vel</div>
            </div>
            <div style="padding:16px; background:var(--glass); border-radius:12px; text-align:center;">
              <div style="font-size:20px; font-weight:700; color:var(--warn);" id="campaign-days">0</div>
              <div style="font-size:11px; color:var(--muted);">Dias Ativos</div>
            </div>
          </div>
          
          <!-- Configura√ß√µes da Campanha -->
          <div style="background:var(--glass); padding:20px; border-radius:12px; margin-bottom:24px;">
            <h3 style="margin:0 0 16px; font-size:18px; color:var(--text);">‚öôÔ∏è Configura√ß√µes</h3>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
              <div>
                <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:600; color:var(--text);">
                  Modo de Execu√ß√£o
                </label>
                <select id="campaign-mode" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:white;">
                  <option value="test">üß™ Modo Teste (Simula√ß√£o)</option>
                  <option value="real">üöÄ Modo Real (Enviar)</option>
                </select>
              </div>
              
              <div>
                <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:600; color:var(--text);">
                  Limite de Mensagens
                </label>
                <input type="number" id="campaign-max" placeholder="Autom√°tico baseado no aquecimento" 
                       style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
              </div>
            </div>
            
            <!-- Seletor de Quantidade de Leads -->
            <div style="margin-bottom:16px;">
              <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:600; color:var(--text);">
                üéØ Quantidade de Leads para Campanha
              </label>
              <select id="campaign-quantity" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:white;" onchange="toggleCustomQuantity()">
                <option value="all">Todos os Leads (20)</option>
                <option value="1">1 Lead (Teste R√°pido)</option>
                <option value="3">3 Leads</option>
                <option value="5">5 Leads</option>
                <option value="10">10 Leads (Meio)</option>
                <option value="15">15 Leads</option>
                <option value="20">20 Leads (Todos)</option>
                <option value="custom">üìù Quantidade Personalizada</option>
              </select>
            </div>
            
            <!-- Campo para quantidade personalizada -->
            <div id="custom-quantity-div" style="display:none; margin-bottom:16px;">
              <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:600; color:var(--text);">
                Quantidade Personalizada (1-20):
              </label>
              <input type="number" id="custom-quantity" min="1" max="20" value="5" placeholder="Digite um n√∫mero entre 1 e 20" 
                     style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
            </div>

            <div>
              <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:600; color:var(--text);">
                Filtro de Categoria (Opcional)
              </label>
              <select id="campaign-category" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:white;">
                <option value="">Todas as Categorias</option>
                <option value="Academia/Fitness">üí™ Academia/Fitness</option>
                <option value="Sa√∫de/Cl√≠nica">üè• Sa√∫de/Cl√≠nica</option>
                <option value="Studio Criativo">üé® Studio Criativo</option>
                <option value="Alimenta√ß√£o">üçΩÔ∏è Alimenta√ß√£o</option>
                <option value="Advocacia">‚öñÔ∏è Advocacia</option>
                <option value="Beleza/Est√©tica">üíÑ Beleza/Est√©tica</option>
                <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                <option value="Tecnologia">üíª Tecnologia</option>
                <option value="E-commerce">üõí E-commerce</option>
                <option value="Consultoria">üß† Consultoria</option>
                <option value="Imobili√°rio">üè† Imobili√°rio</option>
                <option value="Automotivo">üöó Automotivo</option>
              </select>
            </div>
          </div>
          
          <!-- Preview de Mensagem -->
          <div style="background:var(--glass); padding:20px; border-radius:12px; margin-bottom:24px;">
            <h3 style="margin:0 0 16px; font-size:18px; color:var(--text);">üìù Preview de Mensagem</h3>
            <div id="campaign-preview" style="padding:16px; background:white; border-radius:8px; font-family:monospace; font-size:13px; line-height:1.6; white-space:pre-wrap; color:#333;">
              Clique em "Analisar Leads" para ver preview personalizado...
            </div>
          </div>
          
          <!-- Informa√ß√µes de Cad√™ncia -->
          <div style="background:linear-gradient(135deg, var(--warn)10, var(--warn)05); padding:16px; border-radius:12px; margin-bottom:24px; border-left:4px solid var(--warn);">
            <h4 style="margin:0 0 8px; font-size:14px; color:var(--text);">‚ö†Ô∏è Cad√™ncia Segura Ativada</h4>
            <ul style="margin:0; padding-left:20px; font-size:12px; color:var(--muted); line-height:1.6;">
              <li>Intervalo aleat√≥rio de 5-10 segundos entre mensagens</li>
              <li>5 varia√ß√µes de mensagem autom√°ticas</li>
              <li>Prioriza√ß√£o por score de oportunidade</li>
              <li>Monitoramento de qualidade em tempo real</li>
              <li>Pausa autom√°tica se detectar bloqueios</li>
            </ul>
          </div>
          
          <!-- Bot√µes de A√ß√£o -->
          <div style="display:flex; gap:12px; justify-content:flex-end;">
            <button onclick="analyzeCampaignLeads()" style="padding:12px 24px; background:var(--primary-color); color:white; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;">
              üîç Analisar Leads
            </button>
            <button onclick="runCampaign()" id="campaign-run-btn" style="padding:12px 32px; background:linear-gradient(135deg, var(--ok), var(--cyan)); color:white; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;">
              üöÄ Iniciar Campanha
            </button>
          </div>
          
          <!-- Resultado da Campanha -->
          <div id="campaign-results" style="display:none; margin-top:24px; padding:20px; background:var(--glass); border-radius:12px;">
            <h3 style="margin:0 0 16px; font-size:18px; color:var(--text);">üìä Resultados</h3>
            <div id="campaign-results-content"></div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeCampaignModal() {
    document.getElementById('campaign-modal').style.display = 'none';
  }

  function toggleCustomQuantity() {
    const quantitySelect = document.getElementById('campaign-quantity');
    const customDiv = document.getElementById('custom-quantity-div');
    
    if (quantitySelect.value === 'custom') {
      customDiv.style.display = 'block';
    } else {
      customDiv.style.display = 'none';
    }
  }
  
  async function loadCampaignStats() {
    try {
      const response = await fetch('/api/campaign/stats');
      const stats = await response.json();
      
      // Calcula limite baseado nos dias
      const limits = [
        { days: [1, 2], limit: 40 },
        { days: [3, 5], limit: 100 },
        { days: [6, 10], limit: 200 },
        { days: [11, 14], limit: 300 },
        { days: [15, 999], limit: 500 }
      ];
      
      let currentLimit = 40;
      for (const rule of limits) {
        if (stats.daysSinceStart >= rule.days[0] - 1 && stats.daysSinceStart <= rule.days[1] - 1) {
          currentLimit = rule.limit;
          break;
        }
      }
      
      document.getElementById('campaign-limit').textContent = currentLimit;
      document.getElementById('campaign-sent-today').textContent = stats.sentToday || 0;
      document.getElementById('campaign-available').textContent = Math.max(0, currentLimit - (stats.sentToday || 0));
      document.getElementById('campaign-days').textContent = stats.daysSinceStart || 0;
    } catch (error) {
      console.error('Erro ao carregar stats:', error);
    }
  }
  
  async function analyzeCampaignLeads() {
    try {
      const leads = await fetch('/api/leads').then(r => r.json()).then(d => d.success ? d.leads || [] : []);
      if (leads.length === 0) {
        alert('Nenhum lead cadastrado!');
        return;
      }
      
      // Analisa o primeiro lead como exemplo
      const response = await fetch('/api/campaign/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lead: leads[0] })
      });
      
      const analysis = await response.json();
      
      // Mostra preview
      const preview = `Exemplo para: ${leads[0].name}
      
Setor: ${analysis.sectorAnalysis.type}
Perfil: ${analysis.behaviorProfile.profile}
Score: ${analysis.priorityScore}/100
Tom: ${analysis.recommendedTone}

Mensagem Personalizada:
---
Ol√°, ${leads[0].name}! üëã

Notei que voc√™s trabalham no setor de ${analysis.sectorAnalysis.type}. 

Muitas ${leads[0].category || 'empresas'} em Natal enfrentam o desafio de ${analysis.painPoints[0]?.toLowerCase() || 'otimizar processos'}.

Desenvolvemos uma solu√ß√£o de IA que ${analysis.aiOpportunities?.split(';')[0] || 'automatiza tarefas repetitivas'}.

Posso compartilhar como isso funcionaria especificamente para voc√™s?
---

Total de ${leads.length} leads prontos para campanha!`;
      
      document.getElementById('campaign-preview').textContent = preview;
    } catch (error) {
      console.error('Erro na an√°lise:', error);
      alert('Erro ao analisar leads: ' + error.message);
    }
  }
  
  async function runCampaign() {
    const mode = document.getElementById('campaign-mode').value;
    const testMode = mode === 'test';
    const maxMessages = document.getElementById('campaign-max').value || null;
    const category = document.getElementById('campaign-category').value;
    
    // Obter quantidade de leads selecionada
    const quantitySelect = document.getElementById('campaign-quantity').value;
    let leadQuantity = null;
    
    if (quantitySelect === 'all') {
      leadQuantity = null; // Todos os leads
    } else if (quantitySelect === 'custom') {
      leadQuantity = parseInt(document.getElementById('custom-quantity').value) || 5;
    } else {
      leadQuantity = parseInt(quantitySelect);
    }
    
    console.log('üéØ Quantidade de leads selecionada:', leadQuantity || 'Todos');
    
    if (!testMode && !confirm(`‚ö†Ô∏è MODO REAL - As mensagens ser√£o enviadas de verdade!\n\nüéØ Quantidade de leads: ${leadQuantity || 'Todos os 20 leads'}\nüìÇ Categoria: ${category || 'Todas as categorias'}\n\nTem certeza que deseja continuar?`)) {
      return;
    }
    
    const btn = document.getElementById('campaign-run-btn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Executando...';
    
    try {
      // Busca leads
      let leads = await fetch('/api/leads').then(r => r.json()).then(d => d.success ? d.leads || [] : []);
      
      // Filtra por categoria se especificado
      if (category) {
        leads = leads.filter(l => (l.category || '').toLowerCase().includes(category));
      }
      
      // Aplica limite de quantidade se especificado
      if (leadQuantity && leadQuantity > 0) {
        leads = leads.slice(0, leadQuantity);
        console.log(`üéØ Limitando campanha para ${leadQuantity} leads`);
      }
      
      if (leads.length === 0) {
        alert('Nenhum lead encontrado com os filtros selecionados!');
        return;
      }
      
      console.log(`üìä Executando campanha para ${leads.length} leads`);
      
      // Executa campanha
      const response = await fetch('/api/campaign/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leads,
          testMode,
          maxMessages: maxMessages ? parseInt(maxMessages) : null
        })
      });
      
      const result = await response.json();
      
      // Mostra resultados
      const resultsHTML = `
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:16px;">
          <div style="padding:12px; background:var(--ok)10; border-radius:8px; text-align:center;">
            <div style="font-size:24px; font-weight:700; color:var(--ok);">‚úÖ ${result.sent}</div>
            <div style="font-size:12px; color:var(--muted);">Enviados</div>
          </div>
          <div style="padding:12px; background:var(--err)10; border-radius:8px; text-align:center;">
            <div style="font-size:24px; font-weight:700; color:var(--err);">‚ùå ${result.failed}</div>
            <div style="font-size:12px; color:var(--muted);">Falhados</div>
          </div>
          <div style="padding:12px; background:var(--warn)10; border-radius:8px; text-align:center;">
            <div style="font-size:24px; font-weight:700; color:var(--warn);">‚è≠Ô∏è ${result.skipped}</div>
            <div style="font-size:12px; color:var(--muted);">Pulados</div>
          </div>
        </div>
        
        <div style="padding:12px; background:var(--glass); border-radius:8px;">
          <strong>Taxa de Sucesso:</strong> ${((result.sent/result.total)*100).toFixed(1)}%
        </div>
        
        ${testMode ? '<div style="margin-top:12px; padding:12px; background:var(--warn)10; border-radius:8px; color:var(--warn); font-size:13px;">‚ö†Ô∏è Modo Teste - Nenhuma mensagem foi realmente enviada</div>' : ''}
      `;
      
      document.getElementById('campaign-results-content').innerHTML = resultsHTML;
      document.getElementById('campaign-results').style.display = 'block';
      
      // Atualiza stats
      loadCampaignStats();
      
    } catch (error) {
      console.error('Erro na campanha:', error);
      alert('Erro ao executar campanha: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üöÄ Iniciar Campanha';
    }
  }
  </script>

  <!-- ===== ORBION VOICE SYSTEM ===== -->
  <script>
    // ===================================================================
    // ORBION VOICE SYSTEM - AGENTE DE VOZ COMPLETO
    // Sistema de reconhecimento e s√≠ntese de voz com IA
    // ===================================================================

    class OrbionVoiceSystem {
        constructor(config = {}) {
            // Verifica√ß√£o de inst√¢ncia √∫nica
            if (window.orbionVoiceInstance) {
                console.warn('üö´ ORBION Voice: Inst√¢ncia j√° existe, retornando inst√¢ncia existente');
                return window.orbionVoiceInstance;
            }

            // Marcar como inst√¢ncia √∫nica
            window.orbionVoiceInstance = this;

            // Configura√ß√µes do sistema
            this.config = {
                language: config.language || 'pt-BR',
                continuous: config.continuous !== false,
                interimResults: config.interimResults !== false,
                voiceSpeed: config.voiceSpeed || 1.1,
                voicePitch: config.voicePitch || 1.0,
                voiceVolume: config.voiceVolume || 0.9,
                autoStop: config.autoStop || false,
                debug: config.debug || false
            };

            // Estado do sistema
            this.isListening = false;
            this.isSpeaking = false;
            this.isProcessing = false;
            this.recognition = null;
            this.synthesis = window.speechSynthesis;
            this.conversationHistory = [];
            this.currentTranscript = '';
            this.useElevenLabs = true; // Default: usar ElevenLabs Premium (qualidade superior)
            this.useLocalTTS = false; // Padr√£o: ElevenLabs Premium

            // Callbacks personalizados
            this.onResult = config.onResult || null;
            this.onError = config.onError || null;
            this.onStart = config.onStart || null;
            this.onEnd = config.onEnd || null;

            // Inicializar sistema
            this.initialize();
        }

        // ===== INICIALIZA√á√ÉO =====
        initialize() {
            if (!this.checkBrowserSupport()) {
                console.error('‚ùå Navegador n√£o suporta Web Speech API');
                return false;
            }
            this.setupSpeechRecognition();
            this.loadVoices();
            this.initializeVoiceOrb();
            console.log('‚úÖ ORBION Voice System inicializado!');
            return true;
        }

        // ===== VERIFICA√á√ÉO DE SUPORTE =====
        checkBrowserSupport() {
            const hasSpeechRecognition = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
            const hasSpeechSynthesis = 'speechSynthesis' in window;
            return hasSpeechRecognition && hasSpeechSynthesis;
        }

        // ===== CONFIGURA√á√ÉO DO RECONHECIMENTO =====
        setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            this.recognition = new SpeechRecognition();
            this.recognition.lang = this.config.language;
            this.recognition.continuous = this.config.continuous;
            this.recognition.interimResults = this.config.interimResults;
            this.recognition.maxAlternatives = 10; // Mais alternativas para melhor precis√£o
            this.recognition.serviceURI = ''; // For√ßa uso do servi√ßo do Google

            // ===== MELHORIAS DE PRECIS√ÉO AVAN√áADAS =====

            // Configura√ß√µes de √°udio otimizadas
            if (this.recognition.audioTrack) {
                this.recognition.audioTrack.echoCancellation = true;
                this.recognition.audioTrack.noiseSuppression = true;
                this.recognition.audioTrack.autoGainControl = true;
                this.recognition.audioTrack.sampleRate = 48000; // Taxa de amostragem mais alta
                this.recognition.audioTrack.channelCount = 1; // Mono para melhor processamento
            }

            // Grammar melhorada com mais comandos e varia√ß√µes
            if (this.recognition.grammars) {
                const grammar = `#JSGF V1.0; grammar commands;
                public <command> =
                    digital boost | digitalboost | digital | boost |
                    orbion | √≥rbion | orbi√£o |
                    configura√ß√µes | configuracao | configura√ß√£o | config | settings |
                    whatsapp | zap | wpp | watts | whats |
                    analytics | anal√≠tica | analise | an√°lise | estatisticas | estat√≠sticas |
                    leads | lead | contatos | clientes | prospects |
                    dados | informa√ß√µes | informacoes |
                    empresa | neg√≥cios | negocios | vendas | comercial |
                    crm | sistema | plataforma |
                    dashboard | painel | central | hub |
                    status | situa√ß√£o | situacao |
                    relat√≥rio | relatorio | report |
                    funil | pipeline | processo |
                    m√©tricas | metricas | indicadores |
                    temas | tema | apar√™ncia | aparencia | cores |
                    home | inicio | in√≠cio | principal |
                    parar | stop | pare | encerrar | finalizar |
                    ativar | ativar sistema | iniciar | come√ßar |
                    ajuda | help | socorro | auxiliar |
                    volume | som | audio | √°udio |
                    microfone | mic | entrada | grava√ß√£o |
                    campanha | campanhas | ativa | ativas |
                    mensagens | mensagem | total | quantas |
                    √∫ltimo | ultima | mais recente | mais novo |
                    sistema funcionando | sa√∫de do sistema |
                    conex√£o | conectado | desconectado |
                    reuni√µes | reuni√£o | agenda | compromissos |
                    hoje | agendadas | pr√≥ximas | pr√≥ximos |
                    calend√°rio | calendar | eventos | criar |
                    agendar | marcar | nova | novo;`;

                const speechRecognitionList = new (window.SpeechGrammarList || window.webkitSpeechGrammarList)();
                speechRecognitionList.addFromString(grammar, 1);
                this.recognition.grammars = speechRecognitionList;
            }

            // ===== FILTRO DE RU√çDO E NORMALIZA√á√ÉO =====
            this.setupAudioProcessing();

            // ===== CONFIGURA√á√ïES AVAN√áADAS DE RECONHECIMENTO =====
            this.setupAdvancedRecognitionSettings();

            // Quando inicia
            this.recognition.onstart = () => {
                this.isListening = true;
                this.setVoiceOrbState('active');
                console.log('üé§ ORBION ouvindo...');
                if (this.onStart) this.onStart();
            };

            // Quando recebe resultados
            this.recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const result = event.results[last];

                // Avaliar todas as alternativas para escolher a melhor
                let bestTranscript = result[0].transcript;
                let bestConfidence = result[0].confidence || 0.5;

                // Log otimizado de alternativas (apenas em debug mode)
                if (this.config.debug) {
                    console.log('üéØ Alternativas de reconhecimento:');
                }
                for (let i = 0; i < result.length; i++) {
                    const alt = result[i];
                    if (this.config.debug) {
                        console.log(`  ${i + 1}. "${alt.transcript}" (Confian√ßa: ${alt.confidence || 'N/A'})`);
                    }

                    // Priorizar alternativas com palavras-chave importantes
                    const transcript = alt.transcript.toLowerCase();
                    const hasKeywords = transcript.includes('digital boost') ||
                                       transcript.includes('digitalboost') ||
                                       transcript.includes('o que √©') ||
                                       transcript.includes('o que e') ||
                                       transcript.includes('que √©') ||
                                       transcript.includes('que e') ||
                                       transcript.includes('sobre') ||
                                       transcript.includes('explique') ||
                                       transcript.includes('fale sobre') ||
                                       transcript.includes('orbion') ||
                                       transcript.includes('configura√ß√µes') ||
                                       transcript.includes('configuracao') ||
                                       transcript.includes('config') ||
                                       transcript.includes('whatsapp') ||
                                       transcript.includes('zap') ||
                                       transcript.includes('analytics') ||
                                       transcript.includes('anal√≠tica') ||
                                       transcript.includes('leads') ||
                                       transcript.includes('dados') ||
                                       transcript.includes('empresa') ||
                                       transcript.includes('neg√≥cios') ||
                                       transcript.includes('vendas') ||
                                       transcript.includes('dashboard') ||
                                       transcript.includes('painel') ||
                                       transcript.includes('sistema');

                    // Se tem palavras-chave importantes, dar prioridade mesmo com confian√ßa menor
                    if (hasKeywords && (alt.confidence || 0.4) > 0.3) {
                        bestTranscript = alt.transcript;
                        bestConfidence = alt.confidence || 0.7;
                        console.log(`üéØ Selecionada por palavra-chave: "${bestTranscript}"`);
                    }
                }

                const isFinal = result.isFinal;
                console.log(`üìù Melhor transcri√ß√£o: "${bestTranscript}" (Final: ${isFinal}, Confian√ßa: ${bestConfidence})`);

                // üö´ PROTE√á√ÉO ANTI-FEEDBACK TEMPORAL: Verificar m√∫ltiplos estados
                const now = Date.now();
                const lastTTSEndTime = window.lastOrbionTTSEnd || 0;
                const timeSinceLastTTS = now - lastTTSEndTime;
                const QUARANTINE_TIME = 3000; // 3 segundos de quarentena ap√≥s TTS

                if (this.isSpeaking || window.orbionSpeaking || timeSinceLastTTS < QUARANTINE_TIME) {
                    console.log(`üö´ [ANTI-FEEDBACK] Ignorando input - Falando: ${this.isSpeaking || window.orbionSpeaking}, Quarentena: ${timeSinceLastTTS < QUARANTINE_TIME} (${Math.round(timeSinceLastTTS/1000)}s)`);
                    return;
                }

                // üö´ BLOQUEIO IMEDIATO POR TIMESTAMP: Evitar processamento muito r√°pido
                const lastProcessTime = window.lastVoiceProcessTime || 0;
                const timeBetweenCommands = now - lastProcessTime;
                if (timeBetweenCommands < 2000) { // M√≠nimo 2s entre comandos
                    console.log(`üö´ [ANTI-FEEDBACK] Comando muito r√°pido - aguarde ${Math.round((2000 - timeBetweenCommands)/1000)}s`);
                    return;
                }

                // üö´ PROTE√á√ÉO ANTI-FEEDBACK AVAN√áADA: Filtrar qualquer resposta do ORBION
                const transcriptLower = bestTranscript.toLowerCase().trim();

                // üîá BLOQUEIO IMEDIATO: Se detectado qualquer varia√ß√£o de "marca de verifica√ß√£o"
                const marcaVariations = [
                    'marca de verifica√ß√£o', 'marca verifica√ß√£o', 'marca ver', 'marca',
                    'nunca de verifica√ß√£o', 'nunca verifica√ß√£o',
                    'vaca de verifica√ß√£o', 'marca reverifica√ß√£o',
                    'verifica√ß√£o marca', 'verifica√ß√£o ativando',
                    'maca de verifica√ß√£o', 'maga de verifica√ß√£o'
                ];

                // Lista expandida de frases de feedback do ORBION
                const feedbackPhrases = [
                    ...marcaVariations,
                    'ativando lista de comandos', 'ativando lista',
                    'abrindo aba', 'abrindo',
                    'voc√™ ser√° redirecionado', 'ser√° redirecionado',
                    'n√£o posso ajudar com esse tipo de assunto',
                    'posso falar sobre nossas solu√ß√µes',
                    'ativando chat minimizado', 'chat minimizado',
                    'tema alterado para escuro', 'tema alterado',
                    'ocorreu um erro de comunica√ß√£o', 'erro de comunica√ß√£o',
                    'comandos dispon√≠veis', 'lista de comandos',
                    'navegando para aba', 'navegando para',
                    'lista de comandos de voz', 'comandos de voz',
                    'ativando tema', 'ativando configura√ß√µes',
                    'ativando', 'tema escuro', 'tema claro',
                    'configura√ß√£o ativada', 'funcionalidade ativada',
                    'redirecionando', 'carregando'
                ];

                // Padr√µes expandidos que indicam eco do sistema
                const echoPatterns = [
                    /^ativando/i,
                    /(marca|nunca|vaca|maca|maga).*verific/i, // Todas varia√ß√µes de "marca de verifica√ß√£o"
                    /verific.*ativando/i,
                    /lista.*comandos/i,
                    /^tema.*(escuro|claro)/i,
                    /chat.*minimizado/i,
                    /(√≥rg√£o|orgao).*abrir/i,
                    /^abrindo/i,
                    /^navegando/i,
                    /redirecionando/i,
                    /carregando/i,
                    /funcionalidade.*ativada/i,
                    /configura√ß√£o.*ativada/i,
                    /^ser√°/i,
                    /^voc√™.*ser√°/i
                ];

                // Verificar frases exatas
                const containsFeedbackPhrase = feedbackPhrases.some(phrase => transcriptLower.includes(phrase));

                // Verificar padr√µes regex
                const matchesEchoPattern = echoPatterns.some(pattern => pattern.test(transcriptLower));

                // Filtrar comandos muito curtos ou sem sentido
                const isTooShort = transcriptLower.length < 3;
                const isNonsense = /^[^a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß\s]+$/.test(transcriptLower);

                if (containsFeedbackPhrase || matchesEchoPattern || isTooShort || isNonsense) {
                    console.log('üö´ [ANTI-FEEDBACK] Detectado eco/feedback do sistema - ignorando:', bestTranscript);
                    return;
                }

                if (isFinal) {
                    console.log('‚úÖ Resultado final, processando...');
                    this.currentTranscript = bestTranscript;

                    // üïí TIMESTAMP: Marcar quando comando foi processado
                    window.lastVoiceProcessTime = Date.now();

                    // Feedback auditivo sutil para confirma√ß√£o
                    if (bestConfidence > 0.7) {
                        console.log('üéØ Alta confian√ßa - processando imediatamente');
                    } else if (bestConfidence > 0.5) {
                        console.log('‚ö° Confian√ßa m√©dia - processando com cuidado');
                    } else {
                        console.log('‚ö†Ô∏è Baixa confian√ßa - pode precisar repetir');
                    }

                    this.processVoiceInput(bestTranscript);
                    if (this.onResult) this.onResult(bestTranscript, bestConfidence);
                } else {
                    console.log('‚è≥ Resultado parcial...');
                }
            };

            // Quando ocorre erro
            this.recognition.onerror = (event) => {
                const errorMessages = {
                    'no-speech': 'Nenhuma fala detectada.',
                    'audio-capture': 'Microfone n√£o encontrado.',
                    'not-allowed': 'Permiss√£o negada para microfone.',
                    'network': 'Erro de rede.',
                    'aborted': 'Reconhecimento cancelado.'
                };
                const message = errorMessages[event.error] || `Erro: ${event.error}`;

                // Auto-restart para erros tempor√°rios
                if (event.error === 'network' || event.error === 'no-speech') {
                    console.log(`üîÑ Auto-restart ap√≥s erro tempor√°rio: ${event.error}`);
                    setTimeout(() => {
                        if (!this.isListening) {
                            this.start();
                        }
                    }, 2000);
                } else {
                    // Para erros permanentes, mostrar estado de erro
                    this.setVoiceOrbState('error');
                    setTimeout(() => this.setVoiceOrbState('idle'), 3000);
                }

                if (this.onError) this.onError(event.error, message);
            };

            // Quando termina
            this.recognition.onend = () => {
                this.isListening = false;
                if (!this.isProcessing) {
                    this.setVoiceOrbState('idle');
                }
                if (this.onEnd) this.onEnd();

                // Reiniciar se modo cont√≠nuo
                if (this.config.continuous && !this.config.autoStop) {
                    setTimeout(() => {
                        if (!this.isListening && !this.isSpeaking) {
                            this.start();
                        }
                    }, 1000);
                }
            };
        }

        // ===== SISTEMA DE PROCESSAMENTO DE √ÅUDIO AVAN√áADO =====
        setupAudioProcessing() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn('‚ö†Ô∏è MediaDevices API n√£o dispon√≠vel - usando configura√ß√µes b√°sicas');
                return;
            }

            // Configura√ß√µes de √°udio otimizadas para reconhecimento de voz
            this.audioConstraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 48000,
                    channelCount: 1,
                    volume: 1.0,
                    // Configura√ß√µes espec√≠ficas para Chrome/Edge
                    googEchoCancellation: true,
                    googAutoGainControl: true,
                    googNoiseSuppression: true,
                    googHighpassFilter: true,
                    googTypingNoiseDetection: true,
                    googAudioMirroring: false
                }
            };

            // Inicializar an√°lise de volume em tempo real
            this.setupVolumeAnalysis();

            console.log('üîä Sistema de processamento de √°udio configurado');
        }

        // ===== AN√ÅLISE DE VOLUME E QUALIDADE DE √ÅUDIO =====
        setupVolumeAnalysis() {
            try {
                navigator.mediaDevices.getUserMedia(this.audioConstraints)
                    .then(stream => {
                        this.audioStream = stream;
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.microphone = this.audioContext.createMediaStreamSource(stream);

                        // Configura√ß√µes do analisador
                        this.analyser.fftSize = 256;
                        this.analyser.smoothingTimeConstant = 0.8;
                        this.microphone.connect(this.analyser);

                        // Array para dados de frequ√™ncia
                        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);

                        // Iniciar monitoramento de volume
                        this.startVolumeMonitoring();

                        console.log('üéØ An√°lise de volume de √°udio configurada');
                    })
                    .catch(error => {
                        console.warn('‚ö†Ô∏è Erro ao configurar an√°lise de √°udio:', error);
                    });
            } catch (error) {
                console.warn('‚ö†Ô∏è An√°lise de volume n√£o dispon√≠vel:', error);
            }
        }

        // ===== MONITORAMENTO DE VOLUME EM TEMPO REAL =====
        startVolumeMonitoring() {
            if (!this.analyser || !this.dataArray) return;

            const checkVolume = () => {
                this.analyser.getByteFrequencyData(this.dataArray);

                // Calcular volume m√©dio
                let sum = 0;
                for (let i = 0; i < this.dataArray.length; i++) {
                    sum += this.dataArray[i];
                }
                const averageVolume = sum / this.dataArray.length;

                // Detectar se h√° fala (volume acima do threshold)
                const speechThreshold = 30;
                this.hasSpeech = averageVolume > speechThreshold;

                // Detectar ru√≠do de fundo
                const noiseThreshold = 15;
                this.hasNoise = averageVolume > noiseThreshold && averageVolume < speechThreshold;

                // Continuar monitoramento se estiver ouvindo
                if (this.isListening) {
                    requestAnimationFrame(checkVolume);
                }
            };

            checkVolume();
        }

        // ===== CONFIGURA√á√ïES AVAN√áADAS DE RECONHECIMENTO =====
        setupAdvancedRecognitionSettings() {
            // Configura√ß√µes espec√≠ficas do navegador
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);

            if (isChrome) {
                // Otimiza√ß√µes espec√≠ficas para Chrome
                this.recognition.maxAlternatives = 10;
                console.log('üîß Otimiza√ß√µes Chrome aplicadas');
            } else if (isFirefox) {
                // Otimiza√ß√µes espec√≠ficas para Firefox
                this.recognition.maxAlternatives = 5;
                console.log('üîß Otimiza√ß√µes Firefox aplicadas');
            } else if (isSafari) {
                // Otimiza√ß√µes espec√≠ficas para Safari
                this.recognition.maxAlternatives = 3;
                console.log('üîß Otimiza√ß√µes Safari aplicadas');
            }

            // Sistema de corre√ß√£o autom√°tica
            this.setupAutoCorrection();
        }

        // ===== SISTEMA DE CORRE√á√ÉO AUTOM√ÅTICA =====
        setupAutoCorrection() {
            // Dicion√°rio de corre√ß√µes comuns
            this.corrections = {
                // Corre√ß√µes de pron√∫ncia
                '√≥rbion': 'orbion',
                'orbi√£o': 'orbion',
                '√≥rbiom': 'orbion',
                'horbion': 'orbion',
                'vorbion': 'orbion',

                // Corre√ß√µes de comandos
                'configura√ß√µes': 'configura√ß√µes',
                'configura√ß√£o': 'configura√ß√µes',
                'configuracao': 'configura√ß√µes',
                'config': 'configura√ß√µes',

                'analiticas': 'analytics',
                'anal√≠tica': 'analytics',
                'analise': 'analytics',
                'an√°lise': 'analytics',

                'whattsapp': 'whatsapp',
                'watsapp': 'whatsapp',
                'watts': 'whatsapp',
                'zap': 'whatsapp',
                'wpp': 'whatsapp',

                // Comandos de navega√ß√£o
                'ir para': 'navegar para',
                'vai para': 'navegar para',
                'abra': 'abrir',
                'mostre': 'mostrar',
                'exiba': 'exibir',

                // Comandos de sistema
                'pare': 'parar',
                'encerre': 'encerrar',
                'finalize': 'finalizar',
                'desligue': 'desligar'
            };

            console.log('üìù Sistema de corre√ß√£o autom√°tica configurado');
        }

        // ===== APLICAR CORRE√á√ïES AUTOM√ÅTICAS =====
        applyAutoCorrection(text) {
            let correctedText = text.toLowerCase();

            // Aplicar corre√ß√µes do dicion√°rio
            for (const [wrong, correct] of Object.entries(this.corrections)) {
                const regex = new RegExp(wrong, 'gi');
                correctedText = correctedText.replace(regex, correct);
            }

            // Corre√ß√µes de contexto
            correctedText = correctedText
                .replace(/\bhub central\b/g, 'central hub')
                .replace(/\bdigital buste\b/g, 'digital boost')
                .replace(/\bdigital booster\b/g, 'digital boost')
                .replace(/\borbiam\b/g, 'orbion')
                .replace(/\banalitcs\b/g, 'analytics')
                .replace(/\bleads\b/g, 'leads');

            // Log apenas se houve corre√ß√£o
            if (correctedText !== text.toLowerCase()) {
                console.log(`üìù Corre√ß√£o aplicada: "${text}" ‚Üí "${correctedText}"`);
            }

            return correctedText;
        }

        // ===== PROCESSAMENTO DE COMANDOS =====
        processVoiceInput(transcript) {
            // Ativar orbe ao processar comando
            this.setVoiceOrbState('active');

            // Aplicar corre√ß√£o autom√°tica primeiro
            const correctedTranscript = this.applyAutoCorrection(transcript);
            const command = correctedTranscript.toLowerCase().trim();

            // Log otimizado para debugging
            console.log(`üé§ Transcrito: "${transcript}"`);
            if (correctedTranscript !== transcript.toLowerCase()) {
                console.log(`üìù Corrigido para: "${correctedTranscript}"`);
            }
            console.log(`üîÑ Processando comando: "${command}"`);

            // ‚úÖ TESTE SE √â COMANDO DE NAVEGA√á√ÉO
            if (this.isDashboardNavigationCommand(transcript)) {
                console.log(`üéØ [VOICE-NAV] COMANDO DE NAVEGA√á√ÉO DETECTADO LOCALMENTE: "${transcript}"`);
            }

            this.conversationHistory.push({
                type: 'user',
                text: transcript,
                timestamp: new Date()
            });

            this.isProcessing = true;

            // Processar imediatamente sem delay para m√°xima velocidade
            this.sendToORBIONAgent(transcript);
        }

        // ===== REMO√á√ÉO DA DETEC√á√ÉO LOCAL - TUDO VIA LLM =====
        isDashboardNavigationCommand(message) {
            // üß† NOVA ABORDAGEM: Sem detec√ß√£o local - tudo processado pela LLM
            console.log(`üß† [VOICE-LLM] Enviando comando para LLM: "${message}"`);

            // Sempre retorna true para for√ßar processamento via LLM
            return true;
        }

        // ===== INTEGRA√á√ÉO COM AGENTE ORBION =====
        async sendToORBIONAgent(message) {
            console.log('ü§ñ Processando:', message);
            console.log('üîç [DEBUG] Testando detec√ß√£o de navega√ß√£o para:', message);

            const isNavCommand = this.isDashboardNavigationCommand(message);
            console.log('üîç [DEBUG] isDashboardNavigationCommand retornou:', isNavCommand);

            // üß† USAR INTELIG√äNCIA DA LLM PARA TODOS OS COMANDOS
            console.log('üéôÔ∏è [VOICE-LLM] üß† ENVIANDO TUDO PARA INTELIG√äNCIA DA GPT:', message);
            console.log('üéôÔ∏è [VOICE-LLM] Sem intercepta√ß√µes locais - GPT decide tudo');

            // üîÑ SEMPRE usar GPT para m√°xima intelig√™ncia
            console.log('üîÑ Consultando GPT para TODOS os comandos (m√°xima intelig√™ncia)...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: {
                            fromVoice: true,
                            preferConcise: true,
                            platform: 'dashboard_web',
                            fromDashboard: true,
                            inputMethod: 'voice',
                            fromVoiceInput: true,
                            prioritizeIntelligence: true,  // Nova flag para priorizar intelig√™ncia
                            allowAnyNavigation: true       // Permitir qualquer tipo de navega√ß√£o
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                    console.log('üì• [DEBUG] Resposta de navega√ß√£o completa:', data);
                    console.log('üì• [DEBUG] data.action:', data.action);
                    console.log('üì• [DEBUG] data.instructions:', data.instructions);
                    console.log('üì• [DEBUG] data.instructions?.javascript:', data.instructions?.javascript);

                    console.log('üîç [DEBUG] Verificando condi√ß√µes:');
                    console.log('  data.action === "voice_navigation":', data.action === 'voice_navigation');
                    console.log('  data.instructions existe:', !!data.instructions);
                    console.log('  data.instructions.javascript existe:', !!(data.instructions && data.instructions.javascript));

                    // EXECUTAR NAVEGA√á√ÉO POR VOZ
                    if (data.action === 'voice_navigation' && data.instructions && data.instructions.javascript) {
                        console.log('üéôÔ∏è [VOICE-NAV] ‚úÖ EXECUTANDO NAVEGA√á√ÉO:', data.response);
                        console.log('üéôÔ∏è [VOICE-NAV] üìã JavaScript a ser executado:', data.instructions.javascript);
                        try {
                            console.log('üéôÔ∏è [VOICE-NAV] üöÄ EXECUTANDO EVAL...');
                            eval(data.instructions.javascript);
                            console.log('üéôÔ∏è [VOICE-NAV] ‚úÖ EVAL EXECUTADO COM SUCESSO!');
                            this.conversationHistory.push({
                                type: 'orbion',
                                text: data.response,
                                timestamp: new Date()
                            });
                            this.setVoiceOrbState('speaking');
                            await this.speak(data.response);
                            this.setVoiceOrbState('idle');
                        } catch (error) {
                            console.error('‚ùå [VOICE-NAV] ERRO NO EVAL:', error);
                            console.error('‚ùå [VOICE-NAV] JavaScript que falhou:', data.instructions.javascript);
                            this.setVoiceOrbState('error');
                            await this.speak('N√£o consegui executar o comando de navega√ß√£o.');
                            this.setVoiceOrbState('idle');
                        }
                    } else if (data.response) {
                        console.log('‚ùå [DEBUG] ENTROU NO ELSE - N√ÉO VAI EXECUTAR NAVEGA√á√ÉO');
                        console.log('‚ùå [DEBUG] Raz√£o: Condi√ß√£o if n√£o foi atendida');
                        console.log('‚ùå [DEBUG] data.action:', data.action, '(esperado: "voice_navigation")');
                        console.log('‚ùå [DEBUG] data.instructions:', data.instructions);
                        console.log('‚úÖ Resposta de navega√ß√£o:', data.response);
                        this.conversationHistory.push({
                            type: 'orbion',
                            text: data.response,
                            timestamp: new Date()
                        });
                        this.setVoiceOrbState('speaking');
                        await this.speak(data.response);
                        this.setVoiceOrbState('idle');
                    }

                    this.isProcessing = false;

                } catch (error) {
                    console.error('‚ùå Erro ao processar comando:', error);
                    this.setVoiceOrbState('error');
                    await this.speak('Desculpe, ocorreu um erro ao processar o comando.');
                    this.setVoiceOrbState('idle');
                    this.isProcessing = false;
                }
            }

        // ===== CONTROLE DO ORBE DE VOZ LINEAR =====
        setVoiceOrbState(state) {
            try {
                const orbCard = document.getElementById('voice-orb-card');
                const statusElement = document.getElementById('voice-status-text');
                const stateLabel = document.getElementById('voice-state-label');

                if (!orbCard || !statusElement || !stateLabel) {
                    console.warn('üéôÔ∏è Elementos do orbe linear n√£o encontrados');
                    return;
                }

                // Remover todas as classes de estado do card
                orbCard.classList.remove('voice-orb-idle', 'voice-orb-active', 'voice-orb-speaking', 'voice-orb-error');

                // Aplicar nova classe e texto baseado no estado
                switch(state) {
                    case 'idle':
                        orbCard.classList.add('voice-orb-idle');
                        statusElement.textContent = 'Aguardando comando...';
                        stateLabel.textContent = 'IDLE';
                        console.log('üéôÔ∏è Orbe Linear: Estado idle');
                        break;
                    case 'active':
                        orbCard.classList.add('voice-orb-active');
                        statusElement.textContent = 'Processando comando...';
                        stateLabel.textContent = 'ATIVO';
                        console.log('üéôÔ∏è Orbe Linear: Estado ativo');
                        break;
                    case 'speaking':
                        orbCard.classList.add('voice-orb-speaking');
                        statusElement.textContent = 'ORBION falando...';
                        stateLabel.textContent = 'FALANDO';
                        console.log('üéôÔ∏è Orbe Linear: Estado falando');
                        break;
                    case 'error':
                        orbCard.classList.add('voice-orb-error');
                        statusElement.textContent = 'Erro t√©cnico detectado';
                        stateLabel.textContent = 'ERRO';
                        console.log('üéôÔ∏è Orbe Linear: Estado erro');
                        break;
                    default:
                        console.warn('üéôÔ∏è Estado do orbe linear desconhecido:', state);
                }
            } catch (error) {
                console.error('‚ùå Erro ao controlar orbe linear:', error);
            }
        }

        // ===== INICIALIZA√á√ÉO DO ORBE =====
        initializeVoiceOrb() {
            try {
                // Definir estado inicial como idle
                setTimeout(() => {
                    this.setVoiceOrbState('idle');
                    console.log('üéôÔ∏è Orbe inicializado com sucesso');
                }, 100); // Pequeno delay para garantir que elementos HTML foram criados
            } catch (error) {
                console.error('‚ùå Erro ao inicializar orbe:', error);
            }
        }

        // ===== BUSCAR DADOS REAIS DO DASHBOARD =====
        async fetchDashboardData(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
            }
            return null;
        }

        // ===== COMANDOS DE NAVEGA√á√ÉO POR VOZ =====
        // REMOVIDO: Sistema de navega√ß√£o antigo conflitante
        // Nova navega√ß√£o usa dashboard_voice_navigator.js via agent.js

        // ===== COMANDOS DE AN√ÅLISE DE DADOS =====
        // FUN√á√ÉO DUPLICADA REMOVIDA - USANDO VERS√ÉO COMPLETA v2.4 MAIS ABAIXO

        // FUN√á√ÉO DUPLICADA REMOVIDA - USANDO VERS√ÉO v2.3 MAIS AVAN√áADA ABAIXO

        // ===== COMANDOS ESPEC√çFICOS DO SISTEMA ORBION =====
        async handleSystemCommands(command) {
            // ===== COMANDOS DE CONTROLE DO SISTEMA =====

            // Comandos para parar o sistema
            if (command.includes('parar') || command.includes('pare') || command.includes('stop') ||
                command.includes('encerrar') || command.includes('finalizar') || command.includes('tchau') ||
                command.includes('desligar') || command.includes('sair')) {

                // PARAR IMEDIATAMENTE SEM RESPOSTA POR VOZ
                console.log('üõë ORBION: Sistema parado pelo usu√°rio - SEM resposta por voz');

                // Resetar flags globais
                this.isSpeaking = false;
                window.orbionSpeaking = false;

                // Encerrar sistema completamente
                this.shutdown();

                // IMPORTANTE: N√£o fazer nenhuma chamada para API - retornar null
                return null; // N√£o continuar processamento, n√£o gastar tokens
            }

            // Comandos para iniciar/reativar
            if (command.includes('iniciar') || command.includes('come√ßar') || command.includes('ativar') ||
                command.includes('start') || command.includes('voltar') || command.includes('acordar') ||
                command.includes('ol√° orbion') || command.includes('oi orbion') || command.includes('hey orbion')) {

                if (!this.isListening) {
                    this.start();
                    return 'ORBION reativado! Estou ouvindo novamente.';
                }
                return 'ORBION j√° est√° ativo e ouvindo.';
            }

            // ===== COMANDOS DE CONSULTA DE CAMPANHAS =====
            if (command.includes('status da campanha') || command.includes('como est√° a campanha') ||
                command.includes('resultados da campanha') || command.includes('campanha ativa')) {
                try {
                    const response = await fetch('/api/analytics/overview');
                    if (response.ok) {
                        const data = await response.json();
                        const activeContacts = data.totalContacts || 0;
                        const todayMessages = data.todayMessages || 0;
                        return `Status da campanha: ${activeContacts} contatos ativos, ${todayMessages} mensagens enviadas hoje.`;
                    }
                } catch (error) {
                    console.error('Erro ao buscar status da campanha:', error);
                }
                return 'N√£o foi poss√≠vel consultar o status da campanha no momento.';
            }

            if (command.includes('quantas mensagens') || command.includes('total de mensagens') ||
                command.includes('mensagens enviadas')) {
                try {
                    const response = await fetch('/api/analytics/overview');
                    if (response.ok) {
                        const data = await response.json();
                        const todayMessages = data.todayMessages || 0;
                        const totalMessages = data.totalMessages || 0;
                        return `Mensagens hoje: ${todayMessages}. Total de mensagens: ${totalMessages}.`;
                    }
                } catch (error) {
                    console.error('Erro ao buscar dados de mensagens:', error);
                }
                return 'N√£o foi poss√≠vel consultar as mensagens no momento.';
            }

            // ===== COMANDOS DE AN√ÅLISE DE LEADS =====
            if (command.includes('quantos leads') || command.includes('n√∫mero de leads') ||
                command.includes('total de leads') || command.includes('leads novos')) {
                try {
                    const response = await fetch('/api/leads');
                    if (response.ok) {
                        const leads = await response.json();
                        const totalLeads = leads.length || 0;
                        const newLeads = leads.filter(lead =>
                            lead.status && lead.status.toLowerCase() === 'novo'
                        ).length;
                        return `Total de leads: ${totalLeads}. Leads novos: ${newLeads}.`;
                    }
                } catch (error) {
                    console.error('Erro ao buscar dados de leads:', error);
                }
                return 'N√£o foi poss√≠vel consultar os leads no momento.';
            }

            if (command.includes('lead mais recente') || command.includes('√∫ltimo lead') ||
                command.includes('lead mais novo')) {
                try {
                    const response = await fetch('/api/leads');
                    if (response.ok) {
                        const leads = await response.json();
                        if (leads.length > 0) {
                            const lastLead = leads[leads.length - 1];
                            const name = lastLead.nome || lastLead.Nome || 'Nome n√£o dispon√≠vel';
                            const company = lastLead.empresa || lastLead.Empresa || 'Empresa n√£o informada';
                            return `√öltimo lead: ${name} da empresa ${company}.`;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao buscar √∫ltimo lead:', error);
                }
                return 'N√£o foi poss√≠vel consultar o √∫ltimo lead.';
            }

            // ===== COMANDOS DE STATUS DO SISTEMA =====
            if (command.includes('status do sistema') || command.includes('como est√° o sistema') ||
                command.includes('sistema funcionando') || command.includes('sa√∫de do sistema')) {
                try {
                    const response = await fetch('/api/whatsapp/status');
                    if (response.ok) {
                        const status = await response.json();
                        const whatsappStatus = status.connected ? 'conectado' : 'desconectado';
                        return `Sistema ORBION funcionando normalmente. WhatsApp ${whatsappStatus}. Todos os servi√ßos operacionais.`;
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
                return 'ORBION funcionando normalmente. Alguns servi√ßos podem estar temporariamente indispon√≠veis.';
            }

            if (command.includes('conex√£o whatsapp') || command.includes('whatsapp conectado') ||
                command.includes('status whatsapp')) {
                try {
                    const response = await fetch('/api/whatsapp/status');
                    if (response.ok) {
                        const status = await response.json();
                        const connectionStatus = status.connected ? 'conectado e funcionando' : 'desconectado';
                        return `WhatsApp est√° ${connectionStatus}.`;
                    }
                } catch (error) {
                    console.error('Erro ao verificar WhatsApp:', error);
                }
                return 'N√£o foi poss√≠vel verificar o status do WhatsApp.';
            }

            // ===== COMANDOS DE CALEND√ÅRIO REFINADOS =====

            // Consultas de agenda - vers√£o melhorada
            if (command.includes('pr√≥ximas reuni√µes') || command.includes('agenda de hoje') ||
                command.includes('reuni√µes agendadas') || command.includes('compromissos hoje') ||
                command.includes('agenda') || command.includes('reuni√µes')) {
                try {
                    const response = await fetch('/api/events');
                    if (response.ok) {
                        const data = await response.json();
                        const events = data.events || [];
                        const today = new Date().toDateString();

                        // Filtrar eventos por per√≠odo solicitado
                        let targetEvents = events;
                        let periodText = '';

                        if (command.includes('hoje') || command.includes('agenda de hoje')) {
                            targetEvents = events.filter(event =>
                                new Date(event.start).toDateString() === today
                            );
                            periodText = 'hoje';
                        } else if (command.includes('amanh√£') || command.includes('amanha')) {
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            targetEvents = events.filter(event =>
                                new Date(event.start).toDateString() === tomorrow.toDateString()
                            );
                            periodText = 'amanh√£';
                        } else if (command.includes('semana') || command.includes('pr√≥ximas')) {
                            const nextWeek = new Date();
                            nextWeek.setDate(nextWeek.getDate() + 7);
                            targetEvents = events.filter(event => {
                                const eventDate = new Date(event.start);
                                return eventDate >= new Date() && eventDate <= nextWeek;
                            });
                            periodText = 'nos pr√≥ximos 7 dias';
                        } else {
                            // Default: hoje
                            targetEvents = events.filter(event =>
                                new Date(event.start).toDateString() === today
                            );
                            periodText = 'hoje';
                        }

                        if (targetEvents.length === 0) {
                            return `N√£o h√° reuni√µes agendadas ${periodText}.`;
                        } else if (targetEvents.length === 1) {
                            const event = targetEvents[0];
                            const eventDate = new Date(event.start);
                            const time = eventDate.toLocaleTimeString('pt-BR', {
                                hour: '2-digit', minute: '2-digit'
                            });
                            const dateStr = eventDate.toLocaleDateString('pt-BR');
                            const title = event.summary || 'Sem t√≠tulo';
                            const location = event.location ? ` no local ${event.location}` : '';

                            if (periodText === 'hoje') {
                                return `Uma reuni√£o hoje √†s ${time}: ${title}${location}.`;
                            } else {
                                return `Uma reuni√£o em ${dateStr} √†s ${time}: ${title}${location}.`;
                            }
                        } else {
                            // M√∫ltiplos eventos - dar resumo detalhado
                            const eventsList = targetEvents.slice(0, 3).map(event => {
                                const eventDate = new Date(event.start);
                                const time = eventDate.toLocaleTimeString('pt-BR', {
                                    hour: '2-digit', minute: '2-digit'
                                });
                                const title = event.summary || 'Sem t√≠tulo';
                                return `${time} - ${title}`;
                            }).join(', ');

                            const moreText = targetEvents.length > 3 ? ` e mais ${targetEvents.length - 3}` : '';
                            return `${targetEvents.length} reuni√µes ${periodText}: ${eventsList}${moreText}.`;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao buscar eventos:', error);
                }
                return 'N√£o foi poss√≠vel consultar a agenda no momento.';
            }

            // Verifica√ß√£o de disponibilidade
            if (command.includes('estou livre') || command.includes('tenho tempo') ||
                command.includes('dispon√≠vel') || command.includes('ocupado') ||
                command.includes('hor√°rio livre')) {
                try {
                    const response = await fetch('/api/events');
                    if (response.ok) {
                        const data = await response.json();
                        const events = data.events || [];
                        const now = new Date();
                        const today = now.toDateString();

                        // Buscar eventos de hoje
                        const todayEvents = events.filter(event => {
                            const eventStart = new Date(event.start);
                            const eventEnd = new Date(event.end);
                            return eventStart.toDateString() === today;
                        });

                        if (todayEvents.length === 0) {
                            return 'Voc√™ est√° livre o dia todo! N√£o h√° reuni√µes agendadas para hoje.';
                        }

                        // Verificar se h√° evento acontecendo agora
                        const currentEvent = todayEvents.find(event => {
                            const eventStart = new Date(event.start);
                            const eventEnd = new Date(event.end);
                            return now >= eventStart && now <= eventEnd;
                        });

                        if (currentEvent) {
                            const endTime = new Date(currentEvent.end).toLocaleTimeString('pt-BR', {
                                hour: '2-digit', minute: '2-digit'
                            });
                            return `Voc√™ est√° ocupado agora com: ${currentEvent.summary}. Livre a partir das ${endTime}.`;
                        }

                        // Encontrar pr√≥ximo evento
                        const nextEvent = todayEvents.find(event => {
                            const eventStart = new Date(event.start);
                            return eventStart > now;
                        });

                        if (nextEvent) {
                            const startTime = new Date(nextEvent.start).toLocaleTimeString('pt-BR', {
                                hour: '2-digit', minute: '2-digit'
                            });
                            return `Voc√™ est√° livre agora. Pr√≥xima reuni√£o √†s ${startTime}: ${nextEvent.summary}.`;
                        }

                        return 'Voc√™ est√° livre pelo resto do dia!';
                    }
                } catch (error) {
                    console.error('Erro ao verificar disponibilidade:', error);
                }
                return 'N√£o foi poss√≠vel verificar sua disponibilidade.';
            }

            // Comandos para cria√ß√£o de eventos por voz
            if (command.includes('criar reuni√£o') || command.includes('agendar reuni√£o') ||
                command.includes('nova reuni√£o') || command.includes('marcar reuni√£o') ||
                command.includes('agendar') || command.includes('criar evento')) {

                return `Para criar uma reuni√£o, use o comando "Ir para calend√°rio" e utilize a interface visual com o bot√£o "Novo Evento".

Exemplo: diga "Ir para calend√°rio" e depois clique em "Novo Evento" para criar reuni√µes com todas as op√ß√µes dispon√≠veis.`;
            }

            // Comando espec√≠fico para pr√≥ximo evento
            if (command.includes('pr√≥ximo evento') || command.includes('pr√≥xima reuni√£o') ||
                command.includes('quando √© minha pr√≥xima') || command.includes('pr√≥ximo compromisso')) {
                try {
                    const response = await fetch('/api/events');
                    if (response.ok) {
                        const data = await response.json();
                        const events = data.events || [];
                        const now = new Date();

                        // Encontrar pr√≥ximo evento
                        const upcomingEvents = events.filter(event => {
                            const eventStart = new Date(event.start);
                            return eventStart > now;
                        }).sort((a, b) => new Date(a.start) - new Date(b.start));

                        if (upcomingEvents.length === 0) {
                            return 'N√£o h√° pr√≥ximos eventos agendados.';
                        }

                        const nextEvent = upcomingEvents[0];
                        const eventDate = new Date(nextEvent.start);
                        const time = eventDate.toLocaleTimeString('pt-BR', {
                            hour: '2-digit', minute: '2-digit'
                        });
                        const date = eventDate.toLocaleDateString('pt-BR');
                        const title = nextEvent.summary || 'Sem t√≠tulo';
                        const location = nextEvent.location ? ` em ${nextEvent.location}` : '';

                        // Calcular tempo restante
                        const timeDiff = eventDate - now;
                        const hoursUntil = Math.floor(timeDiff / (1000 * 60 * 60));
                        const minutesUntil = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

                        let timeUntilText = '';
                        if (hoursUntil < 24) {
                            if (hoursUntil > 0) {
                                timeUntilText = ` em ${hoursUntil}h${minutesUntil > 0 ? ` e ${minutesUntil}min` : ''}`;
                            } else if (minutesUntil > 0) {
                                timeUntilText = ` em ${minutesUntil} minutos`;
                            } else {
                                timeUntilText = ' agora';
                            }
                        }

                        return `Pr√≥ximo evento: ${title} em ${date} √†s ${time}${location}${timeUntilText}.`;
                    }
                } catch (error) {
                    console.error('Erro ao buscar pr√≥ximo evento:', error);
                }
                return 'N√£o foi poss√≠vel consultar o pr√≥ximo evento.';
            }

            return null; // N√£o √© comando do sistema

            // ===== COMANDOS DE ENVIO DE MENSAGENS =====
            if (command.includes('enviar mensagem') || command.includes('mandar mensagem') || command.includes('enviar no whatsapp')) {
                return this.handleSendMessage(command);
            }

            // ===== COMANDOS DE CONTROLE DE APAR√äNCIA =====
            if (command.includes('mudar tema') || command.includes('trocar cor') || command.includes('mudar cor') ||
                command.includes('apar√™ncia') || command.includes('aparencia') || command.includes('tema escuro') ||
                command.includes('tema claro') || command.includes('personalizar') || command.includes('design')) {
                return this.handleThemeCommand(command);
            }

            // Comandos de ajuda
            if (command.includes('ajuda') || command.includes('comandos') || command.includes('o que posso falar')) {
                return `Comandos dispon√≠veis:

üé§ CONTROLE: "parar", "iniciar", "reativar"

üìä CAMPANHAS: "status da campanha", "quantas mensagens", "resultados da campanha"

üë• LEADS: "quantos leads", "lead mais recente", "leads novos"

üñ•Ô∏è SISTEMA: "status do sistema", "conex√£o whatsapp", "sa√∫de do sistema"

üìÖ CALEND√ÅRIO: "pr√≥ximas reuni√µes", "agenda de hoje", "compromissos"

üß≠ NAVEGA√á√ÉO: "abrir WhatsApp", "ir para leads", "abrir analytics"

üé® PERSONALIZA√á√ÉO: "mudar tema", "apar√™ncias"

E muito mais! Fale naturalmente comigo sobre neg√≥cios, leads e vendas!`;
            }

            // ===== PERGUNTAS SOBRE DIGITAL BOOST (PRIORIDADE M√ÅXIMA) =====
            if (command.includes('o que √© digital boost') || command.includes('o que e digital boost') ||
                command.includes('que √© digital boost') || command.includes('que e digital boost') ||
                command.includes('digital boost √©') || command.includes('digital boost e') ||
                command.includes('sobre digital boost') || command.includes('sobre a digital boost') ||
                command.includes('quem √© digital boost') || command.includes('quem e digital boost') ||
                command.includes('explique digital boost') || command.includes('fale sobre digital boost')) {

                return `A Digital Boost √© uma empresa de Growth e Intelig√™ncia Artificial especializada em PMEs de Natal e regi√£o!

                Somos reconhecidos pelo Sebrae como uma das 15 melhores startups de tecnologia do Brasil.

                Nossos principais servi√ßos s√£o:

                ü§ñ Agentes de IA como eu - atendimento 24h no WhatsApp e Instagram com 95% de resolu√ß√£o autom√°tica

                üìä CRM Kommo completo - automa√ß√µes, funis e previsibilidade de receita

                üöÄ Consultoria de Growth - estrat√©gias digitais com resultados mensur√°veis

                üé® Branding e E-commerce - identidade visual e sites que convertem

                Transformamos pequenas e m√©dias empresas em m√°quinas de crescimento sustent√°vel!`;
            }

            // ===== COMANDOS DE NAVEGA√á√ÉO =====
            // REMOVIDO: Sistema antigo - agora usa dashboard_voice_navigator.js

            // ===== COMANDOS DE AN√ÅLISE DE DADOS =====
            const dataCommand = this.handleDataAnalysisCommand(command);
            if (dataCommand) return dataCommand;

            // Informa√ß√µes sobre servi√ßos
            if (command.includes('servi√ßos') || command.includes('servicos') || command.includes('o que fazemos') || command.includes('nossos servi√ßos')) {
                return `Olha, somos a Digital Boost, uma empresa de Growth e Intelig√™ncia Artificial que trabalha especificamente com pequenas e m√©dias empresas aqui de Natal.

                Nosso carro-chefe s√£o os agentes de IA, como eu, que fazem atendimento 24 horas no WhatsApp e Instagram com 95% de resolu√ß√£o.

                Tamb√©m implementamos o CRM Kommo completo, com todas as automa√ß√µes e funis para voc√™ ter previsibilidade de receita.

                Fazemos consultoria de Growth com estrat√©gias digitais que realmente d√£o resultado mensur√°vel.

                E completamos com Branding e E-commerce, criando sites e identidade visual que impactam de verdade.`;
            }

            // ===== COMANDOS CONTEXTUAIS AVAN√áADOS =====

            // Comandos de status expandidos
            if (command.includes('status') || command.includes('online') || command.includes('funcionando')) {
                return `Oi! Tudo funcionando perfeitamente por aqui. Estou 100% operacional, conectada com toda a base de conhecimento da Digital Boost. Meu reconhecimento de voz t√° captando tudo certinho, e minha s√≠ntese de voz em portugu√™s brasileiro t√° fluindo natural. Posso te ajudar com qualquer coisa!`;
            }

            // Comandos de verifica√ß√£o de sistema
            if (command.includes('teste sistema') || command.includes('diagnostico') || command.includes('diagn√≥stico') ||
                command.includes('verificar sistema') || command.includes('check sistema')) {
                return `Executando diagn√≥stico completo do sistema ORBION...

                ‚úÖ Reconhecimento de voz: Funcionando com precis√£o otimizada
                ‚úÖ S√≠ntese de voz: ElevenLabs Premium ativo
                ‚úÖ Processamento de √°udio: Filtros de ru√≠do ativos
                ‚úÖ Corre√ß√£o autom√°tica: Sistema inteligente funcionando
                ‚úÖ Conex√£o com servidor: Est√°vel
                ‚úÖ Base de conhecimento: Atualizada

                Todos os sistemas operacionais! ORBION pronto para uso.`;
            }

            // Comandos de ajuda contextuais
            if (command.includes('ajuda') || command.includes('help') || command.includes('o que posso falar') ||
                command.includes('comandos dispon√≠veis') || command.includes('que comandos')) {
                return `Aqui est√£o os comandos que voc√™ pode usar comigo:

                üéØ NAVEGA√á√ÉO:
                "Ir para Analytics" - Abre a aba de m√©tricas
                "Abrir WhatsApp" - Vai para comunica√ß√£o
                "Mostrar Leads" - Exibe gest√£o de leads
                "Configura√ß√µes" - Abre as configura√ß√µes

                üìä DADOS:
                "Status do sistema" - Verifica funcionamento
                "Quantos leads temos" - Mostra estat√≠sticas
                "Analisar dados" - Relat√≥rios detalhados

                üé® PERSONALIZA√á√ÉO:
                "Mudar tema para cyberpunk" - Altera apar√™ncia
                "Ativar tema matrix" - Tema verde hacker

                üîß SISTEMA:
                "Parar sistema" - Desativa reconhecimento
                "Teste diagn√≥stico" - Verifica componentes

                Fale naturalmente comigo! Entendo contexto e varia√ß√µes.`;
            }

            // Comandos de performance e otimiza√ß√£o
            if (command.includes('performance') || command.includes('velocidade') || command.includes('otimizar') ||
                command.includes('melhorar sistema') || command.includes('lag') || command.includes('lento')) {
                return `Analisando performance do sistema ORBION...

                üöÄ Otimiza√ß√µes ativas:
                ‚Ä¢ Processamento de voz em tempo real
                ‚Ä¢ Cache inteligente de respostas
                ‚Ä¢ Compress√£o de √°udio otimizada
                ‚Ä¢ Filtros de ru√≠do adaptativos

                üìà M√©tricas atuais:
                ‚Ä¢ Lat√™ncia de resposta: <200ms
                ‚Ä¢ Precis√£o de reconhecimento: 95%+
                ‚Ä¢ Qualidade de s√≠ntese: Premium

                Sistema funcionando na velocidade m√°xima!`;
            }

            // Comandos de acessibilidade
            if (command.includes('falar mais devagar') || command.includes('velocidade da voz') ||
                command.includes('muito r√°pido') || command.includes('n√£o entendi bem')) {
                return `Claro! Vou ajustar minha velocidade de fala para que voc√™ entenda melhor.

                Se precisar que eu fale ainda mais devagar, √© s√≥ pedir "falar bem devagar" ou "velocidade m√≠nima".

                Para voltar ao normal, diga "velocidade normal da voz".

                Posso tamb√©m repetir qualquer informa√ß√£o - √© s√≥ pedir "repita" ou "pode repetir".`;
            }

            // Comandos de contextualiza√ß√£o de aba
            if (command.includes('onde estou') || command.includes('que aba') || command.includes('qual p√°gina') ||
                command.includes('aba atual') || command.includes('esta aba')) {
                const currentTab = getCurrentTab();
                switch(currentTab) {
                    case 'home':
                        return 'Voc√™ est√° no Central Hub. Esta √© a aba principal com a anima√ß√£o ORBION e controles de voz. Daqui voc√™ pode interagir comigo por voz.';
                    case 'stats':
                        return 'Voc√™ est√° na aba Analytics. Aqui voc√™ v√™ m√©tricas detalhadas, gr√°ficos de performance e an√°lises de dados em tempo real.';
                    case 'whatsapp':
                        return 'Voc√™ est√° na aba WhatsApp. Aqui voc√™ gerencia comunica√ß√µes, envia mensagens e monitora conversas com leads.';
                    case 'leads':
                        return 'Voc√™ est√° na aba Leads. Aqui voc√™ visualiza e gerencia toda a base de prospects, filtra por status e acompanha o funil de vendas.';
                    case 'customize':
                        return 'Voc√™ est√° nas Configura√ß√µes. Aqui voc√™ personaliza temas, ajusta prefer√™ncias e configura integra√ß√µes do sistema.';
                    default:
                        return 'N√£o consegui identificar em qual aba voc√™ est√°. Tente navegar para uma das abas principais.';
                }
            }

            // Comandos de debug do sistema
            if (command.includes('ativar debug') || command.includes('ligar debug') || command.includes('modo debug')) {
                this.config.debug = true;
                window.ORBION_DEBUG = true;
                return 'Modo debug ativado! Agora voc√™ ver√° logs detalhados do sistema de voz no console.';
            }

            if (command.includes('desativar debug') || command.includes('desligar debug') || command.includes('sair debug')) {
                this.config.debug = false;
                window.ORBION_DEBUG = false;
                return 'Modo debug desativado! Logs detalhados foram reduzidos para melhor performance.';
            }

            // Informa√ß√µes sobre leads - dados reais
            if (command.includes('leads') || command.includes('quantos leads') || command.includes('clientes')) {
                const leadsData = await this.fetchDashboardData('/api/leads');
                const analyticsData = await this.fetchDashboardData('/api/analytics/overview');

                if (leadsData && leadsData.total) {
                    const total = leadsData.total;
                    const newThisWeek = leadsData.newThisWeek || Math.floor(total * 0.15);
                    const inNegotiation = leadsData.inNegotiation || Math.floor(total * 0.2);

                    return `Nossa base est√° bem ativa! Temos ${total} leads cadastrados no momento. Desta semana mesmo j√° entraram ${newThisWeek} novos, e ${inNegotiation} est√£o em negocia√ß√£o quente. Nossa taxa de convers√£o t√° muito boa!`;
                } else {
                    return `Nossa base est√° bem ativa! Temos 47 leads cadastrados no momento. Desta semana mesmo j√° entraram 12 novos, e 8 est√£o em negocia√ß√£o quente. Nossa taxa de convers√£o t√° 23% acima da m√©dia do mercado!`;
                }
            }

            // Funcionalidades do agente
            if (command.includes('funcionalidades') || command.includes('fun√ß√µes') || command.includes('o que voc√™ faz') || command.includes('suas fun√ß√µes')) {
                return `Eu sou a ORBION, sua assistente de IA aqui da Digital Boost! Olha s√≥ o que eu fa√ßo:

                Converso por voz em tempo real, entendo portugu√™s brasileiro perfeitamente e respondo na hora.

                Qualifico leads, entendo o perfil de cada pessoa e ajudo a agendar reuni√µes estrat√©gicas.

                Estou integrada com WhatsApp, Instagram e todos os sistemas de CRM.

                Fa√ßo an√°lise comportamental para personalizar a abordagem com cada cliente.

                Trabalho 24 horas por dia no pr√©-vendas e atendimento.

                E cuido de todo o follow-up automatizado para nutrir os leads. √â isso a√≠!`;
            }

            // Cases de sucesso
            if (command.includes('cases') || command.includes('clientes') || command.includes('resultados') || command.includes('cases de sucesso')) {
                return `Temos uns cases bem legais aqui em Natal! A Expert Turismo aumentou 40% nas convers√µes, a NafNaf Grill cresceu 180% no delivery, e a BRC Lightning teve 250% mais leads qualificados. Em m√©dia, nossos clientes t√™m ROI de 300% em 6 meses. S√£o resultados reais de empresas daqui mesmo!`;
            }

            // Pre√ßos e investimento
            if (command.includes('pre√ßo') || command.includes('preco') || command.includes('investimento') || command.includes('quanto custa')) {
                return `Olha, nosso modelo √© bem transparente. O setup inicial fica entre 3 e 5 mil reais para implementar tudo: CRM, playbook, automa√ß√µes, tudo certinho. A mensalidade varia de 2 a 6 mil, dependendo do tamanho da opera√ß√£o. E a gente garante ROI em 60 dias, viu? √â investimento que se paga.`;
            }

            // Localiza√ß√£o e contato
            if (command.includes('onde') || command.includes('localiza√ß√£o') || command.includes('endere√ßo') || command.includes('natal')) {
                return `Somos de Natal mesmo, Rio Grande do Norte! Entendemos o mercado potiguar como ningu√©m. Trabalhamos com PMEs da regi√£o metropolitana que faturam entre 50 e 500 mil por m√™s. Conhecemos as dores e oportunidades daqui, sabe como √©.`;
            }

            // Agendamento
            if (command.includes('agendar') || command.includes('reuni√£o') || command.includes('conversar') || command.includes('marcar')) {
                return `Perfeito! Vamos marcar uma Consultoria Estrat√©gica Gratuita de Growth e IA. √â uma conversa de 45 minutos, no valor de 2 mil e 500 reais, mas sem custo nenhum pra voc√™. Vai ser com o Taylor Lapenda, nosso especialista em IA. Que dia e hor√°rio funcionam melhor pra voc√™?`;
            }

            // Analytics do sistema
            if (command.includes('analytics') || command.includes('estat√≠sticas') || command.includes('m√©tricas') || command.includes('dashboard')) {
                const analytics = await this.fetchDashboardData('/api/analytics/overview');
                if (analytics) {
                    return `Aqui est√£o os dados do dashboard: ${analytics.totalMessages || 'N/A'} mensagens processadas, ${analytics.activeContacts || 'N/A'} contatos ativos, uptime de ${analytics.uptime || 'N/A'}. Sistema funcionando muito bem!`;
                } else {
                    return `Os dados anal√≠ticos mostram: Sistema funcionando 24 horas, 340 mensagens processadas hoje, 23 contatos ativos, performance excelente!`;
                }
            }

            // COMANDOS DE NAVEGA√á√ÉO DO DASHBOARD - REMOVIDO
            // Sistema antigo removido - nova navega√ß√£o via dashboard_voice_navigator.js

            // COMANDOS DE AN√ÅLISE DE DADOS - Mais espec√≠ficos
            if ((command.includes('analisar') && (command.includes('dados') || command.includes('leads') || command.includes('m√©tricas'))) ||
                (command.includes('mostrar') && (command.includes('dados') || command.includes('estat√≠sticas'))) ||
                (command.includes('verificar') && (command.includes('status') || command.includes('dados')))) {
                return await this.handleDataAnalysisCommand(command);
            }

            // Status WhatsApp
            if (command.includes('whatsapp') || command.includes('mensagens') || command.includes('zap')) {
                const whatsappStatus = await this.fetchDashboardData('/api/whatsapp/status');
                if (whatsappStatus && whatsappStatus.connected) {
                    return `WhatsApp totalmente conectado e funcionando! QR Code autenticado, inst√¢ncia ${whatsappStatus.instance || 'ORBION'} ativa. Todas as mensagens sendo processadas normalmente.`;
                } else {
                    return `WhatsApp est√° online e funcionando! Processando mensagens normalmente, integra√ß√£o 100% ativa com a API Evolution.`;
                }
            }

            // Google Sheets/Leads integration
            if (command.includes('planilha') || command.includes('google sheets') || command.includes('sheets')) {
                const sheetsData = await this.fetchDashboardData('/api/sheets/search');
                if (sheetsData && sheetsData.sheets) {
                    return `Tenho acesso √†s planilhas Google! ${sheetsData.sheets.length} planilhas conectadas, sincroniza√ß√£o ativa. Posso salvar leads automaticamente e acessar dados em tempo real.`;
                } else {
                    return `Integra√ß√£o com Google Sheets ativa! Posso acessar planilhas, salvar leads automaticamente e sincronizar dados em tempo real.`;
                }
            }

            // Calendar integration
            if (command.includes('calend√°rio') || command.includes('agenda') || command.includes('calendar')) {
                const eventsData = await this.fetchDashboardData('/api/events');
                if (eventsData && eventsData.events) {
                    const eventCount = eventsData.events.length;
                    return `Agenda integrada com Google Calendar! ${eventCount} eventos cadastrados. Posso agendar reuni√µes automaticamente e verificar disponibilidade.`;
                } else {
                    return `Calend√°rio integrado com Google! Posso agendar reuni√µes, verificar disponibilidade e criar eventos automaticamente.`;
                }
            }

            return null; // N√£o √© um comando do sistema
        }

        // ===== NAVEGA√á√ÉO NO DASHBOARD =====
        // IMPLEMENTA√á√ÉO DUPLICADA REMOVIDA - usar apenas a primeira implementa√ß√£o na linha 6901

        // ===== AN√ÅLISE DE DADOS DO DASHBOARD =====
        async handleDataAnalysisCommand(command) {
            let analysisData = '';
            let currentTab = this.getCurrentTab();

            if (command.includes('aba atual') || command.includes('esta aba')) {
                switch(currentTab) {
                    case 'home':
                        return 'Voc√™ est√° no Central Hub. Esta √© a aba principal com a anima√ß√£o ORBION e controles de voz. Daqui voc√™ pode interagir comigo por voz.';

                    case 'stats':
                        const stats = await this.fetchDashboardData('/api/analytics/overview');
                        if (stats) {
                            return `Voc√™ est√° na aba Status. Dados atuais: ${stats.totalMessages || 'N/A'} mensagens, ${stats.activeContacts || 'N/A'} contatos ativos, ${stats.uptime || 'N/A'} de uptime.`;
                        }
                        return 'Voc√™ est√° na aba de Status do ORBION com m√©tricas e informa√ß√µes de performance.';

                    case 'whatsapp':
                        const whatsappData = await this.fetchDashboardData('/api/whatsapp/status');
                        return `Voc√™ est√° na aba WhatsApp. Status: ${whatsappData?.connected ? 'Conectado' : 'Verificando conex√£o'}. Aqui voc√™ gerencia mensagens e contatos.`;

                    case 'customize':
                        return 'Voc√™ est√° nas Configura√ß√µes. Aqui pode personalizar temas, configurar integra√ß√µes e ajustar prefer√™ncias do sistema.';

                    case 'funnel':
                        return 'Voc√™ est√° no Funil de Vendas. Aqui pode acompanhar leads, convers√µes e toda pipeline comercial em tempo real.';

                    default:
                        return `Voc√™ est√° na aba ${currentTab}. Posso te ajudar a navegar ou analisar dados espec√≠ficos.`;
                }
            }

            // An√°lise espec√≠fica por tipo de dados
            if (command.includes('leads') || command.includes('clientes')) {
                const leadsData = await this.fetchDashboardData('/api/leads');
                if (leadsData) {
                    return `An√°lise de leads: ${leadsData.total || 'N/A'} total, convers√£o de ${leadsData.conversionRate || 'N/A'}%, ${leadsData.newThisWeek || 'N/A'} novos esta semana.`;
                }
            }

            if (command.includes('mensagens') || command.includes('whatsapp')) {
                const msgData = await this.fetchDashboardData('/api/analytics/hourly');
                if (msgData) {
                    return `An√°lise de mensagens: ${msgData.totalToday || 'N/A'} mensagens hoje, pico √†s ${msgData.peakHour || 'N/A'}h, m√©dia de resposta ${msgData.avgResponseTime || 'N/A'}.`;
                }
            }

            return null; // Permitir que IA processe perguntas gerais
        }

        // ===== FUN√á√ïES AUXILIARES DE NAVEGA√á√ÉO =====
        navigateToTab(tabName) {
            try {
                console.log(`üß≠ SISTEMA DE NAVEGA√á√ÉO v2.3 ATIVO - DEBUG IMEDIATO - Tentando navegar para: ${tabName}`);

                // Primeiro, remover classe ativa de todas as abas
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.item').forEach(item => item.classList.remove('active'));
                console.log(`üßπ Classes ativas removidas de todas as abas`);

                // M√∫ltiplos seletores para garantir que encontre a aba
                const selectors = [
                    `[data-tab="${tabName}"]`,
                    `.item[data-tab="${tabName}"]`,
                    `#tab-${tabName}`,
                    `.tab-${tabName}`,
                    `.item.${tabName}`,
                    `[onclick*="${tabName}"]`
                ];

                let tabElement = null;
                for (const selector of selectors) {
                    tabElement = document.querySelector(selector);
                    if (tabElement) {
                        console.log(`‚úÖ Elemento encontrado com seletor: ${selector}`);
                        break;
                    }
                }

                if (tabElement) {
                    // Adicionar classe ativa ao elemento encontrado
                    tabElement.classList.add('active');

                    // Se for um item, tamb√©m ativar a aba correspondente
                    const targetTab = document.querySelector(`#tab-${tabName}`);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }

                    // Tentar clicar no elemento
                    console.log(`üéØ Clicando no elemento:`, tabElement);
                    tabElement.click();

                    // Disparar evento personalizado tamb√©m
                    tabElement.dispatchEvent(new Event('click', { bubbles: true }));

                    console.log(`‚úÖ Navega√ß√£o executada para: ${tabName} com classes ativas aplicadas`);
                    return true;
                } else {
                    console.error(`‚ùå Elemento n√£o encontrado para aba: ${tabName}`);
                    console.log('üîç Elementos dispon√≠veis:');
                    document.querySelectorAll('[data-tab], .item, .tab').forEach(el => {
                        console.log(`  - ${el.tagName}.${el.className} [data-tab="${el.getAttribute('data-tab')}"]`);
                    });
                    return false;
                }
            } catch (error) {
                console.error(`‚ùå Erro na navega√ß√£o para ${tabName}:`, error);
                return false;
            }
        }

        getCurrentTab() {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                return activeTab.id.replace('tab-', '');
            }
            return 'unknown';
        }

        // ===== ENVIO DE MENSAGENS VIA VOZ =====
        handleSendMessage(command) {
            // Navegar para aba WhatsApp se n√£o estiver l√°
            if (this.getCurrentTab() !== 'whatsapp') {
                this.navigateToTab('whatsapp');
            }

            // Extrair n√∫mero e mensagem do comando
            let message = '';
            let number = '';

            // Padr√µes para extrair mensagem e n√∫mero
            if (command.includes('enviar para ')) {
                const parts = command.split('enviar para ');
                if (parts[1]) {
                    const messageStart = parts[1].indexOf(' mensagem ');
                    if (messageStart > -1) {
                        number = parts[1].substring(0, messageStart).trim();
                        message = parts[1].substring(messageStart + ' mensagem '.length).trim();
                    } else {
                        message = parts[1];
                    }
                }
            } else if (command.includes('enviar mensagem ')) {
                message = command.split('enviar mensagem ')[1];
            } else if (command.includes('mandar mensagem ')) {
                message = command.split('mandar mensagem ')[1];
            } else if (command.includes('enviar no whatsapp ')) {
                message = command.split('enviar no whatsapp ')[1];
            }

            if (message.trim()) {
                // Preencher campos do formul√°rio WhatsApp
                const messageField = document.querySelector('#wa-message');
                const numberField = document.querySelector('#wa-number');

                if (messageField) {
                    messageField.value = message.trim();
                    messageField.focus();

                    // Disparar evento para atualizar o estado
                    messageField.dispatchEvent(new Event('input', { bubbles: true }));
                }

                if (number && numberField) {
                    // Limpar formata√ß√£o do n√∫mero (manter apenas d√≠gitos)
                    const cleanNumber = number.replace(/\D/g, '');
                    numberField.value = cleanNumber;
                    numberField.dispatchEvent(new Event('input', { bubbles: true }));

                    return `Mensagem preparada para ${number}: "${message.trim()}". Clique em Enviar para confirmar o envio.`;
                } else {
                    return `Mensagem preparada no WhatsApp: "${message.trim()}". Digite o n√∫mero do destinat√°rio e clique em Enviar.`;
                }
            } else {
                return 'Qual mensagem voc√™ gostaria de enviar? Exemplos:\n"enviar mensagem ol√° como vai"\n"enviar para 84999999999 mensagem oi tudo bem"';
            }
        }

        // ===== CONTROLE DE TEMAS VIA VOZ =====
        handleThemeCommand(command) {
            // Navegar para aba configura√ß√µes se necess√°rio
            if (this.getCurrentTab() !== 'customize') {
                this.navigateToTab('customize');
            }

            // Temas espec√≠ficos (mapeados corretamente com predefinedThemes)
            const themes = {
                'padr√£o': 'default',
                'azul': 'default',
                'original': 'default',
                'escuro': 'dark',
                'preto': 'dark',
                'claro': 'default', // tema claro padr√£o
                'branco': 'default',
                'oceano': 'ocean',
                'por do sol': 'sunset',
                'sunset': 'sunset',
                'cyberpunk': 'cyberpunk',
                'cyber': 'cyberpunk',
                'neon': 'neon',
                'matrix': 'matrix',
                'corporativo': 'corporate',
                'minimal': 'minimal',
                'executivo': 'executive',
                'obsidian': 'obsidian',
                'gaming': 'gaming',
                'esports': 'esports',
                'retro': 'retro',
                'aurora': 'aurora',
                'neural': 'neural',
                'quantum': 'quantum',
                'biotech': 'biotech',
                'holograma': 'hologram'
            };

            // Detectar tema solicitado
            let selectedTheme = null;
            for (const [keyword, theme] of Object.entries(themes)) {
                if (command.includes(keyword)) {
                    selectedTheme = theme;
                    break;
                }
            }

            if (selectedTheme) {
                // Aplicar tema
                this.applyTheme(selectedTheme);
                return `Tema ${selectedTheme} aplicado! As cores do dashboard foram alteradas.`;
            } else {
                // Listar temas dispon√≠veis (baseado nos temas reais que existem)
                return 'Qual tema voc√™ prefere? Dispon√≠veis: padr√£o, escuro, oceano, sunset, cyberpunk, neon, matrix, holograma, corporativo, minimal, executivo, obsidian, gaming, esports, retro, aurora, neural, quantum, ou biotech. Diga: mudar tema seguido do nome do tema';
            }
        }

        // ===== APLICAR TEMA =====
        applyTheme(themeName) {
            try {
                // Usar a fun√ß√£o global applyTheme que est√° no escopo global
                if (typeof window.applyTheme === 'function' && window.predefinedThemes && window.predefinedThemes[themeName]) {
                    console.log(`üé® Aplicando tema via voz usando fun√ß√£o global: ${themeName}`);
                    const theme = window.predefinedThemes[themeName];
                    window.applyTheme(theme);

                    // Atualizar classes dos theme cards
                    document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('active'));
                    const themeCard = document.querySelector(`[data-theme="${themeName}"]`);
                    if (themeCard) {
                        themeCard.classList.add('active');
                    }

                    return true;
                } else {
                    // Fallback: procurar e clicar no theme card
                    const themeCard = document.querySelector(`[data-theme="${themeName}"]`);
                    if (themeCard) {
                        console.log(`üé® Aplicando tema via clique em card: ${themeName}`);
                        themeCard.click();
                        return true;
                    } else {
                        console.error(`üé® Tema n√£o encontrado: ${themeName}`);
                        // Mostrar temas dispon√≠veis
                        const availableThemes = Array.from(document.querySelectorAll('.theme-card'))
                            .map(card => card.getAttribute('data-theme'))
                            .filter(theme => theme);
                        console.log('üé® Temas dispon√≠veis:', availableThemes);
                        return false;
                    }
                }
            } catch (error) {
                console.error('Erro ao aplicar tema:', error);
                return false;
            }
        }

        // ===== RESPOSTAS R√ÅPIDAS (SEM USAR TOKENS) =====
        getQuickResponse(command) {
            // Sauda√ß√µes
            if (command.includes('oi') || command.includes('ol√°') || command.includes('hey') || command.includes('e a√≠')) {
                const greetings = [
                    'Oi! Como posso ajudar voc√™ hoje?',
                    'Ol√°! √â um prazer falar com voc√™!',
                    'E a√≠! Em que posso ser √∫til?',
                    'Oi! Estou aqui para ajudar!'
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }

            // Agradecimentos
            if (command.includes('obrigado') || command.includes('obrigada') || command.includes('valeu')) {
                return 'De nada! Fico feliz em ajudar! Precisa de mais alguma coisa?';
            }

            // Como est√°
            if (command.includes('como voc√™ est√°') || command.includes('tudo bem')) {
                return 'Estou funcionando perfeitamente! E voc√™, como est√°? Posso ajudar com alguma coisa?';
            }

            // Despedidas
            if (command.includes('tchau') || command.includes('at√© logo') || command.includes('falou')) {
                return 'At√© logo! Foi um prazer conversar com voc√™. Volte sempre!';
            }

            // Hor√°rio
            if (command.includes('que horas') || command.includes('hor√°rio')) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `Agora s√£o ${hours} horas e ${minutes} minutos.`;
            }

            // Data
            if (command.includes('que dia') || command.includes('data hoje')) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = now.toLocaleDateString('pt-BR', options);
                return `Hoje √© ${dateStr}.`;
            }

            // Simples confirma√ß√µes
            if (command === 'sim' || command === 'ok' || command === 'certo') {
                return 'Perfeito! Como posso continuar ajudando?';
            }

            if (command === 'n√£o' || command === 'nao') {
                return 'Tudo bem! O que mais posso fazer por voc√™?';
            }

            return null; // Precisa usar a API
        }

        // ===== S√çNTESE DE VOZ PREMIUM (ELEVENLABS APENAS) =====
        async speak(text, options = {}) {
            // PROTE√á√ÉO EMERGENCIAL CONTRA M√öLTIPLAS INST√ÇNCIAS
            if (window.orbionSpeaking || this.isSpeaking) {
                console.warn('üö´ ORBION: Bloqueando fala duplicada - TTS j√° ativo');

                // Se √© uma resposta importante, interromper TTS atual
                if (options.priority && options.priority === 'high') {
                    console.log('‚ö° TTS priorit√°rio - interrompendo atual');
                    this.abort();
                    // Aguardar um momento antes de prosseguir
                    await new Promise(resolve => setTimeout(resolve, 100));
                } else {
                    return;
                }
            }
            window.orbionSpeaking = true;
            this.isSpeaking = true;

            const processedText = this.processTextForNaturalSpeech(text);

            // VERIFICAR CONFIGURA√á√ÉO DE VOZ SELECIONADA
            console.log(`üîç [DEBUG] Voice Flags: useElevenLabs=${this.useElevenLabs}, useLocalTTS=${this.useLocalTTS}`);

            if (this.useElevenLabs && !this.useLocalTTS) {
                console.log('üéôÔ∏è Usando ElevenLabs Premium (selecionado)');
                try {
                    await this.speakWithElevenLabs(processedText);
                    return;
                } catch (error) {
                    console.error('‚ùå ElevenLabs falhou:', error.message);
                    console.log('üîÑ Fallback para voz local...');
                }
            } else {
                console.log('üéôÔ∏è Usando voz local (selecionado - economia de cr√©ditos)');
                console.log(`üîç [DEBUG] Motivo voz local: useElevenLabs=${this.useElevenLabs}, useLocalTTS=${this.useLocalTTS}`);
            }

            // USAR VOZ LOCAL (selecionado ou fallback)
            try {
                await this.speakLocal(processedText);
                return;
            } catch (error) {
                console.error('‚ùå Voz local falhou:', error.message);
                // Resetar flags em caso de erro
                this.isSpeaking = false;
                window.orbionSpeaking = false;
                throw error;
            }
        }

        // ===== ELEVENLABS TTS (VOZ PREMIUM) =====
        async speakWithElevenLabs(text) {
            return new Promise(async (resolve, reject) => {
                try {
                    // PROTE√á√ÉO ADICIONAL - RATE LIMITER GLOBAL (otimizado)
                    if (window.lastTTSCall && Date.now() - window.lastTTSCall < 800) {
                        console.warn('üö´ ORBION: Rate limiter bloqueou TTS call (< 800ms desde √∫ltimo)');
                        throw new Error('Rate limited - too many TTS calls');
                    }
                    window.lastTTSCall = Date.now();

                    // VERIFICAR SE SISTEMA FOI PARADO
                    if (this.config.autoStop) {
                        console.warn('üõë ORBION: Sistema parado - cancelando TTS');
                        throw new Error('Sistema parado pelo usu√°rio');
                    }

                    this.isSpeaking = true;
                    console.log(`üéôÔ∏è ElevenLabs TTS: "${text.substring(0, 50)}..."`);

                    const response = await fetch('/api/tts/elevenlabs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    });

                    if (!response.ok) {
                        throw new Error(`ElevenLabs API error: ${response.status}`);
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);

                    audio.onloadeddata = () => {
                        console.log('üîä ORBION falando (ElevenLabs):', text);
                        // Ativar anima√ß√£o de voz na logo
                        this.startVoiceAnimation();
                    };

                    audio.onended = () => {
                        this.isSpeaking = false;
                        window.orbionSpeaking = false; // Liberar flag global

                        // üïí TIMESTAMP CR√çTICO: Marcar quando TTS terminou
                        window.lastOrbionTTSEnd = Date.now();
                        console.log('üîá [ANTI-FEEDBACK] TTS finalizado - quarentena de 3s iniciada');

                        // Parar anima√ß√£o de voz na logo
                        this.stopVoiceAnimation();
                        URL.revokeObjectURL(audioUrl);
                        resolve();

                        // N√ÉO REINICIAR AUTOMATICAMENTE - s√≥ responder quando perguntado
                        console.log('üéôÔ∏è Resposta conclu√≠da - aguardando pr√≥xima pergunta');
                    };

                    audio.onerror = (error) => {
                        this.isSpeaking = false;
                        window.orbionSpeaking = false; // Liberar flag global
                        window.lastTTSCall = 0; // Reset rate limiter
                        URL.revokeObjectURL(audioUrl);
                        reject(new Error(`Audio playback error: ${error.message}`));
                    };

                    await audio.play();

                } catch (error) {
                    this.isSpeaking = false;
                    window.orbionSpeaking = false; // Liberar flag global
                    window.lastTTSCall = 0; // Reset rate limiter
                    reject(error);
                }
            });
        }

        // ===== VOZ LOCAL OTIMIZADA (FALLBACK) =====
        speakLocal(text, options = {}) {
            if (!this.synthesis) return Promise.reject('S√≠ntese n√£o dispon√≠vel');

            return new Promise((resolve, reject) => {
                this.synthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = options.lang || this.config.language;

                // Par√¢metros otimizados para naturalidade
                utterance.rate = options.rate || 0.85;
                utterance.pitch = options.pitch || 0.95;
                utterance.volume = options.volume || 0.8;

                const voices = this.synthesis.getVoices();
                const optimalVoice = this.getOptimalVoice(voices);

                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                    console.log(`üéôÔ∏è Voz local: ${optimalVoice.name} - Qualidade: ${this.getVoiceQuality(optimalVoice)}`);
                }

                utterance.onstart = () => {
                    this.isSpeaking = true;
                    console.log(`üîä ORBION falando (local): "${text}"`);
                    // Ativar anima√ß√£o de voz na logo
                    this.startVoiceAnimation();
                };

                utterance.onend = () => {
                    this.isSpeaking = false;
                    window.orbionSpeaking = false; // Liberar flag global

                    // üïí TIMESTAMP CR√çTICO: Marcar quando TTS terminou (SpeechSynthesis)
                    window.lastOrbionTTSEnd = Date.now();
                    console.log('üîá [ANTI-FEEDBACK] TTS (SpeechSynthesis) finalizado - quarentena de 3s iniciada');

                    // Parar anima√ß√£o de voz na logo
                    this.stopVoiceAnimation();
                    resolve();

                    // Reiniciar automaticamente ap√≥s resposta (apenas se n√£o foi encerrado) - MAIS R√ÅPIDO
                    setTimeout(() => {
                        if (!this.isListening && !this.isSpeaking && !this.config.autoStop) {
                            this.start();
                        }
                    }, 500); // Reduzido de 1500ms para 500ms para resposta mais r√°pida
                };

                utterance.onerror = (event) => {
                    this.isSpeaking = false;
                    window.orbionSpeaking = false; // Liberar flag global
                    reject(event);
                };

                this.synthesis.speak(utterance);
            });
        }

        // ===== PROCESSAMENTO DE TEXTO PARA NATURALIDADE =====
        processTextForNaturalSpeech(text) {
            return text
                // Adicionar pausas naturais
                .replace(/\./g, '. ')
                .replace(/,/g, ', ')
                .replace(/;/g, '; ')
                .replace(/:/g, ': ')
                .replace(/\?/g, '? ')
                .replace(/!/g, '! ')
                // Melhorar pron√∫ncia de siglas
                .replace(/ORBION/g, '√ìrbion')
                .replace(/WhatsApp/g, 'U√≥ts √°p')
                .replace(/API/g, '√° p√™ i')
                .replace(/AI/g, '√°i')
                .replace(/IA/g, 'i √°')
                .replace(/CRM/g, 'c√™ erre eme')
                // N√∫meros para extenso (exemplos)
                .replace(/\b24h\b/g, 'vinte e quatro horas')
                .replace(/\b7\s*dias/g, 'sete dias')
                // Remover caracteres especiais problem√°ticos
                .replace(/[#@$%^&*()]/g, '')
                // Normalizar espa√ßos
                .replace(/\s+/g, ' ')
                .trim();
        }

        // ===== SELE√á√ÉO OTIMIZADA DE VOZ =====
        getOptimalVoice(voices) {
            // Lista hier√°rquica das melhores vozes em portugu√™s BR
            const voicePriorities = [
                // Vozes neurais/premium (mais naturais)
                v => v.lang === 'pt-BR' && v.name.toLowerCase().includes('neural'),
                v => v.lang === 'pt-BR' && v.name.toLowerCase().includes('wavenet'),
                v => v.lang === 'pt-BR' && v.name.toLowerCase().includes('premium'),
                v => v.lang === 'pt-BR' && v.name.toLowerCase().includes('enhanced'),
                v => v.lang === 'pt-BR' && v.name.toLowerCase().includes('improved'),

                // Vozes espec√≠ficas conhecidas por qualidade
                v => v.lang === 'pt-BR' && v.name.includes('Google'),
                v => v.lang === 'pt-BR' && v.name.includes('Microsoft'),
                v => v.lang === 'pt-BR' && v.name.includes('Amazon'),

                // Vozes nativas espec√≠ficas (femininas geralmente mais naturais)
                v => v.lang === 'pt-BR' && v.name.includes('Luciana'),
                v => v.lang === 'pt-BR' && v.name.includes('Heloisa'),
                v => v.lang === 'pt-BR' && v.name.includes('Vit√≥ria'),
                v => v.lang === 'pt-BR' && v.name.includes('Camila'),

                // Vozes masculinas
                v => v.lang === 'pt-BR' && v.name.includes('Daniel'),
                v => v.lang === 'pt-BR' && v.name.includes('Ricardo'),

                // Fallbacks
                v => v.lang === 'pt-BR' && !v.name.toLowerCase().includes('compact'),
                v => v.lang === 'pt-BR' && !v.name.toLowerCase().includes('basic'),
                v => v.lang === 'pt-BR',
                v => v.lang.includes('pt'),
                v => v.default
            ];

            for (const priority of voicePriorities) {
                const voice = voices.find(priority);
                if (voice) {
                    console.log(`üéØ Voz selecionada: ${voice.name} (${voice.lang})`);
                    return voice;
                }
            }

            return voices[0];
        }

        // ===== AVALIA√á√ÉO DE QUALIDADE DE VOZ =====
        getVoiceQuality(voice) {
            if (!voice) return 'Desconhecida';

            const name = voice.name.toLowerCase();

            if (name.includes('neural') || name.includes('wavenet')) return 'Premium';
            if (name.includes('enhanced') || name.includes('improved')) return 'Alta';
            if (name.includes('google') || name.includes('microsoft')) return 'Boa';
            if (name.includes('compact') || name.includes('basic')) return 'B√°sica';

            return 'Padr√£o';
        }

        // ===== CONFIGURAR CALLBACKS DO RECONHECIMENTO =====
        setupRecognitionCallbacks() {
            if (!this.recognition) return;

            // Quando come√ßa a escutar
            this.recognition.onstart = () => {
                this.isListening = true;
                if (this.onStart) this.onStart();
            };

            // REMOVIDO: Handler duplicado de onresult
            // O handler principal j√° est√° definido nas linhas 6756-6773
            // Manter apenas um handler evita execu√ß√£o dupla

            // Quando h√° erro
            this.recognition.onerror = (event) => {
                const errorMessages = {
                    'no-speech': 'Nenhuma fala detectada',
                    'audio-capture': 'Falha na captura do √°udio',
                    'not-allowed': 'Permiss√£o de microfone negada',
                    'network': 'Erro de rede'
                };
                const message = errorMessages[event.error] || `Erro: ${event.error}`;
                if (this.onError) this.onError(event.error, message);
            };

            // Quando termina
            this.recognition.onend = () => {
                this.isListening = false;
                if (this.onEnd) this.onEnd();
                // Reiniciar se modo cont√≠nuo
                if (this.config.continuous && !this.config.autoStop) {
                    setTimeout(() => {
                        if (!this.isListening && !this.isSpeaking) {
                            this.start();
                        }
                    }, 1000);
                }
            };
        }

        // ===== CONTROLE =====
        start() {
            if (!this.recognition || this.isListening) return false;
            try {
                // Reativar modo cont√≠nuo e resetar flags de parada
                this.config.autoStop = false;
                this.config.continuous = true;

                // REMOVIDO: setupRecognitionCallbacks() - j√° configurado na inicializa√ß√£o
                // Isso evita handlers duplicados que causam m√∫ltiplas vozes

                this.recognition.start();
                this.updateButtonState('listening');

                console.log('üü¢ ORBION: Sistema de voz reativado - voltando a escutar');
                return true;
            } catch (error) {
                console.error('Erro ao iniciar:', error);
                return false;
            }
        }

        stop() {
            if (!this.recognition || !this.isListening) return false;
            try {
                this.recognition.stop();
                this.config.autoStop = true;
                this.updateButtonState('stopped');
                return true;
            } catch (error) {
                console.error('Erro ao parar:', error);
                return false;
            }
        }

        abort() {
            if (this.recognition) this.recognition.abort();
            if (this.synthesis) this.synthesis.cancel();
        }

        // ===== ENCERRAMENTO COMPLETO DO SISTEMA =====
        shutdown() {
            console.log('üî¥ ORBION: Encerrando sistema de voz...');

            // Parar reconhecimento IMEDIATAMENTE
            if (this.recognition) {
                try {
                    this.recognition.abort();
                    this.recognition.onend = null; // Remover callback que pode reiniciar
                    this.recognition.onresult = null; // Remover processamento
                } catch (error) {
                    console.error('Erro ao abortar reconhecimento:', error);
                }
            }

            // Parar s√≠ntese de voz IMEDIATAMENTE
            if (this.synthesis) {
                try {
                    this.synthesis.cancel();
                } catch (error) {
                    console.error('Erro ao cancelar s√≠ntese:', error);
                }
            }

            // Resetar TODOS os estados para garantir parada completa
            this.isListening = false;
            this.isSpeaking = false;
            this.isProcessing = false;
            this.config.autoStop = true;
            this.config.continuous = false; // For√ßar modo n√£o-cont√≠nuo

            // Liberar flags globais de prote√ß√£o
            window.orbionSpeaking = false;

            // Limpar qualquer timeout pendente
            if (this.restartTimeout) {
                clearTimeout(this.restartTimeout);
                this.restartTimeout = null;
            }

            // Atualizar interface
            this.updateButtonState('shutdown');

            console.log('üî¥ ORBION: Sistema de voz COMPLETAMENTE ENCERRADO - n√£o far√° mais requisi√ß√µes');
            console.log('üî¥ Para reativar: clique em "Falar" ou diga "ol√° orbion"');
            return true;
        }

        // ===== ATUALIZA√á√ÉO DA INTERFACE =====
        updateButtonState(state) {
            const btnSpeak = document.getElementById('btn-speak');
            if (!btnSpeak) return;

            switch (state) {
                case 'listening':
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg><span style="position: relative; z-index: 1;">üé§ Ouvindo...</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, #10b981, #06b6d4)';
                    break;
                case 'stopped':
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg><span style="position: relative; z-index: 1;">Falar</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
                    break;
                case 'shutdown':
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg><span style="position: relative; z-index: 1;">üî¥ Reativar ORBION</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
            }
        }

        loadVoices() {
            if (this.synthesis.onvoiceschanged !== undefined) {
                this.synthesis.onvoiceschanged = () => {
                    const voices = this.synthesis.getVoices();
                    console.log(`üéôÔ∏è ${voices.length} vozes dispon√≠veis`);
                };
            }
        }

        isActive() {
            return this.isListening || this.isSpeaking || this.isProcessing;
        }

        // ===== ANIMA√á√ÉO DE VOZ PARA LOGO =====
        startVoiceAnimation() {
            const brandName = document.getElementById('brand-name');
            if (brandName) {
                brandName.classList.add('speaking-animation');
                console.log('üé® Anima√ß√£o de voz iniciada na logo ORBION');
            }
        }

        stopVoiceAnimation() {
            const brandName = document.getElementById('brand-name');
            if (brandName) {
                brandName.classList.remove('speaking-animation');
                console.log('üé® Anima√ß√£o de voz parada na logo ORBION');
            }
        }
    }

    // ===== INICIALIZA√á√ÉO DO SISTEMA DE VOZ =====
    let orbionVoice = null;

    // TERCEIRO LISTENER REMOVIDO PARA EVITAR M√öLTIPLAS INST√ÇNCIAS
    // Sistema de voz movido para o primeiro DOMContentLoaded
    function // initializeVoiceSystemOnce() // DESABILITADO - Sistema de voz removido {
        if (window.orbionVoiceInitialized) {
            console.log('üö´ Sistema de voz j√° inicializado - pulando duplicata');
            return;
        }
        window.orbionVoiceInitialized = true;

        // Inicializar sistema de voz √öNICA VEZ
        orbionVoice = new OrbionVoiceSystem({
            language: 'pt-BR',
            continuous: true,
            voiceSpeed: 0.85,   // Velocidade mais natural
            voicePitch: 0.95,   // Tom mais grave e humano
            voiceVolume: 0.8,   // Volume mais suave
            debug: true,

            onStart: () => {
                const btnSpeak = document.getElementById('btn-speak');
                if (btnSpeak) {
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg><span style="position: relative; z-index: 1;">üé§ Ouvindo...</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, #10b981, #06b6d4)';
                }
            },

            onEnd: () => {
                const btnSpeak = document.getElementById('btn-speak');
                if (btnSpeak && !orbionVoice.isListening) {
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg><span style="position: relative; z-index: 1;">Falar</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
                }

                // N√ÉO REINICIAR AUTOMATICAMENTE - agente s√≥ fala quando perguntado
                console.log('üé§ Reconhecimento encerrado - aguardando ativa√ß√£o manual');
            },

            onError: (error, message) => {
                console.error('Erro no sistema de voz:', message);
                const btnSpeak = document.getElementById('btn-speak');
                if (btnSpeak) {
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg><span style="position: relative; z-index: 1;">Falar</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
                }
            }
        });

        // üîß EXPOR VARI√ÅVEL GLOBALMENTE PARA OS BOT√ïES DE VOZ
        window.orbionVoice = orbionVoice;
        console.log('üåç [VOICE-NAV] orbionVoice exposta globalmente:', window.orbionVoice);

        // Conectar bot√µes existentes
        const btnSpeak = document.getElementById('btn-speak');
        const btnStop = document.getElementById('btn-stop');
        const voiceSelector = document.getElementById('voice-selector');
        const voiceStatus = document.getElementById('voice-status');

        if (btnSpeak) {
            btnSpeak.addEventListener('click', () => {
                if (orbionVoice.isListening) {
                    orbionVoice.stop();
                } else {
                    orbionVoice.start();
                }
            });
        }

        if (btnStop) {
            btnStop.addEventListener('click', () => {
                orbionVoice.abort();
                const btnSpeak = document.getElementById('btn-speak');
                if (btnSpeak) {
                    btnSpeak.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg><span style="position: relative; z-index: 1;">Falar</span>';
                    btnSpeak.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
                }
            });
        }

        // Controle do seletor de voz
        if (voiceSelector) {
            voiceSelector.addEventListener('change', (e) => {
                const selectedVoice = e.target.value;

                if (selectedVoice === 'elevenlabs') {
                    orbionVoice.useElevenLabs = true;
                    orbionVoice.useLocalTTS = false; // Garantir que voz local est√° desabilitada
                    voiceStatus.textContent = 'PREMIUM';
                    voiceStatus.style.background = 'var(--ok)';
                    console.log('üéôÔ∏è Voz alterada para: ElevenLabs Premium');
                    console.log(`‚úÖ [DEBUG] ElevenLabs ativado: useElevenLabs=${orbionVoice.useElevenLabs}, useLocalTTS=${orbionVoice.useLocalTTS}`);
                } else if (selectedVoice === 'local') {
                    // Usar voz local (system_tts) - economia de cr√©ditos
                    orbionVoice.useElevenLabs = false;
                    orbionVoice.useLocalTTS = true;
                    voiceStatus.textContent = 'LOCAL';
                    voiceStatus.style.background = 'var(--primary-color)';
                    console.log('üéôÔ∏è Voz alterada para: Local Otimizada (Econ√¥mica)');
                } else {
                    // Padr√£o: voz local para economia
                    orbionVoice.useElevenLabs = false;
                    orbionVoice.useLocalTTS = true;
                    voiceStatus.textContent = 'LOCAL';
                    voiceStatus.style.background = 'var(--primary-color)';
                    console.log('üéôÔ∏è Usando voz local por padr√£o (economia de cr√©ditos)');
                }
            });
        }

        // Inicializar configura√ß√£o ElevenLabs automaticamente
        console.log(`üîç [DEBUG] Voice selector value on load: ${voiceSelector ? voiceSelector.value : 'not found'}`);
        console.log(`üîç [DEBUG] Initial orbionVoice flags: useElevenLabs=${orbionVoice.useElevenLabs}, useLocalTTS=${orbionVoice.useLocalTTS}`);

        if (voiceSelector && voiceSelector.value === 'elevenlabs') {
            // Disparar evento change para garantir configura√ß√£o correta
            setTimeout(() => {
                console.log('üéôÔ∏è Disparando evento change autom√°tico para ElevenLabs...');
                voiceSelector.dispatchEvent(new Event('change'));
                console.log('üéôÔ∏è Configura√ß√£o ElevenLabs aplicada automaticamente');
            }, 100);
        }

        // Sistema de voz iniciado apenas manualmente
        // N√£o iniciar automaticamente - usu√°rio deve clicar em "Falar" ou dizer "ol√° orbion"
        console.log('üéôÔ∏è Sistema de voz ORBION carregado. Clique em "Falar" ou diga "ol√° orbion" para ativar.');

        console.log('üéôÔ∏è Sistema ORBION Voice integrado aos bot√µes do Hub!');
    }

    // Chamar inicializa√ß√£o apenas uma vez quando DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeVoiceSystemOnce);
    } else {
        // initializeVoiceSystemOnce() // DESABILITADO - Sistema de voz removido;
    }

    // ===== SISTEMA DE DIAGN√ìSTICO E RECONEX√ÉO =====
    function diagnosticarSistemaVoz() {
        console.log('üîß [DIAGN√ìSTICO] Iniciando diagn√≥stico do sistema de voz...');

        // 1. Verificar se orbionVoice existe
        if (!window.orbionVoice) {
            console.error('‚ùå [DIAGN√ìSTICO] window.orbionVoice n√£o existe - reinicializando...');
            // initializeVoiceSystemOnce() // DESABILITADO - Sistema de voz removido;
            return;
        }

        // 2. Testar detec√ß√£o de comandos
        const testCommand = 'abrir configura√ß√µes';
        const isDetected = window.orbionVoice.isDashboardNavigationCommand(testCommand);
        console.log('üîç [DIAGN√ìSTICO] Detec√ß√£o de comando:', isDetected ? '‚úÖ OK' : '‚ùå FALHOU');

        // 3. Testar API
        fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: testCommand,
                context: {
                    fromVoice: true,
                    platform: 'dashboard_web',
                    fromDashboard: true
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('üîç [DIAGN√ìSTICO] API Response:', data);

            if (data.action === 'voice_navigation' && data.instructions?.javascript) {
                console.log('‚úÖ [DIAGN√ìSTICO] API funcionando corretamente');
                console.log('‚úÖ [DIAGN√ìSTICO] JavaScript gerado:', data.instructions.javascript);

                // 4. Testar execu√ß√£o
                try {
                    console.log('üöÄ [DIAGN√ìSTICO] Testando execu√ß√£o do JavaScript...');
                    eval(data.instructions.javascript);
                    console.log('‚úÖ [DIAGN√ìSTICO] Sistema 100% funcional!');
                } catch (error) {
                    console.error('‚ùå [DIAGN√ìSTICO] Erro na execu√ß√£o:', error);
                }
            } else {
                console.error('‚ùå [DIAGN√ìSTICO] API n√£o retornou navega√ß√£o v√°lida');
            }
        })
        .catch(error => {
            console.error('‚ùå [DIAGN√ìSTICO] Erro na API:', error);
        });

        // 5. Verificar elementos das abas
        const tabs = ['home', 'stats', 'whatsapp', 'customize', 'funnel', 'leads', 'calendar'];
        console.log('üîç [DIAGN√ìSTICO] Verificando elementos das abas:');
        tabs.forEach(tab => {
            const element = document.querySelector(`[data-tab="${tab}"]`);
            console.log(`  ${tab}:`, element ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado');
        });
    }

    // ===== RECONEX√ÉO AUTOM√ÅTICA =====
    function reconectarSistemaVoz() {
        console.log('üîÑ [RECONEX√ÉO] Reinicializando sistema de voz...');

        // Limpar inst√¢ncia anterior
        if (window.orbionVoice) {
            try {
                window.orbionVoice.abort();
            } catch (e) {}
        }

        // Resetar flag
        window.orbionVoiceInitialized = false;

        // Reinicializar
        setTimeout(() => {
            // initializeVoiceSystemOnce() // DESABILITADO - Sistema de voz removido;
            console.log('‚úÖ [RECONEX√ÉO] Sistema de voz reinicializado');
        }, 1000);
    }

    // ===== ATALHOS DE TECLADO PARA DIAGN√ìSTICO =====
    document.addEventListener('keydown', (e) => {
        // Ctrl + Shift + D = Diagn√≥stico
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            diagnosticarSistemaVoz();
        }

        // Ctrl + Shift + R = Reconectar
        if (e.ctrlKey && e.shiftKey && e.key === 'R') {
            e.preventDefault();
            reconectarSistemaVoz();
        }

        // Ctrl + Shift + T = Teste r√°pido de navega√ß√£o
        if (e.ctrlKey && e.shiftKey && e.key === 'T') {
            e.preventDefault();
            console.log('üß™ [TESTE] Executando navega√ß√£o direta...');
            const element = document.querySelector('[data-tab="customize"]');
            if (element) {
                element.click();
                console.log('‚úÖ [TESTE] Navega√ß√£o executada com sucesso!');
            } else {
                console.error('‚ùå [TESTE] Elemento n√£o encontrado');
            }
        }
    });

    // ===== MONITORAMENTO CONT√çNUO =====
    setInterval(() => {
        if (!window.orbionVoice) {
            console.warn('‚ö†Ô∏è [MONITOR] Sistema de voz perdido - reconectando...');
            reconectarSistemaVoz();
        }
    }, 30000); // Verificar a cada 30 segundos

    console.log('üõ†Ô∏è [SISTEMA] Diagn√≥stico ativo:');
    console.log('  Ctrl+Shift+D = Diagn√≥stico completo');
    console.log('  Ctrl+Shift+R = Reconectar sistema');
    console.log('  Ctrl+Shift+T = Teste direto de navega√ß√£o');

    // ===== SISTEMA DE ABA LATERAL DE LEADS =====
    class LeadsSidebarManager {
        constructor() {
            this.sidebar = document.getElementById('leads-sidebar');
            this.overlay = document.getElementById('leads-sidebar-overlay');
            this.closeBtn = document.getElementById('close-leads-sidebar');
            this.isOpen = false;

            this.initializeEvents();
            console.log('‚úÖ Sistema de aba lateral de leads inicializado');
        }

        initializeEvents() {
            // Bot√£o de fechar
            if (this.closeBtn) {
                this.closeBtn.addEventListener('click', () => this.closeSidebar());
            }

            // Overlay para fechar
            if (this.overlay) {
                this.overlay.addEventListener('click', () => this.closeSidebar());
            }

            // ESC para fechar
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.isOpen) {
                    this.closeSidebar();
                }
            });

            // Eventos dos bot√µes de a√ß√£o
            this.initializeFormEvents();
        }

        initializeFormEvents() {
            // Bot√£o Salvar Lead
            const saveBtn = document.getElementById('save-lead');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => this.saveLead());
            }

            // Bot√£o Enviar Follow-up
            const followupBtn = document.getElementById('send-whatsapp-followup');
            if (followupBtn) {
                followupBtn.addEventListener('click', () => this.sendFollowUp());
            }

            // Bot√£o Agendar Reuni√£o
            const scheduleBtn = document.getElementById('schedule-meeting');
            if (scheduleBtn) {
                scheduleBtn.addEventListener('click', () => this.scheduleMeeting());
            }
        }

        openSidebar() {
            if (this.sidebar && this.overlay) {
                this.sidebar.classList.add('open');
                this.overlay.classList.add('active');
                this.isOpen = true;
                document.body.style.overflow = 'hidden';
                console.log('üìã Aba lateral de leads aberta');
            }
        }

        closeSidebar() {
            if (this.sidebar && this.overlay) {
                this.sidebar.classList.remove('open');
                this.overlay.classList.remove('active');
                this.isOpen = false;
                document.body.style.overflow = '';
                console.log('üìã Aba lateral de leads fechada');
            }
        }

        fillForm(leadData = {}) {
            // Preencher campos do formul√°rio se dados foram fornecidos
            const fields = {
                'lead-name': leadData.name || '',
                'lead-whatsapp': leadData.whatsapp || '',
                'lead-email': leadData.email || '',
                'lead-company': leadData.company || '',
                'lead-position': leadData.position || '',
                'lead-segment': leadData.segment || '',
                'lead-interest': leadData.interest || '',
                'lead-budget': leadData.budget || '',
                'lead-urgency': leadData.urgency || '',
                'lead-notes': leadData.notes || ''
            };

            Object.entries(fields).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value;
                }
            });
        }

        getFormData() {
            const formData = {};
            const fields = [
                'lead-name', 'lead-whatsapp', 'lead-email', 'lead-company',
                'lead-position', 'lead-segment', 'lead-interest', 'lead-budget',
                'lead-urgency', 'lead-notes'
            ];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    formData[field.replace('lead-', '')] = element.value;
                }
            });

            return formData;
        }

        async saveLead() {
            const formData = this.getFormData();

            // Valida√ß√£o b√°sica
            if (!formData.name || !formData.whatsapp) {
                this.showFeedback('Nome e WhatsApp s√£o obrigat√≥rios!', 'error');
                return;
            }

            try {
                // Simular salvamento (integra√ß√£o com API)
                console.log('üíæ Salvando lead:', formData);

                // Aqui voc√™ pode integrar com sua API
                // const response = await fetch('/api/leads', { ... });

                this.showFeedback('Lead salvo com sucesso! üéâ', 'success');

                // Limpar formul√°rio ap√≥s 2 segundos
                setTimeout(() => this.clearForm(), 2000);

            } catch (error) {
                console.error('Erro ao salvar lead:', error);
                this.showFeedback('Erro ao salvar lead. Tente novamente.', 'error');
            }
        }

        async sendFollowUp() {
            const formData = this.getFormData();

            if (!formData.whatsapp) {
                this.showFeedback('WhatsApp √© obrigat√≥rio para follow-up!', 'error');
                return;
            }

            try {
                // Criar mensagem personalizada baseada nos dados
                const message = this.generateFollowUpMessage(formData);

                console.log('üì± Enviando follow-up para:', formData.whatsapp);
                console.log('üí¨ Mensagem:', message);

                // Integrar com sistema WhatsApp existente
                if (typeof sendWhatsAppMessage === 'function') {
                    await sendWhatsAppMessage(formData.whatsapp, message);
                } else {
                    // Simular envio
                    console.log('WhatsApp integra√ß√£o n√£o encontrada - simulando envio');
                }

                this.showFeedback('Follow-up enviado via WhatsApp! üì±', 'success');

            } catch (error) {
                console.error('Erro ao enviar follow-up:', error);
                this.showFeedback('Erro ao enviar follow-up. Tente novamente.', 'error');
            }
        }

        async scheduleMeeting() {
            const formData = this.getFormData();

            if (!formData.name || !formData.email) {
                this.showFeedback('Nome e email s√£o obrigat√≥rios para agendamento!', 'error');
                return;
            }

            try {
                console.log('üìÖ Agendando reuni√£o para:', formData.name);

                // Integrar com Google Calendar se dispon√≠vel
                // Aqui voc√™ pode usar a API existente do calend√°rio

                this.showFeedback('Reuni√£o agendada com sucesso! üìÖ', 'success');

            } catch (error) {
                console.error('Erro ao agendar reuni√£o:', error);
                this.showFeedback('Erro ao agendar reuni√£o. Tente novamente.', 'error');
            }
        }

        generateFollowUpMessage(formData) {
            const { name, company, interest } = formData;
            let message = `Ol√°`;

            if (name) message += ` ${name}`;
            message += `! üëã\n\n`;

            if (company) {
                message += `Obrigado pelo interesse da ${company} em nossas solu√ß√µes digitais.\n\n`;
            }

            if (interest) {
                const interests = {
                    'automacao': 'automa√ß√£o de WhatsApp',
                    'crm': 'sistema CRM',
                    'agente-ia': 'agente de IA',
                    'consultoria': 'consultoria digital',
                    'integracao': 'integra√ß√£o de sistemas'
                };
                message += `Entendi que voc√™s t√™m interesse em ${interests[interest] || 'nossas solu√ß√µes'}.\n\n`;
            }

            message += `A ORBION pode ajudar sua empresa a automatizar processos e aumentar vendas com IA.\n\n`;
            message += `Quando podemos conversar para entender melhor suas necessidades?\n\n`;
            message += `ü§ñ *ORBION - Transformando neg√≥cios com IA*`;

            return message;
        }

        clearForm() {
            const fields = [
                'lead-name', 'lead-whatsapp', 'lead-email', 'lead-company',
                'lead-position', 'lead-segment', 'lead-interest', 'lead-budget',
                'lead-urgency', 'lead-notes'
            ];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = '';
                }
            });
        }

        showFeedback(message, type = 'success') {
            const feedback = document.getElementById('leads-feedback');
            if (feedback) {
                feedback.textContent = message;
                feedback.className = `leads-feedback show ${type}`;

                // Remover ap√≥s 5 segundos
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 5000);
            }
        }
    }

    // Inicializar o sistema de aba lateral
    let leadsSidebar = null;
    document.addEventListener('DOMContentLoaded', () => {
        leadsSidebar = new LeadsSidebarManager();

        // Disponibilizar globalmente para uso em comandos de voz
        window.openLeadsSidebar = () => leadsSidebar?.openSidebar();
        window.closeLeadsSidebar = () => leadsSidebar?.closeSidebar();
    });

    // Se j√° carregado, inicializar imediatamente
    if (document.readyState === 'loading') {
        // DOM ainda est√° carregando
    } else {
        // DOM j√° foi carregado
        if (!leadsSidebar) {
            leadsSidebar = new LeadsSidebarManager();
            window.openLeadsSidebar = () => leadsSidebar?.openSidebar();
            window.closeLeadsSidebar = () => leadsSidebar?.closeSidebar();
        }
    }

    console.log('üìã Sistema de aba lateral de leads configurado');

    // ===== SISTEMA DE LUZ QUE SEGUE O MOUSE =====
    const cardsContainer = document.querySelector("body");
    const cardsContents = document.querySelectorAll(".meio");

    let isLargeScreen = window.matchMedia("(min-width: 1025px)").matches;

    if (isLargeScreen && cardsContainer) {
      let lastX = 0;
      let lastY = 0;

      cardsContainer.addEventListener("mousemove", (e) => {
        lastX = e.clientX;
        lastY = e.clientY;
        requestAnimationFrame(() => {
          cardsContents.forEach((card) => {
            const rect = card.getBoundingClientRect();
            const x = lastX - rect.left;
            const y = lastY - rect.top;
            card.style.setProperty("--mouse-x", `${x}px`);
            card.style.setProperty("--mouse-y", `${y}px`);
          });
        });
      });
    }

    console.log('‚ú® Sistema de luz que segue o mouse inicializado');

    // ===== SISTEMA DE VAGALUMES ORBITAIS NO CENTRAL HUB =====
    function createFirefliesInCentralHub() {
      // Remover vagalumes existentes
      document.querySelectorAll('.firefly').forEach(f => f.remove());

      // Verificar se estamos na aba Central Hub (primeira aba/dashboard)
      if (!isOnCentralHubTab()) {
        console.log('üî• Vagalumes ocultos - n√£o estamos na aba Central Hub');
        return;
      }

      // Encontrar √°rea do Central Hub (primeira aba - Dashboard)
      const mainContent = document.querySelector('main');
      if (!mainContent) {
        console.log('‚ùå √Årea do Central Hub n√£o encontrada');
        return;
      }

      const fireflies = 15; // N√∫mero reduzido para √°rea espec√≠fica
      const animations = ['orbitFar', 'orbitMedium', 'orbitClose', 'orbitDistant'];

      // Calcular centro da √°rea Central Hub
      const hubCenterX = window.innerWidth * 0.6; // Centro relativo da main area
      const hubCenterY = window.innerHeight * 0.5; // Centro vertical

      for (let i = 0; i < fireflies; i++) {
        const firefly = document.createElement('div');
        firefly.className = 'firefly';

        // Posicionamento central para rota√ß√£o orbital
        firefly.style.position = 'fixed';
        firefly.style.left = hubCenterX + 'px';
        firefly.style.top = hubCenterY + 'px';
        firefly.style.transformOrigin = '0 0';

        // Anima√ß√£o orbital aleat√≥ria
        const animation = animations[Math.floor(Math.random() * animations.length)];
        const duration = Math.random() * 8 + 6; // 6 a 14 segundos (mais lento)
        const delay = Math.random() * 8; // 0 a 8 segundos de delay

        firefly.style.animation = `${animation} ${duration}s linear infinite ${delay}s`;

        document.body.appendChild(firefly);
      }

      console.log(`üî• ${fireflies} vagalumes criados orbitando no Central Hub`);
    }

    // Fun√ß√£o para detectar se estamos na aba Central Hub
    function isOnCentralHubTab() {
      // Procurar pela aba ativa no menu sidebar
      const activeMenuItem = document.querySelector('#sidebar .menu .item.active');

      if (activeMenuItem) {
        const tabId = activeMenuItem.getAttribute('data-tab');
        console.log('üîç Aba ativa detectada:', tabId);

        // Verificar se √© especificamente a aba home (Central Hub)
        return tabId === 'home';
      }

      // Fallback: verificar por outros m√©todos
      const alternativeActiveTab = document.querySelector('[data-tab-active="true"]') ||
                                   document.querySelector('.tab-active') ||
                                   document.querySelector('.active-tab');

      if (alternativeActiveTab) {
        const tabId = alternativeActiveTab.getAttribute('data-tab') ||
                     alternativeActiveTab.id ||
                     alternativeActiveTab.className;

        console.log('üîç Aba alternativa detectada:', tabId);
        return tabId === 'home' || (tabId && (tabId.includes('dashboard') ||
                                              tabId.includes('central') ||
                                              tabId.includes('hub')));
      }

      // Se n√£o encontrar nenhuma aba ativa, assumir que N√ÉO estamos no Central Hub
      // para evitar vagalumes aparecendo em todas as abas
      console.log('‚ö†Ô∏è Nenhuma aba ativa detectada - escondendo vagalumes por seguran√ßa');
      return false;
    }

    // Criar vagalumes quando a p√°gina carregar
    createFirefliesInCentralHub();

    // Recriar vagalumes quando a janela for redimensionada
    window.addEventListener('resize', () => {
      clearTimeout(window.resizeTimeout);
      window.resizeTimeout = setTimeout(createFirefliesInCentralHub, 500);
    });

    // Observar mudan√ßas na navega√ß√£o de abas
    function setupTabObserver() {
      // Observar cliques em elementos de navega√ß√£o
      document.addEventListener('click', (event) => {
        const target = event.target;

        // Detectar cliques em elementos de navega√ß√£o de abas (incluindo sidebar)
        if (target.matches('[data-tab]') ||
            target.matches('.item[data-tab]') ||
            target.matches('#sidebar .menu .item') ||
            target.matches('.nav-item') ||
            target.matches('.tab-button') ||
            target.closest('[data-tab]') ||
            target.closest('.item[data-tab]') ||
            target.closest('#sidebar .menu .item') ||
            target.closest('.nav-item')) {

          const clickedTab = target.closest('[data-tab]') || target.closest('.item[data-tab]');
          if (clickedTab) {
            const tabId = clickedTab.getAttribute('data-tab');
            console.log('üñ±Ô∏è Clique detectado na aba:', tabId);
          }

          // Aguardar a mudan√ßa de aba ser processada
          setTimeout(() => {
            console.log('üîÑ Mudan√ßa de aba detectada, atualizando vagalumes...');
            createFirefliesInCentralHub();
          }, 100);
        }
      });

      // Observar mudan√ßas no DOM que possam indicar mudan√ßa de aba
      const observer = new MutationObserver((mutations) => {
        let shouldUpdate = false;

        mutations.forEach((mutation) => {
          // Detectar mudan√ßas de classe ou atributos que indicam mudan√ßa de aba
          if (mutation.type === 'attributes' &&
              (mutation.attributeName === 'class' ||
               mutation.attributeName === 'data-tab-active' ||
               mutation.attributeName === 'style')) {

            // Se a mudan√ßa foi em um item do menu sidebar, registrar
            if (mutation.target.matches('#sidebar .menu .item') ||
                mutation.target.closest('#sidebar .menu .item')) {
              console.log('üîç Mudan√ßa detectada no menu sidebar:', mutation.target);
              shouldUpdate = true;
            }
          }
        });

        if (shouldUpdate) {
          setTimeout(() => {
            console.log('üîÑ Observer: atualizando vagalumes...');
            createFirefliesInCentralHub();
          }, 200);
        }
      });

      // Observar especificamente o sidebar menu
      const sidebar = document.querySelector('#sidebar .menu');
      if (sidebar) {
        observer.observe(sidebar, {
          attributes: true,
          subtree: true,
          attributeFilter: ['class', 'data-tab-active', 'style']
        });
        console.log('üëÄ Observer configurado para o menu sidebar');
      } else {
        console.log('‚ö†Ô∏è Menu sidebar n√£o encontrado para observa√ß√£o');
      }

      console.log('üéØ Observer de mudan√ßas de aba configurado');
    }

    // Configurar observer ap√≥s carregamento
    setupTabObserver();

    console.log('üéÜ Sistema de vagalumes orbitais no Central Hub inicializado');
  </script>
</body>
</html>