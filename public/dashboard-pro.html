<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadly IA - Digital Boost</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/dashboard/styles/crm-modules.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Digital Boost Color Palette */
            --bg-dark: #000000;
            --bg-navy: #04060a;
            --cyan: #18c5ff;
            --violet: #7c5cff;
            --text-light: #eaf2ff;
            --text-muted: #a7b3c8;
            --glass-bg: rgba(10, 16, 26, 0.55);
            --card-bg: rgba(16, 24, 39, 0.5);
            --border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Matrix Background Effect */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15;
            pointer-events: none;
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 0 0 1px rgba(24, 197, 255, 0.2);
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(24px, 4vw, 40px);
            font-weight: 900;
            background: linear-gradient(90deg, var(--cyan), var(--violet));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            color: var(--success);
            font-size: 14px;
            font-weight: 600;
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding: 12px;
            background: var(--glass-bg);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            padding: 14px 24px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 12px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tab-button:hover {
            background: rgba(24, 197, 255, 0.1);
            border-color: rgba(24, 197, 255, 0.3);
            color: var(--cyan);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--cyan) 0%, var(--violet) 100%);
            color: var(--text-light);
            border-color: transparent;
            box-shadow: 0 0 20px rgba(24, 197, 255, 0.5);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--cyan), var(--violet));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--cyan);
            box-shadow: 0 0 20px rgba(24, 197, 255, 0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--cyan), var(--violet));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 13px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Buttons - Digital Boost Style */
        .btn {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--cyan), var(--violet));
            color: #031018;
            box-shadow: 0 0 0 1px rgba(24, 197, 255, 0.35), 0 0 16px rgba(24, 197, 255, 0.28);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 0 1px rgba(24, 197, 255, 0.5), 0 0 24px rgba(24, 197, 255, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--cyan);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Action Buttons */
        .btn-action {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-action i {
            font-size: 1rem;
        }

        .btn-default {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-default:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-greeting {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-greeting:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-followup {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-followup:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-lost {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }

        .btn-lost:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
        }

        /* Campaign Section */
        .campaign-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--cyan);
        }

        .campaign-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--cyan);
            box-shadow: 0 0 0 2px rgba(24, 197, 255, 0.2);
        }

        .input-group input::placeholder {
            color: var(--text-muted);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th {
            background: rgba(24, 197, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--cyan);
            border-bottom: 1px solid var(--border);
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        .results-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(24, 197, 255, 0.2);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Event Items */
        .event-item {
            background: rgba(124, 92, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--violet);
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .event-item:hover {
            background: rgba(124, 92, 255, 0.1);
            transform: translateX(8px);
        }

        .event-item h4 {
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .event-item p {
            color: var(--text-muted);
            font-size: 14px;
            margin: 4px 0;
        }

        /* Calendar Kanban Layout */
        .calendar-kanban {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            min-height: 400px;
        }

        @media (max-width: 1200px) {
            .calendar-kanban {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .calendar-kanban {
                grid-template-columns: 1fr;
            }
        }

        .calendar-column {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .calendar-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .calendar-column-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        .calendar-column-count {
            background: rgba(124, 92, 255, 0.3);
            color: var(--violet);
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .calendar-column.column-today .calendar-column-header {
            border-bottom-color: var(--success);
        }

        .calendar-column.column-today .calendar-column-count {
            background: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .calendar-column.column-tomorrow .calendar-column-header {
            border-bottom-color: var(--cyan);
        }

        .calendar-column.column-tomorrow .calendar-column-count {
            background: rgba(24, 197, 255, 0.3);
            color: var(--cyan);
        }

        .calendar-column.column-week .calendar-column-header {
            border-bottom-color: var(--violet);
        }

        .calendar-column.column-later .calendar-column-header {
            border-bottom-color: var(--text-muted);
        }

        .calendar-column.column-later .calendar-column-count {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
        }

        .calendar-column-cards {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .calendar-column-cards::-webkit-scrollbar {
            width: 4px;
        }

        .calendar-column-cards::-webkit-scrollbar-track {
            background: transparent;
        }

        .calendar-column-cards::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .calendar-empty {
            color: var(--text-muted);
            font-size: 13px;
            text-align: center;
            padding: 20px;
            opacity: 0.6;
        }

        /* Event Card Kanban Style */
        .event-card {
            background: rgba(124, 92, 255, 0.08);
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: grab;
        }

        .event-card:hover {
            border-color: var(--violet);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 92, 255, 0.2);
        }

        .event-card:active {
            cursor: grabbing;
        }

        .event-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .event-card.drag-over {
            border-color: var(--cyan);
            background: rgba(24, 197, 255, 0.15);
        }

        .event-card-header {
            padding: 12px;
            cursor: pointer;
        }

        .event-card-title {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .event-card-title h4 {
            color: var(--text-light);
            margin: 0;
            font-weight: 600;
            font-size: 13px;
            flex: 1;
            line-height: 1.3;
        }

        .event-card-time {
            font-size: 11px;
            color: var(--cyan);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .event-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-card-location {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-card-actions {
            display: flex;
            gap: 4px;
        }

        .event-card-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-muted);
            width: 26px;
            height: 26px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 11px;
        }

        .event-card-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-light);
        }

        .event-card-btn.btn-edit:hover {
            background: rgba(24, 197, 255, 0.3);
            color: var(--cyan);
        }

        .event-card-btn.btn-delete:hover {
            background: rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .event-card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
        }

        .event-card.expanded .event-card-body {
            max-height: 300px;
        }

        .event-card-details {
            padding: 12px;
            font-size: 12px;
        }

        .event-card-detail {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .event-card-detail:last-child {
            margin-bottom: 0;
        }

        .event-card-detail i {
            color: var(--cyan);
            width: 14px;
            flex-shrink: 0;
            margin-top: 2px;
            font-size: 11px;
        }

        .event-card-detail a {
            color: var(--cyan);
            text-decoration: none;
        }

        .event-card-detail a:hover {
            text-decoration: underline;
        }

        /* Edit Event Modal */
        .edit-event-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .edit-event-form .input-group {
            margin-bottom: 0;
        }

        /* Lead Cards Grid */
        .leads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .lead-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .lead-card:hover {
            border-color: var(--cyan);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(24, 197, 255, 0.15);
        }

        .lead-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .lead-card-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-light);
            margin: 0;
        }

        .lead-card-company {
            font-size: 12px;
            color: var(--cyan);
            margin-top: 4px;
        }

        .lead-card-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lead-card-status.status-new {
            background: rgba(24, 197, 255, 0.2);
            color: var(--cyan);
        }

        .lead-card-status.status-contacted {
            background: rgba(124, 92, 255, 0.2);
            color: var(--violet);
        }

        .lead-card-status.status-qualified {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .lead-card-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .lead-card-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .lead-card-row i {
            width: 14px;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .lead-card-row a {
            color: var(--text-muted);
            text-decoration: none;
        }

        .lead-card-row a:hover {
            color: var(--cyan);
        }

        .lead-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .lead-card-tag {
            background: rgba(124, 92, 255, 0.15);
            color: var(--violet);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .lead-card-actions {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .lead-card-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .lead-card-btn.btn-whatsapp {
            background: rgba(37, 211, 102, 0.2);
            color: #25d366;
        }

        .lead-card-btn.btn-whatsapp:hover {
            background: rgba(37, 211, 102, 0.3);
        }

        .lead-card-btn.btn-details {
            background: rgba(24, 197, 255, 0.2);
            color: var(--cyan);
        }

        .lead-card-btn.btn-details:hover {
            background: rgba(24, 197, 255, 0.3);
        }

        .leads-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-navy));
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 0 40px rgba(24, 197, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--cyan);
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 32px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .campaign-controls {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .tab-button {
                padding: 12px 20px;
                font-size: 12px;
            }
        }

        /* Alert Messages */
        .alert {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .alert.show {
            display: flex;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        /* BANT Funnel Styles */
        .bant-stage-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
        }

        .bant-stage-need {
            background: rgba(24, 197, 255, 0.2);
            color: var(--cyan);
            border: 1px solid var(--cyan);
        }

        .bant-stage-budget {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .bant-stage-authority {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .bant-stage-timing {
            background: rgba(124, 92, 255, 0.2);
            color: var(--violet);
            border: 1px solid var(--violet);
        }

        .status-badge-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-em-andamento {
            background: rgba(124, 92, 255, 0.15);
            color: var(--violet);
            border: 1px solid rgba(124, 92, 255, 0.4);
        }

        .status-completo {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--violet));
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .bant-table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        .bant-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bant-table th {
            background: rgba(24, 197, 255, 0.08);
            padding: 14px 12px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--cyan);
            border-bottom: 1px solid var(--border);
            font-weight: 700;
        }

        .bant-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 13px;
            color: var(--text-light);
        }

        .bant-table tr:hover {
            background: rgba(24, 197, 255, 0.05);
        }

        .bant-row-tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dashed var(--cyan);
        }

        .bant-row-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 0;
            background: var(--bg-navy);
            border: 1px solid var(--cyan);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(24, 197, 255, 0.3);
            color: var(--text-light);
        }

        .bant-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .bant-mini-stat {
            background: rgba(24, 197, 255, 0.08);
            border: 1px solid rgba(24, 197, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .bant-mini-stat:hover {
            background: rgba(24, 197, 255, 0.12);
            border-color: var(--cyan);
            transform: translateY(-2px);
        }

        .bant-mini-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .bant-mini-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--cyan), var(--violet));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Kanban Board Styles */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .kanban-column {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            min-height: 500px;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ✨ Botão "Ver todos" no header */
        .header-expand-btn {
            background: rgba(24, 197, 255, 0.1);
            border: 1px solid rgba(24, 197, 255, 0.3);
            color: var(--cyan);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .header-expand-btn:hover {
            background: rgba(24, 197, 255, 0.2);
            border-color: var(--cyan);
            transform: scale(1.05);
        }

        .header-expand-btn:active {
            transform: scale(0.98);
        }

        .column-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 400px;
        }

        .lead-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            padding-bottom: 28px; /* Espaço para o indicador de expansão */
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            position: relative;
        }

        .lead-card:active {
            cursor: grabbing;
        }

        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 197, 255, 0.2);
            border-color: var(--cyan);
        }

        .lead-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .card-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-light);
        }

        .card-score {
            background: var(--cyan);
            color: #000;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }

        .card-info {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            background: rgba(255, 255, 255, 0.08);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ===== CARD EXPANSION STYLES ===== */
        .lead-card.expanded {
            background: rgba(24, 197, 255, 0.05);
            border-color: var(--cyan);
        }

        .card-summary {
            position: relative;
        }

        .card-details {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .detail-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            min-width: 80px;
        }

        .detail-value {
            font-size: 12px;
            color: var(--text-light);
            text-align: right;
            word-break: break-word;
        }

        .expand-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
            pointer-events: none;
        }

        .lead-card.expanded .expand-indicator {
            transform: rotate(180deg);
        }

        .column-sdr .column-title { color: #9ca3af; }
        .column-need .column-title { color: var(--cyan); }
        .column-budget .column-title { color: var(--success); }
        .column-authority .column-title { color: var(--warning); }
        .column-timing .column-title { color: var(--violet); }
        .column-scheduler .column-title { color: #ec4899; }
        .column-completed .column-title { color: #10b981; }

        .drag-over {
            background: rgba(24, 197, 255, 0.1);
            border-color: var(--cyan);
        }

        .empty-column {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 13px;
        }


        /* ✨ MODAL: Overlay e Container */
        .leads-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }

        .leads-modal-overlay.active {
            display: flex;
        }

        .leads-modal-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }

        /* Modal Header */
        .leads-modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
        }

        .leads-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .leads-modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .leads-modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Modal Body */
        .leads-modal-body {
            padding: 24px 32px;
            overflow-y: auto;
            flex: 1;
        }

        /* Grid de Cards no Modal */
        .leads-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        /* Card dentro do modal (mesma aparência do Kanban) */
        .leads-modal-card {
            background: var(--glass-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .leads-modal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: var(--cyan);
        }

        /* Animações */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .leads-modal-container {
                width: 95%;
                max-height: 90vh;
            }

            .leads-modal-grid {
                grid-template-columns: 1fr;
            }

            .leads-modal-header {
                padding: 16px 20px;
            }

            .leads-modal-body {
                padding: 16px 20px;
            }
        }

        /* ✨ NOVO: Grupos de serviço (NEED stage) */
        .service-group {
            margin-bottom: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        .service-group-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
            color: var(--cyan);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .service-group[data-service="dre"] .service-group-header {
            color: #10b981;
        }

        .service-group[data-service="fluxo_caixa"] .service-group-header {
            color: #f59e0b;
        }

        .service-group[data-service="estoque"] .service-group-header {
            color: #8b5cf6;
        }

        .service-group[data-service="indicadores"] .service-group-header {
            color: #3b82f6;
        }

        .service-group[data-service="crm"] .service-group-header {
            color: #ec4899;
        }

        .service-group[data-service="receitas"] .service-group-header {
            color: #22c55e;
        }

        .service-group[data-service="clientes"] .service-group-header {
            color: #06b6d4;
        }

        .service-group[data-service="unclassified"] .service-group-header {
            color: #6b7280;
        }

        .service-group-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .service-group:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 1400px) {
            .kanban-board {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Matrix Background Canvas -->
    <canvas id="matrix-canvas"></canvas>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>LEADLY IA</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="status-badge">Sistema Operacional</div>
                <div class="user-menu" style="display: flex; align-items: center; gap: 12px;">
                    <span id="user-name" style="color: var(--text-muted); font-size: 14px;"></span>
                    <button onclick="logout()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard', event)">Dashboard</button>
            <button class="tab-button" onclick="switchTab('command-center', event)">Command Center</button>
            <button class="tab-button" onclick="switchTab('calendario', event)">Calendario</button>
            <button class="tab-button" onclick="switchTab('leads', event)">Leads</button>
            <button class="tab-button" onclick="switchTab('scoring', event)">Scoring</button>
            <button class="tab-button" onclick="switchTab('funil-bant', event)">Funil BANT</button>
            <button class="tab-button" onclick="switchTab('pipeline', event)">Pipeline</button>
            <button class="tab-button" onclick="switchTab('cadencia', event)">Cadencia</button>
            <button class="tab-button" onclick="switchTab('forecasting', event)">Forecast</button>
            <button class="tab-button" onclick="switchTab('clientes', event)">Clientes</button>
            <button class="tab-button" onclick="switchTab('activities', event)">Atividades</button>
            <button class="tab-button" onclick="switchTab('team', event)">Time</button>
            <button class="tab-button" onclick="switchTab('automations', event)">Automacoes</button>
            <button class="tab-button" onclick="switchTab('prospecting', event)">Prospeccao</button>
            <button class="tab-button" onclick="switchTab('ai-insights', event)">AI Insights</button>
            <button class="tab-button" onclick="switchTab('reports', event)">Relatorios</button>
            <button class="tab-button" onclick="switchTab('agentes', event)">Agentes</button>
            <button class="tab-button" onclick="switchTab('integracoes', event)">Integracoes</button>
            <button class="tab-button" onclick="switchTab('conta', event)">Conta</button>
        </div>

        <!-- Alert Messages -->
        <div id="alert-container"></div>

        <!-- TAB 1: Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Mensagens Enviadas</div>
                    <div class="stat-value" id="stat-messages">0</div>
                    <div class="stat-change">Dados do WhatsApp</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Usuários Responderam</div>
                    <div class="stat-value" id="stat-responses">0</div>
                    <div class="stat-change">Taxa de resposta</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taxa de Conversão</div>
                    <div class="stat-value" id="stat-conversion">0%</div>
                    <div class="stat-change">Performance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Leads Ativos</div>
                    <div class="stat-value" id="stat-active">0</div>
                    <div class="stat-change">Em tempo real</div>
                </div>
            </div>

            <!-- Agent Performance Metrics -->
            <div class="campaign-section" style="margin-bottom: 30px;">
                <h2 class="section-title">DESEMPENHO DOS AGENTES</h2>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
                    <!-- SDR Agent -->
                    <div class="stat-card">
                        <div class="stat-label">SDR - Prospecção</div>
                        <div class="stat-value" id="stat-sdr-processed">0</div>
                        <div class="stat-change" id="stat-sdr-rate">Taxa: 0%</div>
                    </div>

                    <!-- Specialist Agent -->
                    <div class="stat-card">
                        <div class="stat-label">Specialist - Qualificação</div>
                        <div class="stat-value" id="stat-specialist-processed">0</div>
                        <div class="stat-change" id="stat-specialist-rate">Taxa: 0%</div>
                    </div>

                    <!-- Scheduler Agent -->
                    <div class="stat-card">
                        <div class="stat-label">Scheduler - Agendamento</div>
                        <div class="stat-value" id="stat-scheduler-processed">0</div>
                        <div class="stat-change" id="stat-scheduler-rate">Taxa: 0%</div>
                    </div>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <!-- SDR Handoffs -->
                    <div class="stat-card" style="background: rgba(24, 197, 255, 0.05);">
                        <div class="stat-label">SDR - Passagens</div>
                        <div class="stat-value" id="stat-sdr-handoffs">0</div>
                        <div class="stat-change" id="stat-sdr-contacts">0 contatos</div>
                    </div>

                    <!-- Specialist Success -->
                    <div class="stat-card" style="background: rgba(124, 92, 255, 0.05);">
                        <div class="stat-label">Specialist - Sucessos</div>
                        <div class="stat-value" id="stat-specialist-success">0</div>
                        <div class="stat-change" id="stat-specialist-contacts">0 contatos</div>
                    </div>

                    <!-- Scheduler Meetings -->
                    <div class="stat-card" style="background: rgba(0, 255, 65, 0.05);">
                        <div class="stat-label">Scheduler - Reuniões</div>
                        <div class="stat-value" id="stat-scheduler-success">0</div>
                        <div class="stat-change" id="stat-scheduler-contacts">0 contatos</div>
                    </div>
                </div>

                <button class="btn btn-secondary btn-small" onclick="refreshAgentMetrics()" style="margin-top: 16px;">
                    Atualizar Métricas dos Agentes
                </button>
            </div>

            <!-- Campaign Controls -->
            <div class="campaign-section">
                <h2 class="section-title">GERENCIADOR DE CAMPANHAS</h2>

                <div class="campaign-controls">
                    <div class="input-group">
                        <label>Quantidade de Leads</label>
                        <input type="number" id="lead-count" placeholder="Ex: 50" min="1" max="1000" value="10">
                    </div>
                    <div class="input-group">
                        <label>Intervalo (segundos)</label>
                        <input type="number" id="interval" placeholder="Ex: 5" min="1" max="300" value="5">
                    </div>
                    <div class="input-group">
                        <label>Tipo de Campanha</label>
                        <select id="campaign-type">
                            <option value="intelligent">Inteligente (BANT)</option>
                            <option value="simple">Simples</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="startCampaign()">
                        Iniciar Campanha
                    </button>
                    <button class="btn btn-secondary" onclick="loadLeadsFromSheet()">
                        Carregar Leads
                    </button>
                    <button class="btn btn-secondary" onclick="refreshStats(true)">
                        Atualizar Métricas
                    </button>
                </div>

                <!-- Loading State -->
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Processando campanha...</p>
                </div>

                <!-- Results Table -->
                <div id="results-container"></div>
            </div>
        </div>

        <!-- TAB 2: Calendário -->
        <div id="tab-calendario" class="tab-content">
            <div class="campaign-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <h2 class="section-title" style="margin: 0;">REUNIÕES AGENDADAS</h2>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="loadEvents()" class="btn btn-secondary btn-small">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                        <button onclick="authorizeGoogle()" class="btn btn-primary btn-small">
                            <i class="fab fa-google"></i> Conectar Google
                        </button>
                    </div>
                </div>

                <div id="eventsLoading" class="loading active">
                    <div class="spinner"></div>
                    Carregando eventos...
                </div>

                <div id="eventsKanban" class="calendar-kanban" style="display: none;">
                    <!-- Hoje -->
                    <div class="calendar-column column-today">
                        <div class="calendar-column-header">
                            <span class="calendar-column-title">HOJE</span>
                            <span class="calendar-column-count" id="count-today">0</span>
                        </div>
                        <div class="calendar-column-cards" id="cards-today"
                             ondrop="handleEventDrop(event, 'today')"
                             ondragover="handleEventDragOver(event)"
                             ondragleave="handleEventDragLeave(event)">
                            <div class="calendar-empty">Nenhuma reunião</div>
                        </div>
                    </div>

                    <!-- Amanhã -->
                    <div class="calendar-column column-tomorrow">
                        <div class="calendar-column-header">
                            <span class="calendar-column-title">AMANHÃ</span>
                            <span class="calendar-column-count" id="count-tomorrow">0</span>
                        </div>
                        <div class="calendar-column-cards" id="cards-tomorrow"
                             ondrop="handleEventDrop(event, 'tomorrow')"
                             ondragover="handleEventDragOver(event)"
                             ondragleave="handleEventDragLeave(event)">
                            <div class="calendar-empty">Nenhuma reunião</div>
                        </div>
                    </div>

                    <!-- Esta Semana -->
                    <div class="calendar-column column-week">
                        <div class="calendar-column-header">
                            <span class="calendar-column-title">ESTA SEMANA</span>
                            <span class="calendar-column-count" id="count-week">0</span>
                        </div>
                        <div class="calendar-column-cards" id="cards-week"
                             ondrop="handleEventDrop(event, 'week')"
                             ondragover="handleEventDragOver(event)"
                             ondragleave="handleEventDragLeave(event)">
                            <div class="calendar-empty">Nenhuma reunião</div>
                        </div>
                    </div>

                    <!-- Próximas -->
                    <div class="calendar-column column-later">
                        <div class="calendar-column-header">
                            <span class="calendar-column-title">PRÓXIMAS</span>
                            <span class="calendar-column-count" id="count-later">0</span>
                        </div>
                        <div class="calendar-column-cards" id="cards-later"
                             ondrop="handleEventDrop(event, 'later')"
                             ondragover="handleEventDragOver(event)"
                             ondragleave="handleEventDragLeave(event)">
                            <div class="calendar-empty">Nenhuma reunião</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Evento -->
        <div id="editEventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Editar Evento</h2>
                    <button class="close-modal" onclick="closeEditEventModal()">&times;</button>
                </div>
                <form id="editEventForm" class="edit-event-form" onsubmit="saveEventChanges(event)">
                    <input type="hidden" id="editEventId">
                    <div class="input-group">
                        <label>Título</label>
                        <input type="text" id="editEventTitle" required>
                    </div>
                    <div class="input-group">
                        <label>Descrição</label>
                        <textarea id="editEventDescription" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Data e Hora de Início</label>
                        <input type="datetime-local" id="editEventStart" required>
                    </div>
                    <div class="input-group">
                        <label>Data e Hora de Término</label>
                        <input type="datetime-local" id="editEventEnd" required>
                    </div>
                    <div class="input-group">
                        <label>Local/Link</label>
                        <input type="text" id="editEventLocation">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditEventModal()" style="flex: 1;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB 3: Leads -->
        <div id="tab-leads" class="tab-content">
            <div class="campaign-section">
                <h2 class="section-title">GERENCIADOR DE LEADS</h2>
                <button onclick="loadAllLeads()" class="btn btn-secondary btn-small" style="margin-bottom: 20px;">
                    Atualizar Lista
                </button>
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="leadSearch" placeholder="Filtrar por nome, telefone ou empresa..."
                           style="flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-light); font-family: 'Inter', sans-serif;">
                    <button onclick="filterLeads()" class="btn btn-primary">🔍 Filtrar</button>
                </div>
                <div id="leadsResult">
                    <div class="loading active">
                        <div class="spinner"></div>
                        Carregando leads da planilha...
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: FUNIL BANT -->
        <div id="tab-funil-bant" class="tab-content">
            <!-- Controls and Statistics -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; flex: 1;">
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Total</div>
                            <div class="stat-value" style="font-size: 24px;" id="total-leads-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">SDR</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-sdr-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Need</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-need-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Budget</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-budget-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Authority</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-authority-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Timing</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-timing-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Scheduler</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-scheduler-kanban">0</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-label" style="font-size: 10px;">Completo</div>
                            <div class="stat-value" style="font-size: 24px;" id="count-completed-kanban">0</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="loadKanbanLeads()"> Atualizar</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="kanban-loading" class="loading">
                <div class="spinner"></div>
                <p>Carregando leads...</p>
            </div>

            <!-- Kanban Board -->
            <div id="kanban-board" class="kanban-board" style="display: none;">
                <!-- SDR Column -->
                <div class="kanban-column column-sdr" data-stage="sdr">
                    <div class="column-header">
                        <div class="column-title"> SDR</div>
                        <div class="column-count" id="sdr-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-sdr" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>

                <!-- NEED Column -->
                <div class="kanban-column column-need" data-stage="need">
                    <div class="column-header">
                        <div class="column-title">🔍 NEED</div>
                        <div class="column-count" id="need-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-need" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>

                <!-- BUDGET Column -->
                <div class="kanban-column column-budget" data-stage="budget">
                    <div class="column-header">
                        <div class="column-title"> BUDGET</div>
                        <div class="column-count" id="budget-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-budget" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>

                <!-- AUTHORITY Column -->
                <div class="kanban-column column-authority" data-stage="authority">
                    <div class="column-header">
                        <div class="column-title">👤 AUTHORITY</div>
                        <div class="column-count" id="authority-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-authority" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>

                <!-- TIMING Column -->
                <div class="kanban-column column-timing" data-stage="timing">
                    <div class="column-header">
                        <div class="column-title">⏰ TIMING</div>
                        <div class="column-count" id="timing-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-timing" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>

                <!-- SCHEDULER Column -->
                <div class="kanban-column column-scheduler" data-stage="scheduler">
                    <div class="column-header">
                        <div class="column-title">📅 SCHEDULER</div>
                        <div class="column-count" id="scheduler-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-scheduler" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>

                <!-- COMPLETED Column -->
                <div class="kanban-column column-completed" data-stage="completed">
                    <div class="column-header">
                        <div class="column-title"> COMPLETO</div>
                        <div class="column-count" id="completed-count">0</div>
                    </div>
                    <div class="column-cards" id="cards-completed" ondrop="dropKanban(event)" ondragover="allowDropKanban(event)" ondragleave="dragLeaveKanban(event)">
                        <div class="empty-column">Nenhum lead neste estágio</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 5: Pipeline (CRM) -->
        <div id="tab-pipeline" class="tab-content">
            <div id="content-area"></div>
        </div>

        <!-- TAB: Cadência Outbound 15 Dias -->
        <div id="tab-cadencia" class="tab-content">
            <!-- Cadence Stats -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Em Cadência</div>
                    <div class="stat-value" id="stat-cadence-active">0</div>
                    <div class="stat-change">Leads ativos no fluxo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taxa de Resposta</div>
                    <div class="stat-value" id="stat-cadence-response-rate">0%</div>
                    <div class="stat-change">Respostas / Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dia Médio Resposta</div>
                    <div class="stat-value" id="stat-cadence-avg-day">D0</div>
                    <div class="stat-change">Quando respondem</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Conversões</div>
                    <div class="stat-value" id="stat-cadence-conversions">0</div>
                    <div class="stat-change">Triagens agendadas</div>
                </div>
            </div>

            <!-- Pipeline Kanban View -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">PIPELINE OUTBOUND - 10 ESTÁGIOS</h2>
                <div id="cadence-pipeline-view" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px;">
                    <!-- Stages will be loaded dynamically -->
                    <div style="color: var(--text-muted); padding: 20px;">Carregando pipeline...</div>
                </div>
            </div>

            <!-- Cadence Day Distribution -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">DISTRIBUIÇÃO POR DIA DA CADÊNCIA</h2>
                <div id="cadence-day-chart" style="display: flex; gap: 8px; align-items: flex-end; height: 200px; padding: 20px;">
                    <!-- Day bars will be loaded dynamically -->
                </div>
            </div>

            <!-- Active Enrollments Table -->
            <div class="campaign-section">
                <h2 class="section-title">LEADS EM CADÊNCIA ATIVA</h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 12px; color: var(--primary);">Lead</th>
                                <th style="text-align: left; padding: 12px; color: var(--primary);">Empresa</th>
                                <th style="text-align: center; padding: 12px; color: var(--primary);">Dia</th>
                                <th style="text-align: center; padding: 12px; color: var(--primary);">Msgs</th>
                                <th style="text-align: left; padding: 12px; color: var(--primary);">Próxima Ação</th>
                                <th style="text-align: center; padding: 12px; color: var(--primary);">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="cadence-enrollments-table">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    Carregando leads em cadência...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Response Type Distribution -->
            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">TIPOS DE RESPOSTA</h2>
                <div id="response-type-chart" style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-label" style="color: #22c55e;">Hand Raiser</div>
                        <div class="stat-value" id="stat-response-handraise">0</div>
                        <div class="stat-change">Interessados diretos</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-label" style="color: #3b82f6;">Curioso</div>
                        <div class="stat-value" id="stat-response-curioso">0</div>
                        <div class="stat-change">Quer saber mais</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-label" style="color: #f59e0b;">Cético</div>
                        <div class="stat-value" id="stat-response-cetico">0</div>
                        <div class="stat-change">Precisa convencer</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-label" style="color: #ef4444;">Objeção</div>
                        <div class="stat-value" id="stat-response-objecao">0</div>
                        <div class="stat-change">Resistência</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 6: Clientes -->
        <div id="tab-clientes" class="tab-content">
            <div id="content-area-clientes"></div>
        </div>

        <!-- TAB 7: Automações -->
        <div id="tab-automations" class="tab-content">
            <!-- Engine Stats -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Automações Ativas</div>
                    <div class="stat-value" id="stat-automations-active">0</div>
                    <div class="stat-change">Configuradas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Execuções Hoje</div>
                    <div class="stat-value" id="stat-executions-today">0</div>
                    <div class="stat-change">Total processado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taxa de Sucesso</div>
                    <div class="stat-value" id="stat-automations-success">100%</div>
                    <div class="stat-change">Performance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Última Execução</div>
                    <div class="stat-value" id="stat-last-execution" style="font-size: 18px;">-</div>
                    <div class="stat-change">Timestamp</div>
                </div>
            </div>

            <!-- Quick Win Templates -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">TEMPLATES RÁPIDOS</h2>
                <p style="color: var(--text-muted); margin-bottom: 16px;">Instale automações pré-configuradas com um clique</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <!-- Lead Frio -->
                    <div class="stat-card" style="cursor: pointer;" onclick="installTemplate('lead_frio')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--cyan);">Lead Frio - 48h</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Follow-up automático para leads sem interação há 48h</p>
                            </div>
                            <i class="fas fa-snowflake" style="color: var(--cyan); font-size: 24px;"></i>
                        </div>
                        <button class="btn btn-small btn-primary" style="margin-top: 12px;">Instalar</button>
                    </div>

                    <!-- BANT Timeout -->
                    <div class="stat-card" style="cursor: pointer;" onclick="installTemplate('bant_timeout')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--warning);">BANT Timeout - 24h</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Notifica quando lead fica parado no funil</p>
                            </div>
                            <i class="fas fa-clock" style="color: var(--warning); font-size: 24px;"></i>
                        </div>
                        <button class="btn btn-small btn-primary" style="margin-top: 12px;">Instalar</button>
                    </div>

                    <!-- Meeting No-Show -->
                    <div class="stat-card" style="cursor: pointer;" onclick="installTemplate('meeting_no_show')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--danger);">Meeting No-Show</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Reage quando reunião não é realizada</p>
                            </div>
                            <i class="fas fa-calendar-times" style="color: var(--danger); font-size: 24px;"></i>
                        </div>
                        <button class="btn btn-small btn-primary" style="margin-top: 12px;">Instalar</button>
                    </div>

                    <!-- High Score Alert -->
                    <div class="stat-card" style="cursor: pointer;" onclick="installTemplate('high_score_alert')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--success);">High Score Alert</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Alerta quando lead atinge score 80+</p>
                            </div>
                            <i class="fas fa-fire" style="color: var(--success); font-size: 24px;"></i>
                        </div>
                        <button class="btn btn-small btn-primary" style="margin-top: 12px;">Instalar</button>
                    </div>
                </div>
            </div>

            <!-- Active Automations -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">AUTOMAÇÕES CONFIGURADAS</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button class="btn btn-secondary btn-small" onclick="loadAutomations()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                    <button class="btn btn-primary btn-small" onclick="initializeEngine()">
                        <i class="fas fa-play"></i> Iniciar Engine
                    </button>
                </div>
                <div id="automations-list" style="display: grid; gap: 12px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                        Nenhuma automação configurada. Instale um template acima para começar.
                    </p>
                </div>
            </div>

            <!-- Execution History -->
            <div class="campaign-section">
                <h2 class="section-title">HISTÓRICO DE EXECUÇÕES</h2>
                <div id="executions-list" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                        Nenhuma execução registrada ainda.
                    </p>
                </div>
            </div>
        </div>

        <!-- TAB: Prospecting Automation Monitor -->
        <div id="tab-prospecting" class="tab-content">
            <!-- Status Header -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card" id="prospecting-status-card">
                    <div class="stat-label">Status do Motor</div>
                    <div class="stat-value" id="prosp-status">
                        <span class="status-badge" style="background: var(--text-muted);">PARADO</span>
                    </div>
                    <div class="stat-change" id="prosp-next-send">Aguardando...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Enviados Hoje</div>
                    <div class="stat-value" id="prosp-sent-today">0</div>
                    <div class="stat-change">de <span id="prosp-limit">100</span> max/dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Na Fila</div>
                    <div class="stat-value" id="prosp-queue">0</div>
                    <div class="stat-change">leads pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taxa de Sucesso</div>
                    <div class="stat-value" id="prosp-success-rate">100%</div>
                    <div class="stat-change"><span id="prosp-failed">0</span> falhas</div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">CONTROLE DO MOTOR DE PROSPECCAO</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-small" id="btn-prosp-start" onclick="prospectingControl('start')">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                    <button class="btn btn-warning btn-small" id="btn-prosp-pause" onclick="prospectingControl('pause')" disabled>
                        <i class="fas fa-pause"></i> Pausar
                    </button>
                    <button class="btn btn-primary btn-small" id="btn-prosp-resume" onclick="prospectingControl('resume')" disabled>
                        <i class="fas fa-forward"></i> Retomar
                    </button>
                    <button class="btn btn-danger btn-small" id="btn-prosp-stop" onclick="prospectingControl('stop')" disabled>
                        <i class="fas fa-stop"></i> Parar
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="prospectingControl('test')">
                        <i class="fas fa-vial"></i> Modo Teste
                    </button>
                    <button class="btn btn-outline btn-small" onclick="loadProspectingStatus()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>

                <!-- Config Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-label" style="color: var(--cyan);">Intervalo Entre Envios</div>
                        <div class="stat-value" style="font-size: 24px;"><span id="prosp-interval">5</span> min</div>
                        <input type="range" min="1" max="30" value="5" id="prosp-interval-slider"
                               onchange="updateProspConfig('intervalMinutes', this.value)"
                               style="width: 100%; margin-top: 10px; accent-color: var(--cyan);">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color: var(--success);">Horario de Trabalho</div>
                        <div class="stat-value" style="font-size: 18px;"><span id="prosp-work-hours">08:00 - 18:00</span></div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Seg-Sex apenas</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color: var(--warning);">Limite Diario</div>
                        <div class="stat-value" style="font-size: 24px;"><span id="prosp-max-day">100</span></div>
                        <input type="range" min="10" max="200" value="100" id="prosp-max-slider"
                               onchange="updateProspConfig('maxPerDay', this.value)"
                               style="width: 100%; margin-top: 10px; accent-color: var(--warning);">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color: var(--violet);">Cooldown</div>
                        <div class="stat-value" style="font-size: 24px;"><span id="prosp-cooldown">24</span>h</div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Antes de re-contatar</p>
                    </div>
                </div>
            </div>

            <!-- Live Activity Feed -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">ATIVIDADE EM TEMPO REAL</h2>
                <div id="prosp-activity-feed" style="max-height: 300px; overflow-y: auto; background: var(--card-bg); border-radius: 8px; padding: 16px;">
                    <p style="color: var(--text-muted); text-align: center;">Motor parado. Inicie para ver atividade.</p>
                </div>
            </div>

            <!-- Session Metrics -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">METRICAS DA SESSAO</h2>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="stat-card" style="border-left: 4px solid var(--success);">
                        <div class="stat-label">Total Processado</div>
                        <div class="stat-value" id="prosp-total-processed">0</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--primary);">
                        <div class="stat-label">Enviados</div>
                        <div class="stat-value" id="prosp-total-sent">0</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--danger);">
                        <div class="stat-label">Falharam</div>
                        <div class="stat-value" id="prosp-total-failed">0</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--warning);">
                        <div class="stat-label">Ignorados</div>
                        <div class="stat-value" id="prosp-total-skipped">0</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--violet);">
                        <div class="stat-label">Inicio Sessao</div>
                        <div class="stat-value" id="prosp-session-start" style="font-size: 14px;">-</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--cyan);">
                        <div class="stat-label">Ultimo Envio</div>
                        <div class="stat-value" id="prosp-last-sent" style="font-size: 14px;">-</div>
                    </div>
                </div>
            </div>

            <!-- Skip Reasons -->
            <div class="campaign-section" style="margin-bottom: 20px;">
                <h2 class="section-title">MOTIVOS DE SKIP</h2>
                <div id="prosp-skip-reasons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                    <div class="stat-card" style="text-align: center; padding: 12px;">
                        <i class="fas fa-phone-slash" style="color: var(--danger); font-size: 20px;"></i>
                        <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="skip-invalid-phone">0</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Tel. Invalido</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 12px;">
                        <i class="fas fa-redo" style="color: var(--warning); font-size: 20px;"></i>
                        <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="skip-already-prospected">0</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Ja Prospectado</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 12px;">
                        <i class="fas fa-ban" style="color: var(--danger); font-size: 20px;"></i>
                        <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="skip-opt-out">0</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Opt-Out</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 12px;">
                        <i class="fas fa-clock" style="color: var(--primary); font-size: 20px;"></i>
                        <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="skip-recently-contacted">0</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Em Cooldown</div>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="campaign-section">
                <h2 class="section-title">HISTORICO DE PROSPECCAO</h2>
                <div id="prosp-history" style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--card-bg); color: var(--text-muted); font-size: 12px;">
                                <th style="padding: 12px; text-align: left;">Data/Hora</th>
                                <th style="padding: 12px; text-align: left;">Empresa</th>
                                <th style="padding: 12px; text-align: left;">Telefone</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="prosp-history-body">
                            <tr>
                                <td colspan="4" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                    Nenhum registro de prospeccao ainda.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Command Center -->
        <div id="tab-command-center" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Leads Quentes</div>
                    <div class="stat-value" id="cc-hot-leads">0</div>
                    <div class="stat-change"><i class="fas fa-fire"></i> Score 80+</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tarefas Pendentes</div>
                    <div class="stat-value" id="cc-pending-tasks">0</div>
                    <div class="stat-change"><i class="fas fa-clock"></i> Para hoje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Reunioes Hoje</div>
                    <div class="stat-value" id="cc-meetings-today">0</div>
                    <div class="stat-change"><i class="fas fa-calendar-check"></i> Agendadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pipeline Total</div>
                    <div class="stat-value" id="cc-pipeline-value">R$ 0</div>
                    <div class="stat-change"><i class="fas fa-chart-line"></i> Em aberto</div>
                </div>
            </div>

            <!-- Cadence KPIs -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card" style="border-left: 4px solid var(--primary);">
                    <div class="stat-label">Em Cadencia</div>
                    <div class="stat-value" id="cc-cadence-active">0</div>
                    <div class="stat-change"><i class="fas fa-broadcast-tower"></i> Fluxo ativo</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--success);">
                    <div class="stat-label">Responderam</div>
                    <div class="stat-value" id="cc-cadence-responded">0</div>
                    <div class="stat-change"><i class="fas fa-reply"></i> Esta semana</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--violet);">
                    <div class="stat-label">Taxa Resposta</div>
                    <div class="stat-value" id="cc-cadence-rate">0%</div>
                    <div class="stat-change"><i class="fas fa-percentage"></i> Media geral</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--warning);">
                    <div class="stat-label">Acoes Pendentes</div>
                    <div class="stat-value" id="cc-cadence-pending">0</div>
                    <div class="stat-change"><i class="fas fa-tasks"></i> Para hoje</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <!-- Activity Feed -->
                <div class="campaign-section">
                    <h2 class="section-title">FEED DE ATIVIDADES</h2>
                    <div id="cc-activity-feed" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando atividades...</p>
                    </div>
                </div>

                <!-- Hot Leads -->
                <div class="campaign-section">
                    <h2 class="section-title">LEADS QUENTES</h2>
                    <div id="cc-hot-leads-list" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando leads...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Lead Scoring -->
        <div id="tab-scoring" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card" style="border-left: 4px solid #10b981;">
                    <div class="stat-label">Grade A (90-100)</div>
                    <div class="stat-value" id="score-grade-a">0</div>
                    <div class="stat-change" style="color: var(--success);">Leads premium</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--cyan);">
                    <div class="stat-label">Grade B (70-89)</div>
                    <div class="stat-value" id="score-grade-b">0</div>
                    <div class="stat-change" style="color: var(--cyan);">Alto potencial</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--warning);">
                    <div class="stat-label">Grade C (50-69)</div>
                    <div class="stat-value" id="score-grade-c">0</div>
                    <div class="stat-change" style="color: var(--warning);">Medio potencial</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <div class="stat-label">Grade D/F (0-49)</div>
                    <div class="stat-value" id="score-grade-df">0</div>
                    <div class="stat-change" style="color: var(--danger);">Baixo potencial</div>
                </div>
            </div>

            <div class="campaign-section">
                <h2 class="section-title">REGRAS DE SCORING</h2>
                <p style="color: var(--text-muted); margin-bottom: 16px;">Configure como os leads sao pontuados automaticamente</p>
                <div id="scoring-rules-list" style="display: grid; gap: 12px;">
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">BANT Completo</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Lead completou qualificacao BANT</p>
                        </div>
                        <span style="color: var(--success); font-weight: bold;">+30 pts</span>
                    </div>
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">Reuniao Agendada</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Lead agendou demonstracao</p>
                        </div>
                        <span style="color: var(--success); font-weight: bold;">+25 pts</span>
                    </div>
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">Engajamento Alto</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Mais de 5 interacoes</p>
                        </div>
                        <span style="color: var(--cyan); font-weight: bold;">+15 pts</span>
                    </div>
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">Tempo de Resposta</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Responde em menos de 1h</p>
                        </div>
                        <span style="color: var(--cyan); font-weight: bold;">+10 pts</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Forecasting -->
        <div id="tab-forecasting" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Forecast Commit</div>
                    <div class="stat-value" id="forecast-commit">R$ 0</div>
                    <div class="stat-change" style="color: var(--success);">Altamente provavel</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Forecast Best Case</div>
                    <div class="stat-value" id="forecast-best">R$ 0</div>
                    <div class="stat-change" style="color: var(--cyan);">Cenario otimista</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Forecast Pipeline</div>
                    <div class="stat-value" id="forecast-pipeline">R$ 0</div>
                    <div class="stat-change" style="color: var(--warning);">Total em aberto</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="forecast-winrate">0%</div>
                    <div class="stat-change"><i class="fas fa-trophy"></i> Taxa de conversao</div>
                </div>
            </div>

            <div class="campaign-section">
                <h2 class="section-title">VELOCIDADE DE VENDAS</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div class="stat-card">
                        <div class="stat-label">Ciclo Medio</div>
                        <div class="stat-value" style="font-size: 28px;" id="forecast-cycle">0 dias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ticket Medio</div>
                        <div class="stat-value" style="font-size: 28px;" id="forecast-ticket">R$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Deals/Mes</div>
                        <div class="stat-value" style="font-size: 28px;" id="forecast-deals">0</div>
                    </div>
                </div>
            </div>

            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">GRAFICO DE PROJECAO</h2>
                <div id="forecast-chart" style="min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                    <p>Grafico de projecao de vendas</p>
                </div>
            </div>
        </div>

        <!-- TAB: Activities -->
        <div id="tab-activities" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <div class="stat-label">Atrasadas</div>
                    <div class="stat-value" id="act-overdue">0</div>
                    <div class="stat-change" style="color: var(--danger);">Precisam atencao</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--warning);">
                    <div class="stat-label">Para Hoje</div>
                    <div class="stat-value" id="act-today">0</div>
                    <div class="stat-change" style="color: var(--warning);">Pendentes</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--cyan);">
                    <div class="stat-label">Esta Semana</div>
                    <div class="stat-value" id="act-week">0</div>
                    <div class="stat-change" style="color: var(--cyan);">Programadas</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--success);">
                    <div class="stat-label">Concluidas (30d)</div>
                    <div class="stat-value" id="act-completed">0</div>
                    <div class="stat-change" style="color: var(--success);">Finalizadas</div>
                </div>
            </div>

            <div class="campaign-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;">LISTA DE ATIVIDADES</h2>
                    <button class="btn btn-primary btn-small" onclick="showNewActivityModal()">
                        <i class="fas fa-plus"></i> Nova Atividade
                    </button>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="btn btn-secondary btn-small activity-filter active" data-filter="all">Todas</button>
                    <button class="btn btn-secondary btn-small activity-filter" data-filter="overdue">Atrasadas</button>
                    <button class="btn btn-secondary btn-small activity-filter" data-filter="today">Hoje</button>
                    <button class="btn btn-secondary btn-small activity-filter" data-filter="upcoming">Proximas</button>
                </div>
                <div id="activities-list" style="display: grid; gap: 12px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando atividades...</p>
                </div>
            </div>
        </div>

        <!-- TAB: Team -->
        <div id="tab-team" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Total de Usuarios</div>
                    <div class="stat-value" id="team-total">0</div>
                    <div class="stat-change"><i class="fas fa-users"></i> Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Times</div>
                    <div class="stat-value" id="team-groups">0</div>
                    <div class="stat-change"><i class="fas fa-user-friends"></i> Configurados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Online Agora</div>
                    <div class="stat-value" id="team-online">0</div>
                    <div class="stat-change" style="color: var(--success);"><i class="fas fa-circle"></i> Conectados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Melhor Vendedor</div>
                    <div class="stat-value" id="team-top" style="font-size: 18px;">-</div>
                    <div class="stat-change"><i class="fas fa-trophy" style="color: gold;"></i> Este mes</div>
                </div>
            </div>

            <div class="campaign-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;">MEMBROS DO TIME</h2>
                    <button class="btn btn-primary btn-small" onclick="showNewUserModal()">
                        <i class="fas fa-user-plus"></i> Novo Usuario
                    </button>
                </div>
                <div id="team-members-list" style="display: grid; gap: 12px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando time...</p>
                </div>
            </div>

            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">LEADERBOARD</h2>
                <div id="team-leaderboard" style="display: grid; gap: 8px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando ranking...</p>
                </div>
            </div>
        </div>

        <!-- TAB: AI Insights -->
        <div id="tab-ai-insights" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Sentimento Medio</div>
                    <div class="stat-value" id="ai-sentiment">-</div>
                    <div class="stat-change"><i class="fas fa-smile"></i> Das conversas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Objecoes Detectadas</div>
                    <div class="stat-value" id="ai-objections">0</div>
                    <div class="stat-change"><i class="fas fa-exclamation-triangle"></i> Esta semana</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taxa de Resolucao</div>
                    <div class="stat-value" id="ai-resolution">0%</div>
                    <div class="stat-change"><i class="fas fa-check-circle"></i> De objecoes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Insights Gerados</div>
                    <div class="stat-value" id="ai-insights-count">0</div>
                    <div class="stat-change"><i class="fas fa-lightbulb"></i> Recomendacoes</div>
                </div>
            </div>

            <div class="campaign-section">
                <h2 class="section-title">ANALISE DE SENTIMENTO</h2>
                <div id="ai-sentiment-chart" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; width: 100%;">
                        <div class="stat-card" style="text-align: center; background: rgba(16, 185, 129, 0.1);">
                            <i class="fas fa-smile" style="font-size: 32px; color: var(--success); margin-bottom: 8px;"></i>
                            <div class="stat-value" id="ai-positive">0%</div>
                            <div class="stat-label">Positivo</div>
                        </div>
                        <div class="stat-card" style="text-align: center; background: rgba(245, 158, 11, 0.1);">
                            <i class="fas fa-meh" style="font-size: 32px; color: var(--warning); margin-bottom: 8px;"></i>
                            <div class="stat-value" id="ai-neutral">0%</div>
                            <div class="stat-label">Neutro</div>
                        </div>
                        <div class="stat-card" style="text-align: center; background: rgba(239, 68, 68, 0.1);">
                            <i class="fas fa-frown" style="font-size: 32px; color: var(--danger); margin-bottom: 8px;"></i>
                            <div class="stat-value" id="ai-negative">0%</div>
                            <div class="stat-label">Negativo</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">PRINCIPAIS OBJECOES</h2>
                <div id="ai-objections-list" style="display: grid; gap: 12px;">
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">Preco muito alto</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Mencoes sobre valor do produto</p>
                        </div>
                        <span style="color: var(--danger); font-weight: bold;">32 vezes</span>
                    </div>
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">Preciso pensar</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Leads indecisos</p>
                        </div>
                        <span style="color: var(--warning); font-weight: bold;">28 vezes</span>
                    </div>
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-light);">Ja uso outro</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Concorrencia ativa</p>
                        </div>
                        <span style="color: var(--cyan); font-weight: bold;">15 vezes</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Reports -->
        <div id="tab-reports" class="tab-content">
            <div class="campaign-section">
                <h2 class="section-title">GERADOR DE RELATORIOS</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Selecione o tipo de relatorio e o periodo desejado</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label>Tipo de Relatorio</label>
                        <select id="report-type">
                            <option value="pipeline">Pipeline de Vendas</option>
                            <option value="conversion">Taxa de Conversao</option>
                            <option value="activity">Atividades</option>
                            <option value="performance">Performance da Equipe</option>
                            <option value="leads">Leads por Origem</option>
                            <option value="forecast">Forecast</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Data Inicial</label>
                        <input type="date" id="report-start">
                    </div>
                    <div class="input-group">
                        <label>Data Final</label>
                        <input type="date" id="report-end">
                    </div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> Gerar Relatorio
                    </button>
                    <button class="btn btn-secondary" onclick="exportReport('csv')">
                        <i class="fas fa-download"></i> Exportar CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportReport('json')">
                        <i class="fas fa-code"></i> Exportar JSON
                    </button>
                </div>
            </div>

            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">RELATORIOS RAPIDOS</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <div class="stat-card" style="cursor: pointer;" onclick="generateQuickReport('daily')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--cyan);">Relatorio Diario</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Resumo das atividades de hoje</p>
                            </div>
                            <i class="fas fa-calendar-day" style="color: var(--cyan); font-size: 24px;"></i>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="generateQuickReport('weekly')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--violet);">Relatorio Semanal</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Performance dos ultimos 7 dias</p>
                            </div>
                            <i class="fas fa-calendar-week" style="color: var(--violet); font-size: 24px;"></i>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="generateQuickReport('monthly')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="stat-label" style="color: var(--success);">Relatorio Mensal</div>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 8px 0;">Analise completa do mes</p>
                            </div>
                            <i class="fas fa-calendar-alt" style="color: var(--success); font-size: 24px;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">RESULTADO</h2>
                <div id="report-result" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                    <p style="color: var(--text-muted);">Selecione um tipo de relatorio para visualizar</p>
                </div>
            </div>
        </div>

        <!-- TAB: Agentes -->
        <div id="tab-agentes" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Total de Agentes</div>
                    <div class="stat-value" id="agents-total">0</div>
                    <div class="stat-change"><i class="fas fa-robot"></i> Configurados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Agentes Ativos</div>
                    <div class="stat-value" id="agents-active">0</div>
                    <div class="stat-change" style="color: var(--success);"><i class="fas fa-check-circle"></i> Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Conversas Hoje</div>
                    <div class="stat-value" id="agents-conversations">0</div>
                    <div class="stat-change"><i class="fas fa-comments"></i> Processadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taxa de Qualificacao</div>
                    <div class="stat-value" id="agents-qualification">0%</div>
                    <div class="stat-change"><i class="fas fa-chart-line"></i> Media</div>
                </div>
            </div>

            <div class="campaign-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;">MEUS AGENTES</h2>
                    <button class="btn btn-primary btn-small" onclick="showNewAgentModal()">
                        <i class="fas fa-plus"></i> Novo Agente
                    </button>
                </div>

                <div id="agents-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando agentes...</p>
                </div>
            </div>

            <!-- Templates Section -->
            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">TEMPLATES DISPONIVEIS</h2>
                <p style="color: var(--text-muted); margin-bottom: 16px;">Comece rapidamente com um template pre-configurado</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <div class="stat-card agent-template-card" style="cursor: pointer;" onclick="createAgentFromTemplate('sdr')">
                        <div style="display: flex; gap: 16px; align-items: start;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--cyan), var(--violet)); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user-tie" style="font-size: 24px; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="color: var(--text-light); margin-bottom: 4px;">SDR Agent</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Agente de qualificacao com SPIN Selling e BANT tracking</p>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="font-size: 10px; background: rgba(24, 197, 255, 0.2); color: var(--cyan); padding: 2px 8px; border-radius: 4px;">SPIN</span>
                                    <span style="font-size: 10px; background: rgba(124, 92, 255, 0.2); color: var(--violet); padding: 2px 8px; border-radius: 4px;">BANT</span>
                                    <span style="font-size: 10px; background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 2px 8px; border-radius: 4px;">Objecoes</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card agent-template-card" style="cursor: pointer;" onclick="createAgentFromTemplate('specialist')">
                        <div style="display: flex; gap: 16px; align-items: start;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--violet), #ff6b6b); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-brain" style="font-size: 24px; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="color: var(--text-light); margin-bottom: 4px;">Specialist Agent</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Consultor tecnico para duvidas complexas do produto</p>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="font-size: 10px; background: rgba(124, 92, 255, 0.2); color: var(--violet); padding: 2px 8px; border-radius: 4px;">RAG</span>
                                    <span style="font-size: 10px; background: rgba(245, 158, 11, 0.2); color: var(--warning); padding: 2px 8px; border-radius: 4px;">FAQ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card agent-template-card" style="cursor: pointer;" onclick="createAgentFromTemplate('scheduler')">
                        <div style="display: flex; gap: 16px; align-items: start;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--success), var(--cyan)); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-calendar-check" style="font-size: 24px; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="color: var(--text-light); margin-bottom: 4px;">Scheduler Agent</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Agendamento inteligente de reunioes e calls</p>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="font-size: 10px; background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 2px 8px; border-radius: 4px;">Calendar</span>
                                    <span style="font-size: 10px; background: rgba(24, 197, 255, 0.2); color: var(--cyan); padding: 2px 8px; border-radius: 4px;">Slots</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card agent-template-card" style="cursor: pointer;" onclick="createAgentFromTemplate('support')">
                        <div style="display: flex; gap: 16px; align-items: start;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--warning), var(--danger)); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-headset" style="font-size: 24px; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="color: var(--text-light); margin-bottom: 4px;">Support Agent</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Suporte ao cliente com base de conhecimento</p>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="font-size: 10px; background: rgba(245, 158, 11, 0.2); color: var(--warning); padding: 2px 8px; border-radius: 4px;">Tickets</span>
                                    <span style="font-size: 10px; background: rgba(239, 68, 68, 0.2); color: var(--danger); padding: 2px 8px; border-radius: 4px;">Escalation</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setores Section -->
            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title">SETORES DE NEGOCIO</h2>
                <p style="color: var(--text-muted); margin-bottom: 16px;">Configuracoes pre-definidas por industria</p>

                <div id="sectors-list" style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="energia_solar" onclick="showSectorDefaults('energia_solar')">
                        <i class="fas fa-sun"></i> Energia Solar
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="saas" onclick="showSectorDefaults('saas')">
                        <i class="fas fa-cloud"></i> SaaS
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="consultoria" onclick="showSectorDefaults('consultoria')">
                        <i class="fas fa-briefcase"></i> Consultoria
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="ecommerce" onclick="showSectorDefaults('ecommerce')">
                        <i class="fas fa-shopping-cart"></i> E-commerce
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="varejo" onclick="showSectorDefaults('varejo')">
                        <i class="fas fa-store"></i> Varejo
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="educacao" onclick="showSectorDefaults('educacao')">
                        <i class="fas fa-graduation-cap"></i> Educacao
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="imobiliario" onclick="showSectorDefaults('imobiliario')">
                        <i class="fas fa-home"></i> Imobiliario
                    </button>
                    <button class="btn btn-secondary btn-small sector-btn" data-sector="financeiro" onclick="showSectorDefaults('financeiro')">
                        <i class="fas fa-dollar-sign"></i> Financeiro
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: Integracoes -->
        <div id="tab-integracoes" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Canais Conectados</div>
                    <div class="stat-value" id="integrations-channels">0</div>
                    <div class="stat-change"><i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CRMs Integrados</div>
                    <div class="stat-value" id="integrations-crms">0</div>
                    <div class="stat-change"><i class="fas fa-plug"></i> Sincronizados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Webhooks Ativos</div>
                    <div class="stat-value" id="integrations-webhooks">0</div>
                    <div class="stat-change"><i class="fas fa-bolt"></i> Recebendo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Leads Sincronizados</div>
                    <div class="stat-value" id="integrations-synced">0</div>
                    <div class="stat-change"><i class="fas fa-sync"></i> Ultima hora</div>
                </div>
            </div>

            <!-- WhatsApp Channels Section -->
            <div class="campaign-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;"><i class="fab fa-whatsapp" style="color: #25D366;"></i> CANAIS WHATSAPP</h2>
                </div>

                <div id="whatsapp-channels-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Carregando canais...</p>
                </div>

                <div style="margin-top: 16px; padding: 16px; background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 12px;">
                    <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 12px;">
                        <i class="fas fa-info-circle"></i> Para conectar um novo canal, va ate a tab <strong>Agentes</strong>, selecione um agente e clique em "Conectar WhatsApp".
                    </p>
                </div>
            </div>

            <!-- CRM Integrations Section -->
            <div class="campaign-section" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;"><i class="fas fa-plug"></i> INTEGRACOES CRM</h2>
                    <button class="btn btn-primary btn-small" onclick="showConnectCRMModal()">
                        <i class="fas fa-plus"></i> Conectar CRM
                    </button>
                </div>

                <div id="crm-integrations-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhum CRM conectado ainda</p>
                </div>

                <!-- CRM Providers Available -->
                <div style="margin-top: 20px;">
                    <h3 style="color: var(--text-muted); font-size: 14px; margin-bottom: 12px; text-transform: uppercase;">CRMs Disponiveis</h3>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div class="stat-card crm-provider-card" style="cursor: pointer; flex: 1; min-width: 200px;" onclick="connectCRM('kommo')">
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #00b2ff, #0066ff); display: flex; align-items: center; justify-content: center;">
                                    <span style="font-weight: 700; color: white; font-size: 18px;">K</span>
                                </div>
                                <div>
                                    <h4 style="color: var(--text-light); margin-bottom: 4px;">Kommo</h4>
                                    <p style="font-size: 12px; color: var(--text-muted);">Ex-amoCRM</p>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card crm-provider-card" style="cursor: pointer; flex: 1; min-width: 200px; opacity: 0.6;" onclick="alert('Em breve!')">
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #ff7043, #ff5722); display: flex; align-items: center; justify-content: center;">
                                    <span style="font-weight: 700; color: white; font-size: 18px;">H</span>
                                </div>
                                <div>
                                    <h4 style="color: var(--text-light); margin-bottom: 4px;">HubSpot</h4>
                                    <p style="font-size: 12px; color: var(--text-muted);">Em breve</p>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card crm-provider-card" style="cursor: pointer; flex: 1; min-width: 200px; opacity: 0.6;" onclick="alert('Em breve!')">
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #00c46f, #009d57); display: flex; align-items: center; justify-content: center;">
                                    <span style="font-weight: 700; color: white; font-size: 18px;">P</span>
                                </div>
                                <div>
                                    <h4 style="color: var(--text-light); margin-bottom: 4px;">Pipedrive</h4>
                                    <p style="font-size: 12px; color: var(--text-muted);">Em breve</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Conta -->
        <div id="tab-conta" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card" id="account-status-card">
                    <div class="stat-label">Status da Conta</div>
                    <div class="stat-value" id="account-status">Trial</div>
                    <div class="stat-change" id="account-status-detail"><i class="fas fa-clock"></i> Carregando...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Agentes Permitidos</div>
                    <div class="stat-value" id="account-agent-limit">1</div>
                    <div class="stat-change" id="account-agent-usage">0 em uso</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mensagens Enviadas</div>
                    <div class="stat-value" id="account-messages">0</div>
                    <div class="stat-change" id="account-message-limit">Limite: -</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Proxima Renovacao</div>
                    <div class="stat-value" id="account-renewal">-</div>
                    <div class="stat-change" id="account-plan">Plano atual</div>
                </div>
            </div>

            <!-- Trial Banner -->
            <div id="trial-banner" class="campaign-section" style="display: none; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2)); border: 1px solid rgba(245, 158, 11, 0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h3 style="color: var(--warning); margin-bottom: 8px;"><i class="fas fa-clock"></i> Periodo de Trial</h3>
                        <p style="color: var(--text-muted);" id="trial-message">Seu trial expira em <strong id="trial-days-left">7</strong> dias. Aproveite todas as funcionalidades!</p>
                    </div>
                    <button class="btn btn-primary" onclick="showUpgradeModal()">
                        <i class="fas fa-rocket"></i> Fazer Upgrade
                    </button>
                </div>
            </div>

            <!-- Expired Banner -->
            <div id="expired-banner" class="campaign-section" style="display: none; background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2)); border: 1px solid rgba(239, 68, 68, 0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h3 style="color: var(--danger); margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> Trial Expirado</h3>
                        <p style="color: var(--text-muted);">Seu periodo de trial terminou. Seus agentes estao pausados. Faca upgrade para continuar.</p>
                    </div>
                    <button class="btn btn-primary" onclick="showUpgradeModal()">
                        <i class="fas fa-rocket"></i> Ativar Agora
                    </button>
                </div>
            </div>

            <!-- Account Info -->
            <div class="campaign-section">
                <h2 class="section-title"><i class="fas fa-user-circle"></i> INFORMACOES DA CONTA</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">Email</label>
                        <p style="color: var(--text-light); font-size: 16px;" id="account-email">-</p>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">Nome</label>
                        <p style="color: var(--text-light); font-size: 16px;" id="account-name">-</p>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">Empresa</label>
                        <p style="color: var(--text-light); font-size: 16px;" id="account-company">-</p>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">Conta criada em</label>
                        <p style="color: var(--text-light); font-size: 16px;" id="account-created">-</p>
                    </div>
                </div>
            </div>

            <!-- Plan Features -->
            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title"><i class="fas fa-star"></i> RECURSOS DO PLANO</h2>

                <div id="plan-features" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    <!-- Features populated by JS -->
                </div>
            </div>

            <!-- Billing History -->
            <div class="campaign-section" style="margin-top: 20px;">
                <h2 class="section-title"><i class="fas fa-receipt"></i> HISTORICO DE COBRANCAS</h2>

                <div id="billing-history" style="overflow-x: auto;">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">Nenhuma cobranca ainda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Lead Details -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Lead</h2>
                <button class="close-modal" onclick="closeLeadModal()">×</button>
            </div>
            <div id="modalLeadContent"></div>
        </div>
    </div>

    <!-- Modal for Agent Creation/Edit -->
    <div id="agentModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="agentModalTitle">Novo Agente</h2>
                <button class="close-modal" onclick="closeAgentModal()">&times;</button>
            </div>
            <div id="agentModalContent">
                <form id="agentForm" onsubmit="saveAgent(event)">
                    <input type="hidden" id="agent-id" value="">

                    <!-- Step 1: Identidade -->
                    <div class="agent-config-section">
                        <h3 style="color: var(--cyan); margin-bottom: 16px;"><i class="fas fa-id-badge"></i> Identidade do Agente</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div class="input-group">
                                <label>Nome do Agente *</label>
                                <input type="text" id="agent-name" placeholder="Ex: Leadly, Sofia" required>
                            </div>
                            <div class="input-group">
                                <label>Nome da Empresa *</label>
                                <input type="text" id="agent-company" placeholder="Nome da sua empresa" required>
                            </div>
                            <div class="input-group">
                                <label>Setor *</label>
                                <select id="agent-sector" required onchange="loadSectorDefaults(this.value)">
                                    <option value="">Selecione...</option>
                                    <option value="energia_solar">Energia Solar</option>
                                    <option value="saas">SaaS</option>
                                    <option value="consultoria">Consultoria</option>
                                    <option value="ecommerce">E-commerce</option>
                                    <option value="varejo">Varejo</option>
                                    <option value="educacao">Educacao</option>
                                    <option value="imobiliario">Imobiliario</option>
                                    <option value="financeiro">Financeiro</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Tipo de Agente</label>
                                <select id="agent-type">
                                    <option value="sdr">SDR (Qualificacao)</option>
                                    <option value="specialist">Especialista</option>
                                    <option value="scheduler">Agendador</option>
                                    <option value="support">Suporte</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Negocio -->
                    <div class="agent-config-section" style="margin-top: 20px;">
                        <h3 style="color: var(--violet); margin-bottom: 16px;"><i class="fas fa-briefcase"></i> Contexto do Negocio</h3>
                        <div class="input-group">
                            <label>Descricao do Negocio *</label>
                            <textarea id="agent-description" rows="2" placeholder="O que sua empresa faz em uma frase" required></textarea>
                        </div>
                        <div class="input-group">
                            <label>Proposta de Valor *</label>
                            <textarea id="agent-value-prop" rows="2" placeholder="Principal beneficio que voce entrega" required></textarea>
                        </div>
                        <div class="input-group">
                            <label>Produtos/Servicos (um por linha)</label>
                            <textarea id="agent-offerings" rows="3" placeholder="Sistema de gestao&#10;Consultoria especializada&#10;Suporte premium"></textarea>
                        </div>
                    </div>

                    <!-- Step 3: CTA -->
                    <div class="agent-config-section" style="margin-top: 20px;">
                        <h3 style="color: var(--success); margin-bottom: 16px;"><i class="fas fa-bullseye"></i> Call to Action</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div class="input-group">
                                <label>Tipo de CTA</label>
                                <select id="agent-cta-type">
                                    <option value="reuniao">Agendar Reuniao</option>
                                    <option value="demonstracao">Demonstracao</option>
                                    <option value="orcamento">Enviar Orcamento</option>
                                    <option value="visita">Agendar Visita</option>
                                    <option value="teste_gratis">Teste Gratuito</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Duracao</label>
                                <input type="text" id="agent-cta-duration" placeholder="Ex: 30 minutos">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Descricao do CTA</label>
                            <input type="text" id="agent-cta-desc" placeholder="Ex: Diagnostico gratuito para sua empresa">
                        </div>
                        <div class="input-group">
                            <label>Valor para o Lead</label>
                            <input type="text" id="agent-cta-value" placeholder="O que o lead ganha na call">
                        </div>
                    </div>

                    <!-- Step 4: BANT Fields -->
                    <div class="agent-config-section" style="margin-top: 20px;">
                        <h3 style="color: var(--warning); margin-bottom: 16px;"><i class="fas fa-clipboard-check"></i> Campos BANT (Qualificacao)</h3>
                        <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">Selecione os campos que deseja rastrear durante a conversa</p>
                        <div id="bant-fields-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                            <!-- Campos BANT serao carregados dinamicamente -->
                        </div>
                    </div>

                    <!-- Step 5: Status -->
                    <div class="agent-config-section" style="margin-top: 20px;">
                        <h3 style="color: var(--text-muted); margin-bottom: 16px;"><i class="fas fa-toggle-on"></i> Status</h3>
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="agent-active" checked>
                                <span>Agente Ativo</span>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeAgentModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Agente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Agent Config Details -->
    <div id="agentConfigModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="agentConfigTitle">Configuracao do Agente</h2>
                <button class="close-modal" onclick="closeAgentConfigModal()">&times;</button>
            </div>
            <div id="agentConfigContent">
                <!-- Conteudo carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal for WhatsApp QR Code Connection -->
    <div id="whatsappQrModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fab fa-whatsapp" style="color: #25D366;"></i> Conectar WhatsApp</h2>
                <button class="close-modal" onclick="closeWhatsappQrModal()">&times;</button>
            </div>
            <div id="whatsappQrContent" style="text-align: center; padding: 24px;">
                <div id="qr-loading" style="display: none;">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p style="color: var(--text-muted);">Gerando QR Code...</p>
                </div>
                <div id="qr-code-container" style="display: none;">
                    <p style="margin-bottom: 16px; color: var(--text-muted);">Escaneie o QR Code com seu WhatsApp</p>
                    <div id="qr-code" style="background: white; padding: 20px; border-radius: 12px; display: inline-block;">
                        <img id="qr-code-image" src="" alt="QR Code" style="max-width: 256px;">
                    </div>
                    <p style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">
                        Abra o WhatsApp > Menu > Aparelhos conectados > Conectar um aparelho
                    </p>
                </div>
                <div id="qr-connected" style="display: none;">
                    <div style="font-size: 64px; color: var(--success); margin-bottom: 16px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="color: var(--success); margin-bottom: 8px;">WhatsApp Conectado!</h3>
                    <p style="color: var(--text-muted);" id="connected-phone">Numero conectado</p>
                </div>
                <div id="qr-error" style="display: none;">
                    <div style="font-size: 64px; color: var(--danger); margin-bottom: 16px;">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <h3 style="color: var(--danger); margin-bottom: 8px;">Erro na Conexao</h3>
                    <p style="color: var(--text-muted);" id="error-message">Tente novamente</p>
                    <button class="btn btn-primary btn-small" style="margin-top: 16px;" onclick="retryWhatsappConnection()">
                        <i class="fas fa-redo"></i> Tentar Novamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================================
        // AUTHENTICATION CHECK (temporarily disabled for debugging)
        // ======================================
        (function checkAuth() {
            const token = localStorage.getItem('auth_token');

            // TEMPORARILY: Allow access without auth for debugging
            // TODO: Re-enable auth after fixing login redirect issue
            if (!token) {
                console.log('No auth token - allowing access for debugging');
                return; // Don't redirect
            }

            // Skip auth check for demo mode
            if (token.startsWith('demo_')) {
                return;
            }

            // Token exists - verify with server (non-blocking, won't redirect on failure)
            fetch('/api/auth/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => res.ok ? res.json() : null)
            .then(data => {
                if (data && data.success) {
                    localStorage.setItem('auth_user', JSON.stringify(data.data));
                    console.log('Authenticated as:', data.data.name);
                }
            })
            .catch(err => {
                console.log('Auth verification failed, but allowing access:', err);
            });
        })();

        // Logout function
        function logout() {
            const token = localStorage.getItem('auth_token');
            if (token && !token.startsWith('demo_')) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                }).catch(() => {});
            }
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_user');
            localStorage.removeItem('refresh_token');
            window.location.href = '/login.html';
        }

        // Get current user
        function getCurrentUser() {
            try {
                return JSON.parse(localStorage.getItem('auth_user') || '{}');
            } catch {
                return {};
            }
        }

        // ======================================
        // SECURITY: XSS Prevention Helper
        // ======================================
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Matrix Background Effect
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const matrix = 'LEADLY0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#18c5ff';
            ctx.font = `${fontSize}px monospace`;

            for (let i = 0; i < drops.length; i++) {
                const text = matrix[Math.floor(Math.random() * matrix.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(drawMatrix, 35);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Tab Switching
        let currentTab = 'dashboard';

        function switchTab(tabName, event) {
            try {
                console.log('[TAB] Switching to:', tabName);

                // Remove active from all buttons and content
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // Add active to selected button
                if (event && event.target) {
                    event.target.classList.add('active');
                } else {
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
                            btn.classList.add('active');
                        }
                    });
                }

                // Show the tab content
                const tabElement = document.getElementById('tab-' + tabName);
                if (tabElement) {
                    tabElement.classList.add('active');
                } else {
                    console.error('[TAB] Tab element not found:', 'tab-' + tabName);
                    return;
                }

                currentTab = tabName;

                // Load content (with error protection - non-blocking)
                loadTabContent(tabName).catch(err => {
                    console.error('[TAB] Error loading content for', tabName, ':', err);
                });
            } catch (error) {
                console.error('[TAB] Error switching tab:', error);
            }
        }

        async function loadTabContent(tabName) {
            try {
                switch(tabName) {
                    case 'command-center':
                        await loadCommandCenter();
                        break;
                    case 'calendario':
                        await loadEvents();
                        break;
                    case 'leads':
                        await loadAllLeads();
                        break;
                    case 'scoring':
                        await loadScoringData();
                        break;
                    case 'funil-bant':
                        await loadKanbanLeads();
                        break;
                    case 'pipeline':
                        await loadPipelineModule();
                        break;
                    case 'cadencia':
                        await loadCadenciaData();
                        break;
                    case 'forecasting':
                        await loadForecastingData();
                        break;
                    case 'clientes':
                        await loadClientesModule();
                        break;
                    case 'activities':
                        await loadActivitiesData();
                        break;
                    case 'team':
                        await loadTeamData();
                        break;
                    case 'automations':
                        await loadAutomations();
                        await loadExecutions();
                        await loadEngineStats();
                        break;
                    case 'prospecting':
                        await loadProspectingStatus();
                        await loadProspectingHistory();
                        break;
                    case 'ai-insights':
                        await loadAIInsights();
                        break;
                    case 'reports':
                        await initReportsTab();
                        break;
                    case 'agentes':
                        await loadAgentsList();
                        break;
                    case 'integracoes':
                        await loadIntegrationsTab();
                        break;
                    case 'conta':
                        await loadAccountTab();
                        break;
                }
            } catch (error) {
                console.error('[TAB] Error loading content for', tabName, ':', error);
            }
        }

        // CRM Module Loaders
        async function loadPipelineModule() {
            try {
                if (window.pipelineModule) {
                    console.log('[DASHBOARD] Loading Pipeline module...');
                    await window.pipelineModule.init();
                    window.pipelineModule.render('content-area');
                    console.log('[DASHBOARD] Pipeline module loaded successfully');
                } else {
                    console.error('Pipeline module not loaded');
                }
            } catch (error) {
                console.error('Error loading pipeline module:', error);
            }
        }

        async function loadClientesModule() {
            try {
                if (window.clientesModule) {
                    console.log('[DASHBOARD] Loading Clientes module...');
                    await window.clientesModule.init();
                    window.clientesModule.render('content-area-clientes');
                    console.log('[DASHBOARD] Clientes module loaded successfully');
                } else {
                    console.error('Clientes module not loaded');
                }
            } catch (error) {
                console.error('Error loading clientes module:', error);
            }
        }

        // Cadência Outbound Module
        async function loadCadenciaData() {
            try {
                console.log('[CADENCIA] Loading cadence data...');

                const [stats, enrollments, pipelineView] = await Promise.all([
                    fetch('/api/cadences/stats').then(r => r.json()).catch(() => ({ stats: {} })),
                    fetch('/api/cadences/enrollments/active').then(r => r.json()).catch(() => ({ enrollments: [], stats: {} })),
                    fetch('/api/cadences/pipeline-view').then(r => r.json()).catch(() => ({ stages: [] }))
                ]);

                // Update stats
                document.getElementById('stat-cadence-active').textContent = stats.stats?.active || 0;
                document.getElementById('stat-cadence-response-rate').textContent = (stats.stats?.response_rate || 0) + '%';
                document.getElementById('stat-cadence-avg-day').textContent = 'D' + (stats.stats?.avg_response_day || 0);
                document.getElementById('stat-cadence-conversions').textContent = stats.stats?.converted || 0;

                // Update response type counts
                if (stats.stats?.by_response_type) {
                    stats.stats.by_response_type.forEach(rt => {
                        const el = document.getElementById('stat-response-' + rt.response_type);
                        if (el) el.textContent = rt.count;
                    });
                }

                // Render pipeline Kanban view
                const pipelineContainer = document.getElementById('cadence-pipeline-view');
                if (pipelineView.stages && pipelineView.stages.length > 0) {
                    pipelineContainer.innerHTML = pipelineView.stages.map(stage => `
                        <div style="min-width: 200px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; border: 1px solid ${stage.color}40;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${stage.color};"></div>
                                <span style="font-weight: bold; font-size: 12px;">${stage.name}</span>
                                <span style="margin-left: auto; background: ${stage.color}30; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${stage.count}</span>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${stage.leads.slice(0, 5).map(lead => `
                                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px; margin-bottom: 8px; font-size: 11px;">
                                        <div style="font-weight: bold; color: var(--text-light);">${lead.nome || 'Sem nome'}</div>
                                        <div style="color: var(--text-muted);">${lead.empresa || '-'}</div>
                                        ${lead.cadence_day ? `<div style="color: ${stage.color};">D${lead.cadence_day}</div>` : ''}
                                    </div>
                                `).join('')}
                                ${stage.count > 5 ? `<div style="text-align: center; color: var(--text-muted); font-size: 10px;">+${stage.count - 5} mais</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    pipelineContainer.innerHTML = '<div style="color: var(--text-muted); padding: 20px;">Nenhum dado no pipeline</div>';
                }

                // Render day distribution chart
                const dayChartContainer = document.getElementById('cadence-day-chart');
                if (enrollments.stats?.by_day) {
                    const maxCount = Math.max(...Object.values(enrollments.stats.by_day), 1);
                    const days = [];
                    for (let i = 1; i <= 15; i++) {
                        const count = enrollments.stats.by_day[i] || 0;
                        const height = (count / maxCount) * 150;
                        days.push(`
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: ${height}px; background: linear-gradient(to top, var(--primary), var(--violet)); border-radius: 4px;"></div>
                                <span style="font-size: 10px; color: var(--text-muted);">D${i}</span>
                                <span style="font-size: 10px; color: var(--primary);">${count}</span>
                            </div>
                        `);
                    }
                    dayChartContainer.innerHTML = days.join('');
                } else {
                    // Show empty chart with all 15 days
                    const days = [];
                    for (let i = 1; i <= 15; i++) {
                        days.push(`
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 5px; background: var(--border-color); border-radius: 4px;"></div>
                                <span style="font-size: 10px; color: var(--text-muted);">D${i}</span>
                                <span style="font-size: 10px; color: var(--text-muted);">0</span>
                            </div>
                        `);
                    }
                    dayChartContainer.innerHTML = days.join('');
                }

                // Render enrollments table
                const tableBody = document.getElementById('cadence-enrollments-table');
                if (enrollments.enrollments && enrollments.enrollments.length > 0) {
                    tableBody.innerHTML = enrollments.enrollments.map(e => `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 12px;">
                                <div style="font-weight: bold; color: var(--text-light);">${e.lead_nome || 'Sem nome'}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${e.lead_telefone || ''}</div>
                            </td>
                            <td style="padding: 12px; color: var(--text-muted);">${e.lead_empresa || '-'}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: var(--primary)30; color: var(--primary); padding: 4px 12px; border-radius: 12px; font-weight: bold;">D${e.current_day}</span>
                            </td>
                            <td style="padding: 12px; text-align: center; color: var(--text-muted);">${e.messages_sent || 0}</td>
                            <td style="padding: 12px; color: var(--text-muted);">${e.current_step_name || 'Aguardando'}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="pauseCadenceEnrollment('${e.id}')" style="background: var(--warning)20; color: var(--warning); border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; margin-right: 4px;">Pausar</button>
                                <button onclick="markCadenceResponse('${e.id}')" style="background: var(--success)20; color: var(--success); border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer;">Respondeu</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">Nenhum lead em cadência ativa</td></tr>';
                }

                console.log('[CADENCIA] Data loaded successfully');
            } catch (error) {
                console.error('Error loading cadence data:', error);
            }
        }

        // Cadence Actions
        async function pauseCadenceEnrollment(enrollmentId) {
            try {
                const response = await fetch(`/api/cadences/enrollments/${enrollmentId}/pause`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Paused from dashboard' })
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('Cadência pausada com sucesso', 'success');
                    loadCadenciaData();
                } else {
                    showAlert('Erro ao pausar: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Erro ao pausar cadência', 'error');
            }
        }

        async function markCadenceResponse(enrollmentId) {
            try {
                const responseType = prompt('Tipo de resposta:\n- curioso\n- cetico\n- hand_raiser\n- objecao');
                if (!responseType) return;

                const response = await fetch(`/api/cadences/enrollments/${enrollmentId}/respond`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ response_channel: 'whatsapp', response_type: responseType })
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('Resposta registrada! Lead movido para "Respondeu"', 'success');
                    loadCadenciaData();
                } else {
                    showAlert('Erro: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Erro ao registrar resposta', 'error');
            }
        }

        // Command Center Module
        async function loadCommandCenter() {
            try {
                const [kpis, activities, hotLeads, cadenceStats, pendingActions] = await Promise.all([
                    fetch('/api/command-center/kpis').then(r => r.json()).catch(() => ({})),
                    fetch('/api/command-center/activity-feed?limit=10').then(r => r.json()).catch(() => ({ activities: [] })),
                    fetch('/api/scoring/leads/hot?limit=5').then(r => r.json()).catch(() => ({ leads: [] })),
                    fetch('/api/cadences/stats').then(r => r.json()).catch(() => ({ stats: {} })),
                    fetch('/api/cadences/actions/pending').then(r => r.json()).catch(() => ({ count: 0 }))
                ]);

                // Update KPIs
                document.getElementById('cc-hot-leads').textContent = kpis.hotLeads || 0;
                document.getElementById('cc-pending-tasks').textContent = kpis.pendingTasks || 0;
                document.getElementById('cc-meetings-today').textContent = kpis.meetingsToday || 0;
                document.getElementById('cc-pipeline-value').textContent = formatCurrency(kpis.pipelineValue || 0);

                // Update Cadence KPIs
                document.getElementById('cc-cadence-active').textContent = cadenceStats.stats?.active || 0;
                document.getElementById('cc-cadence-responded').textContent = cadenceStats.stats?.responded || 0;
                document.getElementById('cc-cadence-rate').textContent = (cadenceStats.stats?.response_rate || 0) + '%';
                document.getElementById('cc-cadence-pending').textContent = pendingActions.count || 0;

                // Render Activity Feed
                const feedContainer = document.getElementById('cc-activity-feed');
                if (activities.activities && activities.activities.length > 0) {
                    feedContainer.innerHTML = activities.activities.map(act => `
                        <div class="event-item" style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4 style="margin-bottom: 4px;">${act.description || act.type}</h4>
                                    <p style="font-size: 12px;">${act.leadName || 'Lead'} - ${formatTimeAgo(act.createdAt)}</p>
                                </div>
                                <span style="color: var(--cyan); font-size: 12px;">${act.type}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    feedContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhuma atividade recente</p>';
                }

                // Render Hot Leads
                const hotLeadsContainer = document.getElementById('cc-hot-leads-list');
                if (hotLeads.leads && hotLeads.leads.length > 0) {
                    hotLeadsContainer.innerHTML = hotLeads.leads.map(lead => `
                        <div class="stat-card" style="margin-bottom: 12px; cursor: pointer;" onclick="showLeadDetails('${lead.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--text-light);">${lead.name}</strong>
                                    <p style="font-size: 12px; color: var(--text-muted);">${lead.company || 'Sem empresa'}</p>
                                </div>
                                <span style="background: linear-gradient(135deg, var(--success), #059669); padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 14px;">
                                    ${lead.score || 0}
                                </span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    hotLeadsContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhum lead quente</p>';
                }
            } catch (error) {
                console.error('Error loading command center:', error);
            }
        }

        // Lead Scoring Module
        async function loadScoringData() {
            try {
                const [distribution, rules] = await Promise.all([
                    fetch('/api/scoring/distribution').then(r => r.json()).catch(() => ({})),
                    fetch('/api/scoring/rules').then(r => r.json()).catch(() => ({ rules: [] }))
                ]);

                // Update grade counts
                document.getElementById('score-grade-a').textContent = distribution.gradeA || 0;
                document.getElementById('score-grade-b').textContent = distribution.gradeB || 0;
                document.getElementById('score-grade-c').textContent = distribution.gradeC || 0;
                document.getElementById('score-grade-df').textContent = (distribution.gradeD || 0) + (distribution.gradeF || 0);

                // Rules are already rendered statically
            } catch (error) {
                console.error('Error loading scoring data:', error);
            }
        }

        // Forecasting Module
        async function loadForecastingData() {
            try {
                const [forecast, velocity] = await Promise.all([
                    fetch('/api/forecasting/current').then(r => r.json()).catch(() => ({})),
                    fetch('/api/forecasting/velocity').then(r => r.json()).catch(() => ({}))
                ]);

                // Update forecast values
                document.getElementById('forecast-commit').textContent = formatCurrency(forecast.commit || 0);
                document.getElementById('forecast-best').textContent = formatCurrency(forecast.bestCase || 0);
                document.getElementById('forecast-pipeline').textContent = formatCurrency(forecast.pipeline || 0);
                document.getElementById('forecast-winrate').textContent = (forecast.winRate || 0).toFixed(1) + '%';

                // Update velocity metrics
                document.getElementById('forecast-cycle').textContent = (velocity.avgCycle || 0) + ' dias';
                document.getElementById('forecast-ticket').textContent = formatCurrency(velocity.avgTicket || 0);
                document.getElementById('forecast-deals').textContent = velocity.dealsPerMonth || 0;
            } catch (error) {
                console.error('Error loading forecasting data:', error);
            }
        }

        // Activities Module
        async function loadActivitiesData() {
            try {
                const [stats, activities] = await Promise.all([
                    fetch('/api/activities/stats').then(r => r.json()).catch(() => ({})),
                    fetch('/api/activities?limit=20').then(r => r.json()).catch(() => ({ activities: [] }))
                ]);

                // Update stats
                document.getElementById('act-overdue').textContent = stats.overdue || 0;
                document.getElementById('act-today').textContent = stats.today || 0;
                document.getElementById('act-week').textContent = stats.thisWeek || 0;
                document.getElementById('act-completed').textContent = stats.completed || 0;

                // Render activities list
                const container = document.getElementById('activities-list');
                if (activities.activities && activities.activities.length > 0) {
                    container.innerHTML = activities.activities.map(act => {
                        const isOverdue = new Date(act.dueDate) < new Date() && act.status !== 'completed';
                        const borderColor = isOverdue ? 'var(--danger)' : act.status === 'completed' ? 'var(--success)' : 'var(--cyan)';
                        return `
                            <div class="stat-card" style="border-left: 4px solid ${borderColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong style="color: var(--text-light);">${act.title}</strong>
                                        <p style="font-size: 12px; color: var(--text-muted);">${act.type} - ${formatDate(act.dueDate)}</p>
                                    </div>
                                    <span style="color: ${borderColor}; font-size: 12px; text-transform: uppercase;">${act.status}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhuma atividade encontrada</p>';
                }
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        // Team Module
        async function loadTeamData() {
            try {
                const [users, teams, leaderboard] = await Promise.all([
                    fetch('/api/team/users').then(r => r.json()).catch(() => ({ users: [] })),
                    fetch('/api/team/teams').then(r => r.json()).catch(() => ({ teams: [] })),
                    fetch('/api/team/leaderboard').then(r => r.json()).catch(() => ({ leaderboard: [] }))
                ]);

                // Update stats
                document.getElementById('team-total').textContent = users.users?.length || 0;
                document.getElementById('team-groups').textContent = teams.teams?.length || 0;
                document.getElementById('team-online').textContent = users.users?.filter(u => u.status === 'online').length || 0;

                // Top performer
                if (leaderboard.leaderboard && leaderboard.leaderboard.length > 0) {
                    document.getElementById('team-top').textContent = leaderboard.leaderboard[0].name || '-';
                }

                // Render team members
                const membersContainer = document.getElementById('team-members-list');
                if (users.users && users.users.length > 0) {
                    membersContainer.innerHTML = users.users.map(user => `
                        <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--cyan), var(--violet)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                    ${(user.name || 'U').substring(0, 2).toUpperCase()}
                                </div>
                                <div>
                                    <strong style="color: var(--text-light);">${user.name}</strong>
                                    <p style="font-size: 12px; color: var(--text-muted);">${user.role}</p>
                                </div>
                            </div>
                            <span style="color: ${user.status === 'online' ? 'var(--success)' : 'var(--text-muted)'};">
                                <i class="fas fa-circle" style="font-size: 8px;"></i> ${user.status || 'offline'}
                            </span>
                        </div>
                    `).join('');
                } else {
                    membersContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhum usuario cadastrado</p>';
                }

                // Render leaderboard
                const lbContainer = document.getElementById('team-leaderboard');
                if (leaderboard.leaderboard && leaderboard.leaderboard.length > 0) {
                    lbContainer.innerHTML = leaderboard.leaderboard.slice(0, 5).map((user, idx) => `
                        <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center; ${idx === 0 ? 'background: rgba(255, 215, 0, 0.1); border: 1px solid gold;' : ''}">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 20px; font-weight: bold; color: ${idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? '#cd7f32' : 'var(--text-muted)'};">
                                    #${idx + 1}
                                </span>
                                <strong style="color: var(--text-light);">${user.name}</strong>
                            </div>
                            <span style="color: var(--cyan); font-weight: bold;">${formatCurrency(user.revenue || 0)}</span>
                        </div>
                    `).join('');
                } else {
                    lbContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Sem dados de ranking</p>';
                }
            } catch (error) {
                console.error('Error loading team data:', error);
            }
        }

        // AI Insights Module
        async function loadAIInsights() {
            try {
                const [sentiment, objections] = await Promise.all([
                    fetch('/api/ai-insights/sentiment').then(r => r.json()).catch(() => ({})),
                    fetch('/api/ai-insights/objections').then(r => r.json()).catch(() => ({ objections: [] }))
                ]);

                // Update sentiment stats
                document.getElementById('ai-sentiment').textContent = sentiment.overall || 'Neutro';
                document.getElementById('ai-objections').textContent = objections.total || 0;
                document.getElementById('ai-resolution').textContent = (sentiment.resolutionRate || 0).toFixed(0) + '%';
                document.getElementById('ai-insights-count').textContent = sentiment.insightsCount || 0;

                // Update sentiment breakdown
                document.getElementById('ai-positive').textContent = (sentiment.positive || 0).toFixed(0) + '%';
                document.getElementById('ai-neutral').textContent = (sentiment.neutral || 0).toFixed(0) + '%';
                document.getElementById('ai-negative').textContent = (sentiment.negative || 0).toFixed(0) + '%';

                // Objections list is rendered statically
            } catch (error) {
                console.error('Error loading AI insights:', error);
            }
        }

        // Reports Module
        function initReportsTab() {
            // Set default dates
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('report-start').value = startDate.toISOString().split('T')[0];
            document.getElementById('report-end').value = today.toISOString().split('T')[0];
        }

        async function generateReport() {
            const type = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;

            const resultContainer = document.getElementById('report-result');
            resultContainer.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="color: var(--text-muted); margin-top: 16px;">Gerando relatorio...</p></div>';

            try {
                const response = await fetch(`/api/reports/generate?type=${type}&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();

                if (data.success) {
                    resultContainer.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="color: var(--cyan); margin-bottom: 16px;">Relatorio: ${type.toUpperCase()}</h3>
                            <pre style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; overflow-x: auto; color: var(--text-light);">${JSON.stringify(data.report, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 40px;">Erro ao gerar relatorio</p>';
                }
            } catch (error) {
                resultContainer.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 40px;">Erro ao gerar relatorio</p>';
            }
        }

        async function generateQuickReport(period) {
            const resultContainer = document.getElementById('report-result');
            resultContainer.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="color: var(--text-muted); margin-top: 16px;">Gerando relatorio rapido...</p></div>';

            try {
                const response = await fetch(`/api/reports/quick/${period}`);
                const data = await response.json();

                resultContainer.innerHTML = `
                    <div style="padding: 20px;">
                        <h3 style="color: var(--cyan); margin-bottom: 16px;">Relatorio ${period.charAt(0).toUpperCase() + period.slice(1)}</h3>
                        <pre style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; overflow-x: auto; color: var(--text-light);">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultContainer.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 40px;">Erro ao gerar relatorio</p>';
            }
        }

        function exportReport(format) {
            const type = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;

            window.open(`/api/reports/export?type=${type}&startDate=${startDate}&endDate=${endDate}&format=${format}`, '_blank');
        }

        // Utility Functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('pt-BR');
        }

        function formatTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'agora';
            if (diff < 3600) return Math.floor(diff / 60) + 'min atras';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h atras';
            return Math.floor(diff / 86400) + 'd atras';
        }

        function showNewActivityModal() {
            showAlert('Modal de nova atividade - Em desenvolvimento', 'warning');
        }

        function showNewUserModal() {
            showAlert('Modal de novo usuario - Em desenvolvimento', 'warning');
        }

        // Dashboard Functions
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.innerHTML = `
                <span>${type === 'success' ? '[OK]' : type === 'error' ? '[ERRO]' : '[AVISO]'}</span>
                <span>${message}</span>
            `;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        async function refreshStats(showNotification = false) {
            try {
                const response = await fetch('/api/analytics/whatsapp-stats');
                const data = await response.json();

                document.getElementById('stat-messages').textContent = data.totalMessages || 0;
                document.getElementById('stat-responses').textContent = data.receivedMessages || 0;
                document.getElementById('stat-conversion').textContent =
                    (data.responseRate || 0).toFixed(1) + '%';
                document.getElementById('stat-active').textContent = data.uniqueContacts || 0;

                // Só mostra alerta se for refresh manual
                if (showNotification) {
                    showAlert('Métricas atualizadas com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                // Só mostra erro se for refresh manual
                if (showNotification) {
                    showAlert('Erro ao carregar métricas. Tentando novamente...', 'warning');
                }
            }
        }

        async function loadLeadsFromSheet() {
            try {
                const response = await fetch('/api/leads');
                const data = await response.json();
                const leads = data.leads || [];
                showAlert(`${leads.length} leads carregados da planilha`, 'success');
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                showAlert('Erro ao carregar leads', 'error');
            }
        }

        async function startCampaign() {
            const leadCount = parseInt(document.getElementById('lead-count').value);
            const interval = parseInt(document.getElementById('interval').value);
            const campaignType = document.getElementById('campaign-type').value;

            if (!leadCount || leadCount < 1) {
                showAlert('Quantidade de leads inválida', 'error');
                return;
            }

            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                const response = await fetch('/api/whatsapp/intelligent-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        limit: leadCount,
                        delaySeconds: interval,
                        campaignType: campaignType
                    })
                });

                const result = await response.json();

                if (result.success || result.sent > 0) {
                    showAlert(`Campanha iniciada! ${result.sent} mensagens enviadas`, 'success');
                    displayResults(result);
                    refreshStats();
                } else {
                    showAlert(result.error || 'Erro ao iniciar campanha', 'error');
                }
            } catch (error) {
                console.error('Erro ao iniciar campanha:', error);
                showAlert('Erro ao iniciar campanha', 'error');
            } finally {
                loading.classList.remove('active');
            }
        }

        function displayResults(result) {
            const container = document.getElementById('results-container');

            let html = `
                <h3 style="margin-top: 24px; color: var(--cyan); font-family: Orbitron;">RESULTADOS DA CAMPANHA</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Contato</th>
                            <th>Nome</th>
                            <th>Status</th>
                            <th>Mensagem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (result.results && result.results.length > 0) {
                result.results.forEach(item => {
                    const status = item.success ?
                        '<span style="color: var(--success)">Enviado</span>' :
                        '<span style="color: var(--danger)">Falhou</span>';

                    html += `
                        <tr>
                            <td>${item.phone}</td>
                            <td>${item.name || 'N/A'}</td>
                            <td>${status}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${item.message ? item.message.substring(0, 50) + '...' : 'N/A'}
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += '<tr><td colspan="4" style="text-align: center;">Nenhum resultado disponível</td></tr>';
            }

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Calendar Functions
        let eventsData = [];
        let draggedEventCard = null;

        async function loadEvents() {
            const loadingEl = document.getElementById('eventsLoading');
            const kanbanEl = document.getElementById('eventsKanban');

            loadingEl.classList.add('active');
            kanbanEl.style.display = 'none';

            try {
                const response = await fetch('/api/events');
                const data = await response.json();

                eventsData = data.events || [];
                renderEventCards();

                loadingEl.classList.remove('active');
                kanbanEl.style.display = 'grid';
            } catch (error) {
                loadingEl.innerHTML = '<div class="alert alert-error show">Erro ao carregar eventos: ' + error.message + '</div>';
            }
        }

        function getEventCategory(dateStr) {
            if (!dateStr) return 'later';

            const eventDate = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const endOfWeek = new Date(today);
            endOfWeek.setDate(endOfWeek.getDate() + 7);

            const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());

            if (eventDay.getTime() === today.getTime()) return 'today';
            if (eventDay.getTime() === tomorrow.getTime()) return 'tomorrow';
            if (eventDay < endOfWeek) return 'week';
            return 'later';
        }

        function renderEventCards() {
            const categories = {
                today: [],
                tomorrow: [],
                week: [],
                later: []
            };

            // Categorize events
            eventsData.forEach((event, index) => {
                const startDate = event.startDateTime || event.start?.dateTime || event.start?.date || event.start;
                const category = getEventCategory(startDate);
                categories[category].push({ event, index });
            });

            // Render each column
            Object.keys(categories).forEach(category => {
                const container = document.getElementById(`cards-${category}`);
                const countEl = document.getElementById(`count-${category}`);
                const events = categories[category];

                countEl.textContent = events.length;

                if (events.length === 0) {
                    container.innerHTML = '<div class="calendar-empty">Nenhuma reunião</div>';
                    return;
                }

                let html = '';
                events.forEach(({ event, index }) => {
                    html += createEventCardHtml(event, index);
                });

                container.innerHTML = html;
            });
        }

        function createEventCardHtml(event, index) {
            const eventId = event.id || event.eventId || index;
            const startDate = event.startDateTime || event.start?.dateTime || event.start?.date || event.start;
            const endDate = event.endDateTime || event.end?.dateTime || event.end?.date || event.end;
            const title = event.title || event.summary || 'Reunião sem título';

            const formatTime = (dateStr) => {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return '';
                    return date.toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return '';
                }
            };

            const formatDateFull = (dateStr) => {
                if (!dateStr) return 'Data não disponível';
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'Data inválida';
                    return date.toLocaleString('pt-BR', {
                        weekday: 'short',
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return 'Erro ao formatar';
                }
            };

            const startTime = formatTime(startDate);
            const endTime = formatTime(endDate);
            const timeRange = startTime && endTime ? `${startTime} - ${endTime}` : startTime || '';

            return `
                <div class="event-card"
                     data-event-id="${eventId}"
                     data-index="${index}"
                     draggable="true"
                     ondragstart="handleEventDragStart(event)"
                     ondragend="handleEventDragEnd(event)">
                    <div class="event-card-header" onclick="toggleEventCard(this.parentElement)">
                        <div class="event-card-title">
                            <h4>${escapeHtml(title)}</h4>
                        </div>
                        <div class="event-card-time">
                            <i class="fas fa-clock"></i> ${timeRange}
                        </div>
                        <div class="event-card-meta">
                            ${event.location || event.meetLink ? `
                            <span class="event-card-location">
                                <i class="fas fa-${event.meetLink ? 'video' : 'map-marker-alt'}"></i>
                                ${escapeHtml(event.location || 'Online')}
                            </span>
                            ` : '<span></span>'}
                            <div class="event-card-actions">
                                <button class="event-card-btn btn-edit" onclick="event.stopPropagation(); editEvent('${eventId}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="event-card-btn btn-delete" onclick="event.stopPropagation(); deleteEvent('${eventId}')" title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="event-card-body">
                        <div class="event-card-details">
                            <div class="event-card-detail">
                                <i class="fas fa-calendar"></i>
                                <span>${formatDateFull(startDate)}</span>
                            </div>
                            ${event.description ? `
                            <div class="event-card-detail">
                                <i class="fas fa-align-left"></i>
                                <span>${escapeHtml(event.description)}</span>
                            </div>
                            ` : ''}
                            ${event.meetLink ? `
                            <div class="event-card-detail">
                                <i class="fas fa-video"></i>
                                <a href="${event.meetLink}" target="_blank">Entrar na reunião</a>
                            </div>
                            ` : ''}
                            ${event.attendees && event.attendees.length > 0 ? `
                            <div class="event-card-detail">
                                <i class="fas fa-users"></i>
                                <span>${event.attendees.map(a => a.email || a).join(', ')}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleEventCard(card) {
            card.classList.toggle('expanded');
        }

        function editEvent(eventId) {
            const event = eventsData.find(e => (e.id || e.eventId) == eventId);
            if (!event) {
                showAlert('Evento não encontrado', 'error');
                return;
            }

            document.getElementById('editEventId').value = eventId;
            document.getElementById('editEventTitle').value = event.title || event.summary || '';
            document.getElementById('editEventDescription').value = event.description || '';
            document.getElementById('editEventLocation').value = event.location || '';

            const startDate = event.startDateTime || event.start?.dateTime || event.start?.date || event.start;
            const endDate = event.endDateTime || event.end?.dateTime || event.end?.date || event.end;

            if (startDate) {
                const start = new Date(startDate);
                document.getElementById('editEventStart').value = start.toISOString().slice(0, 16);
            }
            if (endDate) {
                const end = new Date(endDate);
                document.getElementById('editEventEnd').value = end.toISOString().slice(0, 16);
            }

            document.getElementById('editEventModal').classList.add('active');
        }

        function closeEditEventModal() {
            document.getElementById('editEventModal').classList.remove('active');
        }

        async function saveEventChanges(e) {
            e.preventDefault();

            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('editEventTitle').value;
            const description = document.getElementById('editEventDescription').value;
            const start = document.getElementById('editEventStart').value;
            const end = document.getElementById('editEventEnd').value;
            const location = document.getElementById('editEventLocation').value;

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        start: new Date(start).toISOString(),
                        end: new Date(end).toISOString(),
                        location
                    })
                });

                if (!response.ok) {
                    throw new Error('Falha ao atualizar evento');
                }

                showAlert('Evento atualizado com sucesso!', 'success');
                closeEditEventModal();
                loadEvents();
            } catch (error) {
                showAlert('Erro ao atualizar evento: ' + error.message, 'error');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja remover esta reunião?')) {
                return;
            }

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Falha ao remover evento');
                }

                showAlert('Reunião removida com sucesso!', 'success');
                loadEvents();
            } catch (error) {
                showAlert('Erro ao remover evento: ' + error.message, 'error');
            }
        }

        // Drag and Drop for Event Cards
        function handleEventDragStart(e) {
            draggedEventCard = e.target.closest('.event-card');
            if (draggedEventCard) {
                draggedEventCard.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedEventCard.dataset.eventId);
            }
        }

        function handleEventDragEnd(e) {
            if (draggedEventCard) {
                draggedEventCard.classList.remove('dragging');
                draggedEventCard = null;
            }
            document.querySelectorAll('.event-card, .calendar-column-cards').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleEventDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const column = e.target.closest('.calendar-column-cards');
            if (column) {
                column.classList.add('drag-over');
            }
        }

        function handleEventDragLeave(e) {
            const column = e.target.closest('.calendar-column-cards');
            if (column && !column.contains(e.relatedTarget)) {
                column.classList.remove('drag-over');
            }
        }

        function handleEventDrop(e, category) {
            e.preventDefault();
            const column = e.target.closest('.calendar-column-cards');

            if (!column || !draggedEventCard) {
                return;
            }

            // Move the card to the new column
            const emptyEl = column.querySelector('.calendar-empty');
            if (emptyEl) {
                emptyEl.remove();
            }

            column.appendChild(draggedEventCard);
            column.classList.remove('drag-over');

            // Update counts
            updateColumnCounts();

            showAlert('Card movido! (Reorganização visual apenas)', 'success');
        }

        function updateColumnCounts() {
            ['today', 'tomorrow', 'week', 'later'].forEach(category => {
                const container = document.getElementById(`cards-${category}`);
                const countEl = document.getElementById(`count-${category}`);
                const cards = container.querySelectorAll('.event-card');
                countEl.textContent = cards.length;

                // Add empty message if no cards
                if (cards.length === 0 && !container.querySelector('.calendar-empty')) {
                    container.innerHTML = '<div class="calendar-empty">Nenhuma reunião</div>';
                }
            });
        }

        // Leads Functions
        let allLeadsData = [];

        async function loadAllLeads() {
            const container = document.getElementById('leadsResult');
            container.innerHTML = '<div class="loading active"><div class="spinner"></div>Carregando leads...</div>';

            try {
                const response = await fetch('/api/leads');
                const data = await response.json();

                if (!data.leads || data.leads.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhum lead encontrado na planilha.</p>';
                    allLeadsData = [];
                    return;
                }

                // Normalizar nomes de campos (converter de Maiúscula para minúscula)
                allLeadsData = data.leads.map(lead => ({
                    nome: lead.Nome || lead.nome,
                    telefone: lead.Telefone || lead.telefone,
                    email: lead.Email || lead.email,
                    empresa: lead.Empresa || lead.empresa,
                    cargo: lead.Cargo || lead.cargo,
                    segmento: lead.Segmento || lead.segmento,
                    faturamento: lead.Faturamento || lead.faturamento,
                    funcionarios: lead.Funcionários || lead.funcionarios,
                    cidade: lead.Cidade || lead.cidade,
                    estado: lead.Estado || lead.estado,
                    fonte: lead.Fonte || lead.fonte,
                    status: lead.Status || lead.status,
                    observacoes: lead.Observações || lead.observacoes
                }));

                displayLeads(allLeadsData);
            } catch (error) {
                container.innerHTML = '<div class="alert alert-error show">Erro ao carregar leads: ' + error.message + '</div>';
                allLeadsData = [];
            }
        }

        function filterLeads() {
            const query = document.getElementById('leadSearch').value.toLowerCase();

            if (!query) {
                displayLeads(allLeadsData);
                return;
            }

            const filtered = allLeadsData.filter(lead => {
                return (lead.nome && lead.nome.toLowerCase().includes(query)) ||
                       (lead.telefone && lead.telefone.toLowerCase().includes(query)) ||
                       (lead.empresa && lead.empresa.toLowerCase().includes(query)) ||
                       (lead.cargo && lead.cargo.toLowerCase().includes(query)) ||
                       (lead.email && lead.email.toLowerCase().includes(query));
            });

            displayLeads(filtered);
        }

        function displayLeads(leads) {
            const container = document.getElementById('leadsResult');

            if (!leads || leads.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Nenhum lead encontrado.</p>';
                return;
            }

            let html = '<div class="leads-grid">';

            leads.forEach(lead => {
                const leadJson = JSON.stringify(lead).replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                const status = lead.status || 'Novo';
                const statusClass = status.toLowerCase() === 'qualificado' ? 'status-qualified' :
                                   status.toLowerCase() === 'contactado' ? 'status-contacted' : 'status-new';

                html += `
                    <div class="lead-card">
                        <div class="lead-card-header">
                            <div>
                                <h4 class="lead-card-name">${escapeHtml(lead.nome || 'Sem nome')}</h4>
                                ${lead.empresa ? `<div class="lead-card-company">${escapeHtml(lead.empresa)}</div>` : ''}
                            </div>
                            <span class="lead-card-status ${statusClass}">${escapeHtml(status)}</span>
                        </div>

                        <div class="lead-card-info">
                            ${lead.telefone ? `
                            <div class="lead-card-row">
                                <i class="fas fa-phone"></i>
                                <a href="tel:${lead.telefone}">${lead.telefone}</a>
                            </div>
                            ` : ''}
                            ${lead.email ? `
                            <div class="lead-card-row">
                                <i class="fas fa-envelope"></i>
                                <a href="mailto:${lead.email}">${lead.email}</a>
                            </div>
                            ` : ''}
                            ${lead.cargo ? `
                            <div class="lead-card-row">
                                <i class="fas fa-briefcase"></i>
                                <span>${escapeHtml(lead.cargo)}</span>
                            </div>
                            ` : ''}
                            ${lead.cidade || lead.estado ? `
                            <div class="lead-card-row">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${escapeHtml([lead.cidade, lead.estado].filter(Boolean).join(', '))}</span>
                            </div>
                            ` : ''}
                        </div>

                        ${lead.segmento || lead.fonte ? `
                        <div class="lead-card-tags">
                            ${lead.segmento ? `<span class="lead-card-tag">${escapeHtml(lead.segmento)}</span>` : ''}
                            ${lead.fonte ? `<span class="lead-card-tag">${escapeHtml(lead.fonte)}</span>` : ''}
                        </div>
                        ` : ''}

                        <div class="lead-card-actions">
                            <button onclick="callLead('${lead.telefone || ''}')" class="lead-card-btn btn-whatsapp" ${!lead.telefone ? 'disabled' : ''}>
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button onclick='showLeadModal(${leadJson})' class="lead-card-btn btn-details">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            html += `
                <div class="leads-summary">
                    <span>Total: <strong>${leads.length}</strong> leads</span>
                    <span>Exibindo todos os resultados</span>
                </div>
            `;
            container.innerHTML = html;
        }

        function showLeadModal(lead) {
            const modal = document.getElementById('leadModal');
            const content = document.getElementById('modalLeadContent');

            let html = '<div style="margin-bottom: 20px;">';
            html += '<h3 style="color: var(--cyan); margin-bottom: 16px;">Informações Básicas</h3>';
            html += '<p style="margin: 8px 0;"><strong>Nome:</strong> ' + (lead.nome || 'N/A') + '</p>';
            html += '<p style="margin: 8px 0;"><strong>Telefone:</strong> ' + (lead.telefone || 'N/A') + '</p>';
            html += '<p style="margin: 8px 0;"><strong>Email:</strong> ' + (lead.email || 'N/A') + '</p>';
            html += '<p style="margin: 8px 0;"><strong>Empresa:</strong> ' + (lead.empresa || 'N/A') + '</p>';
            html += '<p style="margin: 8px 0;"><strong>Cargo:</strong> ' + (lead.cargo || 'N/A') + '</p>';
            if (lead.cidade) html += '<p style="margin: 8px 0;"><strong>Cidade:</strong> ' + lead.cidade + '</p>';
            if (lead.estado) html += '<p style="margin: 8px 0;"><strong>Estado:</strong> ' + lead.estado + '</p>';
            html += '</div>';

            html += '<div style="display: flex; gap: 12px;">';
            html += '<button onclick="callLead(\'' + (lead.telefone || '') + '\')" class="btn btn-primary">Iniciar Conversa</button>';
            html += '<button onclick="scheduleMeeting(\'' + (lead.nome || '') + '\', \'' + (lead.email || '') + '\')" class="btn btn-secondary">Agendar Reunião</button>';
            html += '</div>';

            content.innerHTML = html;
            modal.classList.add('active');
        }

        function closeLeadModal() {
            document.getElementById('leadModal').classList.remove('active');
        }

        async function callLead(phone) {
            if (!phone) {
                showAlert('Telefone não disponível', 'error');
                return;
            }

            try {
                await fetch('/api/whatsapp/call-lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });

                showAlert('Conversa iniciada com sucesso!', 'success');
                closeLeadModal();
            } catch (error) {
                showAlert('Erro ao iniciar conversa: ' + error.message, 'error');
            }
        }

        function scheduleMeeting(name, email) {
            switchTab('calendario');
            closeLeadModal();

            if (name) document.getElementById('eventTitle').value = 'Reunião com ' + name;
            if (email) document.getElementById('eventAttendees').value = email;

            document.getElementById('eventForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('leadModal');
            if (event.target === modal) {
                closeLeadModal();
            }
        }

        // Handle Enter key in search and live filtering
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[DASHBOARD] Initializing...');

            // Display user name
            const user = getCurrentUser();
            const userNameEl = document.getElementById('user-name');
            if (userNameEl && user.name) {
                userNameEl.textContent = user.name;
            }

            // Initialize search input (with null check)
            const searchInput = document.getElementById('leadSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        filterLeads();
                    }
                });

                searchInput.addEventListener('input', () => {
                    if (allLeadsData.length > 0) {
                        filterLeads();
                    }
                });
            }

            //  FIX: Load initial dashboard metrics
            try {
                console.log('[DASHBOARD] Loading initial metrics...');
                await refreshStats(false);  // Load WhatsApp stats
                await refreshAgentMetrics();  // Load agent metrics
                console.log('[DASHBOARD] Initial metrics loaded');
            } catch (error) {
                console.error('[DASHBOARD] Error loading initial metrics:', error);
            }

            //  FIX: Set up auto-refresh for metrics (every 30 seconds)
            setInterval(() => {
                if (currentTab === 'dashboard') {
                    refreshStats(false);
                    refreshAgentMetrics();
                }
            }, 30000);

            console.log('[DASHBOARD] Initialization complete');
        });

        // Google OAuth Functions
        async function authorizeGoogle() {
            try {
                const response = await fetch('/api/google/auth-url');
                const data = await response.json();

                if (data.authUrl) {
                    // Verificar se é um placeholder
                    if (data.authUrl.includes('YOUR_CLIENT_ID')) {
                        showAlert('Google OAuth não configurado. Configure google_credentials.json no servidor.', 'warning');
                        console.info('Para configurar Google OAuth:\n1. Crie projeto no Google Cloud Console\n2. Habilite Calendar API\n3. Configure google_credentials.json');
                        return;
                    }
                    window.open(data.authUrl, '_blank', 'width=600,height=700');
                    showAlert('Abrindo janela de autenticação do Google...', 'success');
                } else {
                    showAlert('Erro ao obter URL de autenticação', 'error');
                }
            } catch (error) {
                console.error('Erro ao autorizar Google:', error);
                showAlert('Erro ao conectar com Google', 'error');
            }
        }

        async function checkGoogleAuth() {
            try {
                const response = await fetch('/api/google/auth-status');
                const data = await response.json();

                const googleButton = document.querySelector('button[onclick="authorizeGoogle()"]');
                if (!googleButton) return;

                if (data.authenticated && data.tokenInfo) {
                    // Verificar se o token está expirado
                    const isExpired = data.tokenInfo.expiresIn && data.tokenInfo.expiresIn < 0;

                    if (isExpired) {
                        // Token expirado - permitir reconexão
                        googleButton.innerHTML = ' Reconectar Google';
                        googleButton.classList.add('btn-warning');
                        googleButton.classList.remove('btn-primary');
                    } else {
                        // Token válido
                        googleButton.innerHTML = '✓ Google Conectado';
                        googleButton.classList.add('btn-success');
                        googleButton.classList.remove('btn-primary');
                        // Não desabilitar - permitir reconexão se necessário
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
            }
        }

        // Agent Metrics Functions
        async function refreshAgentMetrics() {
            try {
                const response = await fetch('/api/analytics/agent-metrics');
                const data = await response.json();

                if (data.agents) {
                    // SDR Agent
                    document.getElementById('stat-sdr-processed').textContent = data.agents.sdr.processed || 0;
                    document.getElementById('stat-sdr-rate').textContent = `Taxa: ${data.agents.sdr.successRate || 0}%`;
                    document.getElementById('stat-sdr-handoffs').textContent = data.agents.sdr.handoffs || 0;
                    document.getElementById('stat-sdr-contacts').textContent = `${data.agents.sdr.contacts || 0} contatos`;

                    // Specialist Agent
                    document.getElementById('stat-specialist-processed').textContent = data.agents.specialist.processed || 0;
                    document.getElementById('stat-specialist-rate').textContent = `Taxa: ${data.agents.specialist.successRate || 0}%`;
                    document.getElementById('stat-specialist-success').textContent = data.agents.specialist.success || 0;
                    document.getElementById('stat-specialist-contacts').textContent = `${data.agents.specialist.contacts || 0} contatos`;

                    // Scheduler Agent
                    document.getElementById('stat-scheduler-processed').textContent = data.agents.scheduler.processed || 0;
                    document.getElementById('stat-scheduler-rate').textContent = `Taxa: ${data.agents.scheduler.successRate || 0}%`;
                    document.getElementById('stat-scheduler-success').textContent = data.agents.scheduler.success || 0;
                    document.getElementById('stat-scheduler-contacts').textContent = `${data.agents.scheduler.contacts || 0} contatos`;

                    console.log('Métricas dos agentes atualizadas');
                }
            } catch (error) {
                console.error('Erro ao carregar métricas dos agentes:', error);
            }
        }

        // Kanban Board Functions
        let leadsKanbanData = [];
        let draggedKanbanElement = null;
        let kanbanFirstLoad = true; // ⚡ Flag para primeira carga

        // Load leads from API
        async function loadKanbanLeads() {
            const loading = document.getElementById('kanban-loading');
            const kanbanBoard = document.getElementById('kanban-board');

            // ⚡ OTIMIZAÇÃO: Só mostrar loading na primeira carga
            if (kanbanFirstLoad) {
                loading.style.display = 'block';
                kanbanBoard.style.display = 'none';
            }

            try {
                const response = await fetch('/api/funil/bant');
                const data = await response.json();

                leadsKanbanData = (data.leads || data.data || []).map(lead => ({
                    id: lead.id || lead.contactId || lead.telefone || lead.phone,
                    nome: lead.nome || lead.contactName || lead.name || 'Sem nome',
                    telefone: lead.telefone || lead.phone || lead.contactId,
                    email: lead.email,
                    empresa: lead.empresa || lead.company || 'N/A',
                    setor: lead.setor || lead.sector || 'N/A',
                    stage: (lead.currentAgent || lead.currentStage || lead.bant_stage || lead.stage || 'sdr').toLowerCase(),
                    bant_stage: (lead.currentStage || lead.bant_stage || lead.stage || 'need').toLowerCase(),
                    score: parseInt(lead.qualificationScore || lead.qualification_score || lead.score || 0),

                    // NEED Stage - novos campos
                    nome_pessoa: lead.nome_pessoa || lead.nome || '',
                    nome_negocio: lead.nome_negocio || lead.empresa || '',
                    nicho: lead.nicho || lead.setor || '',
                    cargo_funcao: lead.cargo_funcao || '',
                    problema: lead.problema_principal || lead.problem || '',
                    intensidade: lead.intensidade_problema || '',
                    receita_mensal: lead.receita_mensal || '',
                    funcionarios: lead.funcionarios || '',
                    servico: lead.servico_identificado || '',

                    // BUDGET Stage
                    investimento: lead.verba_disponivel || lead.investimento_disponivel || lead.investment || lead.faixa_investimento || '',

                    // AUTHORITY Stage
                    decisor: lead.decisor || lead.decision_maker || lead.decisor_principal || '',
                    autonomia: lead.autonomia_decisao || '',

                    // TIMING Stage
                    urgencia: lead.urgencia || lead.urgency || '',
                    prazo: lead.prazo_ideal || '',

                    updated_at: lead.updated_at || lead.updatedAt
                }));

                renderKanbanBoard();

                // ⚡ OTIMIZAÇÃO: Só ocultar loading na primeira carga
                if (kanbanFirstLoad) {
                    loading.style.display = 'none';
                    kanbanBoard.style.display = 'grid';
                    kanbanFirstLoad = false; // Marca que já carregou
                }
            } catch (error) {
                console.error('Erro ao carregar leads:', error);

                if (kanbanFirstLoad) {
                    loading.innerHTML = `<p style="color: #ef4444;">Erro ao carregar leads: ${error.message}</p>`;
                    // Mock data para teste
                    leadsKanbanData = generateMockKanbanLeads();
                    renderKanbanBoard();
                    kanbanBoard.style.display = 'grid';
                    kanbanFirstLoad = false;
                }
            }
        }

        // Generate mock data for testing
        function generateMockKanbanLeads() {
            return [
                { id: '1', nome: 'João Silva', telefone: '84999999999', empresa: 'Tech Solutions', setor: 'Tecnologia', stage: 'sdr', bant_stage: 'need', score: 85, problema: 'Automação de vendas', investimento: 'R$ 5-10k', decisor: 'Sim', urgencia: 'Alta' },
                { id: '2', nome: 'Maria Santos', telefone: '84988888888', empresa: 'Digital Agency', setor: 'Marketing', stage: 'specialist', bant_stage: 'need', score: 72, problema: 'Leads qualificados', investimento: '', decisor: '', urgencia: '' },
                { id: '3', nome: 'Pedro Costa', telefone: '84977777777', empresa: 'E-commerce Plus', setor: 'Varejo', stage: 'specialist', bant_stage: 'budget', score: 68, problema: 'Conversão baixa', investimento: 'R$ 10-15k', decisor: '', urgencia: '' },
                { id: '4', nome: 'Ana Lima', telefone: '84966666666', empresa: 'Consultoria RN', setor: 'Consultoria', stage: 'specialist', bant_stage: 'authority', score: 91, problema: 'Processo manual', investimento: 'R$ 15-20k', decisor: 'Gerente', urgencia: '' },
                { id: '5', nome: 'Carlos Mendes', telefone: '84955555555', empresa: 'Startup XYZ', setor: 'SaaS', stage: 'specialist', bant_stage: 'timing', score: 88, problema: 'Escala', investimento: 'R$ 20k+', decisor: 'CEO', urgencia: 'Urgente' },
                { id: '6', nome: 'Beatriz Souza', telefone: '84944444444', empresa: 'Imobiliária ABC', setor: 'Imobiliário', stage: 'scheduler', bant_stage: 'timing', score: 79, problema: 'CRM', investimento: 'R$ 5-10k', decisor: 'Dono', urgencia: 'Média' },
            ];
        }

        // Render Kanban board
        function renderKanbanBoard() {
            // Clear all columns
            ['sdr', 'need', 'budget', 'authority', 'timing', 'scheduler', 'completed'].forEach(stage => {
                const column = document.getElementById(`cards-${stage}`);
                column.innerHTML = '';
            });

            // Group leads by stage
            const stages = {
                sdr: [],
                need: [],
                budget: [],
                authority: [],
                timing: [],
                scheduler: [],
                completed: []
            };

            leadsKanbanData.forEach(lead => {
                // Determine which column to place the lead
                let targetStage = 'sdr';

                if (lead.stage === 'scheduler' || lead.currentAgent === 'scheduler') {
                    targetStage = 'scheduler';
                } else if (lead.stage === 'specialist' || lead.currentAgent === 'specialist') {
                    // Use BANT stage for specialist
                    targetStage = lead.bant_stage || 'need';
                } else if (lead.stage === 'sdr') {
                    targetStage = 'sdr';
                }

                if (stages[targetStage]) {
                    stages[targetStage].push(lead);
                }
            });

            // Render cards in each column
            Object.keys(stages).forEach(stage => {
                const column = document.getElementById(`cards-${stage}`);
                const leads = stages[stage];

                // ✨ ATUALIZAR HEADER com botão "Ver todos"
                const header = column.parentElement.querySelector('.column-header');
                const countElement = document.getElementById(`${stage}-count`);
                const statElement = document.getElementById(`count-${stage}-kanban`);

                // Atualizar contador
                if (countElement) countElement.textContent = leads.length;
                if (statElement) statElement.textContent = leads.length;

                // Remover botão anterior se existir
                const oldBtn = header?.querySelector('.header-expand-btn');
                if (oldBtn) oldBtn.remove();

                // Adicionar botão "Ver todos" no header se > 5 leads
                const MAX_VISIBLE = 5;
                if (leads.length > MAX_VISIBLE && header) {
                    const expandBtn = document.createElement('button');
                    expandBtn.className = 'header-expand-btn';
                    expandBtn.innerHTML = `👁️ Ver todos`;
                    expandBtn.onclick = (e) => openLeadsModal(stage, e);

                    // Inserir botão antes do count
                    header.insertBefore(expandBtn, countElement);
                }

                // Renderizar cards
                if (leads.length === 0) {
                    column.innerHTML = '<div class="empty-column">Nenhum lead neste estágio</div>';
                } else if (stage === 'need') {
                    // ✨ ESPECIAL NEED: Agrupar por serviço + limitar a 5
                    column.innerHTML = renderNeedStageWithServices(leads, MAX_VISIBLE);
                } else {
                    // ✨ OUTROS ESTÁGIOS: Limitar a 5 cards
                    const visibleLeads = leads.slice(0, MAX_VISIBLE);
                    column.innerHTML = visibleLeads.map(lead => createKanbanLeadCard(lead)).join('');
                }
            });

            // Update total
            document.getElementById('total-leads-kanban').textContent = leadsKanbanData.length;
        }

        // ✨ NOVA FUNÇÃO: Renderizar estágio NEED agrupado por módulo financeiro
        function renderNeedStageWithServices(leads, maxVisible = 5) {
            // Mapeamento de módulos financeiros
            const serviceEmojis = {
                dre: '',
                fluxo_caixa: '',
                estoque: '📦',
                indicadores: '',
                crm: '🤝',
                receitas: '💵',
                clientes: '👥'
            };

            const serviceNames = {
                dre: 'DRE - Demonstrativo de Resultados',
                fluxo_caixa: 'Fluxo de Caixa',
                estoque: 'Gestão de Estoque',
                indicadores: 'Indicadores Financeiros',
                crm: 'CRM Integrado',
                receitas: 'Receitas e Faturamento',
                clientes: 'Gestão de Clientes'
            };

            // Agrupar leads por módulo
            const leadsByService = {
                dre: [],
                fluxo_caixa: [],
                estoque: [],
                indicadores: [],
                crm: [],
                receitas: [],
                clientes: [],
                unclassified: []
            };

            leads.forEach(lead => {
                const servico = lead.servico_identificado || lead.bantStages?.need?.campos?.servico_identificado;

                if (servico && leadsByService[servico]) {
                    leadsByService[servico].push(lead);
                } else {
                    leadsByService.unclassified.push(lead);
                }
            });

            // ✨ LIMITAR a maxVisible leads no total
            let leadsRendered = 0;
            let html = '';

            // Renderizar cada grupo de serviço (apenas os que têm leads)
            Object.keys(leadsByService).forEach(serviceKey => {
                const serviceLeads = leadsByService[serviceKey];

                if (serviceLeads.length === 0 || leadsRendered >= maxVisible) return;

                const emoji = serviceEmojis[serviceKey] || '❓';
                const name = serviceNames[serviceKey] || 'Não Classificado';

                // Calcular quantos leads renderizar deste serviço
                const leadsToShow = Math.min(serviceLeads.length, maxVisible - leadsRendered);
                const visibleLeads = serviceLeads.slice(0, leadsToShow);

                html += `
                    <div class="service-group" data-service="${serviceKey}">
                        <div class="service-group-header">
                            ${emoji} ${name} (${serviceLeads.length})
                        </div>
                        <div class="service-group-cards">
                            ${visibleLeads.map(lead => createKanbanLeadCard(lead)).join('')}
                        </div>
                    </div>
                `;

                leadsRendered += leadsToShow;
            });

            return html || '<div class="empty-column">Nenhum lead neste estágio</div>';
        }

        // ✨ NOVA FUNÇÃO: Abrir modal com todos os leads do estágio
        function openLeadsModal(stage, event) {
            event.stopPropagation();

            // Mapeamento de nomes dos estágios
            const stageNames = {
                sdr: ' SDR - Prospecção',
                need: '🔍 NEED - Identificação',
                budget: ' BUDGET - Orçamento',
                authority: '👤 AUTHORITY - Decisor',
                timing: '⏰ TIMING - Urgência',
                scheduler: '📅 SCHEDULER - Agendamento',
                completed: ' COMPLETO'
            };

            // Pegar todos os leads deste estágio
            const stages = {
                sdr: [],
                need: [],
                budget: [],
                authority: [],
                timing: [],
                scheduler: [],
                completed: []
            };

            leadsKanbanData.forEach(lead => {
                let targetStage = 'sdr';

                if (lead.stage === 'scheduler' || lead.currentAgent === 'scheduler') {
                    targetStage = 'scheduler';
                } else if (lead.stage === 'specialist' || lead.currentAgent === 'specialist') {
                    targetStage = lead.bant_stage || 'need';
                } else if (lead.stage === 'sdr') {
                    targetStage = 'sdr';
                }

                if (stages[targetStage]) {
                    stages[targetStage].push(lead);
                }
            });

            const leads = stages[stage] || [];

            // Atualizar título do modal
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.innerHTML = `${stageNames[stage]} <span style="color: var(--cyan); margin-left: 8px;">(${leads.length} leads)</span>`;

            // Renderizar cards no grid do modal
            const modalGrid = document.getElementById('modalLeadsGrid');
            modalGrid.innerHTML = leads.map(lead => createKanbanLeadCard(lead)).join('');

            // Mostrar modal
            const modal = document.getElementById('leadsModal');
            modal.classList.add('active');

            // Fechar modal ao clicar no overlay
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeLeadsModal();
                }
            });
        }

        // ✨ NOVA FUNÇÃO: Fechar modal
        function closeLeadsModal() {
            const modal = document.getElementById('leadsModal');
            modal.classList.remove('active');
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLeadsModal();
            }
        });

        // Create lead card HTML with expandable details
        function createKanbanLeadCard(lead) {
            const stageName = lead.bant_stage ? lead.bant_stage.toUpperCase() : (lead.stage || 'SDR').toUpperCase();

            return `
                <div class="lead-card" draggable="true" data-lead-id="${lead.id}"
                     ondragstart="dragStartKanban(event)" ondragend="dragEndKanban(event)"
                     onclick="toggleCardExpand(event)">

                    <!-- Conteúdo resumido (sempre visível) -->
                    <div class="card-summary">
                        <div class="card-header">
                            <div class="card-name">${lead.nome}</div>
                            ${lead.score > 0 ? `<div class="card-score">${lead.score}</div>` : ''}
                        </div>
                        <div class="card-info">${lead.telefone}</div>
                        ${lead.empresa !== 'N/A' ? `<div class="card-info">${lead.empresa}</div>` : ''}
                    </div>

                    <!-- Conteúdo detalhado (expandível) -->
                    <div class="card-details" style="display: none;">
                        <!-- NEED Stage -->
                        ${lead.nicho ? `
                        <div class="detail-section">
                            <div class="detail-label">Nicho:</div>
                            <div class="detail-value">${lead.nicho}</div>
                        </div>` : `
                        <div class="detail-section">
                            <div class="detail-label">Setor:</div>
                            <div class="detail-value">${lead.setor || 'N/A'}</div>
                        </div>`}
                        ${lead.cargo_funcao ? `
                        <div class="detail-section">
                            <div class="detail-label">Função:</div>
                            <div class="detail-value">${lead.cargo_funcao}</div>
                        </div>` : ''}
                        ${lead.problema ? `
                        <div class="detail-section">
                            <div class="detail-label">Problema:</div>
                            <div class="detail-value">${lead.problema}</div>
                        </div>` : ''}
                        ${lead.intensidade ? `
                        <div class="detail-section">
                            <div class="detail-label">Intensidade:</div>
                            <div class="detail-value">${lead.intensidade}/10</div>
                        </div>` : ''}
                        ${lead.receita_mensal ? `
                        <div class="detail-section">
                            <div class="detail-label">Receita Mensal:</div>
                            <div class="detail-value">${lead.receita_mensal}</div>
                        </div>` : ''}
                        ${lead.funcionarios ? `
                        <div class="detail-section">
                            <div class="detail-label">Funcionários:</div>
                            <div class="detail-value">${lead.funcionarios}</div>
                        </div>` : ''}

                        <!-- BUDGET Stage -->
                        ${lead.investimento ? `
                        <div class="detail-section">
                            <div class="detail-label">Investimento:</div>
                            <div class="detail-value">${lead.investimento}</div>
                        </div>` : ''}

                        <!-- AUTHORITY Stage -->
                        ${lead.decisor ? `
                        <div class="detail-section">
                            <div class="detail-label">Decisor:</div>
                            <div class="detail-value">${lead.decisor}</div>
                        </div>` : ''}

                        <!-- TIMING Stage -->
                        ${lead.urgencia ? `
                        <div class="detail-section">
                            <div class="detail-label">Urgência:</div>
                            <div class="detail-value">${lead.urgencia}</div>
                        </div>` : ''}
                        ${lead.prazo ? `
                        <div class="detail-section">
                            <div class="detail-label">Prazo:</div>
                            <div class="detail-value">${lead.prazo}</div>
                        </div>` : ''}

                        <!-- Metadata -->
                        ${lead.stage ? `
                        <div class="detail-section">
                            <div class="detail-label">Agente:</div>
                            <div class="detail-value">${lead.stage.toUpperCase()}</div>
                        </div>` : ''}
                        ${lead.updated_at ? `
                        <div class="detail-section">
                            <div class="detail-label">Última atualização:</div>
                            <div class="detail-value">${new Date(lead.updated_at).toLocaleString('pt-BR')}</div>
                        </div>` : ''}
                    </div>

                    <!-- Indicador de expansão -->
                    <div class="expand-indicator">▼</div>
                </div>
            `;
        }

        // Toggle card expansion on click
        function toggleCardExpand(event) {
            // Prevenir propagação para não interferir no drag
            event.stopPropagation();

            const card = event.currentTarget;
            const details = card.querySelector('.card-details');
            const indicator = card.querySelector('.expand-indicator');

            if (!details) return;

            const isExpanded = card.classList.contains('expanded');

            if (isExpanded) {
                // Colapsar
                card.classList.remove('expanded');
                details.style.display = 'none';
                indicator.style.transform = 'rotate(0deg)';
            } else {
                // Expandir
                card.classList.add('expanded');
                details.style.display = 'block';
                indicator.style.transform = 'rotate(180deg)';
            }
        }

        // Drag and Drop functions
        function dragStartKanban(event) {
            event.stopPropagation();

            // Make sure we're dragging the card, not a child element
            let target = event.target;
            while (target && !target.classList.contains('lead-card')) {
                target = target.parentElement;
            }

            if (!target) {
                console.error(' Drag target não é um card válido');
                return;
            }

            draggedKanbanElement = target;
            target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', target.dataset.leadId || '');

            console.log(' Drag iniciado:', target.dataset.leadId);
        }

        function dragEndKanban(event) {
            event.stopPropagation();

            let target = event.target;
            while (target && !target.classList.contains('lead-card')) {
                target = target.parentElement;
            }

            if (target) {
                target.classList.remove('dragging');
            }

            console.log(' Drag finalizado');
        }

        function allowDropKanban(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('drag-over');
        }

        function dragLeaveKanban(event) {
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
        }

        async function dropKanban(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedKanbanElement) {
                console.warn(' Nenhum elemento sendo arrastado');
                return;
            }

            const targetColumn = event.currentTarget;
            const leadId = draggedKanbanElement.dataset.leadId;
            const newStage = targetColumn.parentElement.dataset.stage;

            console.log(`📦 Drop: movendo lead ${leadId} para ${newStage}`);

            if (!leadId || !newStage) {
                console.error(' leadId ou newStage inválido', { leadId, newStage });
                showAlert('Erro: dados inválidos para movimentação', 'error');
                return;
            }

            // Remove empty message if exists
            const emptyMsg = targetColumn.querySelector('.empty-column');
            if (emptyMsg) emptyMsg.remove();

            // Move card to new column visually
            targetColumn.appendChild(draggedKanbanElement);

            // Update backend
            await updateKanbanLeadStage(leadId, newStage);

            // Refresh counts and board
            loadKanbanLeads();
        }

        // Update lead stage in backend
        async function updateKanbanLeadStage(leadId, newStage) {
            try {
                const response = await fetch('/api/leads/update-stage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        leadId,
                        stage: newStage
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao atualizar estágio');
                }

                console.log(`Lead ${leadId} movido para ${newStage}`);
            } catch (error) {
                console.error('Erro ao atualizar lead:', error);
                showAlert('Erro ao atualizar estágio do lead. Recarregue a página.', 'error');
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (currentTab === 'funil-bant') {
                loadKanbanLeads();
            }
        }, 30000);

        // Load analytics on page load
        window.addEventListener('load', () => {
            refreshStats();
            checkGoogleAuth();
            refreshAgentMetrics();
        });

        // Auto-refresh stats every 30 seconds (otimizado - reduz 86% das requisições)
        setInterval(refreshStats, 30000);

        // ============================================
        // AUTOMATION ENGINE FUNCTIONS
        // ============================================

        // Load automations list
        async function loadAutomations() {
            try {
                const response = await fetch('/api/automations');
                const data = await response.json();

                const container = document.getElementById('automations-list');

                if (!data.success || !data.automations || data.automations.length === 0) {
                    container.innerHTML = `
                        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                            Nenhuma automação configurada. Instale um template acima para começar.
                        </p>
                    `;
                    return;
                }

                container.innerHTML = data.automations.map(automation => `
                    <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-weight: 600; color: var(--text-light);">${automation.name}</div>
                                <span style="
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    background: ${automation.enabled ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                    color: ${automation.enabled ? 'var(--success)' : 'var(--danger)'};
                                ">${automation.enabled ? 'Ativo' : 'Inativo'}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                ${automation.description || 'Sem descrição'}
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                                Trigger: ${automation.trigger?.type || 'N/A'}
                                ${automation.trigger?.cron ? `(${automation.trigger.cron})` : ''}
                                ${automation.trigger?.event ? `(${automation.trigger.event})` : ''}
                                | Execuções: ${automation.total_executions || 0}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-small btn-secondary" onclick="runAutomation('${automation.id}')" title="Executar agora">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="toggleAutomation('${automation.id}', ${!automation.enabled})" title="${automation.enabled ? 'Desativar' : 'Ativar'}">
                                <i class="fas fa-${automation.enabled ? 'pause' : 'play-circle'}"></i>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="deleteAutomation('${automation.id}')" title="Excluir" style="color: var(--danger);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                // Update active count
                document.getElementById('stat-automations-active').textContent =
                    data.automations.filter(a => a.enabled).length;

            } catch (error) {
                console.error('Error loading automations:', error);
                showAlert('Erro ao carregar automações', 'error');
            }
        }

        // Load execution history
        async function loadExecutions() {
            try {
                const response = await fetch('/api/automations/executions/recent?limit=50');
                const data = await response.json();

                const container = document.getElementById('executions-list');

                if (!data.success || !data.executions || data.executions.length === 0) {
                    container.innerHTML = `
                        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                            Nenhuma execução registrada ainda.
                        </p>
                    `;
                    return;
                }

                container.innerHTML = data.executions.map(exec => `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        border-bottom: 1px solid var(--border);
                    ">
                        <div>
                            <div style="font-weight: 500; color: var(--text-light);">${exec.automation_name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">
                                ${new Date(exec.executed_at).toLocaleString('pt-BR')}
                                | ${exec.matched_count} itens | ${exec.duration_ms}ms
                            </div>
                        </div>
                        <span style="
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 11px;
                            background: ${exec.status === 'success' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                            color: ${exec.status === 'success' ? 'var(--success)' : 'var(--danger)'};
                        ">${exec.status === 'success' ? 'Sucesso' : 'Falha'}</span>
                    </div>
                `).join('');

                // Update today's execution count
                const today = new Date().toDateString();
                const todayCount = data.executions.filter(e =>
                    new Date(e.executed_at).toDateString() === today
                ).length;
                document.getElementById('stat-executions-today').textContent = todayCount;

            } catch (error) {
                console.error('Error loading executions:', error);
            }
        }

        // Load engine stats
        async function loadEngineStats() {
            try {
                const response = await fetch('/api/automations/engine/stats');
                const data = await response.json();

                if (data.success && data.stats) {
                    const stats = data.stats;

                    // Calculate success rate
                    const successRate = stats.executionsTotal > 0
                        ? Math.round((stats.executionsSuccess / stats.executionsTotal) * 100)
                        : 100;

                    document.getElementById('stat-automations-success').textContent = successRate + '%';

                    if (stats.lastExecution) {
                        const lastExec = new Date(stats.lastExecution);
                        document.getElementById('stat-last-execution').textContent =
                            lastExec.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    }
                }
            } catch (error) {
                console.error('Error loading engine stats:', error);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // PROSPECTING ENGINE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════

        let prospectingRefreshInterval = null;

        // Load prospecting status and metrics
        async function loadProspectingStatus() {
            try {
                const response = await fetch('/api/prospecting/status');
                const data = await response.json();

                if (!data.success) {
                    console.error('Error loading prospecting status');
                    return;
                }

                const status = data.data;
                updateProspectingUI(status);

            } catch (error) {
                console.error('Error loading prospecting status:', error);
            }
        }

        // Update UI with prospecting status
        function updateProspectingUI(status) {
            // Status badge
            const statusEl = document.getElementById('prosp-status');
            const statusColors = {
                'stopped': 'var(--text-muted)',
                'running': 'var(--success)',
                'paused': 'var(--warning)',
                'processing': 'var(--primary)'
            };
            const statusLabels = {
                'stopped': 'PARADO',
                'running': 'RODANDO',
                'paused': 'PAUSADO',
                'processing': 'PROCESSANDO'
            };
            statusEl.innerHTML = `<span class="status-badge" style="background: ${statusColors[status.state] || 'var(--text-muted)'}; padding: 6px 12px; border-radius: 4px;">${statusLabels[status.state] || status.state}</span>`;

            // Update status card color
            const statusCard = document.getElementById('prospecting-status-card');
            if (status.state === 'running' || status.state === 'processing') {
                statusCard.style.borderLeft = '4px solid var(--success)';
            } else if (status.state === 'paused') {
                statusCard.style.borderLeft = '4px solid var(--warning)';
            } else {
                statusCard.style.borderLeft = '';
            }

            // Queue size
            document.getElementById('prosp-queue').textContent = status.queueSize || 0;

            // Config values
            if (status.config) {
                document.getElementById('prosp-interval').textContent = status.config.intervalMinutes || 5;
                document.getElementById('prosp-interval-slider').value = status.config.intervalMinutes || 5;
                document.getElementById('prosp-max-day').textContent = status.config.maxPerDay || 100;
                document.getElementById('prosp-max-slider').value = status.config.maxPerDay || 100;
                document.getElementById('prosp-limit').textContent = status.config.maxPerDay || 100;
                document.getElementById('prosp-cooldown').textContent = status.config.cooldownHours || 24;
                document.getElementById('prosp-work-hours').textContent =
                    `${String(status.config.startHour || 8).padStart(2, '0')}:00 - ${String(status.config.endHour || 18).padStart(2, '0')}:00`;
            }

            // Metrics
            if (status.metrics) {
                document.getElementById('prosp-sent-today').textContent = status.metrics.totalSent || 0;
                document.getElementById('prosp-total-processed').textContent = status.metrics.totalProcessed || 0;
                document.getElementById('prosp-total-sent').textContent = status.metrics.totalSent || 0;
                document.getElementById('prosp-total-failed').textContent = status.metrics.totalFailed || 0;
                document.getElementById('prosp-total-skipped').textContent = status.metrics.totalSkipped || 0;
                document.getElementById('prosp-failed').textContent = status.metrics.totalFailed || 0;

                // Success rate
                const total = status.metrics.totalProcessed || 0;
                const failed = status.metrics.totalFailed || 0;
                const successRate = total > 0 ? Math.round(((total - failed) / total) * 100) : 100;
                document.getElementById('prosp-success-rate').textContent = successRate + '%';

                // Session start
                if (status.metrics.sessionStart) {
                    document.getElementById('prosp-session-start').textContent =
                        new Date(status.metrics.sessionStart).toLocaleString('pt-BR');
                } else {
                    document.getElementById('prosp-session-start').textContent = '-';
                }

                // Last processed
                if (status.metrics.lastProcessedAt) {
                    document.getElementById('prosp-last-sent').textContent =
                        new Date(status.metrics.lastProcessedAt).toLocaleString('pt-BR');
                } else {
                    document.getElementById('prosp-last-sent').textContent = '-';
                }

                // Skip reasons
                const skipReasons = status.metrics.skipReasons || {};
                document.getElementById('skip-invalid-phone').textContent = skipReasons.invalid_phone || 0;
                document.getElementById('skip-already-prospected').textContent = skipReasons.already_prospected || 0;
                document.getElementById('skip-opt-out').textContent = skipReasons.opt_out || 0;
                document.getElementById('skip-recently-contacted').textContent = skipReasons.recently_contacted || 0;
            }

            // Update button states
            updateProspectingButtons(status.state);

            // Next send time
            if (status.nextProcessAt) {
                document.getElementById('prosp-next-send').textContent =
                    `Proximo: ${new Date(status.nextProcessAt).toLocaleTimeString('pt-BR')}`;
            } else if (status.state === 'running') {
                document.getElementById('prosp-next-send').textContent = 'Processando...';
            } else {
                document.getElementById('prosp-next-send').textContent = 'Aguardando...';
            }
        }

        // Update button states based on engine state
        function updateProspectingButtons(state) {
            const btnStart = document.getElementById('btn-prosp-start');
            const btnPause = document.getElementById('btn-prosp-pause');
            const btnResume = document.getElementById('btn-prosp-resume');
            const btnStop = document.getElementById('btn-prosp-stop');

            switch(state) {
                case 'stopped':
                    btnStart.disabled = false;
                    btnPause.disabled = true;
                    btnResume.disabled = true;
                    btnStop.disabled = true;
                    break;
                case 'running':
                case 'processing':
                    btnStart.disabled = true;
                    btnPause.disabled = false;
                    btnResume.disabled = true;
                    btnStop.disabled = false;
                    // Start auto-refresh
                    startProspectingAutoRefresh();
                    break;
                case 'paused':
                    btnStart.disabled = true;
                    btnPause.disabled = true;
                    btnResume.disabled = false;
                    btnStop.disabled = false;
                    break;
            }
        }

        // Start auto-refresh for prospecting status
        function startProspectingAutoRefresh() {
            if (prospectingRefreshInterval) return;
            prospectingRefreshInterval = setInterval(() => {
                if (currentTab === 'prospecting') {
                    loadProspectingStatus();
                }
            }, 5000); // Refresh every 5 seconds
        }

        // Stop auto-refresh
        function stopProspectingAutoRefresh() {
            if (prospectingRefreshInterval) {
                clearInterval(prospectingRefreshInterval);
                prospectingRefreshInterval = null;
            }
        }

        // Control prospecting engine
        async function prospectingControl(action) {
            try {
                let endpoint = `/api/prospecting/${action}`;
                let method = 'POST';

                const response = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    const messages = {
                        'start': 'Motor de prospeccao iniciado!',
                        'stop': 'Motor de prospeccao parado.',
                        'pause': 'Motor pausado.',
                        'resume': 'Motor retomado.',
                        'test': 'Modo teste iniciado (dry-run).'
                    };
                    showAlert(messages[action] || 'Acao executada', 'success');

                    // Add to activity feed
                    addProspectingActivity(`Motor ${action === 'start' ? 'iniciado' : action === 'stop' ? 'parado' : action === 'pause' ? 'pausado' : action === 'resume' ? 'retomado' : 'em modo teste'}`, 'info');

                    // Reload status
                    setTimeout(loadProspectingStatus, 500);

                    // Handle auto-refresh
                    if (action === 'start' || action === 'test') {
                        startProspectingAutoRefresh();
                    } else if (action === 'stop') {
                        stopProspectingAutoRefresh();
                    }

                } else {
                    showAlert(data.error || 'Erro ao executar acao', 'error');
                }

            } catch (error) {
                console.error('Prospecting control error:', error);
                showAlert('Erro de conexao', 'error');
            }
        }

        // Update prospecting config
        async function updateProspConfig(key, value) {
            try {
                // Update display immediately
                if (key === 'intervalMinutes') {
                    document.getElementById('prosp-interval').textContent = value;
                } else if (key === 'maxPerDay') {
                    document.getElementById('prosp-max-day').textContent = value;
                    document.getElementById('prosp-limit').textContent = value;
                }

                const response = await fetch('/api/prospecting/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [key]: parseInt(value) })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Configuracao atualizada', 'success');
                } else {
                    showAlert(data.error || 'Erro ao atualizar', 'error');
                }

            } catch (error) {
                console.error('Config update error:', error);
            }
        }

        // Add activity to feed
        function addProspectingActivity(message, type = 'info') {
            const feed = document.getElementById('prosp-activity-feed');
            const colors = {
                'info': 'var(--primary)',
                'success': 'var(--success)',
                'error': 'var(--danger)',
                'warning': 'var(--warning)'
            };
            const icons = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-circle'
            };

            const entry = document.createElement('div');
            entry.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);';
            entry.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]};"></i>
                <div style="flex: 1;">
                    <span style="color: var(--text-light);">${message}</span>
                    <span style="color: var(--text-muted); font-size: 11px; margin-left: 8px;">
                        ${new Date().toLocaleTimeString('pt-BR')}
                    </span>
                </div>
            `;

            // Check if feed has placeholder
            if (feed.querySelector('p')) {
                feed.innerHTML = '';
            }

            feed.insertBefore(entry, feed.firstChild);

            // Keep only last 20 entries
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Load prospecting history from database
        async function loadProspectingHistory() {
            try {
                const response = await fetch('/api/prospecting/history?limit=50');
                const data = await response.json();

                const tbody = document.getElementById('prosp-history-body');

                if (!data.success || !data.data || data.data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                Nenhum registro de prospeccao ainda.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.data.map(entry => {
                    const statusColors = {
                        'success': 'var(--success)',
                        'dry_run': 'var(--primary)',
                        'failed': 'var(--danger)',
                        'error': 'var(--danger)'
                    };
                    const statusLabels = {
                        'success': 'Enviado',
                        'dry_run': 'Teste',
                        'failed': 'Falhou',
                        'error': 'Erro'
                    };

                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 12px; color: var(--text-muted); font-size: 12px;">
                                ${new Date(entry.prospected_at).toLocaleString('pt-BR')}
                            </td>
                            <td style="padding: 12px; color: var(--text-light);">
                                ${entry.empresa || '-'}
                            </td>
                            <td style="padding: 12px; color: var(--text-muted); font-family: monospace;">
                                ${entry.phone ? entry.phone.replace(/(\d{2})(\d{2})(\d{5})(\d{4})/, '+$1 ($2) $3-$4') : '-'}
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    background: ${statusColors[entry.status] || 'var(--text-muted)'}20;
                                    color: ${statusColors[entry.status] || 'var(--text-muted)'};
                                ">${statusLabels[entry.status] || entry.status}</span>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading prospecting history:', error);
            }
        }

        // Install template
        async function installTemplate(templateId) {
            try {
                const response = await fetch(`/api/automations/templates/${templateId}/install`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Template instalado com sucesso!`, 'success');
                    loadAutomations();
                    loadEngineStats();
                } else {
                    showAlert(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error installing template:', error);
                showAlert('Erro ao instalar template', 'error');
            }
        }

        // Run automation manually
        async function runAutomation(id) {
            try {
                showAlert('Executando automação...', 'info');

                const response = await fetch(`/api/automations/${id}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    const matched = data.result?.matched || 0;
                    showAlert(`Automação executada! ${matched} itens processados.`, 'success');
                    loadExecutions();
                    loadEngineStats();
                } else {
                    showAlert(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error running automation:', error);
                showAlert('Erro ao executar automação', 'error');
            }
        }

        // Toggle automation enabled/disabled
        async function toggleAutomation(id, enabled) {
            try {
                const response = await fetch(`/api/automations/${id}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Automação ${enabled ? 'ativada' : 'desativada'}!`, 'success');
                    loadAutomations();
                } else {
                    showAlert(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error toggling automation:', error);
                showAlert('Erro ao alterar status', 'error');
            }
        }

        // Delete automation
        async function deleteAutomation(id) {
            if (!confirm('Tem certeza que deseja excluir esta automação?')) {
                return;
            }

            try {
                const response = await fetch(`/api/automations/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Automação excluída!', 'success');
                    loadAutomations();
                } else {
                    showAlert(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting automation:', error);
                showAlert('Erro ao excluir automação', 'error');
            }
        }

        // Initialize engine
        async function initializeEngine() {
            try {
                const response = await fetch('/api/automations/engine/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    loadEngineStats();
                } else {
                    showAlert(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error initializing engine:', error);
                showAlert('Erro ao inicializar engine', 'error');
            }
        }

        // ======================================
        // AGENTS MANAGEMENT (with XSS protection)
        // ======================================

        // BANT fields configuration (default)
        const defaultBantFields = {
            budget: { label: 'Orcamento', weight: 25 },
            authority: { label: 'Autoridade', weight: 20 },
            need: { label: 'Necessidade', weight: 30 },
            timeline: { label: 'Prazo', weight: 25 },
            company_size: { label: 'Tamanho Empresa', weight: 10 },
            decision_process: { label: 'Processo Decisao', weight: 15 },
            current_solution: { label: 'Solucao Atual', weight: 10 },
            pain_points: { label: 'Dores', weight: 20 }
        };

        // Load agents list
        async function loadAgentsList() {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/agents', {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                const data = await response.json();

                const container = document.getElementById('agents-list');
                if (!container) return;

                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; grid-column: 1/-1;">
                            <i class="fas fa-robot" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i>
                            <p style="color: var(--text-muted);">Nenhum agente configurado ainda.</p>
                            <p style="color: var(--text-muted); font-size: 12px;">Clique em "Novo Agente" ou selecione um template abaixo.</p>
                        </div>
                    `;
                    updateAgentStats({ total: 0, active: 0 });
                    return;
                }

                const agents = data.data;
                let activeCount = 0;

                container.innerHTML = agents.map(agent => {
                    if (agent.status === 'active') activeCount++;
                    const statusColor = agent.status === 'active' ? 'var(--success)' : 'var(--warning)';
                    const statusLabel = agent.status === 'active' ? 'Ativo' : 'Rascunho';
                    const typeIcons = { sdr: 'fa-user-tie', specialist: 'fa-brain', scheduler: 'fa-calendar-check', support: 'fa-headset' };

                    return `
                        <div class="stat-card agent-card" style="position: relative;">
                            <div style="display: flex; gap: 16px; align-items: start;">
                                <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--cyan), var(--violet)); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas ${typeIcons[agent.type] || 'fa-robot'}" style="font-size: 20px; color: white;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <h3 style="color: var(--text-light); margin-bottom: 4px;">${escapeHtml(agent.name)}</h3>
                                        <span style="font-size: 10px; padding: 2px 8px; border-radius: 4px; background: ${statusColor}20; color: ${statusColor};">${statusLabel}</span>
                                    </div>
                                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                        ${escapeHtml(agent.persona?.companyName || 'Empresa nao definida')}
                                    </p>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                                        <span style="font-size: 10px; background: rgba(24, 197, 255, 0.2); color: var(--cyan); padding: 2px 8px; border-radius: 4px;">${escapeHtml(agent.type?.toUpperCase() || 'SDR')}</span>
                                        ${agent.persona?.sector ? `<span style="font-size: 10px; background: rgba(124, 92, 255, 0.2); color: var(--violet); padding: 2px 8px; border-radius: 4px;">${escapeHtml(agent.persona.sector)}</span>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-secondary btn-small" onclick="editAgent('${escapeHtml(agent.id)}')">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        <button class="btn btn-secondary btn-small" onclick="viewAgentConfig('${escapeHtml(agent.id)}')">
                                            <i class="fas fa-cog"></i> Config
                                        </button>
                                        <button class="btn btn-secondary btn-small" style="color: var(--danger);" onclick="deleteAgent('${escapeHtml(agent.id)}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                updateAgentStats({ total: agents.length, active: activeCount });

            } catch (error) {
                console.error('Error loading agents:', error);
                const container = document.getElementById('agents-list');
                if (container) {
                    container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 20px;">Erro ao carregar agentes</p>`;
                }
            }
        }

        // Update agent statistics
        function updateAgentStats(stats) {
            const totalEl = document.getElementById('agents-total');
            const activeEl = document.getElementById('agents-active');
            if (totalEl) totalEl.textContent = stats.total || 0;
            if (activeEl) activeEl.textContent = stats.active || 0;
        }

        // Show new agent modal
        function showNewAgentModal() {
            document.getElementById('agentModalTitle').textContent = 'Novo Agente';
            document.getElementById('agent-id').value = '';
            document.getElementById('agentForm').reset();
            loadBantFieldsUI();
            document.getElementById('agentModal').style.display = 'flex';
        }

        // Close agent modal
        function closeAgentModal() {
            document.getElementById('agentModal').style.display = 'none';
        }

        // Close agent config modal
        function closeAgentConfigModal() {
            document.getElementById('agentConfigModal').style.display = 'none';
        }

        // ============================================
        // WHATSAPP / EVOLUTION API INTEGRATION
        // ============================================

        let currentAgentForWhatsApp = null;
        let qrCheckInterval = null;

        function closeWhatsappQrModal() {
            document.getElementById('whatsappQrModal').style.display = 'none';
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
        }

        async function checkEvolutionStatus(agentId) {
            const statusContainer = document.getElementById('whatsapp-integration-status');
            if (!statusContainer) return;

            statusContainer.innerHTML = '<p style="color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Verificando status...</p>';

            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/whatsapp/status', {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                const data = await response.json();

                if (data.success && data.data?.connected) {
                    statusContainer.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
                            <div>
                                <p style="color: var(--success); font-weight: 600; margin-bottom: 4px;">WhatsApp Conectado</p>
                                <p style="font-size: 12px; color: var(--text-muted);">Numero: ${escapeHtml(data.data.phoneNumber || 'N/A')}</p>
                                <p style="font-size: 12px; color: var(--text-muted);">Instancia: ${escapeHtml(data.data.instance || 'digitalboost')}</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusContainer.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 12px; height: 12px; background: var(--danger); border-radius: 50%;"></div>
                            <div>
                                <p style="color: var(--danger); font-weight: 600; margin-bottom: 4px;">WhatsApp Desconectado</p>
                                <p style="font-size: 12px; color: var(--text-muted);">Clique em "Conectar WhatsApp" para configurar</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error checking Evolution status:', error);
                statusContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></div>
                        <div>
                            <p style="color: var(--warning); font-weight: 600; margin-bottom: 4px;">Status Desconhecido</p>
                            <p style="font-size: 12px; color: var(--text-muted);">Erro ao verificar: ${escapeHtml(error.message)}</p>
                        </div>
                    </div>
                `;
            }
        }

        async function connectWhatsApp(agentId) {
            currentAgentForWhatsApp = agentId;
            const modal = document.getElementById('whatsappQrModal');
            modal.style.display = 'flex';

            // Show loading state
            document.getElementById('qr-loading').style.display = 'block';
            document.getElementById('qr-code-container').style.display = 'none';
            document.getElementById('qr-connected').style.display = 'none';
            document.getElementById('qr-error').style.display = 'none';

            try {
                const token = localStorage.getItem('auth_token');

                // Request QR code from Evolution API
                const response = await fetch('/api/agents/evolution/qrcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                    },
                    body: JSON.stringify({ agentId, instanceName: 'digitalboost' })
                });

                const data = await response.json();

                if (data.success && data.data?.qrcode) {
                    // Show QR Code
                    document.getElementById('qr-loading').style.display = 'none';
                    document.getElementById('qr-code-container').style.display = 'block';
                    document.getElementById('qr-code-image').src = data.data.qrcode;

                    // Start polling for connection status
                    startConnectionPolling(agentId);
                } else if (data.data?.connected) {
                    // Already connected
                    document.getElementById('qr-loading').style.display = 'none';
                    document.getElementById('qr-connected').style.display = 'block';
                    document.getElementById('connected-phone').textContent = 'Numero: ' + (data.data.phoneNumber || 'Conectado');
                } else {
                    throw new Error(data.error || 'Falha ao gerar QR Code');
                }
            } catch (error) {
                console.error('Error connecting WhatsApp:', error);
                document.getElementById('qr-loading').style.display = 'none';
                document.getElementById('qr-error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message || 'Erro desconhecido';
            }
        }

        function startConnectionPolling(agentId) {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
            }

            let attempts = 0;
            const maxAttempts = 60; // 2 minutes (2s intervals)

            qrCheckInterval = setInterval(async () => {
                attempts++;

                if (attempts >= maxAttempts) {
                    clearInterval(qrCheckInterval);
                    document.getElementById('qr-code-container').style.display = 'none';
                    document.getElementById('qr-error').style.display = 'block';
                    document.getElementById('error-message').textContent = 'Tempo esgotado. Tente novamente.';
                    return;
                }

                try {
                    const token = localStorage.getItem('auth_token');
                    const response = await fetch('/api/whatsapp/status', {
                        headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                    });
                    const data = await response.json();

                    if (data.success && data.data?.connected) {
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;

                        // Show success
                        document.getElementById('qr-code-container').style.display = 'none';
                        document.getElementById('qr-connected').style.display = 'block';
                        document.getElementById('connected-phone').textContent = 'Numero: ' + (data.data.phoneNumber || 'Conectado');

                        showAlert('WhatsApp conectado com sucesso!', 'success');

                        // Update status in config modal
                        setTimeout(() => {
                            checkEvolutionStatus(agentId);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function retryWhatsappConnection() {
            if (currentAgentForWhatsApp) {
                connectWhatsApp(currentAgentForWhatsApp);
            }
        }

        // Close WhatsApp modal on click outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'whatsappQrModal') {
                closeWhatsappQrModal();
            }
        });

        // ============================================
        // END WHATSAPP INTEGRATION
        // ============================================

        // Load BANT fields UI
        function loadBantFieldsUI(selectedFields = null) {
            const container = document.getElementById('bant-fields-container');
            if (!container) return;

            container.innerHTML = Object.entries(defaultBantFields).map(([key, field]) => {
                const checked = selectedFields ? (selectedFields[key] ? 'checked' : '') : (key === 'budget' || key === 'authority' || key === 'need' || key === 'timeline' ? 'checked' : '');
                return `
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--glass-bg);">
                        <input type="checkbox" name="bant_${key}" value="${key}" ${checked}>
                        <span style="font-size: 13px;">${escapeHtml(field.label)}</span>
                    </label>
                `;
            }).join('');
        }

        // Load sector defaults
        async function loadSectorDefaults(sector) {
            if (!sector) return;
            try {
                const response = await fetch(`/api/config/sector-defaults/${sector}`);
                const data = await response.json();

                if (data.success && data.data.bantFields) {
                    loadBantFieldsUI(data.data.bantFields);
                }
            } catch (error) {
                console.error('Error loading sector defaults:', error);
            }
        }

        // Save agent (create or update)
        async function saveAgent(event) {
            event.preventDefault();

            const agentId = document.getElementById('agent-id').value;
            const isEdit = !!agentId;

            // Collect form data
            const agentData = {
                name: document.getElementById('agent-name').value.trim(),
                type: document.getElementById('agent-type').value,
                status: document.getElementById('agent-active').checked ? 'active' : 'draft',
                persona: {
                    companyName: document.getElementById('agent-company').value.trim(),
                    sector: document.getElementById('agent-sector').value,
                    role: 'SDR',
                    personality: 'consultivo'
                },
                behavior: {
                    description: document.getElementById('agent-description').value.trim(),
                    valueProposition: document.getElementById('agent-value-prop').value.trim(),
                    offerings: document.getElementById('agent-offerings').value.split('\n').filter(x => x.trim()),
                    cta: {
                        type: document.getElementById('agent-cta-type').value,
                        description: document.getElementById('agent-cta-desc').value.trim(),
                        duration: document.getElementById('agent-cta-duration').value.trim(),
                        valueForLead: document.getElementById('agent-cta-value').value.trim()
                    }
                }
            };

            // Collect BANT fields
            const bantFields = {};
            document.querySelectorAll('#bant-fields-container input[type="checkbox"]:checked').forEach(cb => {
                const key = cb.value;
                bantFields[key] = defaultBantFields[key] || { label: key, weight: 10 };
            });
            agentData.behavior.bantFields = bantFields;

            // Input validation (security)
            if (!agentData.name || agentData.name.length < 2) {
                showAlert('Nome do agente deve ter pelo menos 2 caracteres', 'error');
                return;
            }
            if (!agentData.persona.companyName) {
                showAlert('Nome da empresa e obrigatorio', 'error');
                return;
            }
            if (!agentData.persona.sector) {
                showAlert('Selecione um setor', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const url = isEdit ? `/api/agents/${agentId}` : '/api/agents';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                    },
                    body: JSON.stringify(agentData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(isEdit ? 'Agente atualizado!' : 'Agente criado!', 'success');
                    closeAgentModal();
                    loadAgentsList();
                } else {
                    showAlert('Erro: ' + (data.error || 'Falha ao salvar'), 'error');
                }
            } catch (error) {
                console.error('Error saving agent:', error);
                showAlert('Erro ao salvar agente', 'error');
            }
        }

        // Edit agent
        async function editAgent(agentId) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/agents/${agentId}`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                const data = await response.json();

                if (!data.success || !data.data) {
                    showAlert('Agente nao encontrado', 'error');
                    return;
                }

                const agent = data.data;

                document.getElementById('agentModalTitle').textContent = 'Editar Agente';
                document.getElementById('agent-id').value = agent.id;
                document.getElementById('agent-name').value = agent.name || '';
                document.getElementById('agent-type').value = agent.type || 'sdr';
                document.getElementById('agent-company').value = agent.persona?.companyName || '';
                document.getElementById('agent-sector').value = agent.persona?.sector || '';
                document.getElementById('agent-description').value = agent.behavior?.description || '';
                document.getElementById('agent-value-prop').value = agent.behavior?.valueProposition || '';
                document.getElementById('agent-offerings').value = (agent.behavior?.offerings || []).join('\n');
                document.getElementById('agent-cta-type').value = agent.behavior?.cta?.type || 'reuniao';
                document.getElementById('agent-cta-desc').value = agent.behavior?.cta?.description || '';
                document.getElementById('agent-cta-duration').value = agent.behavior?.cta?.duration || '';
                document.getElementById('agent-cta-value').value = agent.behavior?.cta?.valueForLead || '';
                document.getElementById('agent-active').checked = agent.status === 'active';

                loadBantFieldsUI(agent.behavior?.bantFields);

                document.getElementById('agentModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading agent:', error);
                showAlert('Erro ao carregar agente', 'error');
            }
        }

        // Delete agent
        async function deleteAgent(agentId) {
            if (!confirm('Tem certeza que deseja excluir este agente?')) {
                return;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/agents/${agentId}`, {
                    method: 'DELETE',
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Agente excluido!', 'success');
                    loadAgentsList();
                } else {
                    showAlert('Erro: ' + (data.error || 'Falha ao excluir'), 'error');
                }
            } catch (error) {
                console.error('Error deleting agent:', error);
                showAlert('Erro ao excluir agente', 'error');
            }
        }

        // View agent configuration
        async function viewAgentConfig(agentId) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/agents/${agentId}/config`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                const data = await response.json();

                const modal = document.getElementById('agentConfigModal');
                const title = document.getElementById('agentConfigTitle');
                const content = document.getElementById('agentConfigContent');

                if (!data.success) {
                    title.textContent = 'Configuracao do Agente';
                    content.innerHTML = `
                        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
                            Nenhuma configuracao avancada definida para este agente.<br>
                            <button class="btn btn-primary btn-small" style="margin-top: 16px;" onclick="generateAgentConfig('${escapeHtml(agentId)}')">
                                <i class="fas fa-magic"></i> Gerar Configuracao
                            </button>
                        </p>
                    `;
                } else {
                    const config = data.data;
                    title.textContent = 'Configuracao: ' + escapeHtml(config.identity?.agentName || 'Agente');
                    content.innerHTML = `
                        <div style="display: grid; gap: 16px;">
                            <!-- SECAO WHATSAPP INTEGRATION -->
                            <div class="stat-card" style="border: 2px solid #25D366;">
                                <h4 style="color: #25D366; margin-bottom: 12px;"><i class="fab fa-whatsapp"></i> Integracao WhatsApp</h4>
                                <div id="whatsapp-integration-status" style="margin-bottom: 12px;">
                                    <p style="color: var(--text-muted);">Verificando status...</p>
                                </div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <button class="btn btn-secondary btn-small" onclick="checkEvolutionStatus('${escapeHtml(agentId)}')">
                                        <i class="fas fa-sync-alt"></i> Verificar Status
                                    </button>
                                    <button class="btn btn-primary btn-small" style="background: #25D366; border-color: #25D366;" onclick="connectWhatsApp('${escapeHtml(agentId)}')">
                                        <i class="fab fa-whatsapp"></i> Conectar WhatsApp
                                    </button>
                                </div>
                            </div>

                            <div class="stat-card">
                                <h4 style="color: var(--cyan); margin-bottom: 8px;"><i class="fas fa-id-badge"></i> Identidade</h4>
                                <p><strong>Empresa:</strong> ${escapeHtml(config.identity?.companyName || '-')}</p>
                                <p><strong>Setor:</strong> ${escapeHtml(config.identity?.sector || '-')}</p>
                                <p><strong>Papel:</strong> ${escapeHtml(config.identity?.role || 'SDR')}</p>
                            </div>
                            <div class="stat-card">
                                <h4 style="color: var(--violet); margin-bottom: 8px;"><i class="fas fa-bullseye"></i> CTA</h4>
                                <p><strong>Tipo:</strong> ${escapeHtml(config.cta?.type || '-')}</p>
                                <p><strong>Descricao:</strong> ${escapeHtml(config.cta?.description || '-')}</p>
                                <p><strong>Valor:</strong> ${escapeHtml(config.cta?.valueForLead || '-')}</p>
                            </div>
                            <div class="stat-card">
                                <h4 style="color: var(--warning); margin-bottom: 8px;"><i class="fas fa-clipboard-check"></i> BANT</h4>
                                <p><strong>Campos:</strong> ${Object.keys(config.bantConfig?.fields || {}).map(k => escapeHtml(k)).join(', ') || 'Padrao'}</p>
                                <p><strong>Threshold:</strong> ${config.bantConfig?.qualificationThreshold || 60}%</p>
                            </div>
                            <div class="stat-card">
                                <h4 style="color: var(--success); margin-bottom: 8px;"><i class="fas fa-history"></i> Versao</h4>
                                <p><strong>Versao:</strong> ${config.version || 1}</p>
                                <p><strong>Criado:</strong> ${config.created_at ? new Date(config.created_at).toLocaleString() : '-'}</p>
                            </div>
                        </div>
                    `;
                    // Auto-check WhatsApp status
                    setTimeout(() => checkEvolutionStatus(agentId), 500);
                }

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading agent config:', error);
                showAlert('Erro ao carregar configuracao', 'error');
            }
        }

        // Generate agent config from template
        async function generateAgentConfig(agentId) {
            try {
                const token = localStorage.getItem('auth_token');
                // First get the agent data
                const agentResponse = await fetch(`/api/agents/${agentId}`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                const agentData = await agentResponse.json();

                if (!agentData.success) {
                    showAlert('Agente nao encontrado', 'error');
                    return;
                }

                const agent = agentData.data;

                // Generate config
                const configResponse = await fetch('/api/config/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                    },
                    body: JSON.stringify({
                        companyName: agent.persona?.companyName,
                        agentName: agent.name,
                        sector: agent.persona?.sector || 'consultoria',
                        description: agent.behavior?.description,
                        offerings: agent.behavior?.offerings,
                        valueProposition: agent.behavior?.valueProposition,
                        ctaDescription: agent.behavior?.cta?.description,
                        ctaType: agent.behavior?.cta?.type
                    })
                });

                const configData = await configResponse.json();

                if (configData.success) {
                    // Save the config
                    await fetch(`/api/agents/${agentId}/config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                        },
                        body: JSON.stringify({
                            config: configData.data,
                            tenantId: 'default'
                        })
                    });

                    showAlert('Configuracao gerada!', 'success');
                    closeAgentConfigModal();
                    viewAgentConfig(agentId);
                } else {
                    showAlert('Erro ao gerar configuracao', 'error');
                }
            } catch (error) {
                console.error('Error generating config:', error);
                showAlert('Erro ao gerar configuracao', 'error');
            }
        }

        // Create agent from template
        async function createAgentFromTemplate(templateType) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/agents/templates/${templateType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                    },
                    body: JSON.stringify({ tenantId: 'default' })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Agente ${templateType.toUpperCase()} criado!`, 'success');
                    loadAgentsList();
                    // Open edit modal to customize
                    if (data.data?.id) {
                        setTimeout(() => editAgent(data.data.id), 500);
                    }
                } else {
                    showAlert('Erro: ' + (data.error || 'Falha ao criar'), 'error');
                }
            } catch (error) {
                console.error('Error creating from template:', error);
                showAlert('Erro ao criar agente', 'error');
            }
        }

        // Show sector defaults
        async function showSectorDefaults(sector) {
            try {
                const response = await fetch(`/api/config/sector-defaults/${sector}`);
                const data = await response.json();

                if (data.success) {
                    // Pre-fill the new agent form with sector defaults
                    showNewAgentModal();
                    document.getElementById('agent-sector').value = sector;
                    loadSectorDefaults(sector);
                    showAlert(`Carregando defaults para ${sector}`, 'info');
                }
            } catch (error) {
                console.error('Error loading sector:', error);
            }
        }

        // Add agentes to loadTabContent
        const originalLoadTabContent = typeof loadTabContent === 'function' ? loadTabContent : null;

        async function loadTabContent(tabName) {
            if (originalLoadTabContent) {
                await originalLoadTabContent(tabName);
            }

            if (tabName === 'agentes') {
                loadAgentsList();
            }
        }

        // Close modals on click outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'agentModal') closeAgentModal();
                if (e.target.id === 'agentConfigModal') closeAgentConfigModal();
            }
        });
    </script>

    <!-- CRM Core Scripts -->
    <script src="/dashboard/core/utils.js"></script>
    <script src="/dashboard/core/api.js"></script>
    <script src="/dashboard/core/router.js"></script>

    <!-- CRM Module Scripts -->
    <script src="/dashboard/modules/pipeline.module.js"></script>
    <script src="/dashboard/modules/clientes.module.js"></script>

    <!-- Initialize CRM Modules -->
    <script>
        console.log(' CRM modules loaded');
    </script>

    <!-- ✨ MODAL: Ver Todos os Leads -->
    <div class="leads-modal-overlay" id="leadsModal">
        <div class="leads-modal-container">
            <div class="leads-modal-header">
                <div class="leads-modal-title" id="modalTitle">
                    <!-- Título dinâmico -->
                </div>
                <button class="leads-modal-close" onclick="closeLeadsModal()">
                    ✕
                </button>
            </div>
            <div class="leads-modal-body">
                <div class="leads-modal-grid" id="modalLeadsGrid">
                    <!-- Cards renderizados dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
