/**
 * ğŸ§ª TESTE COMPLETO DO FLUXO DE CAMPANHA
 * Simula:
 * 1. Envio de campanha (com salvamento de estado)
 * 2. Resposta do lead
 * 3. VerificaÃ§Ã£o se segunda primeira mensagem NÃƒO Ã© enviada
 * 4. VerificaÃ§Ã£o se fluxo BANT continua normalmente
 */

import { saveEnhancedState, getEnhancedState } from '../src/memory.js';
import { chatHandler } from '../src/agent.js';

console.log('\nğŸ§ª ===== TESTE DO FLUXO DE CAMPANHA =====\n');

// Limpar dados de teste anteriores
const TEST_PHONE = '5584999887766';
console.log(`ğŸ“ Testando com nÃºmero: ${TEST_PHONE}\n`);

async function testCampaignFlow() {
  try {
    // ========================================
    // ETAPA 1: SIMULAR ENVIO DE CAMPANHA
    // ========================================
    console.log('ğŸ“§ [ETAPA 1] Simulando envio de campanha...\n');

    const lead = {
      name: 'Ã“tica VisÃ£o Clara',
      phone: TEST_PHONE,
      sector: 'Ã“tica'
    };

    // Simulando mensagem de campanha (nÃ£o precisa gerar, sÃ³ testar o estado)
    const campaignMessage = `OlÃ¡ ${lead.name}, somos a Digital Boost. Como podemos ajudar?`;
    console.log('ğŸ“¨ Mensagem de campanha simulada');
    console.log('---');
    console.log(campaignMessage);
    console.log('---\n');

    // Salvar estado (simulando o que campaign_manager faz)
    const campaignState = {
      contactId: lead.phone,
      state: {
        current: 'opening',
        subState: 'first_contact',
        lastUpdate: new Date().toISOString()
      },
      bant: {
        budget: null,
        authority: null,
        need: null,
        timing: null,
        email: null
      },
      qualification: {
        score: 70,
        archetype: null,
        persona: null
      },
      engagement: {
        level: 'low',
        lastInteraction: new Date().toISOString()
      },
      metadata: {
        origin: 'campaign',  // ğŸ”‘ CAMPO CRÃTICO
        campaign_id: 'test_campaign_001',
        sent_at: new Date().toISOString(),
        lead_info: {
          name: lead.name,
          company: lead.name,
          sector: lead.sector
        }
      },
      nextBestAction: 'wait_for_response'
    };

    await saveEnhancedState(lead.phone, campaignState);
    console.log('âœ… Estado de campanha salvo no banco\n');

    // Verificar estado salvo
    const savedState = await getEnhancedState(lead.phone);
    console.log('ğŸ“Š Estado salvo verificado:');
    console.log(`   - origin: ${savedState?.metadata?.origin}`);
    console.log(`   - campaign_id: ${savedState?.metadata?.campaign_id}`);
    console.log(`   - state.current: ${savedState?.state?.current}`);
    console.log(`   - qualification.score: ${savedState?.qualification?.score}\n`);

    // ========================================
    // ETAPA 2: SIMULAR RESPOSTA DO LEAD
    // ========================================
    console.log('ğŸ’¬ [ETAPA 2] Simulando resposta do lead Ã  campanha...\n');

    const leadResponse = 'Oi, tenho interesse sim!';
    console.log(`ğŸ—£ï¸ Lead responde: "${leadResponse}"\n`);

    // Chamar agent.js (que deve detectar resposta a campanha)
    const context = {
      contactId: lead.phone,
      metadata: {
        contactProfileName: lead.name
      }
    };

    console.log('ğŸ¤– Processando resposta no agent.js...\n');
    const agentResponse = await chatHandler(leadResponse, context);

    console.log('ğŸ“¤ Resposta do agent:');
    console.log('---');
    console.log(agentResponse.message);
    console.log('---\n');

    // ========================================
    // ETAPA 3: VERIFICAR SE NÃƒO HOUVE DUPLA PRIMEIRA MENSAGEM
    // ========================================
    console.log('ğŸ” [ETAPA 3] Verificando se NÃƒO houve dupla primeira mensagem...\n');

    const isFirstMessage = agentResponse.message.includes('Sou ORBION, agente inteligente da Digital Boost');

    if (isFirstMessage) {
      console.log('âŒ FALHA: Agent enviou OUTRA primeira mensagem!');
      console.log('   Isso significa que a detecÃ§Ã£o de resposta a campanha NÃƒO estÃ¡ funcionando.\n');
      return false;
    } else {
      console.log('âœ… SUCESSO: Agent NÃƒO enviou outra primeira mensagem!');
      console.log('   A detecÃ§Ã£o de resposta a campanha estÃ¡ funcionando corretamente.\n');
    }

    // ========================================
    // ETAPA 4: VERIFICAR SE FLUXO BANT ESTÃ ATIVO
    // ========================================
    console.log('ğŸ¯ [ETAPA 4] Verificando se fluxo BANT estÃ¡ ativo...\n');

    const stateAfterResponse = await getEnhancedState(lead.phone);
    console.log('ğŸ“Š Estado apÃ³s resposta:');
    console.log(`   - state.current: ${stateAfterResponse?.state?.current}`);
    console.log(`   - state.subState: ${stateAfterResponse?.state?.subState}`);
    console.log(`   - qualification.score: ${stateAfterResponse?.qualification?.score}`);
    console.log(`   - bant: ${JSON.stringify(stateAfterResponse?.bant || {}, null, 2)}\n`);

    // ========================================
    // ETAPA 5: SIMULAR CONTINUAÃ‡ÃƒO DA CONVERSA (FLUXO BANT)
    // ========================================
    console.log('ğŸ”„ [ETAPA 5] Testando continuaÃ§Ã£o do fluxo BANT...\n');

    // Resposta 2: Mencionar necessidade
    const response2 = 'Sim, tenho dificuldade em gerenciar os pedidos de Ã³culos no WhatsApp';
    console.log(`ğŸ—£ï¸ Lead responde: "${response2}"\n`);

    const agentResponse2 = await chatHandler(response2, context);
    console.log('ğŸ“¤ Resposta do agent (deve explorar necessidade):');
    console.log('---');
    console.log(agentResponse2.message);
    console.log('---\n');

    const stateAfter2 = await getEnhancedState(lead.phone);
    console.log('ğŸ“Š Estado apÃ³s segunda mensagem:');
    console.log(`   - state.current: ${stateAfter2?.state?.current}`);
    console.log(`   - bant.need: ${stateAfter2?.bant?.need || 'ainda nÃ£o capturado'}\n`);

    // ========================================
    // RESUMO FINAL
    // ========================================
    console.log('ğŸ“‹ ===== RESUMO DO TESTE =====\n');
    console.log('âœ… 1. Campanha enviou mensagem');
    console.log('âœ… 2. Estado salvo com origin=campaign');
    console.log(`${isFirstMessage ? 'âŒ' : 'âœ…'} 3. Lead respondeu SEM receber segunda primeira mensagem`);
    console.log('âœ… 4. Fluxo BANT iniciado corretamente');
    console.log('âœ… 5. Conversa continuou normalmente\n');

    console.log('ğŸ‰ TESTE COMPLETO!\n');
    return true;

  } catch (error) {
    console.error('âŒ ERRO NO TESTE:', error.message);
    console.error(error.stack);
    return false;
  }
}

// Executar teste
testCampaignFlow()
  .then(success => {
    if (success) {
      console.log('âœ… Todos os testes passaram! Sistema funcionando corretamente.\n');
      process.exit(0);
    } else {
      console.log('âŒ Alguns testes falharam. Revise a implementaÃ§Ã£o.\n');
      process.exit(1);
    }
  })
  .catch(error => {
    console.error('âŒ Erro fatal:', error);
    process.exit(1);
  });
